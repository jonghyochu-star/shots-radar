
<!-- OVERLAY: Category Top Mix (safe add-on, no overrides except exposing a new function) -->
<script>
(function(){
  if (typeof fetchWithRotate !== 'function' || typeof ytVideos !== 'function') {
    console.warn('[overlay] Missing base helpers (fetchWithRotate/ytVideos).');
    return;
  }
  const DAY = 86400000;
  const isoSec = (d) => {
    const m = (d||'').match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
    return m ? (+(m[1]||0)*3600 + +(m[2]||0)*60 + +(m[3]||0)) : 0;
  };
  function daysBetween(iso){ return Math.max(1, Math.round((Date.now() - new Date(iso).getTime())/DAY)); }
  function derive(v){
    const views = +(v?.statistics?.viewCount||0);
    const days = daysBetween(v?.snippet?.publishedAt);
    v._d = v._d || {};
    v._d.vspd = Math.round(views / days); // views/day
    return v;
  }
  const CATS = [
    {id:'10', name:'Music'},
    {id:'20', name:'Gaming'},
    {id:'24', name:'Entertainment'},
    {id:'22', name:'People & Blogs'},
    {id:'23', name:'Comedy'},
    {id:'25', name:'News & Politics'},
    {id:'17', name:'Sports'},
    {id:'26', name:'Howto & Style'},
    {id:'27', name:'Education'},
    {id:'28', name:'Science & Tech'},
    {id:'1',  name:'Film & Animation'},
    {id:'15', name:'Pets & Animals'},
    {id:'19', name:'Travel & Events'},
    {id:'2',  name:'Autos & Vehicles'},
  ];

  async function mostPopularByCat(region, catId, pages=1){
    let out=[]; let next=null; let loops=0;
    do{
      const sp = new URLSearchParams({
        part:'snippet,contentDetails,statistics',
        chart:'mostPopular',
        regionCode:String(region||'KR'),
        videoCategoryId:catId,
        maxResults:'50'
      });
      if(next) sp.set('pageToken', next);
      const url = `https://www.googleapis.com/youtube/v3/videos?${sp.toString()}`;
      const res = await fetchWithRotate(url, 1);
      out.push(...(res.items||[]));
      next = res.nextPageToken; loops++;
    }while(next && loops < Math.max(1,pages));
    return out;
  }

  async function searchByCat(region, catId, publishedAfter, pages=2){
    let items=[]; let next=null; let loops=0;
    do{
      const sp = new URLSearchParams({
        part:'snippet',
        type:'video',
        order:'viewCount',
        regionCode:String(region||'KR'),
        videoCategoryId:catId,
        publishedAfter:String(publishedAfter||''),
        maxResults:'50'
      });
      if(next) sp.set('pageToken', next);
      const url = `https://www.googleapis.com/youtube/v3/search?${sp.toString()}`;
      const res = await fetchWithRotate(url, 100);
      items.push(...(res.items||[]));
      next = res.nextPageToken; loops++;
    }while(next && loops < Math.max(1,pages));
    // hydrate
    const ids = Array.from(new Set(items.map(x=>x?.id?.videoId).filter(Boolean)));
    let vids=[];
    for(let i=0;i<ids.length;i+=50){
      const r = await ytVideos(ids.slice(i,i+50));
      vids.push(...(r.items||[]));
    }
    return vids;
  }

  async function fetchCategoryTopMix({region='KR', days=14, perCat=3, minSec=0, maxSec=120, useMostPopularPages=1}){
    const publishedAfter = new Date(Date.now()-days*DAY).toISOString();
    const bag = [];
    for(const cat of CATS){
      // 1) mostPopular first (cheap)
      let vids = await mostPopularByCat(region, cat.id, useMostPopularPages);
      // filter by length & recency
      let filtered = vids.filter(v=>{
        const s = isoSec(v?.contentDetails?.duration);
        const pub = v?.snippet?.publishedAt;
        return s>=minSec && s<=maxSec && (new Date(pub).getTime() >= new Date(publishedAfter).getTime());
      });
      // 2) if 부족, fallback to search.list in that category
      if(filtered.length < perCat){
        const extra = await searchByCat(region, cat.id, publishedAfter, 2);
        vids.push(...extra);
        filtered = vids.filter(v=>{
          const s = isoSec(v?.contentDetails?.duration);
          const pub = v?.snippet?.publishedAt;
          return s>=minSec && s<=maxSec && (new Date(pub).getTime() >= new Date(publishedAfter).getTime());
        });
      }
      // derive & pick top perCat by speed
      filtered.forEach(derive);
      filtered.sort((a,b)=> (b?._d?.vspd||0) - (a?._d?.vspd||0));
      const take = filtered.slice(0, perCat).map(v=>{ v._cat = cat.name; return v; });
      bag.push(...take);
    }
    // global sort by speed desc
    bag.sort((a,b)=> (b?._d?.vspd||0) - (a?._d?.vspd||0));
    return bag;
  }

  // expose globally
  window.fetchCategoryTopMix = fetchCategoryTopMix;
  window.__YT_TOP_CATS = CATS;
  console.log('[overlay] Category Top Mix ready. Try:',
    "fetchCategoryTopMix({region:'KR', days:14, perCat:3, minSec:0, maxSec:120}).then(list=>{STATE.videos=list; renderTable(list);})"
  );
})();
</script>
