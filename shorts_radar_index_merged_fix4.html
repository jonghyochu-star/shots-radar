<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shorts Radar — 통합 패치(S1.1 fix4)</title>
  <link rel="icon" href="data:,">
  <style>
    :root { --bg:#0b1116; --card:#101922; --muted:#7a8a9a; --text:#e8f0f7; --accent:#62d26f; --accent2:#6aa7ff; --warn:#ffb84d; --good:#1f7a3f; }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Pretendard,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1280px;margin:24px auto;padding:0 16px 140px}
    h1{font-weight:800;letter-spacing:-.3px;font-size:26px;margin:0 0 10px}
    h3{margin:0 0 8px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:12px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .card{background:linear-gradient(180deg,#0f1821,#0a1118);border:1px solid #1e2a36;border-radius:14px;padding:14px 14px 16px;box-shadow:0 8px 22px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea,button{border-radius:10px;border:1px solid #2a3a4a;background:#0c141c;color:var(--text);padding:10px 12px;font-size:14px}
    input::placeholder,textarea::placeholder{color:#6b7b8b}
    button{cursor:pointer;background:#152332;border:1px solid #274156}
    button.primary{background:linear-gradient(180deg,#2a6fff,#2461e6);border:0}
    button.ghost{background:transparent;border:1px dashed #2d3b49}
    button.danger{background:#4b1c16;border:1px solid #6b2c24}
    .hint{color:var(--muted);font-size:12px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .pill{background:#0f1620;border:1px solid #1e2a36;border-radius:999px;padding:6px 10px;font-size:12px;color:#b9c7d6}
    .badge{padding:4px 8px;border-radius:999px;background:#0e1b29;border:1px solid #23374a;font-size:11px}
    .grade-S{background:#0d2a19;border-color:#1e4a2a;color:#bfffd0}
    .good{color:#8fe39c}
    .thumb{width:120px;height:68px;background:#111;border:1px solid #253444;border-radius:10px;object-fit:cover}
    .footer{position:fixed;left:0;right:0;bottom:0;background:rgba(9,14,20,.9);border-top:1px solid #1e2a36;padding:10px 16px;display:flex;gap:8px;align-items:center;justify-content:center}
    .small{font-size:12px}
    .muted{color:#9fb0bf}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Table layout + overflow handling */
    .table-wrap{overflow-x:auto;border-radius:12px}
    table.table{width:100%;min-width:1400px;border-collapse:collapse;table-layout:fixed}
    .table th,.table td{padding:10px;border-bottom:1px solid #1e2a36;text-align:left;font-size:13px;white-space:nowrap;vertical-align:middle}
    .table th{color:#a5b6c6;font-weight:600;position:sticky;top:0;background:#0b1219}
    .table .c-title{width:440px;max-width:440px;overflow:hidden;text-overflow:ellipsis}
    .table .c-channel{width:220px;max-width:220px;overflow:hidden;text-overflow:ellipsis}
    .table .c-thumb{width:136px}
    .table .c-uploadedAt{width:170px}
    .table .c-length{width:80px}
    .num{width:110px}

    /* Channel board layout with sidebar */
    .board-grid{display:grid;grid-template-columns:1fr 260px;gap:12px}
    .sidebar{border:1px solid #223243;border-radius:12px;background:#0e1620;padding:10px;position:sticky;top:76px;height:fit-content}
    .channel-card{display:flex;justify-content:space-between;align-items:center;border:1px solid #223243;border-radius:12px;padding:10px 12px;background:#0e1620}

    /* Viral candidates */
    .viral{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .viral .item{display:flex;gap:10px;border:1px solid #223243;border-radius:12px;background:#0e1620;padding:8px}
    .viral .item .meta{display:flex;flex-direction:column;gap:4px}

    /* Heatmap */
    .heat{display:grid;grid-template-columns:repeat(24, 1fr);gap:2px}
    .heat .cell{height:16px;border-radius:3px;background:#0e1620;border:1px solid #1e2735}

    /* Video table card with left toolbar */
    .vgrid{display:grid;grid-template-columns:52px 1fr;gap:12px}
    .vbar{display:flex;flex-direction:column;gap:8px;align-items:stretch}
    .vbar button{padding:8px 6px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>Shorts Radar — <span class="muted">통합 패치 S1.1</span></h1>
        <div class="sub">안정판 + S1(테이블/필터/Export) 완전 통합 · 라벨 한글화 · CSV/JSON 스키마 고정</div>
      </div>
      <div class="row">
        <button id="btnExportCsv" class="ghost">CSV</button>
        <button id="btnExportJson" class="ghost">JSON</button>
        <button id="btnReprobe" class="ghost">워치리스트 재측정</button>
        <button id="btnReset" class="danger">초기화</button>
      </div>
    </div>

    <!-- 1) 연결 설정 / 2) 찾을 조건 -->
    <div class="grid cols-2">
      <div class="card">
        <h3>1) 연결 설정</h3>
        <div class="row" style="gap:8px">
          <input id="apiKey" placeholder="YouTube Data API 키 붙여넣기" style="min-width:320px" aria-label="YouTube API Key" autocomplete="off"/>
          <button id="saveKey" class="primary">키 저장</button>
          <span class="hint">* GCP 콘솔에서 HTTP referrer(내 GitHub Pages 도메인) 제한 권장</span>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <label>일일 한도(유닛)</label>
          <input id="quotaLimit" type="number" min="1000" step="100" value="10000" style="width:120px" aria-label="일일 한도" autocomplete="off"/>
          <button id="quotaApply" class="ghost">적용</button>
          <span id="quotaStat" class="pill">API 사용량(오늘) 0 / 10000 (0%)</span>
          <button id="quotaReset" class="ghost">사용량 초기화</button>
        </div>
      </div>

      <div class="card">
        <h3>2) 찾을 조건</h3>
        <div class="row" style="gap:8px">
          <input id="keywords" placeholder="찾을 주제(예: 정치풍자, 고양이 모래매트)" style="flex:1" aria-label="키워드" autocomplete="off"/>
          <input id="channels" placeholder="경쟁 채널 ID들(쉼표 구분 · 선택)" style="flex:1" aria-label="채널 ID 목록" autocomplete="off"/>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <select id="days" title="기간">
            <option value="3">최근 3일</option>
            <option value="7" selected>최근 7일</option>
            <option value="14">최근 14일</option>
          </select>
          <select id="region" title="지역 힌트">
            <option value="KR" selected>KR</option><option value="US">US</option><option value="JP">JP</option><option value="GB">GB</option>
          </select>
          <select id="lang" title="언어 힌트">
            <option value="ko" selected>ko</option><option value="en">en</option><option value="ja">ja</option>
          </select>
          <input id="maxResults" type="number" min="10" max="200" value="80" style="width:120px" aria-label="결과 개수" autocomplete="off"/>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <label><input id="shortsOnly" type="checkbox" checked/> Shorts만</label>
          <label>최대 길이(초) <input id="shortsMaxSec" type="number" value="60" min="10" max="240" style="width:90px"></label>
          <button id="runBtn" class="primary">찾기 시작</button>
        </div>
      </div>
    </div>

    <!-- 요약 KPI -->
    <div class="card" style="margin-top:12px">
      <h3>요약</h3>
      <div id="summary" class="kpi"></div>
    </div>

    <!-- 바이럴 후보 (안정판 기능 복구) -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3>바이럴 후보</h3>
        <span class="hint">최근 결과 중 종합 상위 · 반응률/속도도 우수</span>
      </div>
      <div id="viralWrap" class="viral"></div>
    </div>

    <!-- 올리기 좋은 시간대 (히트맵) -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <div>
          <h3>올리기 좋은 시간대 (히트맵)</h3>
          <div class="hint">요일 × 시간(로컬) — 종합 점수 합산 기준</div>
        </div>
        <ol id="bestTimes" style="margin:0"></ol>
      </div>
      <div id="heatmap" class="heat" style="margin-top:8px"></div>
    </div>

    <!-- 채널 운영 카드 + 사이드바 -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3>경쟁 채널 운영 카드</h3>
        <span class="hint">최근 결과에 등장한 채널 기준(게시 주기/시간대)</span>
      </div>
      <div class="board-grid" style="margin-top:8px">
        <div id="chanBoard" class="grid" style="gap:8px"></div>
        <div class="sidebar">
          <div class="small muted" style="margin-bottom:6px">사이드바</div>
          <label>최소 등장 수</label>
          <input id="chanMinCount" type="number" value="2" min="1" max="20" style="width:100%">
          <label style="margin-top:8px">표시 개수</label>
          <input id="chanLimit" type="number" value="8" min="3" max="30" style="width:100%">
          <label style="margin-top:8px">정렬</label>
          <select id="chanSort" style="width:100%"><option value="count">결과수</option><option value="gap">평균 주기</option></select>
          <button id="chanApply" class="ghost" style="margin-top:10px;width:100%">적용</button>
        </div>
      </div>
    </div>

    <!-- 보기/정렬/필터 + 토글 -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="gap:8px">
        <label>보기 프리셋</label>
        <select id="viewPreset">
          <option value="all">전체(기본)</option>
          <option value="stable">안정판</option>
          <option value="simple">간단</option>
          <option value="speedeng">속도·반응</option>
          <option value="metrics">지표만</option>
          <option value="packaging">패키징</option>
        </select>

        <label>정렬</label>
        <select id="sortKey"></select>
        <select id="sortDir"><option value="desc">내림차순</option><option value="asc">오름차순</option></select>

        <span id="summaryPill" class="pill">수집 0 · 표시 0</span>
      </div>
      <div class="row" style="gap:10px;margin-top:8px">
        <label>최소 반응률(‰)</label><input id="fMinER" type="number" value="0" step="0.1" style="width:120px" />
        <label>최소 조회 배율</label><input id="fMinVMult" type="number" value="0" step="0.1" style="width:120px" />
        <label>최소 임팩트 등급</label>
        <select id="fMinGrade"><option value="ALL">전체</option><option value="D">D</option><option value="C">C</option><option value="B">B</option><option value="A">A</option><option value="S">S</option></select>
        <button id="saveFilters" class="ghost">필터 저장</button>
        <button id="resetFilters" class="ghost">필터 초기화</button>
      </div>
      <div id="colControls" class="row" style="gap:8px; margin:10px 0 0; align-items:center; flex-wrap:wrap"></div>
    </div>

    <!-- 영상 테이블 + 좌측 사이드바 -->
    <div class="card" style="margin-top:12px">
      <div class="vgrid">
        <div class="vbar">
          <button id="btnPresetStable">안정판</button>
          <button id="btnPresetSimple">간단</button>
          <button id="btnToggleAll">열 전체 On/Off</button>
          <button id="btnToTop">상단</button>
          <button id="btnToBottom">하단</button>
        </div>
        <div>
          <h3>영상 리스트</h3>
          <div class="table-wrap">
            <table class="table" id="table">
              <thead id="thead"></thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 비슷하게 만들기 도우미 -->
    <div class="card" style="margin-top:12px">
      <h3>비슷하게 만들기 도우미</h3>
      <div class="hint">상위 종합 Top5를 템플릿으로 변환합니다. 복사해서 제작 가이드로 쓰세요.</div>
      <textarea id="helperText" rows="8" style="margin-top:8px;width:100%;resize:vertical" placeholder="결과가 생성되면 여기에 자동 작성됩니다."></textarea>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button id="btnCopyHelper" class="primary">복사</button>
      </div>
    </div>

  </div>

  <div class="footer small">
    <span>Tip: <b>종합</b>이 높은 순으로 오늘 바로 따라 만들 주제를 고르세요. — <span class="muted">속도·반응률·신선도·주제적합</span>을 합칩니다.</span>
  </div>

<script>
(()=>{
  // ===== 공통 유틸 =====
  const $ = s => document.querySelector(s);
  const fmt = n => (n===undefined||n===null) ? '-' : Number(n).toLocaleString('en-US');
  const hms = sec => {sec=+sec|0;const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60;return (h? h+':':'')+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')};
  const isoToSec = d => {const m=(d||'').match(/PT(?:(\\d+)H)?(?:(\\d+)M)?(?:(\\d+)S)?/);return m?(+(m[1]||0)*3600+ +(m[2]||0)*60+ +(m[3]||0)):0};
  const hoursSince = iso => (Date.now()-new Date(iso).getTime())/36e5;
  const escapeHtml = s => (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  // ===== 상태 & 저장 =====
  const COLUMN_KEYS = ['bookmark','thumb','title','channel','uploadedAt','length','views','likes','comments','vel','er','fresh','viewMult','velMult','impact','delta','pick','cluster'];
  const LABELS = { bookmark:'☆', thumb:'썸네일', title:'제목', channel:'채널', uploadedAt:'업로드일', length:'길이', views:'조회', likes:'좋아요', comments:'댓글', vel:'속도', er:'반응률(‰)', fresh:'신선도', viewMult:'조회 배율', velMult:'속도 배율', impact:'임팩트 등급', delta:'Δ24h', pick:'종합', cluster:'묶음' };
  const DEFAULT_COLS = {bookmark:true,thumb:true,title:true,channel:true,uploadedAt:true,length:true,views:true,likes:true,comments:true,vel:true,er:true,fresh:true,viewMult:true,velMult:true,impact:true,delta:true,pick:true,cluster:true};
  let STATE = { items:[], filtered:[], watch:new Set(), snapshots:{}, cols:null, sortKey:'pick', sortDir:'desc', filters:{minER:0, minVMult:0, minGrade:'ALL'}, chan:{list:[],minCount:2,limit:8,sort:'count'} };

  const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const load=(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}};

  // ===== 헤더 동적 생성 (열 토글 정합성) =====
  function buildHeader(){
    const thead = $('#thead');
    const tr = document.createElement('tr');
    COLUMN_KEYS.forEach(k=>{
      const th = document.createElement('th');
      th.className = 'c-'+k + (['views','likes','comments','vel','er','fresh','viewMult','velMult','impact','delta','pick'].includes(k)?' num':'');
      th.textContent = LABELS[k];
      tr.appendChild(th);
    });
    thead.innerHTML='';
    thead.appendChild(tr);
  }

  // ===== YouTube API & Quota =====
  function todayStr(){ const d=new Date(); return d.toISOString().slice(0,10); }
  const QUOTA_KEY='sr_quota';
  function getQuota(){ let q = load(QUOTA_KEY, null); const today=todayStr(); if(!q) q={date:today, used:0, limit:10000}; if(q.date!==today){ q.date=today; q.used=0; } return q; }
  function saveQuota(q){ save(QUOTA_KEY, q); }
  function setQuotaLimit(n){ const q=getQuota(); q.limit=Math.max(1000, Number(n)||10000); saveQuota(q); renderQuota(); }
  function incQuota(units){ const q=getQuota(); q.used += Math.max(0, units|0); saveQuota(q); renderQuota(); }
  function resetQuota(){ const q={date:todayStr(), used:0, limit:getQuota().limit}; saveQuota(q); renderQuota(); }
  function renderQuota(){ const q=getQuota(); const pct=Math.min(100, Math.round((q.used/(q.limit||1))*100)); $('#quotaStat').innerHTML=`API 사용량(오늘) <b>${q.used}</b> / ${q.limit} (${pct}%)`; $('#quotaLimit').value=q.limit; }

  async function ytSearch({q, channelId, publishedAfter, regionCode, lang, maxResults, key, pageToken}){
    const params=new URLSearchParams({part:'snippet',type:'video',order:'date',maxResults:String(Math.min(50,maxResults||50)),publishedAfter,regionCode,relevanceLanguage:lang,key});
    if(q) params.set('q', q);
    if(channelId) params.set('channelId', channelId);
    if(pageToken) params.set('pageToken', pageToken);
    const url=`https://www.googleapis.com/youtube/v3/search?${params.toString()}`;
    const r=await fetch(url); if(!r.ok) throw new Error('search '+r.status); incQuota(100); return r.json();
  }
  async function ytVideos(ids,key){
    const url=`https://www.googleapis.com/youtube/v3/videos?`+new URLSearchParams({part:'snippet,contentDetails,statistics',id:ids.join(','),key});
    const r=await fetch(url); if(!r.ok) throw new Error('videos '+r.status); incQuota(1); return r.json();
  }

  // ===== 워치리스트/스냅샷 (Δ24h) =====
  function loadWatch(){ STATE.watch = new Set(load('sr_watchlist', [])); STATE.snapshots = load('sr_snapshots', {} ) || {}; }
  function saveWatch(){ save('sr_watchlist', [...STATE.watch]); save('sr_snapshots', STATE.snapshots); }
  function toggleWatch(id){ if(STATE.watch.has(id)) STATE.watch.delete(id); else STATE.watch.add(id); saveWatch(); renderTable(); }
  function pushSnapshot(id, v){ const s=STATE.snapshots[id] || (STATE.snapshots[id]=[]); s.push({t:new Date().toISOString(), views:+(v.statistics.viewCount||0)}); STATE.snapshots[id]=s.slice(-60); saveWatch(); }
  function delta24h(id){ const s=STATE.snapshots[id]||[]; if(s.length<2) return 0; const from = Date.now()-24*3600*1000; const r = s.filter(x=> new Date(x.t).getTime()>=from); if(r.length<2) return 0; return Math.max(0, (r[r.length-1].views - r[0].views)); }

  // ===== 지표 계산 =====
  function computePrimary(v){
    const views=+v.statistics.viewCount||0;
    const likes=+v.statistics.likeCount||0;
    const comments=+v.statistics.commentCount||0;
    const hours=Math.max(0.01, hoursSince(v.snippet.publishedAt));
    const vel=views/Math.max(0.01, hours);                 // 속도
    const er=(likes + 5*comments)/Math.max(views,1)*1000;  // 반응률(‰)
    const fresh=Math.exp(-hours/48);                        // 신선도
    return {views,likes,comments,hours,vel,er,fresh};
  }
  function computeMultipliers(items){
    const avg = (arr)=> arr.reduce((s,x)=>s+x,0)/Math.max(1,arr.length);
    const avgViews = avg(items.map(x=>x._p.views));
    const avgVel   = avg(items.map(x=>x._p.vel));
    items.forEach(v=>{
      v._m = { viewMult: v._p.views/Math.max(1,avgViews), velMult:  v._p.vel/Math.max(0.01,avgVel) };
    });
  }
  function percentile(arr, v){
    const a=[...arr].sort((x,y)=>x-y);
    let lo=0, hi=a.length-1, pos=0;
    while(lo<=hi){ const mid=(lo+hi)>>1; if(a[mid]<=v){pos=mid; lo=mid+1;} else {hi=mid-1;} }
    return (pos/(a.length-1||1))*100;
  }
  function scoreImpact(items){
    const pks = items.map(x=>x._pick);
    items.forEach(v=>{
      const pct = percentile(pks, v._pick);
      v._impact = {score: pct, grade: (pct>=90?'S': pct>=80?'A': pct>=60?'B': pct>=40?'C':'D')};
    });
  }
  function computePick(v){
    // 종합 = vel^0.5 × max(er,0)^0.3 × fresh^0.2 × (주제적합은 추후 확장)
    return Math.pow(v._p.vel,0.5) * Math.pow(Math.max(v._p.er,0),0.3) * Math.pow(v._p.fresh,0.2);
  }

  // ===== 렌더 공통 =====
  function applyColumnVisibility(){
    COLUMN_KEYS.forEach(k=>{
      const disp = (STATE.cols?.[k] ?? true) ? '' : 'none';
      document.querySelectorAll('.c-'+k).forEach(el=> el.style.display=disp);
    });
  }

  function renderTable(){
    applyFilters();
    const arr=[...STATE.filtered];
    const key=STATE.sortKey||'pick'; const asc=(STATE.sortDir||'desc')==='asc';
    const valOf=(v)=>{
      switch(key){
        case 'views': return v._p.views;
        case 'vel': return v._p.vel;
        case 'er': return v._p.er;
        case 'viewMult': return v._m.viewMult;
        case 'velMult': return v._m.velMult;
        case 'delta': return v._delta24h || 0;
        case 'pick': default: return v._pick;
      }
    };
    arr.sort((a,b)=> asc? (valOf(a)-valOf(b)) : (valOf(b)-valOf(a)));

    const tb = document.querySelector('#tbody'); tb.innerHTML='';
    arr.forEach(v=>{
      const sec = isoToSec(v.contentDetails.duration||'PT0S');
      const upISO = v.snippet.publishedAt;
      const upLocal = new Date(upISO).toLocaleString('ko-KR');
      const g=v._impact.grade;
      const d24 = v._delta24h||0;
      const star = STATE.watch.has(v.id) ? '★' : '☆';

      const tr=document.createElement('tr');
      const cells = {
        bookmark: `<span class="star ${STATE.watch.has(v.id)?'on':''}" data-id="${v.id}">${star}</span>`,
        thumb: `<a href="https://www.youtube.com/watch?v=${v.id}" target="_blank"><img class="thumb" src="${v.snippet.thumbnails?.medium?.url||''}"/></a>`,
        title: `${escapeHtml(v.snippet.title||'')}`,
        channel: `${escapeHtml(v.snippet.channelTitle||'')}`,
        uploadedAt: `<span title="${upISO}">${upLocal}</span>`,
        length: hms(sec),
        views: Number(v._p.views).toLocaleString('en-US'),
        likes: Number(v._p.likes).toLocaleString('en-US'),
        comments: Number(v._p.comments).toLocaleString('en-US'),
        vel: v._p.vel.toFixed(1),
        er: v._p.er.toFixed(2),
        fresh: v._p.fresh.toFixed(2),
        viewMult: v._m.viewMult.toFixed(2)+'×',
        velMult: v._m.velMult.toFixed(2)+'×',
        impact: `<span class="badge grade-${g}">${g}</span> <span class="muted">(${v._impact.score.toFixed(0)})</span>`,
        delta: `<span class="${d24>0?'good':''}">+${Number(d24).toLocaleString('en-US')}</span>`,
        pick: `<b class="good">${v._pick.toFixed(2)}</b>`,
        cluster: `<span class="badge">${v.clusterId ?? '-'}</span>`
      };
      COLUMN_KEYS.forEach(k=>{
        const td=document.createElement('td');
        td.className='c-'+k + (['views','likes','comments','vel','er','fresh','viewMult','velMult','impact','delta','pick'].includes(k)?' num':'');
        td.innerHTML = cells[k];
        tr.appendChild(td);
      });
      tb.appendChild(tr);
    });
    // 별 토글 바인딩
    tb.querySelectorAll('.star').forEach(s=> s.addEventListener('click', (ev)=>{ const id=ev.target.getAttribute('data-id'); toggleWatch(id);}));

    applyColumnVisibility();
    document.querySelector('#summaryPill').textContent = `수집 ${STATE.items.length} · 표시 ${STATE.filtered.length}`;
  }

  // ===== Export (CSV/JSON) — 스키마 고정 =====
  function toCsvRow(arr){ return arr.map(v=>{ const s=(v===null||v===undefined)?'':String(v).replace(/"/g,'""'); return '"' + s + '"'; }).join(','); }
  function exportCsv(){
    if(!STATE.filtered.length) return alert('내보낼 데이터가 없습니다.');
    const headers = ['id','title','channel','publishedAt','durationSec','views','likes','comments','vel','er','fresh','fit','viewMult','velMult','impact','delta','pick','clusterId'];
    const rows = [headers.join(',')];
    STATE.filtered.forEach(v=>{
      const sec = (v.contentDetails?.duration) ? isoToSec(v.contentDetails.duration) : 0;
      rows.push(toCsvRow([
        v.id, v.snippet.title||'', v.snippet.channelTitle||'',
        v.snippet.publishedAt, sec,
        v._p.views, v._p.likes, v._p.comments,
        v._p.vel.toFixed(3), v._p.er.toFixed(3), v._p.fresh.toFixed(4),
        (v.metrics?.fit ?? 0).toFixed(3),
        v._m.viewMult.toFixed(3), v._m.velMult.toFixed(3),
        v._impact.grade, (v._delta24h||0),
        v._pick.toFixed(4), (v.clusterId??'')
      ]));
    });
    const blob=new Blob([rows.join("\\n")],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`shorts_radar_export_${timestamp()}_KST.csv`; document.body.appendChild(a); a.click(); a.remove();
  }
  function exportJson(){
    const out = STATE.filtered.map(v=>{
      const sec = (v.contentDetails?.duration) ? isoToSec(v.contentDetails.duration) : 0;
      return {
        id: v.id, title: v.snippet.title||'', channel: v.snippet.channelTitle||'',
        publishedAt: v.snippet.publishedAt, durationSec: sec,
        views: v._p.views, likes: v._p.likes, comments: v._p.comments,
        vel: v._p.vel, er: v._p.er, fresh: v._p.fresh, fit: v.metrics?.fit ?? 0,
        viewMult: v._m.viewMult, velMult: v._m.velMult,
        impact: v._impact.grade, delta: v._delta24h||0, pick: v._pick,
        clusterId: v.clusterId ?? null
      };
    });
    const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`shorts_radar_export_${timestamp()}_KST.json`; document.body.appendChild(a); a.click(); a.remove();
  }
  function timestamp(){ const d=new Date(); const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}_${z(d.getHours())}${z(d.getMinutes())}`; }

  // ===== 요약/보조 위젯 =====
  function setSummary(items){
    const avg=(arr,fn)=> arr.reduce((s,x)=>s+fn(x),0)/Math.max(1,arr.length);
    $('#summary').innerHTML = [
      `<span class="pill">총 수집 <b>${items.length}</b></span>`,
      `<span class="pill">평균 속도 <b>${avg(items,x=>x._p.vel).toFixed(1)}</b></span>`,
      `<span class="pill">평균 반응률 <b>${avg(items,x=>x._p.er).toFixed(2)}</b></span>`
    ].join(' ');
  }
  function bestHours(items){
    const hours=new Array(24).fill(0);
    items.forEach(v=>{ const h=new Date(v.snippet.publishedAt).getHours(); hours[h]+=v._pick; });
    return hours.map((v,i)=>({v,i})).sort((a,b)=>b.v-a.v).slice(0,5);
  }
  function renderBestTimes(items){
    const top=bestHours(items);
    $('#bestTimes').innerHTML = top.map(x=>`<li>${String(x.i).padStart(2,'0')}:00 · 점수 ${x.v.toFixed(1)}</li>`).join('');
  }
  function renderHeatmap(items){
    // 요일(0=일) x 시간(0~23): 종합 합산
    const grid=[...Array(7)].map(()=> new Array(24).fill(0));
    items.forEach(v=>{
      const d=new Date(v.snippet.publishedAt);
      grid[d.getDay()][d.getHours()] += v._pick;
    });
    const flat = grid.flat();
    const max = Math.max(1, ...flat);
    const heat = $('#heatmap'); heat.innerHTML='';
    const dayLabel = ['일','월','화','수','목','금','토'];
    for(let r=0;r<7;r++){
      for(let c=0;c<24;c++){
        const v = grid[r][c]/max;
        const cell=document.createElement('div');
        cell.className='cell';
        const g = Math.round(30 + v*130);
        cell.style.background = `rgb(${10}, ${g/2}, ${Math.min(220,60+g)})`;
        cell.title = `${dayLabel[r]} ${String(c).padStart(2,'0')}:00 · ${grid[r][c].toFixed(1)}`;
        heat.appendChild(cell);
      }
    }
  }
  function renderViral(items){
    const top = [...items].sort((a,b)=> b._pick - a._pick).slice(0,2);
    const box = $('#viralWrap'); box.innerHTML='';
    top.forEach(v=>{
      const el=document.createElement('div'); el.className='item';
      el.innerHTML = `
        <img class="thumb" src="${v.snippet.thumbnails?.medium?.url||''}" alt="thumb">
        <div class="meta">
          <div><b>${escapeHtml(v.snippet.title||'')}</b></div>
          <div class="small muted">${escapeHtml(v.snippet.channelTitle||'')} · ${new Date(v.snippet.publishedAt).toLocaleString('ko-KR')}</div>
          <div class="small">조회 ${Number(v._p.views).toLocaleString('en-US')} · 속도 ${v._p.vel.toFixed(1)} · 반응률 ${v._p.er.toFixed(2)}‰ · <span class="badge grade-${v._impact.grade}">${v._impact.grade}</span></div>
        </div>`;
      box.appendChild(el);
    });
  }
  function buildHelper(items){
    const top = [...items].sort((a,b)=> b._pick - a._pick).slice(0,5);
    const lines = top.map((v,i)=>{
      return `#${i+1}. ${v.snippet.title} — ${v.snippet.channelTitle}
- 업로드: ${new Date(v.snippet.publishedAt).toLocaleString('ko-KR')} / 길이 ${hms(isoToSec(v.contentDetails.duration||'PT0S'))}
- 핵심지표: 속도 ${v._p.vel.toFixed(1)}, 반응률 ${v._p.er.toFixed(2)}‰, 임팩트 ${v._impact.grade}
- 템플릿: [Hook 3초] → [키 포인트 2개] → [CTA 3초]`;
    }).join('\\n\\n');
    $('#helperText').value = lines + `\\n\\n추천 업로드 시간: ` + bestHours(items).map(x=>`${String(x.i).padStart(2,'0')}:00`).join(', ');
  }

  function renderChannelBoard(items){
    const byCh={};
    items.forEach(v=>{ const cid=v.snippet.channelId; (byCh[cid]=byCh[cid]||{title:v.snippet.channelTitle,times:[]}).times.push(v.snippet.publishedAt); });
    let list=Object.values(byCh).map(ch=>{
      const t=ch.times.map(x=>new Date(x).getTime()).sort((a,b)=>a-b);
      let gaps=[]; for(let i=1;i<t.length;i++) gaps.push((t[i]-t[i-1])/(24*3600*1000));
      const avgGap=gaps.length? (gaps.reduce((s,x)=>s+x,0)/gaps.length):0;
      const hours=new Array(24).fill(0); ch.times.forEach(x=>{ hours[new Date(x).getHours()]++; });
      const topHour=hours.map((v,i)=>({v,i})).sort((a,b)=>b.v-a.v)[0]?.i ?? 0;
      return {title:ch.title, count:ch.times.length, avgGap, topHour};
    });

    // apply sidebar filters
    const minCount = STATE.chan.minCount;
    const limit = STATE.chan.limit;
    const sort = STATE.chan.sort;
    list = list.filter(x=> x.count >= minCount);
    list.sort((a,b)=> sort==='gap' ? (a.avgGap-b.avgGap) : (b.count-a.count) );
    list = list.slice(0, limit);

    const board=$('#chanBoard'); board.innerHTML='';
    list.forEach(ch=>{
      const el=document.createElement('div'); el.className='channel-card';
      el.innerHTML=`<div><b>${escapeHtml(ch.title||'-')}</b><div class="small muted">결과수 ${ch.count} · 평균 주기 ${ch.avgGap?ch.avgGap.toFixed(1)+'일':'-'}</div></div>
                    <div class="small">히트 시간대: <b>${String(ch.topHour).padStart(2,'0')}:00</b></div>`;
      board.appendChild(el);
    });
  }

  // ===== 필터 =====
  function applyFilters(){
    const f=STATE.filters;
    STATE.filtered = STATE.items.filter(v=>{
      const okER = v._p.er >= (f.minER||0);
      const okVM = v._m.viewMult >= (f.minVMult||0);
      const okG  = (f.minGrade==='ALL') || (rankGrade(v._impact.grade) >= rankGrade(f.minGrade));
      return okER && okVM && okG;
    });
  }
  function rankGrade(g){ return ({'D':1,'C':2,'B':3,'A':4,'S':5}[g]||0); }

  // ===== 실행 파이프라인 =====
  async function run(){
    try{
      const key = $('#apiKey').value.trim(); if(!key) return alert('API 키를 입력하세요.');
      const days = +($('#days').value||7);
      const region = $('#region').value||'KR';
      const lang = $('#lang').value||'ko';
      const maxResults = Math.max(10, Math.min(200, +($('#maxResults').value||80)));
      const qStr = ($('#keywords').value||'').trim();
      const chStr = ($('#channels').value||'').trim();
      const publishedAfter = new Date(Date.now()-days*24*3600*1000).toISOString();
      const shortsOnly = $('#shortsOnly').checked;
      const shortsMax = Math.max(10, Math.min(240, +($('#shortsMaxSec').value||60)));

      let items=[];
      async function fetchChunk({q, channelId}){
        let pageToken=null, collected=0;
        while(collected < maxResults){
          const res=await ytSearch({q, channelId, publishedAfter, regionCode:region, lang, maxResults, key, pageToken});
          const ids=(res.items||[]).map(x=>x.id.videoId).filter(Boolean);
          if(!ids.length) break;
          const vd=await ytVideos(ids, key);
          (vd.items||[]).forEach(v=> items.push(v));
          collected += ids.length;
          pageToken = res.nextPageToken; if(!pageToken) break;
        }
      }
      if(qStr) await fetchChunk({q:qStr, channelId:null});
      if(chStr){
        const ids = chStr.split(',').map(s=>s.trim()).filter(Boolean);
        for(const cid of ids){ await fetchChunk({q:null, channelId:cid}); }
      }
      // 중복 제거
      const seen=new Set(); items = items.filter(v=>{ if(seen.has(v.id)) return false; seen.add(v.id); return true; });

      // Shorts 필터(길이 기준)
      if(shortsOnly){
        items = items.filter(v=> (isoToSec(v.contentDetails?.duration||'PT0S')<=shortsMax) );
      }

      // 지표/배율/임팩트
      items.forEach(v=>{ v._p = computePrimary(v); });
      computeMultipliers(items);
      items.forEach(v=>{ v._pick = computePick(v); v._delta24h = delta24h(v.id); });
      scoreImpact(items);

      STATE.items = items;
      setSummary(items);
      renderViral(items);
      renderHeatmap(items);
      STATE.chan.list = items; // cache
      renderChannelBoard(items);
      renderBestTimes(items);
      renderTable();
      buildHelper(items);
    }catch(e){
      console.error(e);
      alert('실행 중 오류: '+e.message);
    }
  }

  // ===== 초기화/바인딩 =====
  function buildColControls(){
    if(!STATE.cols) STATE.cols=load('sr_cols', DEFAULT_COLS);
    if(!STATE.sortKey) STATE.sortKey = load('sr_sortKey','pick');
    if(!STATE.sortDir) STATE.sortDir = load('sr_sortDir','desc');

    // 열 토글
    const holder = $('#colControls'); holder.innerHTML = `<label>열 토글</label><div id="colToggles" class="row" style="gap:6px"></div>`;
    const box=$('#colToggles'); box.innerHTML='';
    COLUMN_KEYS.forEach(k=>{
      const id='vis_'+k;
      const lbl=document.createElement('label'); lbl.className='small'; lbl.style.display='flex'; lbl.style.alignItems='center'; lbl.style.gap='6px';
      lbl.innerHTML=`<input type="checkbox" id="${id}" ${STATE.cols[k]?'checked':''}/> ${LABELS[k]}`;
      box.appendChild(lbl);
      document.getElementById(id).addEventListener('change',()=>{ STATE.cols[k]=document.getElementById(id).checked; save('sr_cols', STATE.cols); applyColumnVisibility(); });
    });

    // 정렬키
    const sortOpts=[['pick','종합'],['delta','Δ24h'],['vel','속도'],['er','반응률(‰)'],['viewMult','조회 배율'],['velMult','속도 배율'],['views','조회']];
    const sk=$('#sortKey'); sk.innerHTML=''; sortOpts.forEach(([v,t])=>{ const o=document.createElement('option'); o.value=v; o.textContent=t; sk.appendChild(o); });
    sk.value=STATE.sortKey;
    $('#sortDir').value=STATE.sortDir;
    sk.addEventListener('change',()=>{ STATE.sortKey=sk.value; save('sr_sortKey', STATE.sortKey); renderTable(); });
    $('#sortDir').addEventListener('change',()=>{ STATE.sortDir=$('#sortDir').value; save('sr_sortDir', STATE.sortDir); renderTable(); });

    // 프리셋
    $('#viewPreset').addEventListener('change',()=>{
      const p=$('#viewPreset').value;
      const vis={}; COLUMN_KEYS.forEach(k=>vis[k]=false);
      if(p==='all'){ COLUMN_KEYS.forEach(k=>vis[k]=true); }
      else if(p==='stable'){ ['thumb','title','channel','views','likes','comments','vel','er','pick'].forEach(k=>vis[k]=true); vis.bookmark=true; vis.uploadedAt=true; vis.length=true; }
      else if(p==='simple'){ ['thumb','title','pick'].forEach(k=>vis[k]=true); }
      else if(p==='speedeng'){ ['thumb','title','vel','er','pick'].forEach(k=>vis[k]=true); vis.bookmark=true; }
      else if(p==='metrics'){ ['vel','er','fresh','viewMult','velMult','impact','pick'].forEach(k=>vis[k]=true); }
      else if(p==='packaging'){ ['thumb','title','uploadedAt','likes','comments','impact','delta','pick'].forEach(k=>vis[k]=true); }
      STATE.cols=vis; save('sr_cols', vis); buildColControls(); applyColumnVisibility();
    });
  }

  function bindSidebars(){
    // Video table vbar quick actions
    $('#btnPresetStable').addEventListener('click', ()=>{ $('#viewPreset').value='stable'; $('#viewPreset').dispatchEvent(new Event('change')); });
    $('#btnPresetSimple').addEventListener('click', ()=>{ $('#viewPreset').value='simple'; $('#viewPreset').dispatchEvent(new Event('change')); });
    $('#btnToggleAll').addEventListener('click', ()=>{
      const allOn = Object.values(STATE.cols).every(v=>v);
      COLUMN_KEYS.forEach(k=> STATE.cols[k]=!allOn);
      save('sr_cols', STATE.cols);
      buildColControls(); applyColumnVisibility();
    });
    $('#btnToTop').addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
    $('#btnToBottom').addEventListener('click', ()=> window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}));

    // Channel sidebar
    $('#chanApply').addEventListener('click', ()=>{
      STATE.chan.minCount = +($('#chanMinCount').value||2);
      STATE.chan.limit = +($('#chanLimit').value||8);
      STATE.chan.sort = $('#chanSort').value;
      renderChannelBoard(STATE.chan.list||[]);
    });

    // Helper copy
    $('#btnCopyHelper').addEventListener('click', ()=>{
      $('#helperText').select(); document.execCommand('copy');
      alert('복사되었습니다.');
    });
  }

  function init(){
    buildHeader();

    const savedKey = load('yt_api_key','');
    if(savedKey) $('#apiKey').value = savedKey;
    $('#saveKey').addEventListener('click', ()=>{ save('yt_api_key', $('#apiKey').value.trim()); alert('저장되었습니다.'); });

    // 쿼터
    renderQuota();
    $('#quotaApply').addEventListener('click', ()=> setQuotaLimit($('#quotaLimit').value));
    $('#quotaReset').addEventListener('click', resetQuota);

    // 워치리스트
    loadWatch();
    $('#btnReprobe').addEventListener('click', async ()=>{
      const key = $('#apiKey').value.trim(); if(!key) return alert('API 키 필요');
      const ids=[...STATE.watch]; if(!ids.length) return alert('워치리스트가 비었습니다.');
      for(let i=0;i<ids.length;i+=50){
        const data = await ytVideos(ids.slice(i,i+50), key);
        (data.items||[]).forEach(v=> pushSnapshot(v.id, v));
      }
      alert('재측정 완료');
      STATE.items.forEach(v=> v._delta24h = delta24h(v.id));
      renderTable();
    });

    // 실행 버튼
    $('#runBtn').addEventListener('click', run);

    // 필터
    const savedFilters = load('sr_filters', STATE.filters);
    STATE.filters = Object.assign({}, STATE.filters, savedFilters);
    $('#fMinER').value = STATE.filters.minER;
    $('#fMinVMult').value = STATE.filters.minVMult;
    $('#fMinGrade').value = STATE.filters.minGrade;
    $('#saveFilters').addEventListener('click', ()=>{
      STATE.filters = { minER: +$('#fMinER').value || 0, minVMult: +$('#fMinVMult').value || 0, minGrade: $('#fMinGrade').value || 'ALL' };
      save('sr_filters', STATE.filters);
      renderTable();
    });
    $('#resetFilters').addEventListener('click', ()=>{
      STATE.filters = {minER:0, minVMult:0, minGrade:'ALL'};
      save('sr_filters', STATE.filters);
      $('#fMinER').value=0; $('#fMinVMult').value=0; $('#fMinGrade').value='ALL';
      renderTable();
    });

    // 정렬/열토글/프리셋
    buildColControls();
    applyColumnVisibility();
    bindSidebars();

    // Export
    $('#btnExportCsv').addEventListener('click', exportCsv);
    $('#btnExportJson').addEventListener('click', exportJson);

    // 초기화
    $('#btnReset').addEventListener('click', ()=>{
      if(!confirm('모든 로컬 저장소(키/설정/워치리스트)를 초기화할까요?')) return;
      ['yt_api_key','sr_cols','sr_sortKey','sr_sortDir','sr_filters','sr_quota','sr_watchlist','sr_snapshots'].forEach(k=> localStorage.removeItem(k));
      location.reload();
    });
  }

  init();
})();
</script>
</body>
</html>
