<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shorts Radar — 개인용 유튜브 쇼츠 레이더</title>
  <style>
    :root { --bg:#0b1116; --card:#101922; --muted:#7a8a9a; --text:#e8f0f7; --accent:#62d26f; --accent2:#6aa7ff; --warn:#ffb84d; }
    html,body{height:100%;}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Pretendard,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px 56px}
    h1{font-weight:800;letter-spacing:-.5px;font-size:26px;margin:0 0 14px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:18px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .card{background:linear-gradient(180deg,#0f1821,#0a1118);border:1px solid #1e2a36;border-radius:14px;padding:14px 14px 16px;box-shadow:0 8px 22px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea,button{border-radius:10px;border:1px solid #2a3a4a;background:#0c141c;color:var(--text);padding:10px 12px;font-size:14px}
    input::placeholder,textarea::placeholder{color:#6b7b8b}
    input[readonly]{opacity:.8}
    button{cursor:pointer;background:#152332;border:1px solid #274156}
    button.primary{background:linear-gradient(180deg,#2a6fff,#2461e6);border:0}
    button.ghost{background:transparent;border:1px dashed #2d3b49}
    button.danger{background:#4b1c16;border:1px solid #6b2c24}
    .hint{color:var(--muted);font-size:12px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .pill{background:#0f1620;border:1px solid #1f2a36;border-radius:999px;padding:8px 12px;font-size:12px;color:#b9c7d6}
    .tag{display:inline-block;background:#0e1620;border:1px solid #213142;border-radius:999px;padding:4px 8px;margin:2px;color:#a8b9cc;font-size:12px}
    .muted{color:#9fb0bf}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #1e2a36;text-align:left;font-size:13px}
    .table th{color:#a5b6c6;font-weight:600}
    .badge{padding:4px 8px;border-radius:999px;background:#0e1b29;border:1px solid #23374a;font-size:11px}
    .good{color:#b9ffd0}
    .warn{color:var(--warn)}
    .cluster{display:flex;gap:12px;align-items:flex-start}
    .thumb{width:120px;height:68px;background:#111;border:1px solid #253444;border-radius:10px;object-fit:cover}
    .footer{position:fixed;left:0;right:0;bottom:0;background:rgba(9,14,20,.9);border-top:1px solid #1e2a36;padding:10px 16px;display:flex;gap:8px;align-items:center;justify-content:center}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .small{font-size:12px}
    .hero{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    @media (max-width:900px){.grid.cols-3{grid-template-columns:1fr}.grid.cols-2{grid-template-columns:1fr}.thumb{width:96px;height:54px}}
      /* Heatmap styles */
    .hm{font-size:11px}
    .hm .row{display:flex;align-items:center;gap:4px;margin:2px 0}
    .hm .label{width:18px;color:#8fa4b8;text-align:right;margin-right:6px}
    .hm .cell{width:18px;height:18px;border-radius:4px;border:1px solid #213142;background:#0e1620}
    .hm .legend{display:flex;align-items:center;gap:6px;margin-top:6px}
    .hm .legend .box{width:18px;height:18px;border-radius:4px;border:1px solid #213142}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div>
        <h1>Shorts Radar <span class="muted">— "많은 사람들이 본 것과 비슷한 쇼츠" 탐지기</span></h1>
        <div class="sub">키워드·채널 기준으로 최근 쇼츠를 수집하고 <b>속도</b>(조회/시간), <b>반응</b>(좋아요·댓글), <b>신선도</b>(최근성), <b>주제적합</b>을 합쳐 <b>종합점수</b>로 정렬합니다. 비슷한 주제의 영상들을 <b>묶음</b>으로 보여주고, 바로 쓰는 <b>샷리스트/첫문장/해시태그</b>를 제안합니다.</div>
      </div>
      <div class="row">
        <button id="exportCsv" class="ghost">CSV 내보내기</button>
        <button id="exportManual" class="ghost">사용법 내보내기(MD)</button>
        <button id="resetBtn" class="danger">초기화</button>
      </div>
    </div>

    <!-- API & 검색 설정 -->
    <div class="grid cols-2">
      <div class="card">
        <h3 style="margin:0 0 8px">1) 연결 설정</h3>
        <div class="row" style="gap:8px">
          <label for="apiKey" class="sr-only">API Key</label>
          <input id="apiKey" placeholder="YouTube Data API 키 붙여넣기" style="min-width:300px" />
          <button id="saveKey" class="primary">키 저장</button>
          <span class="hint">* GCP 콘솔에서 HTTP referrer(본인 GitHub Pages 도메인) 제한을 꼭 설정하세요.</span>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">2) 찾을 조건</h3>
        <div class="row" style="gap:8px">
          <input id="keywords" placeholder="찾을 주제(예: 정치풍자, 고양이 모래매트)" style="flex:1" />
          <input id="channels" placeholder="경쟁 채널 ID들(쉼표로 구분 · 선택)" style="flex:1" />
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <select id="presetSelect" style="min-width:220px"></select>
          <button id="presetLoad" class="ghost">설정 불러오기</button>
          <button id="presetSave" class="ghost">현재 입력 저장</button>
          <button id="presetDel" class="danger">삭제</button>
          <span class="hint">* 내 브라우저(로컬)에 저장됩니다.</span>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <select id="days">
            <option value="3">최근 3일</option>
            <option value="7" selected>최근 7일</option>
            <option value="14">최근 14일</option>
          </select>
          <select id="region" title="지역 힌트: 선택한 국가 이용자에게 보일 확률을 높이는 랭킹 가중치입니다. 강제 필터가 아니며 채널을 지정하면 영향이 작습니다.">
            <option value="KR" selected>KR</option>
            <option value="US">US</option>
            <option value="JP">JP</option>
            <option value="GB">GB</option>
          </select>
          <select id="lang" title="언어 힌트: 선택한 언어(예: ko)와 관련성 높은 결과를 우대하는 랭킹 가중치입니다. 강제 필터가 아닙니다.">
            <option value="ko" selected>ko</option>
            <option value="en">en</option>
            <option value="ja">ja</option>
          </select>
          <input id="maxResults" type="number" min="10" max="200" value="80" style="width:120px" />
          <button id="runBtn" class="primary">찾기 시작</button>
        </div>
        <div class="hint" style="margin-top:8px">* 채널 ID는 유튜브 채널 URL의 <span class=\"mono\">/channel/UC…</span> 부분입니다. 비워두면 주제(키워드)만으로 찾습니다. · <b>지역/언어</b>는 <b>검색 힌트(랭킹 가중치)</b>로, 결과를 강제로 필터링하지 않으며 채널을 지정하면 영향이 작습니다.</div>
      </div>
    </div>

    <!-- KPI 요약 -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">요약</h3>
      <div id="summary" class="kpi"></div>
    </div>

    <!-- 클러스터 보드 -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">비슷한 주제 묶음</h3>
        <div class="row">
          <label>최소 종합점수</label>
          <input id="minRank" type="number" value="0" step="0.01" style="width:100px" />
          <label>묶음 개수(k)</label>
          <input id="kValue" type="number" min="1" max="20" value="0" style="width:80px" title="0이면 자동(√N)" />
          <button id="recluster" class="ghost">다시 묶기</button>
        </div>
      </div>
      <div id="clusters" class="grid cols-2" style="margin-top:8px"></div>
    </div>

    <!-- 올리기 좋은 시간대 (시간대 지도) -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">올리기 좋은 시간대 (시간대 지도)</h3>
        <span class="hint">로컬 시간 기준 · PickRank 가중치</span>
      </div>
      <div class="grid cols-2" style="margin-top:8px">
        <div id="heatmap" class="hm"></div>
        <div>
          <b>추천 Top 시간대</b>
          <ol id="bestTimes" style="margin-top:6px"></ol>
          <div class="hint" style="margin-top:8px">* 데이터가 적으면 기간을 14일로 넓혀 보세요.</div>
        </div>
      </div>
    </div>

    <!-- 영상 테이블 -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">영상 리스트</h3>
      <div id="colControls" class="row" style="gap:8px; margin:6px 0 8px; align-items:center; flex-wrap:wrap"></div>
      <table class="table" id="table">
        <thead>
          <tr>
            <th>썸네일</th>
            <th>제목</th>
            <th>채널</th>
            <th>길이</th>
            <th>조회</th>
            <th>좋아요</th>
            <th>댓글</th>
            <th>속도</th>
            <th>반응</th>
            <th>신선도</th>
            <th>주제적합</th>
            <th>종합점수</th>
            <th>묶음</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- 비슷하게 만들기 도우미 -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">비슷하게 만들기 도우미</h3>
        <div class="row"><label>묶음 번호</label><input id="wizCluster" type="number" value="0" style="width:80px"/><button id="runWizard" class="ghost">생성</button></div>
      </div>
      <div id="wizardOut" class="grid cols-2" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="footer small">
    <span>Tip: <b>종합점수</b>가 높은 순으로 오늘 바로 따라 만들 주제를 고르세요. — <span class="muted">속도(조회/시간)·반응(좋아요/댓글)·신선도·주제적합</span>을 합쳐 계산합니다.</span>
  </div>

<script>
(function(){
  // --- Utilities ---
  const $ = sel => document.querySelector(sel);
  const now = () => new Date();
  const hoursSince = iso => (now() - new Date(iso)) / 36e5;
  const fmt = n => n?.toLocaleString('en-US') ?? '-';
  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));

  const stopwords = new Set("이 그 저 데 는 은 는 을 를 와 과 도 의 에 로 으로 한 하는 했다 하기 하며 또는 그리고 그러나 그래서 부터 까지 보다 보다도 및 등 더 것 같은 이런 저런 뭐 왜 또 좀 아주 보다처럼 경우 대한 위한 위한것 같은것 누구 무엇 어디 어떻게 그렇지만 모두 너무 정말 지금 아주 매우 그냥 서로 다시 또한 또한만 약간 만큼 만큼의 라는 라고 으로서 으로써 때문 때문인 듯 듯이 함께 대해 대한 또한또 다른 이런저런 했다가 하다가 된다 했다면 까지도 뿐만 아니라 including with the a an to of for in on at as is are be this that those these from by and or but so very much more less only just than then when where who what how why while into onto about over under again still really".split(/\s+/));
  function tokenize(text=""){
    const t = (text||"")
      .toLowerCase()
      .replace(/[\p{P}\p{S}]/gu,' ')
      .split(/\s+/)
      .filter(w=>w && !stopwords.has(w) && w.length>1);
    return t;
  }

  function uniq(arr){return [...new Set(arr)];}

  function cosine(a,b){
    let dot=0,na=0,nb=0;
    const keys = new Set([...Object.keys(a),...Object.keys(b)]);
    keys.forEach(k=>{ const va=a[k]||0,vb=b[k]||0; dot+=va*vb; na+=va*va; nb+=vb*vb;});
    return dot/(Math.sqrt(na)*Math.sqrt(nb)||1);
  }

  function tf(tokens){
    const m={}; tokens.forEach(w=>m[w]=(m[w]||0)+1);
    const n = tokens.length||1; Object.keys(m).forEach(k=>m[k]/=n);
    return m;
  }

  function idf(docs){
    const df={}; const N=docs.length||1;
    docs.forEach(doc=>uniq(Object.keys(doc)).forEach(k=>{df[k]=(df[k]||0)+1;}));
    const idf={}; Object.keys(df).forEach(k=>idf[k]=Math.log(1+N/(df[k]))+1);
    return idf;
  }

  function tfidf(tfMap,idfMap){
    const v={}; Object.keys(tfMap).forEach(k=>v[k]=tfMap[k]*(idfMap[k]||1));
    return v;
  }

  function topKeywords(vec, n=6){
    return Object.entries(vec).sort((a,b)=>b[1]-a[1]).slice(0,n).map(x=>x[0]);
  }

  function expDecay(hours, tau=48){ return Math.exp(-hours/ tau); }

  // k-means on sparse TF-IDF vectors
  function kmeans(vectors, k, maxIter=20){
    const n = vectors.length; if(n===0) return {labels:[],centroids:[]};
    k = Math.max(1, Math.min(k, n));
    const keys = uniq(vectors.flatMap(v=>Object.keys(v)));
    function dist(a,b){ // cosine distance
      return 1 - cosine(a,b);
    }
    // init: pick k random
    const idxs=uniq([...Array(n).keys()].sort(()=>Math.random()-0.5)).slice(0,k);
    let centroids = idxs.map(i=>Object.assign({}, vectors[i]));
    let labels = new Array(n).fill(0);

    for(let iter=0; iter<maxIter; iter++){
      // assign
      let changed=false;
      for(let i=0;i<n;i++){
        let best=0,bestd=Infinity;
        for(let c=0;c<k;c++){
          const d=dist(vectors[i],centroids[c]);
          if(d<bestd){bestd=d;best=c}
        }
        if(labels[i]!==best){labels[i]=best;changed=true}
      }
      if(!changed) break;
      // update
      const sums=Array.from({length:k},()=>({}));
      const counts=new Array(k).fill(0);
      for(let i=0;i<n;i++){
        const c=labels[i]; counts[c]++;
        for(const [key,val] of Object.entries(vectors[i])){
          sums[c][key]=(sums[c][key]||0)+val;
        }
      }
      for(let c=0;c<k;c++){
        const v={}; const cnt=Math.max(1,counts[c]);
        for(const [key,val] of Object.entries(sums[c])) v[key]=val/cnt;
        centroids[c]=v;
      }
    }
    return {labels,centroids};
  }

  // --- App State ---
  let STATE = { videos:[], clusters:[], idf:null, vectors:[], topicVec:{}, labels:[] };

  function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
  function load(key,def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def; }catch(e){return def}}

  // --- API ---
  async function ytSearch({q, channelId, publishedAfter, regionCode, maxResults, key, pageToken}){
    const params = new URLSearchParams({
      part:'snippet', q, maxResults:String(Math.min(50, maxResults||50)), type:'video',
      order:'date', publishedAfter, regionCode, relevanceLanguage: $('#lang').value||'ko',
      key
    });
    if(channelId) params.set('channelId', channelId);
    if(pageToken) params.set('pageToken', pageToken);
    const url = `https://www.googleapis.com/youtube/v3/search?${params.toString()}`;
    const res = await fetch(url); if(!res.ok) throw new Error('search '+res.status);
    return res.json();
  }

  async function ytVideos(ids,key){
    const params = new URLSearchParams({ part:'snippet,contentDetails,statistics', id: ids.join(','), key });
    const url = `https://www.googleapis.com/youtube/v3/videos?${params.toString()}`;
    const res = await fetch(url); if(!res.ok) throw new Error('videos '+res.status);
    return res.json();
  }

  function isShort(snippet, contentDetails){
    // duration like PT45S or PT1M0S
    const m = (contentDetails?.duration||'').match(/PT(?:(\d+)M)?(?:(\d+)S)?/);
    const sec = (m? (Number(m[1]||0)*60 + Number(m[2]||0)) : 0);
    const hastag = (snippet?.title+" "+snippet?.description)?.toLowerCase().includes('#shorts');
    return sec>0 ? (sec<=62) : hastag; // allow a little margin
  }

  function buildTopicVec(input){ return tf(tokenize(input)); }

  function calcMetrics(v, topicVec){
    const hours = hoursSince(v.snippet.publishedAt);
    const views = Number(v.statistics.viewCount||0);
    const likes = Number(v.statistics.likeCount||0);
    const comments = Number(v.statistics.commentCount||0);
    const vel = views / Math.max(1, hours); // views per hour
    const eng = (likes + 5*comments) / Math.max(1, views) * 1000; // per 1000 views
    const fresh = expDecay(hours, 48);
    const text = `${v.snippet.title||''} ${v.snippet.description||''} ${(v.snippet.tags||[]).join(' ')}`;
    const tfMap = tf(tokenize(text));
    const fit = cosine(tfidf(tfMap, STATE.idf||{}), topicVec);
    // Final PickRank
    const pick = Math.pow(vel,0.5) * Math.pow(Math.max(eng,0),0.3) * Math.pow(fresh,0.2) * Math.max(fit,0.0001);
    return {vel,eng,fresh,fit,pick, tfMap};
  }

  function hoursToHMS(sec){
    const h = Math.floor(sec/3600); const m = Math.floor((sec%3600)/60); const s = Math.floor(sec%60);
    return (h? h+':':'')+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
  }

  function isoToSeconds(dur){
    const m = (dur||'').match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
    return (m? (Number(m[1]||0)*3600 + Number(m[2]||0)*60 + Number(m[3]||0)) : 0);
  }

  // Rendering helpers
  function setSummary(videos){
    const n = videos.length;
    const shorts = videos.filter(v=>v._isShort).length;
    const top = [...videos].sort((a,b)=>b.metrics.pick - a.metrics.pick).slice(0,5);
    const avg = (arr,fn)=> arr.reduce((s,x)=>s+fn(x),0)/Math.max(1,arr.length);
    const pills = [
      `<span class="pill">총 수집 <b>${n}</b> (쇼츠 ${shorts})</span>`,
      `<span class="pill">평균 속도 <b>${avg(videos,x=>x.metrics.vel).toFixed(1)}</b></span>`,
      `<span class="pill">평균 반응 <b>${avg(videos,x=>x.metrics.eng).toFixed(2)}</b></span>`,
      `<span class="pill">종합점수 1위 제목: <b>${(top[0]?.snippet?.title||'-').slice(0,40)}</b></span>`
    ];
    $('#summary').innerHTML = pills.join(' ');
  }

  function renderTable(videos){
    const tb = $('#tbody'); tb.innerHTML='';
    const key = STATE.sortKey || 'pick';
    const asc = (STATE.sortDir || 'desc')==='asc';
    videos.sort((a,b)=>{ const av=getSortValue(a,key); const bv=getSortValue(b,key); return asc? (av-bv):(bv-av); });
    for(const v of videos){
      const sec = isoToSeconds(v.contentDetails.duration);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="c-thumb"><a href="https://www.youtube.com/watch?v=${v.id}" target="_blank"><img class="thumb" src="${v.snippet.thumbnails?.medium?.url||''}"/></a></td>
        <td class="c-title">${escapeHtml(v.snippet.title||'')}</td>
        <td class="c-channel small">${escapeHtml(v.snippet.channelTitle||'')}</td>
        <td class="c-length">${hoursToHMS(sec)}</td>
        <td class="c-views">${fmt(v.statistics.viewCount)}</td>
        <td class="c-likes">${fmt(v.statistics.likeCount)}</td>
        <td class="c-comments">${fmt(v.statistics.commentCount)}</td>
        <td class="c-vel">${v.metrics.vel.toFixed(1)}</td>
        <td class="c-eng">${v.metrics.eng.toFixed(2)}</td>
        <td class="c-fresh">${v.metrics.fresh.toFixed(2)}</td>
        <td class="c-fit">${v.metrics.fit.toFixed(2)}</td>
        <td class="c-pick"><b class="good">${v.metrics.pick.toFixed(2)}</b></td>
        <td class="c-cluster"><span class="badge">${v.clusterId ?? '-'}</span></td>`;
      tb.appendChild(tr);
    }
  }

  function renderClusters(state){
    const el = $('#clusters'); el.innerHTML='';
    const groups = {};
    state.videos.forEach(v=>{ const id=v.clusterId??0; (groups[id]=groups[id]||[]).push(v); });
    const entries = Object.entries(groups).sort((a,b)=> avgRank(b[1]) - avgRank(a[1]));

    for(const [cid, arr] of entries){
      if(arr.length===0) continue;
      const rep = [...arr].sort((a,b)=>b.metrics.pick - a.metrics.pick)[0];
      const keys = topKeywords(state.centroids[cid]||{}, 8);
      const card = document.createElement('div');
      card.className='card cluster';
      card.innerHTML = `
        <img class="thumb" src="${rep?.snippet?.thumbnails?.medium?.url||''}"/>
        <div>
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div><b>묶음 ${cid}</b> · <span class="muted">${arr.length}개</span></div>
            <div class="badge">평균 종합점수 ${avgRank(arr).toFixed(2)}</div>
          </div>
          <div style="margin:6px 0 2px">${keys.map(k=>`<span class="tag">${escapeHtml(k)}</span>`).join('')}</div>
          <div class="hint">대표: ${(rep?.snippet?.title||'').slice(0,80)}</div>
        </div>`;
      el.appendChild(card);
    }
  }

  function avgRank(arr){ return arr.reduce((s,x)=>s+(x.metrics?.pick||0),0)/Math.max(1,arr.length); }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

  // Presets & Heatmap helpers
  const dayOrder = [1,2,3,4,5,6,0]; // 월~일 순서
  const dayNames = ['일','월','화','수','목','금','토'];
  const BUILTIN_PRESETS = [
    {name:'정치드립(시사풍자)', keywords:'정치풍자, 시사 요약, 밈', channels:''},
    {name:'BrotLab 베이킹', keywords:'사워도우, 발효빵, 베이킹 팁', channels:''},
    {name:'Paw Chu 반려동물', keywords:'고양이, 반려동물, 모래매트, 집사 팁', channels:''}
  ];
  function getPresets(){ let p = load('sr_presets', null); if(!p){ p = BUILTIN_PRESETS; save('sr_presets', p);} return p; }
  function setPresets(p){ save('sr_presets', p); }
  function initPresetsUI(){ const sel = $('#presetSelect'); if(!sel) return; const list=getPresets(); sel.innerHTML=list.map((p,i)=>`<option value="${i}">${escapeHtml(p.name)}</option>`).join(''); }
  function formatHour(h){ return String(h).padStart(2,'0')+':00'; }
  function colorFor(val,max){ const n = max>0? (val/max) : 0; const l = 16 + n*48; return `hsl(210,80%,${l}%)`; }
  function renderHeatmap(videos){
    const grid = Array.from({length:7},()=>Array(24).fill(0));
    videos.forEach(v=>{ const d=new Date(v.snippet.publishedAt); const dow=d.getDay(); const h=d.getHours(); const w=Math.max(0, v.metrics?.pick||0); grid[dow][h]+=w; });
    let max=0; for(let d=0;d<7;d++){ for(let h=0;h<24;h++){ if(grid[d][h]>max) max=grid[d][h]; }}
    const hm = $('#heatmap'); if(!hm) return; let html='';
    // header hours
    html += `<div class="row"><span class="label"></span>${[...Array(24).keys()].map(h=>`<span class="small" style="width:18px;text-align:center;color:#8fa4b8">${h%6===0?h:''}</span>`).join('')}</div>`;
    for(const d of dayOrder){
      html += `<div class="row"><span class="label">${dayNames[d]}</span>`;
      for(let h=0;h<24;h++){
        const v = grid[d][h]; const clr = colorFor(v,max);
        html += `<span class="cell" title="${dayNames[d]} ${formatHour(h)} · ${v.toFixed(2)}" style="background:${clr}"></span>`;
      }
      html += `</div>`;
    }
    // legend
    html += `<div class="legend"><span class="small muted">낮음</span><span class="box" style="background:${colorFor(0,max)}"></span><span class="box" style="background:${colorFor(max*0.5,max)}"></span><span class="box" style="background:${colorFor(max,max)}"></span><span class="small muted">높음</span></div>`;
    hm.innerHTML = html;

    // Top times
    const arr=[]; for(let d=0;d<7;d++){ for(let h=0;h<24;h++){ arr.push({d,h,score:grid[d][h]}); }}
    arr.sort((a,b)=>b.score-a.score);
    const top = arr.filter(x=>x.score>0).slice(0,6);
    const best = $('#bestTimes'); if(best) best.innerHTML = top.map(t=>`<li>${dayNames[t.d]} ${formatHour(t.h)}–${formatHour((t.h+1)%24)} · 지수 ${t.score.toFixed(2)}</li>`).join('');
  }

  // Table controls (column visibility & sorting)
  const COLS = [
    {key:'thumb', label:'썸네일'},
    {key:'title', label:'제목'},
    {key:'channel', label:'채널'},
    {key:'length', label:'길이'},
    {key:'views', label:'조회'},
    {key:'likes', label:'좋아요'},
    {key:'comments', label:'댓글'},
    {key:'vel', label:'속도'},
    {key:'eng', label:'반응'},
    {key:'fresh', label:'신선도'},
    {key:'fit', label:'주제적합'},
    {key:'pick', label:'종합점수'},
    {key:'cluster', label:'묶음'},
  ];
  function defaultColVis(){ const m={}; COLS.forEach(c=>m[c.key]=true); return m; }
  function ensureHeaderClasses(){ const ths=document.querySelectorAll('#table thead th'); COLS.forEach((c,i)=>{ if(ths[i]) ths[i].classList.add('c-'+c.key); }); }
  function applyColumnVisibility(){ const vis = STATE.colVis || load('sr_cols', null) || defaultColVis(); COLS.forEach(c=>{ document.querySelectorAll('.c-'+c.key).forEach(el=>{ el.style.display = vis[c.key] ? '' : 'none'; }); }); }
  function getSortValue(v,key){
    switch(key){
      case 'views': return Number(v.statistics.viewCount||0);
      case 'likes': return Number(v.statistics.likeCount||0);
      case 'comments': return Number(v.statistics.commentCount||0);
      case 'vel': return Number(v.metrics?.vel||0);
      case 'eng': return Number(v.metrics?.eng||0);
      case 'fresh': return Number(v.metrics?.fresh||0);
      case 'fit': return Number(v.metrics?.fit||0);
      case 'length': return isoToSeconds(v.contentDetails?.duration||'PT0S');
      case 'pick': default: return Number(v.metrics?.pick||0);
    }
  }
  function buildColControls(){
    if(!STATE.colVis) STATE.colVis = load('sr_cols', null) || defaultColVis();
    if(!STATE.sortKey) STATE.sortKey = load('sr_sortKey', null) || 'pick';
    if(!STATE.sortDir) STATE.sortDir = load('sr_sortDir', null) || 'desc';
    const holder = $('#colControls'); if(!holder) return;
    const labels = Object.fromEntries(COLS.map(c=>[c.key,c.label]));
    holder.innerHTML = `
      <label>보기 프리셋</label>
      <select id="viewPreset">
        <option value="all">전체(기본)</option>
        <option value="speedeng">속도·반응만</option>
        <option value="metrics">지표만(속도/반응/신선도/적합/종합)</option>
        <option value="simple">간단(제목/종합점수)</option>
      </select>
      <label>정렬</label>
      <select id="sortKey"></select>
      <select id="sortDir"><option value="desc">내림차순</option><option value="asc">오름차순</option></select>
      <div id="colToggles" class="row" style="gap:6px"></div>`;
    // sortKey options
    const sortKeys=['pick','vel','eng','fresh','fit','views','likes','comments','length'];
    const sk = $('#sortKey'); sortKeys.forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=labels[k]||k; sk.appendChild(o); });
    sk.value = STATE.sortKey; $('#sortDir').value = STATE.sortDir;
    // checkboxes
    const box=$('#colToggles'); box.innerHTML='';
    COLS.forEach(c=>{ const id='vis_'+c.key; const lbl=document.createElement('label'); lbl.className='small'; lbl.style.display='flex'; lbl.style.alignItems='center'; lbl.style.gap='6px'; lbl.innerHTML=`<input type="checkbox" id="${id}" ${STATE.colVis[c.key]?'checked':''}/> ${c.label}`; box.appendChild(lbl); document.getElementById(id).addEventListener('change',()=>{ STATE.colVis[c.key]=document.getElementById(id).checked; save('sr_cols', STATE.colVis); applyColumnVisibility(); }); });
    // preset
    $('#viewPreset').addEventListener('change',()=>{
      const p = $('#viewPreset').value; const vis=defaultColVis(); Object.keys(vis).forEach(k=>vis[k]=true);
      if(p==='speedeng'){ Object.keys(vis).forEach(k=>vis[k]=false); ['thumb','title','vel','eng','pick'].forEach(k=>vis[k]=true); }
      else if(p==='metrics'){ Object.keys(vis).forEach(k=>vis[k]=false); ['vel','eng','fresh','fit','pick'].forEach(k=>vis[k]=true); }
      else if(p==='simple'){ Object.keys(vis).forEach(k=>vis[k]=false); ['thumb','title','pick'].forEach(k=>vis[k]=true); }
      STATE.colVis=vis; save('sr_cols', vis);
      COLS.forEach(c=>{ const chk=document.getElementById('vis_'+c.key); if(chk) chk.checked=!!vis[c.key]; });
      applyColumnVisibility();
    });
    // sort change
    sk.addEventListener('change',()=>{ STATE.sortKey=sk.value; save('sr_sortKey', STATE.sortKey); renderTable(STATE.videos); applyColumnVisibility(); });
    $('#sortDir').addEventListener('change',()=>{ STATE.sortDir=$('#sortDir').value; save('sr_sortDir', STATE.sortDir); renderTable(STATE.videos); applyColumnVisibility(); });
  }

  // Wizard
  function runWizard(clusterId){
    const group = STATE.videos.filter(v=>v.clusterId===clusterId);
    const out = $('#wizardOut'); out.innerHTML='';
    if(group.length===0){ out.innerHTML='<div class="hint">해당 묶음이 비어 있습니다.</div>'; return; }
    const rep = [...group].sort((a,b)=>b.metrics.pick - a.metrics.pick)[0];
    const keys = topKeywords(STATE.centroids[clusterId]||{}, 8);

    const hooks = [
      `딱 10초로 끝내는 ${keys[0]||'핵심'} 요약`,
      `댓글 폭발한 ${keys[1]||'장면'}, 3초 리메이크`,
      `${keys[2]||'논란'} 한 문장, 앞뒤 맥락은?`
    ];

    const shotlist = [
      '0–2s: 강렬한 썸네일 텍스트 + 효과음',
      `3–8s: ${keys[0]||'핵심요소'} 장면 클립/밈`,
      `9–15s: 대비 장면/팩트 1`,
      `16–22s: 반전 장면/팩트 2`,
      '23–27s: 요약 한 문장(자막 크게)',
      '28–30s: 구독/팔로우 CTA + 다음 편 예고'
    ];

    const hashtags = ['#shorts','#trending', ...keys.slice(0,4).map(k=>'#'+k)].join(' ');

    const left = document.createElement('div'); left.className='card';
    left.innerHTML = `<b>훅(Hooks) 3안</b><ul>${hooks.map(h=>`<li>${escapeHtml(h)}</li>`).join('')}</ul>`;
    const right = document.createElement('div'); right.className='card';
    right.innerHTML = `<b>샷리스트(30초)</b><ol>${shotlist.map(s=>`<li>${escapeHtml(s)}</li>`).join('')}</ol><div style="margin-top:6px"><b>해시태그:</b> <span class="muted">${escapeHtml(hashtags)}</span></div>`;
    out.append(left,right);
  }

  
  <script>
// CSV Export (fixed)
function exportCsv(){
  if(!STATE.videos.length) return alert('데이터가 없습니다.');
  const cols = ['id','title','channel','publishedAt','durationSec','views','likes','comments','vel','eng','fresh','fit','pick','clusterId'];
  const rows = [cols.join(',')];
  for(const v of STATE.videos){
    const sec = isoToSeconds(v.contentDetails.duration || 'PT0S');
    const title   = '"' + String(v.snippet.title||'').replace(/"/g,'""') + '"';
    const channel = '"' + String(v.snippet.channelTitle||'').replace(/"/g,'""') + '"';
    rows.push([
      v.id, title, channel, v.snippet.publishedAt, sec,
      v.statistics.viewCount||0, v.statistics.likeCount||0, v.statistics.commentCount||0,
      (v.metrics?.vel||0).toFixed(3), (v.metrics?.eng||0).toFixed(3),
      (v.metrics?.fresh||0).toFixed(5), (v.metrics?.fit||0).toFixed(5),
      (v.metrics?.pick||0).toFixed(5), v.clusterId??''
    ].join(','));
  }
  const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'shorts_radar.csv';
  document.body.appendChild(a); a.click(); a.remove();
}

 <script>
// Manual Export (fixed)
function exportManual(){
  const date = new Date().toLocaleDateString('ko-KR');
  const md = [
    '# Shorts Radar 사용 매뉴얼 (한 장 요약)',
    '생성일: '+date, '',
    '## 1) 내가 할 일 (처음 1회 설정)',
    '- API 키 발급: Google Cloud → YouTube Data API v3 활성화 → API Key 생성',
    "- 키 보호: Application restrictions = HTTP referrers(웹사이트) → 'https://USERNAME.github.io/*' 추가",
    '- 배포: GitHub Pages (리포에 index.html 업로드 → Settings → Pages → main/root 저장)',
    '- 첫 실행: 페이지 접속 → 1) 연결 설정에서 API 키 저장 → 2) 찾을 조건 입력 → 찾기 시작', '',
    '## 2) 매일 할 일 (5~10분 루틴)',
    '- 자주 쓰는 설정 불러오기 → 찾기 시작',
    '- 비슷한 주제 묶음에서 평균 종합점수 높은 1~2개 선택',
    '- 비슷하게 만들기 도우미에서 묶음 번호 입력 → 생성 (훅 3안 + 샷리스트 + 해시태그)',
    '- 올리기 좋은 시간대(시간대 지도) 확인 → 업로드/예약',
    '- 필요 시 CSV 내보내기로 기록/공유', '',
    '## 3) 화면별 사용법',
    '- 연결 설정: API 키 저장(로컬 보관)',
    '- 찾을 조건: 찾을 주제, 경쟁 채널 ID(쉼표로 여러 개), 기간/지역/언어/최대 결과, 자주 쓰는 설정(불러오기/저장/삭제)',
    '- 요약: 총 수집, 평균 속도/반응, 종합점수 1위 제목',
    '- 비슷한 주제 묶음: 묶음 N, 평균 종합점수, 핵심 키워드. 최소 종합점수·묶음 개수(k) 조정 후 다시 묶기',
    '- 올리기 좋은 시간대: 7×24 히트맵 + 추천 Top 시간대 목록',
    '- 영상 리스트: 열 숨김/정렬 컨트롤(보기 프리셋, 정렬 기준/방향, 개별 열 토글) — 설정은 브라우저에 저장',
    '- 비슷하게 만들기 도우미: 묶음 번호 → 훅 3안/샷리스트/해시태그 생성',
    '- CSV 내보내기: 결과를 파일로 저장', '',
    '## 4) 추천 설정값 & 치트시트',
    '- 시작값: 기간 7일, 최대 결과 80, 묶음 개수 0(자동)',
    '- 노이즈 많음: 최소 종합점수 0.1→0.2→0.3',
    '- 묶음이 너무 큼: k를 8~12로 지정 후 다시 묶기',
    '- 트렌드 빠름: 기간 3일로 축소', '',
    '## 5) 문제 해결',
    "- 403(referrer): 키 제한에 정확한 도메인 'https://USERNAME.github.io/*' 포함 여부 확인",
    '- 결과 적음: 기간 7→14일, 키워드 2~3개로 확장, 지역/언어 조정',
    '- 쿼터 부족: 최대 결과 80→40으로 낮춰 나눠 조회',
    '- 쇼츠 아님 섞임: 길이(60~62초) 확인 후 제외', '',
    '## 6) 운영 팁',
    '- 상위 묶음 1~2개만 집중 제작(분산 줄이기)',
    '- 오프닝 2초/자막 크기/썸네일 텍스트 A/B 변주',
    '- 시간대 지도 상위 슬롯에 예약 업로드',
    '- 매주 자주 쓰는 설정에 새 조합 1~2개 추가',
    ''
  ].join('\n');

  const blob = new Blob([md], {type:'text/markdown;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'Shorts_Radar_사용법.md';
  document.body.appendChild(a); a.click(); a.remove();
}


  // Main pipeline
  async function run(){
    try{
      const key = $('#apiKey').value.trim(); if(!key) return alert('API 키를 입력하세요.');
      const q = $('#keywords').value.trim();
      const channels = $('#channels').value.trim().split(',').map(s=>s.trim()).filter(Boolean);
      const days = Number($('#days').value||7);
      const regionCode = $('#region').value || 'KR';
      const maxResults = Number($('#maxResults').value||80);
      const publishedAfter = new Date(Date.now()-days*24*3600*1000).toISOString();

      // 1) 수집
      const items = [];
      async function collectBy(q, channelId){
        let pageToken=null; let fetched=0; const limit=maxResults;
        do{
          const data = await ytSearch({q, channelId, publishedAfter, regionCode, maxResults: Math.min(50, limit-fetched), key, pageToken});
          const vids = (data.items||[]).filter(it=> it.id?.videoId );
          items.push(...vids.map(it=>({id:it.id.videoId, snippet:it.snippet})));
          fetched += vids.length; pageToken = data.nextPageToken && fetched < limit ? data.nextPageToken : null;
        } while(pageToken);
      }
      if(channels.length){ for(const ch of channels) await collectBy(q||'', ch); }
      else await collectBy(q||'', null);

      const ids = uniq(items.map(x=>x.id));
      // 2) 상세
      const videos=[]; for(let i=0;i<ids.length;i+=50){
        const batch = ids.slice(i,i+50);
        const data = await ytVideos(batch, key);
        data.items.forEach(v=>videos.push(v));
      }

      // 3) 필터: 쇼츠만
      const shorts = videos.filter(v=> isShort(v.snippet, v.contentDetails));

      // 4) 텍스트 전처리 & IDF
      const docs = shorts.map(v=> tf(tokenize(`${v.snippet.title||''} ${v.snippet.description||''} ${(v.snippet.tags||[]).join(' ')}`)) );
      STATE.idf = idf(docs);
      STATE.topicVec = buildTopicVec(q);

      // 5) 메트릭 계산
      shorts.forEach(v=>{
        v._isShort = true;
        v.metrics = calcMetrics(v, STATE.topicVec);
      });

      // 6) 벡터 & 클러스터
      const vecs = docs.map(d=> tfidf(d, STATE.idf));
      const kManual = Number($('#kValue').value||0);
      const k = kManual>0? kManual : Math.max(1, Math.round(Math.sqrt(vecs.length||1)));
      const {labels, centroids} = kmeans(vecs, k);
      shorts.forEach((v,i)=> v.clusterId = labels[i]);

      // 7) 최소 랭크 필터
      const minRank = Number($('#minRank').value||0);
      const filtered = shorts.filter(v=> v.metrics.pick >= minRank);

      // 8) 상태 저장 & 렌더
      STATE.videos = filtered; STATE.vectors = vecs; STATE.centroids = centroids; STATE.labels = labels;
      setSummary(filtered);
      renderClusters(STATE);
      renderTable(filtered);
      renderHeatmap(filtered);
      ensureHeaderClasses();
      applyColumnVisibility();

    }catch(e){ console.error(e); alert('오류: '+e.message); }
  }

  // Events
  $('#runBtn').addEventListener('click', run);
  $('#recluster').addEventListener('click', ()=>{
    if(!STATE.videos.length) return alert('데이터가 없습니다.');
    const vecs = STATE.vectors; const kManual = Number($('#kValue').value||0);
    const k = kManual>0? kManual : Math.max(1, Math.round(Math.sqrt(vecs.length||1)));
    const {labels,centroids} = kmeans(vecs,k);
    STATE.videos.forEach((v,i)=> v.clusterId = labels[i]);
    STATE.centroids = centroids; STATE.labels = labels;
    renderClusters(STATE); renderTable(STATE.videos); renderHeatmap(STATE.videos);
    ensureHeaderClasses();
    applyColumnVisibility();
  });

  $('#runWizard').addEventListener('click', ()=>{
    const cid = Number($('#wizCluster').value||0); runWizard(cid);
  });

  $('#saveKey').addEventListener('click', ()=>{ save('yt_api_key', $('#apiKey').value.trim()); alert('저장됨'); });
  $('#exportCsv').addEventListener('click', exportCsv);
  $('#exportManual').addEventListener('click', exportManual);
  $('#resetBtn').addEventListener('click', ()=>{ localStorage.clear(); $('#apiKey').value=''; alert('초기화 완료'); });

  // Preset events
  $('#presetLoad')?.addEventListener('click', ()=>{ const idx=parseInt($('#presetSelect').value||0); const list=getPresets(); const p=list[idx]; if(!p) return; $('#keywords').value=p.keywords||''; $('#channels').value=p.channels||''; });
  $('#presetSave')?.addEventListener('click', ()=>{ const name=prompt('프리셋 이름을 입력하세요'); if(!name) return; const list=getPresets(); list.unshift({name, keywords:$('#keywords').value.trim(), channels:$('#channels').value.trim()}); setPresets(list); initPresetsUI();
  buildColControls();
  buildColControls(); alert('저장 완료'); });
  $('#presetDel')?.addEventListener('click', ()=>{ const sel=$('#presetSelect'); const idx=parseInt(sel.value||0); const list=getPresets(); if(!list[idx]) return; if(!confirm(`'${list[idx].name}' 프리셋을 삭제할까요?`)) return; list.splice(idx,1); setPresets(list); initPresetsUI(); });

  // Restore
  const savedKey = load('yt_api_key',''); if(savedKey) $('#apiKey').value = savedKey;
  initPresetsUI();
})();
</script>
</body>
</html>
