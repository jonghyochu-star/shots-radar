<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shorts Radar - 통합판 v7.4.2</title>
  <link rel="icon" href="data:,">
  <style>
    :root { --bg:#0b1116; --card:#101922; --muted:#7a8a9a; --text:#e8f0f7; --accent:#62d26f; --accent2:#6aa7ff; --warn:#ffb84d; }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Pretendard,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px 84px;position:relative}
    h1{font-weight:800;letter-spacing:-.4px;font-size:26px;margin:0 0 14px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:18px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .card{background:linear-gradient(180deg,#0f1821,#0a1118);border:1px solid #1e2a36;border-radius:14px;padding:14px 14px 16px;box-shadow:0 8px 22px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input,select,button{border-radius:10px;border:1px solid #2a3a4a;background:#0c141c;color:var(--text);padding:9px 11px;font-size:14px}
    input::placeholder{color:#6b7b8b}
    button{cursor:pointer;background:#152332;border:1px solid #274156}
    button.primary{background:linear-gradient(180deg,#2a6fff,#2461e6);border:0}
    button.ghost{background:transparent;border:1px dashed #2d3b49}
    button.danger{background:#4b1c16;border:1px solid #6b2c24}
    .hint{color:var(--muted);font-size:12px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .pill{background:#0f1620;border:1px solid #1f2a36;border-radius:999px;padding:8px 12px;font-size:12px;color:#b9c7d6;cursor:pointer}
    .pill.active{background:#0f2b1a;border-color:#1f4b2a;color:#b9ffd0}
    .pill.blocked{background:#4b1c16;border-color:#6b2c24;color:#ffcab3}
    .table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #1e2a36;text-align:left;font-size:13px}
    th{color:#a5b6c6;font-weight:600;white-space:nowrap}
    #table thead th{position:sticky;top:0;background:#0f1821;z-index:3}
    .thumb{width:120px;height:68px;background:#111;border:1px solid #253444;border-radius:10px;object-fit:cover}
    .badge{padding:4px 8px;border-radius:999px;background:#0e1b29;border:1px solid #23374a;font-size:11px}
    .grade-S{background:#0f2b1a;border-color:#1f4b2a;color:#b9ffd0}
    .grade-A{background:#0e232f;border-color:#214056;color:#bfe7ff}
    .grade-B,.grade-C{background:#121a24;border-color:#223243;color:#c7d4e3}
    .grade-D{background:#151922;border-color:#222838;color:#9aa8b8}
    .good{color:#b9ffd0}
    .warn{color:var(--warn)}
    .qbar{position:relative;height:8px;width:160px;border:1px solid #213142;border-radius:999px;background:#0e1620}
    .qbar .fill{height:100%;border-radius:999px;background:linear-gradient(90deg,#2a6fff,#62d26f)}
    .star{cursor:pointer;font-size:18px;user-select:none}
    .star.on{color:#ffd166}
    .tag{display:inline-block;background:#0e1620;border:1px solid #213142;border-radius:999px;padding:4px 8px;margin:2px;color:#a8b9cc;font-size:12px}
    .tableWrap{max-height:68vh;overflow:auto;border:1px solid #1e2a36;border-radius:12px;position:relative}
    .sideScroll{position:absolute;right:-56px;top:0;display:flex;flex-direction:column;gap:8px;pointer-events:auto}
    .sideScroll button{width:44px;height:36px;border-radius:10px;border:1px solid #2a3a4a;background:#0c141c;color:#e8f0f7;cursor:pointer}
    @media (max-width:1200px){.sideScroll{right:-2px;top:-54px;flex-direction:row}}
    @media (max-width:1000px){.grid.cols-2{grid-template-columns:1fr}.thumb{width:96px;height:54px}}
  
    /* Long Trend Dashboard */
    :root{ --font-ui: 'Pretendard Variable','Inter','Noto Sans KR',system-ui,-apple-system,'Segoe UI',Roboto,'Apple SD Gothic Neo','Malgun Gothic',sans-serif }
    .longdash{background:linear-gradient(180deg,#0f1821,#0a1118);border:1px solid #1e2a36;border-radius:14px;padding:16px;margin-top:12px;margin-bottom:8px;font-family:var(--font-ui)}
    .longdash .ctrls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
    .longdash h3{font-weight:700;letter-spacing:-0.2px;margin:0}
    .longdash .grid{display:grid;grid-template-columns:2fr 1fr;gap:12px;align-items:start}
    @media (max-width:1100px){.longdash .grid{grid-template-columns:1fr}}
    .chart{position:relative;height:420px}
    .longdash .side{position:relative;height:420px}
    .sideOverlay{position:absolute;top:0;left:0;right:0;padding:4px 0 6px 0}
    .sideChart{position:absolute;left:0;right:0;bottom:0;top:86px}
    @media (max-width:1100px){.longdash .side{height:360px}.sideChart{top:90px}}
    .pills{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0 8px 0;max-height:72px;overflow:auto}
    .pill.off{opacity:.45}
    .risers{display:flex;flex-wrap:wrap;gap:8px}
    .risers .pill{background:#10351f;border-color:#1c5a31;color:#c8ffd9}
    .sideHead .title{font-weight:700;font-size:16px;letter-spacing:-0.2px}
    .sideHead .meta{font-size:12px;color:#9fb2c4;letter-spacing:-0.1px}
    .note{background:#1a2330;border:1px solid #2a3a4a;border-radius:8px;padding:8px 12px;margin:8px 0;font-size:12px;color:#9fb2c4}

    /* Channel Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(8,12,18,.72);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal-panel{width:min(980px,92vw);max-height:86vh;overflow:auto;background:linear-gradient(180deg,#0f1821,#0a1118);border:1px solid #1e2a36;border-radius:16px;box-shadow:0 12px 28px rgba(0,0,0,.4);padding:16px 18px;color:#e8f0f7}
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .modal-title{font-weight:800;font-size:18px}
    .modal-close{border-radius:10px;border:1px solid #2a3a4a;background:#0c141c;color:#e8f0f7;cursor:pointer;padding:6px 10px}
    .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0}
    .kpi-card{background:#0f1620;border:1px solid #1f2a36;border-radius:12px;padding:10px}
    .kpi-card b{font-size:18px}
    .best-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:6px}
    .best-card{background:#0f1620;border:1px solid #1f2a36;border-radius:12px;padding:8px;display:flex;gap:8px}
    .best-thumb{width:132px;height:74px;object-fit:cover;border-radius:10px;border:1px solid #223243}
    .meta-row{display:flex;gap:12px;flex-wrap:wrap;color:#a8b9cc;font-size:12px}
    .badge-soft{display:inline-block;padding:4px 8px;border-radius:999px;background:#0e1620;border:1px solid #213142;color:#b9c7d6;cursor:pointer}
    .badge-soft:disabled{opacity:.5;cursor:not-allowed}
    .hr{height:1px;background:#1e2a36;margin:8px 0}
    .rev-box{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .rev-out{font-weight:700}
    .ch-link{all:unset;cursor:pointer;color:#cfe3ff;text-decoration:underline}
    .ch-link:hover{opacity:.9}
    @media (max-width:768px){.kpi-grid{grid-template-columns:repeat(2,1fr)}.best-grid{grid-template-columns:1fr}}
  
    /* v7.4.2 styles */
    #keyState{ display:flex; flex-wrap:wrap; align-items:center; gap:8px; }
    #keyState > *{ margin:0 !important; }
    .quota-flag{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #2a3a4a; background:#0c141c; color:#9fb2c4; }
    .quota-flag.online{ color:#00d084 !important; border-color:#1c3a24 !important; background:#0c1f14 !important; font-weight:700 !important; }
    .quota-flag.offline{ color:#ffb8b8 !important; border-color:#4a1f1f !important; background:#1c0c0c !important; font-weight:700 !important; }
    .snapshot-notice{background:#1a3a2a;border:2px solid #62d26f;margin:12px 0;padding:12px;}
    .category-hint{background:#1a2330;border:1px solid #2a3a4a;border-radius:8px;padding:10px;margin-top:10px;}
    .seedless-notice{background:#1a3a2a;border:2px solid #62d26f;margin:12px 0;padding:12px;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>Shorts Radar — <span style="color:#7a8a9a">통합판</span> <span style='color:#7a8a9a;font-size:12px;margin-left:8px'>v7.4.2</span></h1>
        <div class="sub">라벨 한글화 · S1 확장 지표/필터/정렬 · S2 채널 모달 · S3 장기 트렌드 · Seedless 카테고리 · Excel Export · 워치리스트 스냅샷(Δ24h)</div>
      </div>
      <div class="row">
        <button id="exportXlsx" class="ghost">Excel</button>
        <button id="btnReprobe" class="ghost">워치리스트 재측정</button>
        <button id="resetBtn" class="danger">초기화</button>
      </div>
    </div>

    <!-- API & 검색 설정 -->
    <div class="grid cols-2">
      <div class="card">
        <h3 style="margin:0 0 8px">1) 연결 설정</h3>
        <div class="row" style="gap:8px">
          <input id="apiKey" placeholder="YouTube Data API 키 (쉼표/공백/줄바꿈으로 여러 개 입력 가능)" style="min-width:300px" aria-label="YouTube API Key" autocomplete="off"/>
          <button id="saveKey" class="primary">키 저장</button>
          <span class="hint">* GCP 콘솔에서 HTTP referrer(본인 GitHub Pages 도메인) 제한을 꼭 설정하세요.</span>
        </div>
        <div class="row" style="gap:8px;margin-top:10px">
          <label>일일 한도(유닛)</label>
          <input id="quotaLimit" type="number" min="1000" step="100" value="10000" style="width:120px" aria-label="일일 한도" autocomplete="off"/>
          <button id="quotaApply" class="ghost">적용</button>
          <span id="quotaStat" class="pill">API 사용량(오늘) 0 / 10000 (0%)</span>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <button id="quotaReset" class="ghost">사용량 초기화</button>
          <span id="quotaStateFlag" class="quota-flag online">상태: <b>ONLINE</b></span>
        </div>
        <div id="quotaBar" class="qbar"><div class="fill" style="width:0%"></div></div>
        <!-- 키 회전 상태 표시 -->
        <div id="keyState" class="row" style="gap:6px;margin-top:8px"></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">2) 찾을 조건</h3>
        <div class="row" style="gap:8px">
          <input id="keywords" placeholder="찾을 주제(예: 정치풍자, 고양이 모래매트)" style="flex:1" aria-label="키워드" autocomplete="off"/>
          <input id="channels" placeholder="경쟁 채널 ID들(쉼표로 구분 · 선택)" style="flex:1" aria-label="채널 ID 목록" autocomplete="off"/>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <select id="days">
            <option value="3">최근 3일</option>
            <option value="7" selected>최근 7일</option>
            <option value="14">최근 14일</option>
          </select>
          <select id="region"><option value="KR" selected>KR</option><option value="US">US</option><option value="JP">JP</option><option value="GB">GB</option></select>
          <select id="lang"><option value="ko" selected>ko</option><option value="en">en</option><option value="ja">ja</option></select>
          <input id="maxResults" type="number" min="10" max="200" value="80" style="width:120px" aria-label="결과 개수" autocomplete="off"/>
          <label>길이(초)</label><input id="minSec" type="number" min="0" value="0" style="width:90px" aria-label="최소 길이(초)" autocomplete="off"/>~<input id="maxSec" type="number" min="1" value="62" style="width:90px" aria-label="최대 길이(초)" autocomplete="off"/>
          <button id="runBtn" class="primary">찾기 시작</button>
        </div>
        <div class="category-hint">
          💡 <b>키워드 없이 검색</b>하면 카테고리별 인기 영상을 자동 수집합니다<br>
          📋 카테고리(16개): 음악, 게임, 유머, 동물, 스포츠, 댄스<br>
          📺 연예, 영화, 드라마, AI, 예능, 시니어<br>
          🎯 국뽕, 오피셜, 리뷰, 정치
        </div>
      </div>
    </div>

    <!-- 요약 KPI -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">요약</h3>
      <div id="summary" class="kpi"></div>
    </div>

    <!-- 올리기 좋은 시간대 -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">올리기 좋은 시간대</h3>
        <span class="hint">로컬 시간 기준 · 종합점수 가중치</span>
      </div>
      <div id="bestTimes" class="row" style="margin-top:6px; flex-wrap:wrap"></div>
    </div>

    <!-- S3: 키워드 장기 트렌드 -->
    <div class="longdash" id="longDash">
      <div class="ctrls">
        <h3>키워드 장기 트렌드</h3>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label>지표</label>
          <select id="ltMetric">
            <option value="views">조회 합(일)</option>
            <option value="ema28" selected>EMA28(조회)</option>
            <option value="score">상승력 점수</option>
          </select>
          <label>기간</label>
          <select id="ltDays">
            <option value="90">90일</option>
            <option value="180" selected>180일</option>
          </select>
          <label>최소 표본</label>
          <input id="ltMinN" type="number" min="1" value="10" style="width:90px"/>
          <label><input id="ltSmoothing" type="checkbox" checked/> 스무딩(EMA)</label>
          <button id="ltReload">대시보드 갱신</button>
        </div>
      </div>
      <div class="note">샘플 데이터로 동작합니다. 배포 시 <code>kw-trend.json</code> 엔드포인트로 교체합니다.</div>
      <div class="pills" id="ltPills"></div>
      <div class="grid">
        <div class="main"><div class="chart"><canvas id="ltChart"></canvas></div></div>
        <div class="side">
          <div class="sideOverlay">
            <div class="sideHead">
              <div class="title">상승 키워드 Top5</div>
              <div class="meta">최근 7일 vs 직전 7일 · 업데이트: <span id="ltUpdate"></span></div>
            </div>
            <div class="risers" id="ltRisers"></div>
          </div>
          <div class="sideChart"><canvas id="ltShare"></canvas></div>
        </div>
      </div>
    </div>

    <!-- 데이터 검증 카드 -->
    <div class="card" id="ltValidationCard" style="margin-top:8px">
      <h3 style="margin:0 0 8px">데이터 검증(최근 30일)</h3>
      <div id="ltValidation" class="row" style="flex-wrap:wrap;gap:8px">
        <span class="pill">표본수: -</span>
        <span class="pill">결측 비중: -</span>
        <span class="pill">일 조회합 범위: -</span>
        <span class="pill">사용 키워드: -</span>
        <span class="pill">엔드포인트: <code id="ltEndpoint">-</code></span>
      </div>
    </div>

    <!-- 영상 리스트 -->
    <div class="card" style="margin-top:12px; position:relative">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">영상 리스트</h3>
        <div class="row small">
          <label>보기 프리셋</label>
          <select id="viewPreset">
            <option value="all">전체(기본)</option>
            <option value="simple">간단</option>
            <option value="speedeng">속도·반응</option>
            <option value="metrics">지표만</option>
            <option value="packaging">패키징</option>
          </select>
          <label>정렬</label>
          <select id="sortKey"></select>
          <select id="sortDir"><option value="desc">내림차순</option><option value="asc">오름차순</option></select>
          <label>최소 반응률 (‰)</label><input id="fMinER" type="number" step="0.1" value="0" style="width:90px"/>
          <label>최소 조회 배율</label><input id="fMinVX" type="number" step="0.1" value="0" style="width:90px"/>
          <label>최소 임팩트 등급</label>
          <select id="fMinGrade"><option value="ALL">전체</option><option value="D">D</option><option value="C">C</option><option value="B">B</option><option value="A">A</option><option value="S">S</option></select>
        </div>
      </div>
      <div id="colToggles" class="row" style="gap:8px; margin:6px 0 8px; align-items:center; flex-wrap:wrap"></div>
      <div id="tableWrap" class="tableWrap">
        <table class="table" id="table">
          <thead>
            <tr>
              <th>☆</th>
              <th>썸네일</th>
              <th>제목</th>
              <th>채널</th>
              <th>업로드일</th>
              <th>길이</th>
              <th>조회</th>
              <th>좋아요</th>
              <th>댓글</th>
              <th>속도</th>
              <th>반응률 (‰)</th>
              <th>신선도</th>
              <th>조회 배율</th>
              <th>속도 배율</th>
              <th>임팩트</th>
              <th>Δ24h</th>
              <th>종합</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="sideScroll" class="sideScroll">
        <button id="scrollUp">▲</button>
        <button id="scrollDown">▼</button>
        <button id="scrollTop">TOP</button>
        <button id="scrollBottom">END</button>
      </div>
    </div>
  </div>

  <!-- S2: Channel Detail Modal -->
  <div id="channelModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="chTitle">
    <div class="modal-panel">
      <div class="modal-head">
        <div class="modal-title" id="chTitle">채널 상세</div>
        <div class="meta-row" id="chLinkHolder"></div>
        <button class="badge-soft" id="chRefresh">실시간 새로고침</button>
        <button class="modal-close" id="chClose">닫기</button>
      </div>
      <div id="chLoading" class="hint">로딩중…</div>
      <div id="chError" class="hint" style="display:none;color:#ffb84d">불러오기에 실패했습니다. API 키/쿼터를 확인하세요.</div>
      <div id="chBody" style="display:none">
        <div class="kpi-grid" id="chKpi"></div>
        <div class="meta-row" id="chPatterns"></div>
        <div class="hr"></div>
        <div><b>베스트 3</b></div>
        <div class="best-grid" id="best3"></div>
        <div class="hr"></div>
        <div class="rev-box">
          <label>예상 CPM(₩/1k뷰)</label>
          <input id="cpmLow" type="number" min="0" value="500" style="width:100px"/>
          ~
          <input id="cpmHigh" type="number" min="0" value="2500" style="width:100px"/>
          <span class="hint">최근 영상 합산 보수 추정</span>
          <span class="rev-out" id="revOut"></span>
        </div>
      </div>
    </div>
  </div>

  <div class="row" style="position:fixed;left:0;right:0;bottom:0;background:rgba(9,14,20,.9);border-top:1px solid #1e2a36;padding:10px 16px;gap:8px;align-items:center;justify-content:center;font-size:12px">
    <span>Tip: <b>업로드일·속도·반응률</b>을 합쳐 상위만 골라 작업하세요.</span>
  </div>

<script>
// ========== SHORTS RADAR v7.4.2 COMPLETE WITH CATEGORIES ==========
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const now = () => new Date();
  const hoursSince = iso => (now() - new Date(iso)) / 36e5;
  const fmt = n => (n===undefined || n===null) ? '-' : Number(n).toLocaleString('en-US');
  const escapeHtml = s => (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const toISO = d => new Date(d).toISOString();
  const isoToSeconds = dur => { const m=(dur||'').match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/); return m?(+(m[1]||0)*3600 + +(m[2]||0)*60 + +(m[3]||0)):0; };
  const hms = sec => { sec=+sec|0; const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; return (h? h+':':'') + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0'); };
  function uniq(arr){ return [...new Set(arr)]; }

  // ========== 카테고리 정의 제거 (videoCategoryId 문제로 인해 사용 안함) ==========
  // v7.4.2: Seedless 모드를 키워드 기반으로 완전 전환

  // ---------- 상태 ----------
  let STATE = {
    videos: [], colVis:null, sortKey:null, sortDir:null,
    filters:{minER:0, minVX:0, minGrade:'ALL'},
    watch:new Set(), snapshots:{}
  };

  // ---------- 저장 ----------
  function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
  function load(key,def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def;}catch(e){return def}}

  // ---------- 시간 헬퍼 ----------
  function pacificTodayStr(){
    try { return new Intl.DateTimeFormat('en-CA',{timeZone:'America/Los_Angeles',year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date()); }
    catch(_) { const d=new Date(); return d.toISOString().slice(0,10); }
  }
  function nextPacificMidnightISO(){
    try{ const la = new Date(new Date().toLocaleString('en-US', { timeZone:'America/Los_Angeles' })); la.setHours(24,0,0,0); return la.toISOString(); }
    catch(_){ const d=new Date(); d.setHours(24,0,0,0); return d.toISOString(); }
  }

  // ---------- 키 회전(로컬) - v7.4.0 개선 ----------
  const ROT = {
    keys: [],
    idx: 0,
    stat: [],
    lastMarkTime: 0, // 중복 방지용
    
    load(){
      const arr = JSON.parse(localStorage.getItem('yt_api_keys')||'[]');
      const legacy = JSON.parse(localStorage.getItem('yt_api_key')||'""');
      this.keys = (arr && arr.length) ? arr : (legacy? [legacy] : []);
      
      const savedIdx = parseInt(localStorage.getItem('sr_curIdx')||'0', 10);
      this.idx = (savedIdx >= 0 && savedIdx < this.keys.length) ? savedIdx : 0;
      
      const savedStat = load('sr_keyStat', {}); 
      const savedDate = load('sr_keyStatDate', null); 
      const todayLA = pacificTodayStr(); 
      if(savedDate !== todayLA){ 
        save('sr_keyStatDate', todayLA); 
        save('sr_keyStat', {}); 
      }
      this.stat = this.keys.map((k,i) => savedStat[k] || {ok:0, fail:0, blocked:false, used:0});
      
      renderKeyState();
    },
    
    saveStat(){
      const obj = {};
      this.keys.forEach((k,i) => { 
        obj[k] = this.stat[i] || {ok:0, fail:0, blocked:false, used:0}; 
      });
      save('sr_keyStat', obj);
    },
    
    current(){ 
      return this.keys.length ? this.keys[this.idx] : null; 
    },
    
    rotate(){ 
      if(this.keys.length <= 1) return;
      
      let attempts = 0;
      do {
        this.idx = (this.idx + 1) % this.keys.length;
        attempts++;
      } while(this.stat[this.idx]?.blocked && attempts < this.keys.length);
      
      localStorage.setItem('sr_curIdx', String(this.idx));
      renderKeyState();
    },
    
    markOk(){ 
      const now = Date.now();
      if(now - this.lastMarkTime < 500) return; // 중복 방지
      this.lastMarkTime = now;
      
      if(!this.stat[this.idx]) this.stat[this.idx] = {ok:0, fail:0, blocked:false, used:0};
      this.stat[this.idx].ok++;
      this.saveStat();
      renderKeyState();
    },
    
    markFail(){ 
      const now = Date.now();
      if(now - this.lastMarkTime < 500) return; // 중복 방지
      this.lastMarkTime = now;
      
      if(!this.stat[this.idx]) this.stat[this.idx] = {ok:0, fail:0, blocked:false, used:0};
      const s = this.stat[this.idx];
      s.fail++;
      if(s.fail >= 3) {
        s.blocked = true;
      }
      this.saveStat();
      this.rotate();
      renderQuotaStateFlag(); // 상태 플래그 업데이트 추가
    },
    
    resetKeyStats(){
      this.stat = this.keys.map(() => ({ok:0, fail:0, blocked:false, used:0}));
      this.saveStat();
      renderKeyState();
    }
  };

  // 키 상태 표시
  function renderKeyState(){
    const holder = $('#keyState');
    if (!holder) return;
    
    if (!ROT.keys.length){
      holder.innerHTML = '<span class="pill">키 상태: 없음</span>';
      renderQuotaStateFlag(); // 상태 플래그 업데이트
      return;
    }
    
    holder.innerHTML = ROT.keys.map((_, i) => {
      const s = ROT.stat[i] || {ok:0, fail:0, blocked:false, used:0};
      const isActive = (i === ROT.idx);
      const className = s.blocked ? 'pill blocked' : (isActive ? 'pill active' : 'pill');
      
      return `
        <span class="${className}" 
              role="button" 
              tabindex="0" 
              title="성공:${s.ok} 실패:${s.fail} 사용:${s.used||0}${s.blocked?' (차단됨)':''}"
              onclick="window._pickKey(${i})"
              onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();window._pickKey(${i});}">
          <b>KEY${i+1}</b>
          ${isActive ? '<span class="badge">NOW</span>' : ''}
          <span class="badge">ok:${s.ok}</span>
          <span class="badge">fail:${s.fail}</span>
          ${s.used ? `<span class="badge">used:${s.used}</span>` : ''}
          ${s.blocked ? '<span class="badge">BLOCK</span>' : ''}
        </span>
      `;
    }).join('');
    
    renderQuotaStateFlag(); // 상태 플래그 업데이트
  }

  window._pickKey = function(i){
    if (i < 0 || i >= ROT.keys.length) return;
    if (ROT.stat[i]?.blocked) {
      alert('이 키는 차단되었습니다. 다른 키를 선택하세요.');
      return;
    }
    ROT.idx = i;
    localStorage.setItem('sr_curIdx', String(i));
    renderKeyState();
    renderQuota(); // 키 변경시 쿼터 표시 업데이트
  };

  // API 호출
  async function fetchWithRotate(url, quotaInc){
    const maxTry = Math.max(1, ROT.keys.length * 2);
    let lastError = null;
    let allBlocked = true;
    
    for(let i = 0; i < ROT.keys.length; i++) {
      if(!ROT.stat[i]?.blocked) {
        allBlocked = false;
        break;
      }
    }
    
    if(allBlocked && ROT.keys.length > 0) {
      console.log('모든 키가 차단됨. 첫 번째 키 블록 해제 시도...');
      ROT.stat[0].blocked = false;
      ROT.stat[0].fail = 0;
      ROT.saveStat();
      ROT.idx = 0;
      renderKeyState();
    }
    
    for(let t = 0; t < maxTry; t++){
      const key = ROT.current();
      if(!key) {
        throw new Error('사용 가능한 API 키가 없습니다');
      }
      
      if(ROT.stat[ROT.idx]?.blocked && !allBlocked) {
        ROT.rotate();
        continue;
      }
      
      const final = url + (url.includes('?') ? '&' : '?') + 'key=' + encodeURIComponent(key);
      
      try{
        const res = await fetch(final, {cache:'no-store'});
        
        if(res.ok){
          const data = await res.json();
          if(quotaInc){ 
            incQuota(quotaInc); 
            // 키별 사용량 증가
            if(!ROT.stat[ROT.idx]) ROT.stat[ROT.idx] = {ok:0, fail:0, blocked:false, used:0};
            ROT.stat[ROT.idx].used = (ROT.stat[ROT.idx].used || 0) + quotaInc;
            ROT.saveStat();
          } 
          ROT.markOk();
          return data;
        } else {
          const errorText = await res.text(); 
          lastError = `HTTP ${res.status}: ${errorText}`; 
          if(shouldLockForQuota(res.status,errorText)) setQuotaLocked(true);
          
          if(res.status === 403 || (res.status >= 400 && res.status < 500)) {
            ROT.markFail();
          }
        }
      } catch(e) {
        lastError = e.message;
        ROT.markFail();
      }
    }
    
    throw new Error(`모든 키 시도 실패: ${lastError}`);
  }

  // ---------- 쿼터 ----------
  const QUOTA_KEY='sr_quota';
  const QUOTA_LOCK_KEY='sr_quota_lock_until';
  
  function todayStr(){ return pacificTodayStr(); }
  function getQuota(){ let q = load(QUOTA_KEY, null); const today=todayStr(); if(!q) q={date:today, used:0, limit:10000}; if(q.date!==today){ q.date=today; q.used=0; } return q; }
  function saveQuota(q){ save(QUOTA_KEY, q); }
  function setQuotaLimit(n){ const q=getQuota(); q.limit=Math.max(1000, Number(n)||10000); saveQuota(q); renderQuota(); renderQuotaStateFlag(); }
  function incQuota(units){ 
    const q=getQuota(); 
    q.used += Math.max(0, units|0); 
    saveQuota(q); 
    renderQuota(); 
    renderQuotaStateFlag(); 
  }
  function resetQuota(){ 
    const q={date:todayStr(), used:0, limit:getQuota().limit}; 
    saveQuota(q); 
    // 키별 사용량도 초기화
    if(ROT.stat){
      ROT.stat.forEach(s => { if(s) s.used = 0; });
      ROT.saveStat();
    }
    renderQuota(); 
    renderQuotaStateFlag(); 
    renderKeyState();
  }
  
  // v7.4.0 개선된 renderQuota
  function renderQuota(){ 
    const q=getQuota(); 
    const pct=Math.min(100, Math.round((q.used/(q.limit||1))*100)); 
    
    // 현재 키 사용량
    let keyInfo = '';
    if(ROT.keys.length > 0){
      const keyUsed = (ROT.stat[ROT.idx] && ROT.stat[ROT.idx].used) || 0;
      keyInfo = ` [KEY${ROT.idx+1}: ${keyUsed}]`;
    }
    
    $('#quotaStat').innerHTML=`API 사용량(오늘) <b>${q.used}</b> / ${q.limit} (${pct}%)${keyInfo}`; 
    $('#quotaLimit').value=q.limit; 
    $('#quotaBar .fill').style.width=pct+'%'; 
  }
  
  function isQuotaLocked(){ 
    const iso=localStorage.getItem(QUOTA_LOCK_KEY); 
    if(!iso) return false; 
    if(new Date(iso)<=new Date()){ 
      localStorage.removeItem(QUOTA_LOCK_KEY); 
      return false; 
    } 
    return true; 
  }
  
  function setQuotaLocked(on=true){ 
    if(on) localStorage.setItem(QUOTA_LOCK_KEY,nextPacificMidnightISO()); 
    else localStorage.removeItem(QUOTA_LOCK_KEY); 
    renderQuotaStateFlag(); 
  }
  
  function shouldLockForQuota(status, text){
    if(status===429) return true;
    if(status!==403) return false;
    const lower = String(text||'').toLowerCase();
    try{ 
      const j=JSON.parse(text); 
      const reason=(j?.error?.errors?.[0]?.reason||j?.error?.status||'').toLowerCase(); 
      if(['quotaexceeded','dailylimitexceeded','userratelimitexceeded','ratelimitexceeded'].includes(reason)) return true; 
    }catch(_){}
    if(/quota|daily.*limit|userratelimitexceeded|ratelimitexceeded/.test(lower)) return true;
    return false;
  }
  
  function renderQuotaStateFlag(){
    const el = $('#quotaStateFlag');
    if(!el) return;
    
    // 모든 키가 차단되었는지 확인
    let allKeysBlocked = false;
    if(ROT.keys.length > 0){
      allKeysBlocked = ROT.stat.every(s => s && s.blocked);
    }
    
    const offline = isQuotaLocked() || allKeysBlocked;
    el.className = 'quota-flag ' + (offline ? 'offline' : 'online');
    el.innerHTML = '상태: <b>' + (offline ? 'OFFLINE(쿼터 소진)' : 'ONLINE') + '</b>';
  }

  // ---------- API ----------
  async function ytSearch({q, channelId, publishedAfter, regionCode, maxResults, pageToken, lang, durBucket, order, videoCategoryId}){
    const params = new URLSearchParams({
      part:'snippet', 
      type:'video', 
      maxResults:String(Math.min(50, maxResults||50))
    });
    
    if(publishedAfter) params.set('publishedAfter', publishedAfter);
    if(regionCode) params.set('regionCode', regionCode);
    if(lang) params.set('relevanceLanguage', lang);
    
    params.set('order', order || 'date');
    if(q) params.set('q', q);
    if(channelId) params.set('channelId', channelId);
    if(pageToken) params.set('pageToken', pageToken);
    if(durBucket) params.set('videoDuration', durBucket);
    if(videoCategoryId) params.set('videoCategoryId', videoCategoryId);
    
    const url = `https://www.googleapis.com/youtube/v3/search?${params.toString()}`;
    return fetchWithRotate(url, 100);
  }
  
  async function ytVideos(ids){
    const url = `https://www.googleapis.com/youtube/v3/videos?`+
      new URLSearchParams({part:'snippet,contentDetails,statistics', id: ids.join(',')}).toString();
    return fetchWithRotate(url, 1);
  }
  
  // ========== Seedless 카테고리별 수집 (v7.4.2 - 16개 카테고리) ==========
  async function ytSearchSeedlessShorts({regionCode, lang, publishedAfter, maxResults=80}){
    console.log('🎯 Seedless 모드: 16개 카테고리별 수집');
    console.log(`🔍 설정: 지역=${regionCode}, 언어=${lang}, 목표=${maxResults}개`);
    
    const allVideos = [];
    const stats = {};  // ✅ 수정: stats 변수 선언 추가
    
    // 16개 카테고리 정의 (한국어/영어 키워드)
    const categories = [
      { 
        name: '음악', 
        keywords: regionCode === 'KR' ? ['음악 쇼츠', 'kpop', '뮤직비디오'] : ['music shorts', 'music video', 'pop music'],
        weight: 3 
      },
      { 
        name: '게임', 
        keywords: regionCode === 'KR' ? ['게임 쇼츠', '게임 하이라이트', '롤 매드무비'] : ['gaming shorts', 'gameplay', 'game clips'],
        weight: 3 
      },
      { 
        name: '유머', 
        keywords: regionCode === 'KR' ? ['웃긴 영상', '유머 모음', '레전드 짤'] : ['funny shorts', 'meme', 'comedy'],
        weight: 3 
      },
      { 
        name: '동물', 
        keywords: regionCode === 'KR' ? ['강아지 고양이', '귀여운 동물', '펫튜브'] : ['cute animals', 'pets', 'dog cat'],
        weight: 2 
      },
      { 
        name: '스포츠', 
        keywords: regionCode === 'KR' ? ['스포츠 하이라이트', '축구 골모음', '야구'] : ['sports highlights', 'football', 'basketball'],
        weight: 2 
      },
      { 
        name: '댄스', 
        keywords: regionCode === 'KR' ? ['댄스 챌린지', '춤 커버', '틱톡 댄스'] : ['dance challenge', 'dance cover', 'tiktok dance'],
        weight: 2 
      },
      { 
        name: '연예', 
        keywords: regionCode === 'KR' ? ['연예 짤', '연예인 소식', '아이돌'] : ['celebrity news', 'kpop idol', 'entertainment'],
        weight: 2 
      },
      { 
        name: '영화', 
        keywords: regionCode === 'KR' ? ['영화 명장면', '영화 리뷰', '영화 추천'] : ['movie scenes', 'movie review', 'film clips'],
        weight: 2 
      },
      { 
        name: '드라마', 
        keywords: regionCode === 'KR' ? ['드라마 하이라이트', '드라마 명장면', '웹드라마'] : ['drama scenes', 'kdrama', 'tv shows'],
        weight: 2 
      },
      { 
        name: 'AI', 
        keywords: regionCode === 'KR' ? ['AI 영상', 'AI 생성', '인공지능'] : ['AI generated', 'AI video', 'artificial intelligence'],
        weight: 1 
      },
      { 
        name: '예능', 
        keywords: regionCode === 'KR' ? ['예능 레전드', '런닝맨', '나혼산'] : ['variety show', 'korean variety', 'tv show funny'],
        weight: 2 
      },
      { 
        name: '시니어', 
        keywords: regionCode === 'KR' ? ['시니어', '5060', '중년 유튜브'] : ['senior', 'boomer', 'elderly'],
        weight: 1 
      },
      { 
        name: '국뽕', 
        keywords: regionCode === 'KR' ? ['국뽕', '밀리터리', '한국 자랑'] : ['korean pride', 'military', 'korea amazing'],
        weight: 1 
      },
      { 
        name: '오피셜', 
        keywords: regionCode === 'KR' ? ['공식 뮤직비디오', 'official', 'MV'] : ['official music video', 'official MV', 'VEVO'],
        weight: 1 
      },
      { 
        name: '리뷰', 
        keywords: regionCode === 'KR' ? ['제품 리뷰', '언박싱', '사용기'] : ['product review', 'unboxing', 'tech review'],
        weight: 2 
      },
      { 
        name: '정치', 
        keywords: regionCode === 'KR' ? ['정치 뉴스', '정치 짤', '시사'] : ['politics', 'political news', 'news'],
        weight: 1 
      }
    ];
    
    const totalWeight = categories.reduce((sum, cat) => sum + cat.weight, 0);
    
    console.log(`📊 ${categories.length}개 카테고리 준비 완료`);
    console.log('카테고리 목록:', categories.map(c => c.name).join(', '));
    
    // 각 카테고리별로 수집
    for(let i = 0; i < categories.length; i++){
      const cat = categories[i];
      const targetPerCategory = Math.max(2, Math.floor((cat.weight / totalWeight) * maxResults / 3)); // 카테고리당 목표
      
      console.log(`\n🔍 [${i+1}/${categories.length}] ${cat.name} (가중치:${cat.weight})`);
      
      const categoryVideos = [];
      
      // 첫 번째 키워드로 검색
      const keyword = cat.keywords[0];
      
      try{
        console.log(`  검색: "${keyword}"`);
        
        const res = await ytSearch({
          q: keyword,
          publishedAfter: publishedAfter,
          regionCode: regionCode,
          lang: lang,
          maxResults: 10, // 더 많이 가져와서 선별 (기존 5 → 10)
          order: 'viewCount' // 조회수 순
        });
        
        if(res && res.items && res.items.length > 0){
          // 상위 3개 선택 (더 확실하게)
          const topItems = res.items.slice(0, Math.min(3, res.items.length));
          
          topItems.forEach(item => {
            item._category = cat.name;
            categoryVideos.push(item);
          });
          
          console.log(`  ✅ ${topItems.length}개 수집`);
          stats[cat.name] = topItems.length;
        } else {
          console.log(`  ⚠️ 결과 없음`);
          stats[cat.name] = 0;
        }
        
      } catch(e){
        console.error(`  ❌ 오류:`, e.message);
        stats[cat.name] = 0;
      }
      
      allVideos.push(...categoryVideos);
      
      // API 쿼터 보호 (필수)
      await new Promise(resolve => setTimeout(resolve, 150));
    }
    
    console.log('\n' + '='.repeat(50));
    console.log('📊 카테고리별 수집 결과:');
    Object.entries(stats).forEach(([cat, count]) => {
      console.log(`  ${cat}: ${count}개`);
    });
    console.log(`\n✨ 총 ${allVideos.length}개 영상 수집 완료`);
    
    if(allVideos.length === 0){
      console.warn('⚠️ 영상 수집 실패. 키워드를 직접 입력해주세요.');
    }
    
    return allVideos;
  }
  
  async function ytChannels(ids){
    const url = `https://www.googleapis.com/youtube/v3/channels?`+
      new URLSearchParams({part:'snippet,statistics,contentDetails', id: ids.join(',')}).toString();
    return fetchWithRotate(url, 1);
  }
  
  function isShort(snippet, contentDetails, minSec, maxSec){
    const m = (contentDetails?.duration||'').match(/PT(?:(\d+)M)?(?:(\d+)S)?/);
    const sec = (m? (Number(m[1]||0)*60 + Number(m[2]||0)) : 0);
    const hashtag = (snippet?.title + ' ' + (snippet?.description||'')).toLowerCase().includes('#shorts');
    if(sec>0){ return (sec>= (minSec||0)) && (sec <= (maxSec||1e9)); }
    return hashtag;
  }

  // ---------- 지표 ----------
  function expDecay(hours, tau=48){ return Math.exp(-hours/ tau); }
  function computeDerived(all){
    all.forEach(v=>{
      const hours = Math.max(0.01, hoursSince(v.snippet.publishedAt));
      const views = +v.statistics.viewCount||0;
      const likes = +v.statistics.likeCount||0;
      const comments = +v.statistics.commentCount||0;
      const vel = views / hours;
      const er = (likes + 5*comments) / Math.max(1, views) * 1000;
      const fresh = expDecay(hours, 48);
      v._d = {hours, views, likes, comments, vel, er, fresh};
    });
    const avg = (arr,fn)=> arr.reduce((s,x)=>s+fn(x),0)/Math.max(1,arr.length);
    const meanViews = avg(all, x=>x._d.views)||1;
    const meanVel   = avg(all, x=>x._d.vel)||1;
    all.forEach(v=>{
      v._d.viewMult = v._d.views / meanViews;
      v._d.velMult  = v._d.vel / meanVel;
    });
    all.forEach(v=>{
      const fit = 0.0001;
      v._d.pick = Math.pow(v._d.vel,0.5) * Math.pow(Math.max(v._d.er,0),0.3) * Math.pow(v._d.fresh,0.2) * fit;
    });
    const picks = all.map(v=>v._d.pick).sort((a,b)=>a-b);
    function percentile(value){
      if(!picks.length) return 0;
      const idx = picks.findIndex(x=>value<=x);
      const i = (idx<0? picks.length-1 : idx);
      return Math.round((i/(picks.length-1||1))*100);
    }
    all.forEach(v=>{
      const p = percentile(v._d.pick);
      let g='D';
      if(p>=90) g='S'; else if(p>=80) g='A'; else if(p>=60) g='B'; else if(p>=40) g='C'; else g='D';
      v._impact = {percentile:p, grade:g};
    });
  }

  // ---------- 워치리스트/Δ24h ----------
  function loadWatch(){ STATE.watch = new Set(load('sr_watchlist', [])); STATE.snapshots = load('sr_snapshots', {} ) || {}; }
  function saveWatch(){ save('sr_watchlist', [...STATE.watch]); save('sr_snapshots', STATE.snapshots); }
  function toggleWatch(id){ if(STATE.watch.has(id)) STATE.watch.delete(id); else STATE.watch.add(id); saveWatch(); renderTable(STATE.videos); }
  function pushSnapshot(id, v){ const s=STATE.snapshots[id] || (STATE.snapshots[id]=[]); s.push({t:toISO(new Date()), views:+(v.statistics.viewCount||0)}); STATE.snapshots[id]=s.slice(-50); saveWatch(); }
  function delta24h(id){ const s=STATE.snapshots[id]||[]; if(s.length<2) return 0; const nowt=new Date(); const from=new Date(nowt - 24*3600*1000); const recent=s.filter(x=> new Date(x.t)>=from); if(recent.length<2) return 0; const first=recent[0], last=recent[recent.length-1]; return (last.views-first.views)||0; }

  // ---------- 컬럼/정렬 ----------
  function defaultColVis(){
    return {bookmark:true,thumb:true,title:true,channel:true,uploadedAt:true,length:true,views:true,likes:true,comments:true,vel:true,er:true,fresh:true,viewMult:true,velMult:true,impact:true,delta:true,pick:true};
  }
  function buildColToggles(){
    if(!STATE.colVis) STATE.colVis = load('sr_cols', null) || defaultColVis();
    const holder = $('#colToggles'); holder.innerHTML='';
    const keys = Object.keys(STATE.colVis);
    const labels = {bookmark:'☆', thumb:'썸네일', title:'제목', channel:'채널', uploadedAt:'업로드일', length:'길이', views:'조회', likes:'좋아요', comments:'댓글', vel:'속도', er:'반응률 (‰)', fresh:'신선도', viewMult:'조회 배율', velMult:'속도 배율', impact:'임팩트', delta:'Δ24h', pick:'종합'};
    keys.forEach(k=>{
      const id='vis_'+k; const w=document.createElement('label'); w.style.display='flex'; w.style.alignItems='center'; w.style.gap='6px'; w.className='hint';
      w.innerHTML = `<input type="checkbox" id="${id}" ${STATE.colVis[k]?'checked':''}/> ${labels[k]||k}`;
      holder.appendChild(w);
      w.querySelector('input').addEventListener('change', ()=>{ STATE.colVis[k]=w.querySelector('input').checked; save('sr_cols', STATE.colVis); applyColumnVisibility(); });
    });
  }
  function applyColumnVisibility(){
    const keys = Object.keys(defaultColVis());
    keys.forEach(k=>{
      $$('#table thead th')[keys.indexOf(k)]?.classList.add('c-'+k);
    });
    Object.keys(STATE.colVis).forEach((k)=>{
      const show = STATE.colVis[k];
      document.querySelectorAll('.c-'+k).forEach(el=>{ el.style.display = show ? '' : 'none'; });
    });
  }
  function buildSortKeys(){
    if(!STATE.sortKey) STATE.sortKey = load('sr_sortKey', null) || 'uploadedAt';
    if(!STATE.sortDir) STATE.sortDir = load('sr_sortDir', null) || 'desc';
    const labelMap = {pick:'종합', uploadedAt:'업로드일', er:'반응률 (‰)', viewMult:'조회 배율', velMult:'속도 배율', views:'조회', vel:'속도'};
    const opts = ['pick','uploadedAt','er','viewMult','velMult','views','vel'];
    const sk = $('#sortKey'); sk.innerHTML=''; opts.forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=labelMap[k]||k; sk.appendChild(o); });
    if(!opts.includes(STATE.sortKey)) STATE.sortKey='uploadedAt';
    sk.value = STATE.sortKey; $('#sortDir').value = STATE.sortDir;
    sk.addEventListener('change', ()=>{ STATE.sortKey=sk.value; save('sr_sortKey', STATE.sortKey); renderTable(STATE.videos); });
    $('#sortDir').addEventListener('change', ()=>{ STATE.sortDir=$('#sortDir').value; save('sr_sortDir', STATE.sortDir); renderTable(STATE.videos); });
  }

  // ---------- 테이블 ----------
  function getSortValue(v,key){
    switch(key){
      case 'views': return +v.statistics.viewCount||0;
      case 'vel': return v._d.vel||0;
      case 'er': return v._d.er||0;
      case 'fresh': return v._d.fresh||0;
      case 'velMult': return v._d.velMult||0;
      case 'viewMult': return v._d.viewMult||0;
      case 'pick': return v._d.pick||0;
      case 'uploadedAt': return new Date(v.snippet.publishedAt).getTime();
      default: return v._d.vel||0;
    }
  }
  function rankGrade(g){ return ({'D':1,'C':2,'B':3,'A':4,'S':5}[g]||0); }
  function renderTable(videos){
    // 자동 스냅샷 저장
    if(Array.isArray(videos) && videos.length > 0){
      saveSnapshot();
    }
    
    const tb = $('#tbody'); tb.innerHTML='';
    const f = STATE.filters;
    const filtered = videos.filter(v=> (v._d.er >= (f.minER||0)) && (v._d.viewMult >= (f.minVX||0)) && (f.minGrade==='ALL' || rankGrade(v._impact.grade) >= rankGrade(f.minGrade)));
    const key = STATE.sortKey || 'uploadedAt';
    const asc = (STATE.sortDir || 'desc')==='asc';
    filtered.sort((a,b)=>{ const av=getSortValue(a,key), bv=getSortValue(b,key); return asc? (av-bv):(bv-av); });
    for(const v of filtered){
      const sec = isoToSeconds(v.contentDetails.duration||'PT0S');
      const delta = delta24h(v.id);
      const catBadge = v._category ? `<span class="badge">${v._category}</span>` : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="c-bookmark"><span class="star ${STATE.watch.has(v.id)?'on':''}" data-id="${v.id}">${STATE.watch.has(v.id)?'★':'☆'}</span></td>
        <td class="c-thumb"><a href="https://www.youtube.com/watch?v=${v.id}" target="_blank"><img class="thumb" src="${v.snippet.thumbnails?.medium?.url||''}"/></a></td>
        <td class="c-title">${escapeHtml(v.snippet.title||'')} ${catBadge}</td>
        <td class="c-channel"><button class="ch-link" data-cid="${v.snippet.channelId||''}" data-ctitle="${escapeHtml(v.snippet.channelTitle||'')}">${escapeHtml(v.snippet.channelTitle||'')}</button></td>
        <td class="c-uploadedAt" title="${v.snippet.publishedAt}">${new Date(v.snippet.publishedAt).toLocaleString('ko-KR')}</td>
        <td class="c-length">${hms(sec)}</td>
        <td class="c-views">${fmt(v.statistics.viewCount)}</td>
        <td class="c-likes">${fmt(v.statistics.likeCount)}</td>
        <td class="c-comments">${fmt(v.statistics.commentCount)}</td>
        <td class="c-vel">${(v._d.vel).toFixed(1)}</td>
        <td class="c-er">${(v._d.er).toFixed(2)}</td>
        <td class="c-fresh">${(v._d.fresh).toFixed(2)}</td>
        <td class="c-viewMult">${(v._d.viewMult).toFixed(2)}×</td>
        <td class="c-velMult">${(v._d.velMult).toFixed(2)}×</td>
        <td class="c-impact"><span class="badge grade-${v._impact.grade}">${v._impact.grade}</span> <span class="muted">(${v._impact.percentile})</span></td>
        <td class="c-delta"><span class="${delta>0?'good':''}">+${fmt(delta||0)}</span></td>
        <td class="c-pick"><b>${(v._d.pick).toFixed(2)}</b></td>`;
      tb.appendChild(tr);
    }
    tb.querySelectorAll('.star').forEach(s=> s.addEventListener('click', (ev)=>{ const id=ev.target.getAttribute('data-id'); toggleWatch(id);}));
    tb.querySelectorAll('.ch-link').forEach(btn=> btn.addEventListener('click', ()=> openChannelModal(btn.dataset.cid, btn.dataset.ctitle)));
    applyColumnVisibility();
    setSummary(videos, filtered);
    renderBestTimes(videos);
  }

  // ---------- 요약/시간대 ----------
  function setSummary(all, filtered){
    const avg = (arr,fn)=> arr.reduce((s,x)=>s+fn(x),0)/Math.max(1,arr.length);
    
    // 카테고리 분포 계산
    const categoryDist = {};
    all.forEach(v => {
      const cat = v._category || '기타';
      categoryDist[cat] = (categoryDist[cat] || 0) + 1;
    });
    
    const pills = [
      `<span class="pill">총 수집 <b>${all.length}</b></span>`,
      `<span class="pill">표시 <b>${filtered.length}</b></span>`,
      `<span class="pill">평균 속도 <b>${avg(all,x=>x._d.vel).toFixed(1)}</b></span>`,
      `<span class="pill">평균 반응률 <b>${avg(all,x=>x._d.er).toFixed(2)}</b>‰</span>`
    ];
    
    // 카테고리 분포 상세 표시
    if(Object.keys(categoryDist).length > 0){
      // 모든 카테고리 표시 (수집된 것만)
      const categories = Object.entries(categoryDist)
        .sort((a, b) => b[1] - a[1])
        .map(([cat, count]) => `${cat}:${count}`);
      
      pills.push(`<span class="pill">🔍 카테고리별: ${categories.join(' ')}</span>`);
      
      // Seedless 모드인 경우 추가 정보
      const seedlessCategories = ['음악', '게임', '유머', '동물', '스포츠', '댄스', '연예', '영화', '드라마', 'AI', '예능', '시니어', '국뽕', '오피셜', '리뷰', '정치'];
      const isSeedless = Object.keys(categoryDist).some(cat => seedlessCategories.includes(cat));
      
      if(isSeedless){
        const collectedCategories = Object.keys(categoryDist).filter(cat => seedlessCategories.includes(cat));
        const totalAttempted = seedlessCategories.length;
        const totalCollected = collectedCategories.length;
        pills.push(`<span class="pill">✨ Seedless: ${totalCollected}/${totalAttempted}개 카테고리 성공</span>`);
      }
    }
    
    $('#summary').innerHTML = pills.join(' ');
  }
  
  function renderBestTimes(videos){
    const slots = new Array(24).fill(0);
    videos.forEach(v=>{ const h=new Date(v.snippet.publishedAt).getHours(); slots[h]+= (v._d.pick||0); });
    const arr = slots.map((v,i)=>({h:i,score:v})).sort((a,b)=>b.score-a.score).slice(0,5);
    const out = arr.map(x=>`<span class="tag">${String(x.h).padStart(2,'0')}:00</span>`).join('');
    $('#bestTimes').innerHTML = out || '<span class="hint">데이터가 부족합니다.</span>';
  }

  // ---------- 실행 파이프라인 ----------
  async function run(){
    if(!ROT.keys.length) return alert('API 키가 필요합니다. 상단에 여러 키를 붙여넣고 [키 저장]을 눌러주세요.');
    const days = +$('#days').value||7;
    const region = $('#region').value||'KR';
    const lang = $('#lang').value||'ko';
    const maxResults = +$('#maxResults').value||80;
    const minSec = +($('#minSec').value||0);
    const maxSec = +($('#maxSec').value||62);
    const durBucket = (maxSec <= 240) ? 'short' : null;
    const q = $('#keywords').value.trim();
    const chanIds = $('#channels').value.trim().split(',').map(s=>s.trim()).filter(Boolean);

    const publishedAfter = new Date(Date.now()-days*24*3600*1000).toISOString();
    
    // ========== Seedless 모드: 키워드/채널 없으면 카테고리별 수집 ==========
    if(!q && chanIds.length === 0){
      console.log('🚀 Seedless 모드 활성화 - 카테고리별 인기 영상 수집');
      
      const summaryEl = $('#summary');
      if(summaryEl){
        summaryEl.innerHTML = '<span class="pill">🔄 카테고리별 수집 중...</span>';
      }
      
      try{
        // 카테고리별 수집
        const searchItems = await ytSearchSeedlessShorts({
          regionCode: region,
          lang: lang,
          publishedAfter: publishedAfter,
          maxResults: maxResults
        });
        
        if(searchItems.length === 0){
          console.warn('Seedless 수집 실패, 기본 검색으로 전환');
          // 실패 시 기본 검색어로 폴백
          const defaultQuery = 'shorts';
          $('#keywords').value = defaultQuery;
          
          let items = [];
          let next = null;
          do{
            const res = await ytSearch({q: defaultQuery, publishedAfter, regionCode: region, maxResults, pageToken: next, lang, durBucket});
            (res.items||[]).forEach(it => items.push(it));
            next = res.nextPageToken;
          } while(items.length < maxResults && next);
          
          const ids = uniq(items.map(x => x.id?.videoId).filter(Boolean)).slice(0, maxResults);
          const videos = [];
          for(let i = 0; i < ids.length; i += 50){
            const res = await ytVideos(ids.slice(i, i + 50));
            (res.items||[]).forEach(v => videos.push(v));
          }
          const shorts = videos.filter(v => isShort(v.snippet, v.contentDetails, minSec, maxSec));
          computeDerived(shorts);
          STATE.videos = shorts;
          renderTable(STATE.videos);
          return;
        }
        
        // 중복 제거
        const videoIds = [...new Set(searchItems.map(x => x.id?.videoId).filter(Boolean))];
        console.log(`🎬 ${videoIds.length}개 고유 영상 ID 확보`);
        
        // 상세 정보 가져오기
        const videos = [];
        for(let i = 0; i < videoIds.length; i += 50){
          const batch = videoIds.slice(i, i + 50);
          const res = await ytVideos(batch);
          (res.items || []).forEach(v => {
            // 카테고리 정보 복원
            const searchItem = searchItems.find(s => s.id?.videoId === v.id);
            if(searchItem){
              v._category = searchItem._category;
            }
            videos.push(v);
          });
        }
        
        // Shorts 필터링
        const shorts = videos.filter(v => isShort(v.snippet, v.contentDetails, minSec, maxSec));
        console.log(`🎯 ${shorts.length}개 Shorts 필터링 완료`);
        
        // 지표 계산
        computeDerived(shorts);
        
        // 조회수 순으로 정렬 (내림차순)
        const sorted = shorts.sort((a, b) => {
          const aViews = parseInt(a.statistics?.viewCount || 0);
          const bViews = parseInt(b.statistics?.viewCount || 0);
          return bViews - aViews;
        });
        
        const finalResults = sorted.slice(0, maxResults);
        
        STATE.videos = finalResults;
        renderTable(STATE.videos);
        
        // 성공 알림
        const notice = document.createElement('div');
        notice.className = 'seedless-notice';
        
        // 카테고리 수 계산
        const categoryCount = [...new Set(finalResults.map(v => v._category).filter(Boolean))].length;
        
        notice.innerHTML = `
          <b>✨ Seedless 모드</b> - ${categoryCount}개 카테고리에서 인기 영상 자동 수집<br>
          <small>수집: ${shorts.length}개 → 선별: ${finalResults.length}개 (조회수 순)</small>
        `;
        const wrap = $('.wrap');
        if(wrap){
          wrap.insertBefore(notice, wrap.children[3]);
          setTimeout(() => {
            notice.style.transition = 'opacity 0.5s';
            notice.style.opacity = '0';
            setTimeout(() => notice.remove(), 500);
          }, 5000);
        }
        
      } catch(e){
        console.error('❌ Seedless 모드 실패:', e);
        // 실패해도 수집된 데이터가 있으면 표시
        if(allVideos && allVideos.length > 0){
          // 중복 제거
          const videoIds = [...new Set(allVideos.map(x => x.id?.videoId).filter(Boolean))];
          console.log(`🎬 실패했지만 ${videoIds.length}개 영상 확보, 처리 진행`);
          
          // 상세 정보 가져오기
          const videos = [];
          for(let i = 0; i < videoIds.length; i += 50){
            const batch = videoIds.slice(i, i + 50);
            const res = await ytVideos(batch);
            (res.items || []).forEach(v => {
              const searchItem = allVideos.find(s => s.id?.videoId === v.id);
              if(searchItem){
                v._category = searchItem._category;
              }
              videos.push(v);
            });
          }
          
          const shorts = videos.filter(v => isShort(v.snippet, v.contentDetails, minSec, maxSec));
          computeDerived(shorts);
          
          const sorted = shorts.sort((a, b) => {
            const aViews = parseInt(a.statistics?.viewCount || 0);
            const bViews = parseInt(b.statistics?.viewCount || 0);
            return bViews - aViews;
          });
          
          const finalResults = sorted.slice(0, maxResults);
          STATE.videos = finalResults;
          renderTable(STATE.videos);
          
          // 부분 성공 알림
          const notice = document.createElement('div');
          notice.className = 'seedless-notice';
          const categoryCount = [...new Set(finalResults.map(v => v._category).filter(Boolean))].length;
          notice.innerHTML = `
            <b>⚠️ Seedless 부분 수집</b> - ${categoryCount}개 카테고리에서 영상 수집 (일부 실패)<br>
            <small>수집: ${shorts.length}개 → 선별: ${finalResults.length}개</small>
          `;
          const wrap = $('.wrap');
          if(wrap){
            wrap.insertBefore(notice, wrap.children[3]);
            setTimeout(() => {
              notice.style.transition = 'opacity 0.5s';
              notice.style.opacity = '0';
              setTimeout(() => notice.remove(), 500);
            }, 5000);
          }
          return;
        }
        
        // 완전 실패 시 기본 검색으로 폴백
        const defaultQuery = 'shorts';
        $('#keywords').value = defaultQuery;
        alert('카테고리별 수집 실패. "shorts"로 기본 검색합니다.');
      }
      
      return;
    }

    // ========== 일반 모드: 키워드/채널 검색 ==========
    let items=[];
    if(q){
      let next=null;
      do{
        const res = await ytSearch({q, publishedAfter, regionCode:region, maxResults, pageToken:next, lang, durBucket});
        (res.items||[]).forEach(it=> items.push(it));
        next = res.nextPageToken;
      }while(items.length < maxResults && next);
    }
    for(const ch of chanIds){
      let next=null;
      do{
        const res = await ytSearch({channelId:ch, publishedAfter, regionCode:region, maxResults, pageToken:next, lang, durBucket});
        (res.items||[]).forEach(it=> items.push(it));
        next = res.nextPageToken;
      }while(items.length < maxResults && next);
    }

    const ids = uniq(items.map(x=>x.id?.videoId).filter(Boolean)).slice(0, maxResults);
    const videos = [];
    for(let i=0;i<ids.length;i+=50){
      const res = await ytVideos(ids.slice(i,i+50));
      (res.items||[]).forEach(v=> videos.push(v));
    }
    const shorts = videos.filter(v=> isShort(v.snippet, v.contentDetails, minSec, maxSec));
    computeDerived(shorts);
    STATE.videos = shorts;
    renderTable(STATE.videos);
  }

  // ---------- S2: Channel Modal ----------
  let __lastChannel = null; // 마지막 열린 채널 정보 저장
  
  async function listChannelRecentVideos(channelId, n=50){
    let items=[], next=null;
    const region = $('#region')?.value||undefined;
    const lang = $('#lang')?.value||undefined;
    do{
      const data = await ytSearch({channelId, order:'date', maxResults:50, pageToken:next, regionCode:region, lang});
      (data.items||[]).forEach(x=> items.push(x));
      next = data.nextPageToken;
    }while(next && items.length < n);
    const ids = [...new Set(items.map(x=>x.id?.videoId).filter(Boolean))].slice(0,n);
    const videos=[];
    for(let i=0;i<ids.length;i+=50){
      const d = await ytVideos(ids.slice(i,i+50));
      (d.items||[]).forEach(v=> videos.push(v));
    }
    return videos;
  }
  function median(arr){ const a=[...arr].sort((x,y)=>x-y); const m=Math.floor(a.length/2); return a.length? (a.length%2? a[m]:(a[m-1]+a[m])/2):0; }
  function sum(arr,fn){ return arr.reduce((s,x)=>s+(fn?fn(x):x),0); }
  function fmtWon(n){ n=Number(n||0); return '₩'+n.toLocaleString('ko-KR'); }

  async function openChannelModal(cid, ctitle){
    __lastChannel = {cid, title: ctitle}; // 저장
    
    const m = document.getElementById('channelModal');
    const body = document.getElementById('chBody');
    const load = document.getElementById('chLoading');
    const err  = document.getElementById('chError');
    const kpi  = document.getElementById('chKpi');
    const best = document.getElementById('best3');
    const pat  = document.getElementById('chPatterns');
    const linkHold = document.getElementById('chLinkHolder');

    m.style.display='flex'; body.style.display='none'; load.style.display=''; err.style.display='none';
    document.getElementById('chTitle').textContent = ctitle || '채널 상세';
    linkHold.innerHTML = `<a class="badge-soft" target="_blank" href="https://www.youtube.com/channel/${cid}">채널로 열기 ↗</a>`;

    // 쿼터 확인 - 소진되었으면 캐시된 데이터만 사용
    const allKeysBlocked = ROT.keys.length > 0 && ROT.stat.every(s => s && s.blocked);
    if(isQuotaLocked() || allKeysBlocked){
      // 캐시된 데이터에서 채널 영상 찾기
      const cachedVideos = STATE.videos.filter(v => v.snippet?.channelId === cid);
      
      if(cachedVideos.length > 0){
        // 캐시 데이터로 표시
        const shorts = cachedVideos.filter(v => {
          const m = (v.contentDetails?.duration||'').match(/PT(?:(\d+)M)?(?:(\d+)S)?/);
          const sec = (m? (Number(m[1]||0)*60 + Number(m[2]||0)) : 0);
          const hashtag = (v.snippet?.title + ' ' + (v.snippet?.description||'')).toLowerCase().includes('#shorts');
          return sec>0 ? (sec<=62) : hashtag;
        });
        
        const avgVel = (sum(shorts, x=>x._d.vel)/Math.max(1,shorts.length)).toFixed(1);
        const avgEr  = (sum(shorts, x=>x._d.er)/Math.max(1,shorts.length)).toFixed(2);
        
        kpi.innerHTML = [
          `<div class="kpi-card"><div>구독자</div><b>-</b></div>`,
          `<div class="kpi-card"><div>누적 조회</div><b>-</b></div>`,
          `<div class="kpi-card"><div>총 영상</div><b>-</b></div>`,
          `<div class="kpi-card"><div>캐시된 ${shorts.length}개 평균</div><b>속도 ${avgVel} · 반응률 ${avgEr}‰</b></div>`
        ].join('');
        
        pat.innerHTML = `<span class="badge-soft">캐시 데이터 사용 중 (쿼터 소진)</span>`;
        
        const top = [...shorts].sort((a,b)=> (b._d.pick - a._d.pick) || (b._d.vel - a._d.vel)).slice(0,3);
        best.innerHTML = top.map(v=>{
          const sec = (v.contentDetails?.duration||'').match(/PT(?:(\d+)M)?(?:(\d+)S)?/);
          const s = (sec? (Number(sec[1]||0)*60 + Number(sec[2]||0)) : 0);
          return `<div class="best-card">
            <a target="_blank" href="https://www.youtube.com/watch?v=${v.id}"><img class="best-thumb" src="${v.snippet.thumbnails?.medium?.url||''}"/></a>
            <div>
              <div style="font-weight:600;margin-bottom:4px">${escapeHtml(v.snippet.title||'')}</div>
              <div class="meta-row">조회 ${(v.statistics.viewCount||0).toLocaleString('en-US')} · 속도 ${v._d.vel.toFixed(1)} · 반응률 ${v._d.er.toFixed(2)}‰ · ${new Date(v.snippet.publishedAt).toLocaleDateString('ko-KR')} · ${s}s</div>
            </div>
          </div>`;
        }).join('');
        
        document.getElementById('revOut').textContent = '쿼터 소진으로 수익 계산 불가';
        
        load.style.display='none'; body.style.display='';
        return;
      } else {
        load.style.display='none'; err.style.display='';
        document.getElementById('chError').textContent = '쿼터가 소진되었고 이 채널의 캐시 데이터가 없습니다.';
        return;
      }
    }
    
    // 쿼터가 있을 때 기존 로직
    try{
      if(!ROT.keys.length) throw new Error('API 키 필요');
      const meta = await ytChannels([cid]);
      const ch = (meta.items||[])[0];
      const vids = await listChannelRecentVideos(cid, 60);
      const shorts = vids.filter(v=>{
        const m = (v.contentDetails?.duration||'').match(/PT(?:(\d+)M)?(?:(\d+)S)?/);
        const sec = (m? (Number(m[1]||0)*60 + Number(m[2]||0)) : 0);
        const hashtag = (v.snippet?.title + ' ' + (v.snippet?.description||'')).toLowerCase().includes('#shorts');
        return sec>0 ? (sec<=62) : hashtag;
      });
      computeDerived(shorts);

      // KPI
      const avgVel = (sum(shorts, x=>x._d.vel)/Math.max(1,shorts.length)).toFixed(1);
      const avgEr  = (sum(shorts, x=>x._d.er)/Math.max(1,shorts.length)).toFixed(2);
      const ts = shorts.map(v=> new Date(v.snippet.publishedAt).getTime()).sort((a,b)=>a-b);
      const gaps=[]; for(let i=1;i<ts.length;i++){ gaps.push((ts[i]-ts[i-1])/(24*3600*1000)); }
      const medGap = gaps.length? median(gaps).toFixed(1)+'일':'-';
      const hours = new Array(24).fill(0); shorts.forEach(v=> hours[new Date(v.snippet.publishedAt).getHours()] += (v._d.pick||0));
      const topHour = hours.map((v,i)=>({v,i})).sort((a,b)=>b.v-a.v)[0]?.i ?? 0;

      kpi.innerHTML = [
        `<div class="kpi-card"><div>구독자</div><b>${(ch?.statistics?.subscriberCount||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,',')}</b></div>`,
        `<div class="kpi-card"><div>누적 조회</div><b>${(ch?.statistics?.viewCount||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,',')}</b></div>`,
        `<div class="kpi-card"><div>총 영상</div><b>${(ch?.statistics?.videoCount||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,',')}</b></div>`,
        `<div class="kpi-card"><div>최근 N개 평균</div><b>속도 ${avgVel} · 반응률 ${avgEr}‰</b></div>`
      ].join('');

      pat.innerHTML = `<span class="badge-soft">업로드 주기(중앙값) ${medGap}</span> <span class="badge-soft">히트 시간대 ${String(topHour).padStart(2,'0')}:00</span>`;

      const top = [...shorts].sort((a,b)=> (b._d.pick - a._d.pick) || (b._d.vel - a._d.vel) || (b._d.er - a._d.er)).slice(0,3);
      best.innerHTML = top.map(v=>{
        const sec = (v.contentDetails?.duration||'').match(/PT(?:(\d+)M)?(?:(\d+)S)?/);
        const s = (sec? (Number(sec[1]||0)*60 + Number(sec[2]||0)) : 0);
        return `<div class="best-card">
          <a target="_blank" href="https://www.youtube.com/watch?v=${v.id}"><img class="best-thumb" src="${v.snippet.thumbnails?.medium?.url||''}"/></a>
          <div>
            <div style="font-weight:600;margin-bottom:4px">${escapeHtml(v.snippet.title||'')}</div>
            <div class="meta-row">조회 ${(v.statistics.viewCount||0).toLocaleString('en-US')} · 속도 ${v._d.vel.toFixed(1)} · 반응률 ${v._d.er.toFixed(2)}‰ · ${new Date(v.snippet.publishedAt).toLocaleDateString('ko-KR')} · ${s}s</div>
          </div>
        </div>`;
      }).join('');

      function calcRevenue(){
        const low = Number(document.getElementById('cpmLow').value||0);
        const high= Number(document.getElementById('cpmHigh').value||0);
        const totalViews = sum(shorts, v=> +v.statistics.viewCount||0);
        const lowRev  = Math.floor(totalViews/1000*low);
        const highRev = Math.floor(totalViews/1000*high);
        document.getElementById('revOut').textContent = `최근 합산 조회 ${totalViews.toLocaleString('ko-KR')} → ${fmtWon(lowRev)} ~ ${fmtWon(highRev)}`;
      }
      document.getElementById('cpmLow').onchange = calcRevenue;
      document.getElementById('cpmHigh').onchange = calcRevenue;
      calcRevenue();

      load.style.display='none'; body.style.display='';
    }catch(e){
      load.style.display='none'; err.style.display='';
      const em = (e && (e.message||e.toString())) || 'unknown error';
      document.getElementById('chError').textContent = '불러오기에 실패했습니다: ' + em;
      console.error(e);
    }
  }
  function closeChannelModal(){ document.getElementById('channelModal').style.display='none'; }
  document.getElementById('chClose').addEventListener('click', closeChannelModal);
  document.getElementById('channelModal').addEventListener('click', (ev)=>{ if(ev.target.id==='channelModal') closeChannelModal(); });
  document.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape') closeChannelModal(); });

  // 모달 새로고침 버튼 이벤트
  document.getElementById('chRefresh').addEventListener('click', function(){
    if(isQuotaLocked()){
      alert('오늘 쿼터 소진 - 내일 00:00 이후 가능');
      return;
    }
    
    if(!__lastChannel || !__lastChannel.cid){
      console.error('No channel info to refresh');
      return;
    }
    
    // 버튼 상태 변경
    const btn = this;
    const originalText = btn.textContent;
    btn.textContent = '새로고침 중...';
    btn.disabled = true;
    
    // 로딩 표시
    const loading = document.getElementById('chLoading');
    const body = document.getElementById('chBody');
    if(loading) loading.style.display = '';
    if(body) body.style.display = 'none';
    
    // 모달 다시 열기
    setTimeout(function(){
      openChannelModal(__lastChannel.cid, __lastChannel.title || '');
      // 버튼 복구
      setTimeout(function(){
        btn.textContent = originalText;
        btn.disabled = false;
      }, 500);
    }, 100);
  });

  // ---------- Export (XLSX) ----------
  function exportXlsx(){
    if(!STATE.videos.length) return alert('데이터가 없습니다.');
    const f = STATE.filters;
    const filtered = STATE.videos.filter(v=> (v._d.er >= (f.minER||0)) && (v._d.viewMult >= (f.minVX||0)) && (f.minGrade==='ALL' || rankGrade(v._impact.grade) >= rankGrade(f.minGrade)));
    const headers = ["id","title","channel","publishedAt","durationSec","views","likes","comments","vel","er","fresh","fit","viewMult","velMult","impact","delta","pick","category"];
    const rows = [headers];
    for(const v of filtered){
      const sec = isoToSeconds(v.contentDetails.duration||'PT0S');
      const delta = delta24h(v.id) || 0;
      rows.push([
        v.id,
        v.snippet.title||"",
        v.snippet.channelTitle||"",
        v.snippet.publishedAt,
        sec,
        +(v.statistics.viewCount||0),
        +(v.statistics.likeCount||0),
        +(v.statistics.commentCount||0),
        +(v._d.vel||0),
        +(v._d.er||0),
        +(v._d.fresh||0),
        0,
        +(v._d.viewMult||0),
        +(v._d.velMult||0),
        v._impact.grade,
        delta,
        +(v._d.pick||0),
        v._category || ''
      ]);
    }
    if(typeof XLSX==='undefined'){ alert('XLSX 라이브러리를 불러오지 못했습니다.'); return; }
    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws['!cols'] = [16,60,28,24,14,12,12,12,12,12,10,8,12,12,10,10,10,10].map(w=>({wch:w}));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'ShortsRadar');
    XLSX.writeFile(wb, `shorts_radar_${new Date().toISOString().slice(0,10)}.xlsx`);
  }

  // ---------- S3: 장기 트렌드 (원본 복구) ----------
  async function loadTrendData(){
    const candidates = [
      'public/kw-trend.json',
      './kw-trend.json',
      './public/kw-trend.json',
      './kw-trend.sample.json'
    ];
    let lastErr=null, lastUrl=null;
    for(const url of candidates){
      try{
        const res = await fetch(url, {cache:'no-store'});
        window.__LT_LASTMOD__ = res.headers && res.headers.get ? res.headers.get('last-modified') : null;
        if(res.ok){
          const data = await res.json();
          const note = document.querySelector('.longdash .note');
          if(note && !url.includes('sample')) note.style.display='none';
          window.__LT_ENDPOINT__ = url;
          return data;
        } else {
          lastErr = new Error('fetch '+res.status);
          lastUrl = url;
        }
      }catch(e){
        lastErr = e; lastUrl = url;
      }
    }
    console.error('Trend load failed. Last:', lastUrl, lastErr);
    throw lastErr || new Error('trend load failed');
  }

  function ema(arr, period){
    const k = 2/(period+1);
    let prev = arr[0]||0; const out=[prev];
    for(let i=1;i<arr.length;i++){ prev = arr[i]*k + prev*(1-k); out.push(prev); }
    return out;
  }
  function zscore(xs, win=28){
    const out=[];
    for(let i=0;i<xs.length;i++){
      const s = Math.max(0, i-win+1);
      const seg = xs.slice(s, i+1);
      const m = seg.reduce((a,b)=>a+b,0)/seg.length;
      const v = seg.reduce((a,b)=>a+(b-m)*(b-m),0)/Math.max(1,(seg.length-1));
      const sd = Math.sqrt(v)||1e-9;
      out.push((xs[i]-m)/sd);
    }
    return out;
  }
  const sumArr = a => a.reduce((x,y)=>x+y,0);
  let ltChart=null, ltShare=null;
  function destroyLT(){ try{ltChart?.destroy();}catch(e){} try{ltShare?.destroy();}catch(e){} }

  async function buildLongTrend(){
    let data;
    try{ data = await loadTrendData(); }catch(e){
      const u = document.getElementById('ltUpdate'); if(u) u.textContent='로드 실패'; console.error(e); return;
    }
    const DAYS = +document.getElementById('ltDays').value||180;
    const MINN = +document.getElementById('ltMinN').value||10;
    const metric = document.getElementById('ltMetric').value;
    const smoothing = document.getElementById('ltSmoothing').checked;

    const u = document.getElementById('ltUpdate');
    if(u){
      const iso = (data.updatedAt||'').trim();
      const lm  = window.__LT_LASTMOD__;
      let dt=null;
      if(iso && /T|\d{2}:\d{2}/.test(iso)) {
        dt = new Date(iso);
      } else if(lm){
        dt = new Date(lm);
      } else if(iso){
        dt = new Date(iso+'T00:00:00Z');
      }
      if(dt && !isNaN(+dt)){
        const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,'0'), d=String(dt.getDate()).padStart(2,'0');
        const hh=String(dt.getHours()).padStart(2,'0'), mm=String(dt.getMinutes()).padStart(2,'0');
        u.textContent = `${y}-${m}-${d} ${hh}:${mm}`;
      }else{
        u.textContent = iso || '-';
      }
    }

    const keys = Object.keys(data.series||{});
    const palettes = {}; keys.forEach((k,i)=> palettes[k]=`hsl(${(i*47)%360} 70% 60%)`);

    const daySet = new Set();
    for(const k of keys){ (data.series[k]||[]).forEach(p=>daySet.add(p.d)); }
    const labelsAll = [...daySet].sort();
    const labels = labelsAll.slice(-DAYS);
    const idx = {}; labels.forEach((d,i)=> idx[d]=i);

    const ds = {};
    for(const k of keys){
      const arr = new Array(labels.length).fill(0);
      const n   = new Array(labels.length).fill(0);
      for(const p of (data.series[k]||[])){
        if(!(p.d in idx)) continue;
        const i = idx[p.d];
        arr[i] += +p.views||0;
        n[i]   += +p.n||0;
      }
      const recentN = sumArr(n.slice(-14)) / Math.max(1, Math.min(14, n.slice(-14).length));
      if(recentN < MINN) continue;
      const ema28 = smoothing? ema(arr, 28) : arr;
      const ema7  = smoothing? ema(arr, 7) : arr;
      const M = ema7.map((v,i)=> (ema28[i]>0? (v/Math.max(ema28[i],1e-9)-1)*100 : 0));
      const A = M.map((v,i)=> v - (i>=7 ? M[i-7] : 0));
      const zM = zscore(M, 28), zA = zscore(A, 28);
      const score = zM.map((z,i)=> z*0.55 + (zA[i]||0)*0.25);
      ds[k] = { views:arr, ema28, score, n };
    }
    const usableKeys = Object.keys(ds).sort((a,b)=> (ds[b].score.at(-1)||0)-(ds[a].score.at(-1)||0));
    
    (function(){
      const __sr_sumArr = (arr)=>arr.reduce((a,b)=>a+(+b||0),0);
      const __sr_last7  = (arr)=>arr.slice(Math.max(0, arr.length-7));
      if (!Array.isArray(window.shareCounts) || !window.shareCounts.length){
        window.shareCounts = (usableKeys || []).map(k => __sr_sumArr(__sr_last7(ds[k].views || [])));
      }
    })();
    
    const tot = (Array.isArray(window.shareCounts)? window.shareCounts.reduce((a,b)=>a+(+b||0),0) : 0) || 1;

    const datasets = usableKeys.map(k=> ({
      label:k, borderColor:palettes[k],
      data: (metric==='views'? ds[k].views : metric==='ema28'? ds[k].ema28 : ds[k].score),
      borderWidth:2, tension:0.25, pointRadius:0, pointHoverRadius:0, hitRadius:6, showLine:true, spanGaps:false, hidden:false
    }));

    const pills = document.getElementById('ltPills');
    if(pills){ pills.innerHTML = usableKeys.map(k=> `<span class="pill" data-key="${k}">${k}</span>`).join('');
      pills.querySelectorAll('.pill').forEach(el=>{
        el.addEventListener('click', ()=>{
          const k = el.dataset.key; const dsObj = ltChart.data.datasets.find(d=> d.label===k);
          dsObj.hidden = !dsObj.hidden; el.classList.toggle('off', dsObj.hidden); ltChart.update();
        });
      });
    }

    destroyLT();
    ltChart = new Chart(document.getElementById('ltChart'), {
      type:'line',
      data:{ labels, datasets },
      options:{
        responsive:true, maintainAspectRatio:false,
        interaction:{mode:'index',intersect:false},
        plugins:{ tooltip:{ itemSort:(a,b)=>{ const by=(b?.parsed?.y ?? b?.raw ?? 0); const ay=(a?.parsed?.y ?? a?.raw ?? 0); return by-ay; } },  legend:{display:false}, decimation:{enabled:true, algorithm:'min-max'} },
        elements:{ point:{ radius:0, hoverRadius:0, hitRadius:6 }, line:{ tension:0.25, borderWidth:2 } },
        scales:{
          x:{grid:{color:'rgba(255,255,255,0.04)'}},
          y:{grid:{color:'rgba(255,255,255,0.04)'},
             ticks:{ callback:v=> v>=1e6? (v/1e6).toFixed(1)+'M' : (v>=1e3? (v/1e3).toFixed(0)+'k' : (v.toFixed?v.toFixed(0):v)) } }
        }
      }
    });

    function sumRange(arr, days, eps){
      const L = arr.length; const mid=Math.max(0,L-days); const start=Math.max(0,L-days*2);
      const prev = sumArr(arr.slice(start, mid)); const now = sumArr(arr.slice(mid, L));
      if (prev < (eps||1000)) return {prev, now, label:'NEW'};
      const pct = Math.round(Math.max(-99, Math.min(999, (now - prev) / Math.max(prev,1) * 100)));
      const label = (pct >= 0 ? '▲ ' : '▼ ') + Math.abs(pct) + '%';
      return {prev, now, label};
    }
    const rises = usableKeys.map(k=> ({k, ...sumRange(ds[k].views, 7, 1000)}))
                            .sort((a,b)=> b.now - a.now).slice(0,5);
    const risers = document.getElementById('ltRisers');
    if(risers) risers.innerHTML = rises.map((r,i)=> `<span class="pill"><b>${i+1}. ${r.k}</b> <i>${r.label}</i> <small>${fmt(r.now)}</small></span>`).join('');
    
    ltShare = new Chart(document.getElementById('ltShare'), {
      type:'bar',
      data:{ labels:usableKeys, datasets:[{label:'최근 30일 표본 비중(%)', data: shareCounts.map(x=> Math.round(x/tot*100))}] },
      options:{ responsive:true, maintainAspectRatio:false, layout:{padding:{top:4,right:8,bottom:0,left:8}},
        plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, max:100, grid:{color:'rgba(255,255,255,0.06)'}}} }
    });
    
    try{
      const vEl = document.getElementById('ltValidation');
      const eEl = document.getElementById('ltEndpoint');
      
      const L = labels.length;
      const DAYS_CHECK = Math.min(30, L);
      const startIdx = L - DAYS_CHECK;
      
      const totalViewsByDay  = Array(DAYS_CHECK).fill(0);
      const totalSampleByDay = Array(DAYS_CHECK).fill(0);
      
      let nonZero = 0;
      const expected = usableKeys.length * DAYS_CHECK;
      
      for (const k of usableKeys) {
        const vArr = ds[k].views.slice(startIdx, startIdx + DAYS_CHECK);
        const nArr = ds[k].n.slice(startIdx, startIdx + DAYS_CHECK);
        for (let i = 0; i < DAYS_CHECK; i++) {
          const v = +vArr[i] || 0;
          const n = +nArr[i] || 0;
          totalViewsByDay[i]  += v;
          totalSampleByDay[i] += n;
          if (v > 0) nonZero++;
        }
      }
      
      const sampleN   = totalSampleByDay.reduce((a,b)=>a+b,0);
      const sumViews  = totalViewsByDay.reduce((a,b)=>a+b,0);
      const avgSample = Math.round(sampleN / DAYS_CHECK);
      const avgViews  = Math.round(sumViews / DAYS_CHECK);
      
      const minV = Math.round(Math.min(...totalViewsByDay));
      const maxV = Math.round(Math.max(...totalViewsByDay));
      
      const miss = expected > 0 ? Math.max(0, 1 - nonZero / expected) : 1;
      
      if (vEl) {
        vEl.innerHTML = [
          `<span class="pill">표본수: ${sampleN.toLocaleString()}</span>`,
          `<span class="pill">일평균 표본수: ${avgSample.toLocaleString()}</span>`,
          `<span class="pill ${miss>0.4?'danger':(miss>0.2?'warn':'')}">결측 비중: ${Math.round(miss*100)}%</span>`,
          `<span class="pill">일 조회합 범위: ${minV.toLocaleString()} ~ ${maxV.toLocaleString()}</span>`,
          `<span class="pill">일평균 조회수: ${avgViews.toLocaleString()}</span>`,
          `<span class="pill">사용 키워드: ${usableKeys.length}</span>`,
          `<span class="pill">엔드포인트: <code>${window.__LT_ENDPOINT__ || 'sample'}</code></span>`
        ].join(' ');
      }
      
      if (eEl) eEl.textContent = window.__LT_ENDPOINT__ || '-';
    }catch(e){ console.warn('validation error', e); }
  }
  setTimeout(()=>{ const btn = document.getElementById('ltReload'); if(btn) btn.addEventListener('click', buildLongTrend); buildLongTrend(); },0);

  // ---------- 스냅샷 v7.4.2 ----------
  function saveSnapshot(){
    try {
      if(!STATE.videos || !STATE.videos.length) return false;
      
      const snapshot = {
        version: '7.4.2',
        timestamp: Date.now(),
        date: new Date().toISOString(),
        data: {
          videos: STATE.videos,
          filters: STATE.filters || {},
          sortKey: STATE.sortKey || 'uploadedAt',
          sortDir: STATE.sortDir || 'desc',
          colVis: STATE.colVis || {}
        }
      };
      
      localStorage.setItem('sr_snapshot_v74', JSON.stringify(snapshot));
      console.log('[SR] Snapshot saved:', STATE.videos.length, 'videos');
      return true;
    } catch(e) {
      console.error('[SR] Snapshot save failed:', e);
      return false;
    }
  }
  
  function loadSnapshot(){
    try {
      const raw = localStorage.getItem('sr_snapshot_v74');
      if(!raw) {
        console.log('[SR] No snapshot found');
        return false;
      }
      
      const snapshot = JSON.parse(raw);
      if(!snapshot || !snapshot.data || !snapshot.data.videos || !snapshot.data.videos.length) {
        console.log('[SR] Invalid snapshot');
        return false;
      }
      
      // 24시간 이내 체크
      const age = Date.now() - snapshot.timestamp;
      if(age > 24 * 3600 * 1000) {
        console.log('[SR] Snapshot too old:', Math.round(age/3600000), 'hours');
        localStorage.removeItem('sr_snapshot_v74');
        return false;
      }
      
      // STATE 복원
      STATE.videos = snapshot.data.videos;
      STATE.filters = snapshot.data.filters || {};
      STATE.sortKey = snapshot.data.sortKey || 'uploadedAt';
      STATE.sortDir = snapshot.data.sortDir || 'desc';
      STATE.colVis = snapshot.data.colVis || STATE.colVis || {};
      
      // UI 복원
      if($('#fMinER')) $('#fMinER').value = STATE.filters.minER || 0;
      if($('#fMinVX')) $('#fMinVX').value = STATE.filters.minVX || 0;
      if($('#fMinGrade')) $('#fMinGrade').value = STATE.filters.minGrade || 'ALL';
      if($('#sortKey')) $('#sortKey').value = STATE.sortKey;
      if($('#sortDir')) $('#sortDir').value = STATE.sortDir;
      
      // 테이블 렌더링
      renderTable(STATE.videos);
      
      // 복원 알림 표시
      const wrap = $('.wrap');
      if(wrap) {
        const notice = document.createElement('div');
        notice.className = 'card snapshot-notice';
        const ageMin = Math.round(age / 60000);
        const ageHour = Math.round(age / 3600000);
        const ageText = ageHour > 0 ? ageHour + '시간' : ageMin + '분';
        notice.innerHTML = `✅ <b>${ageText} 전</b> 검색 결과를 복원했습니다. (${STATE.videos.length}개 영상)`;
        wrap.insertBefore(notice, wrap.children[2]);
        
        setTimeout(function(){
          notice.style.transition = 'all 0.5s';
          notice.style.opacity = '0';
          setTimeout(function(){ notice.remove(); }, 500);
        }, 5000);
      }
      
      console.log('[SR] Snapshot loaded:', STATE.videos.length, 'videos from', new Date(snapshot.timestamp));
      return true;
    } catch(e) {
      console.error('[SR] Snapshot load failed:', e);
      return false;
    }
  }

  // ---------- 이벤트 바인딩 ----------
  $('#runBtn').addEventListener('click', run);
  $('#exportXlsx').addEventListener('click', exportXlsx);
  $('#saveKey').addEventListener('click', ()=>{
    const raw = ($('#apiKey').value || '').trim();
    const tokens = raw.split(/[\s,;|\/\\]+/).map(s=>s.trim()).filter(Boolean);
    const keys = Array.from(new Set(tokens));
    if(!keys.length) return alert('1개 이상 키를 입력하세요.');
    localStorage.removeItem('yt_api_key');
    const old = JSON.parse(localStorage.getItem('yt_api_keys')||'[]');
    const merged = Array.from(new Set([...(Array.isArray(old)?old:[]), ...keys]));
    localStorage.setItem('yt_api_keys', JSON.stringify(merged));
    $('#apiKey').value='';
    ROT.load();
    alert(`${keys.length}개 추가됨 · 총 ${merged.length}개 저장됨`);
  });
  $('#resetBtn').addEventListener('click', ()=>{ if(confirm('모든 설정을 초기화할까요?')){ localStorage.clear(); location.reload(); } });
  $('#quotaApply').addEventListener('click', ()=> setQuotaLimit($('#quotaLimit').value) );
  $('#quotaReset').addEventListener('click', resetQuota);
  $('#btnReprobe').addEventListener('click', ()=>{
    STATE.videos.forEach(v => STATE.watch.has(v.id) && pushSnapshot(v.id, v));
    alert('워치리스트 영상들의 현재 조회수를 저장했습니다.');
  });

  // 필터
  $('#fMinER').addEventListener('change', ()=>{ STATE.filters.minER = +$('#fMinER').value||0; renderTable(STATE.videos); });
  $('#fMinVX').addEventListener('change', ()=>{ STATE.filters.minVX = +$('#fMinVX').value||0; renderTable(STATE.videos); });
  $('#fMinGrade').addEventListener('change', ()=>{ STATE.filters.minGrade = $('#fMinGrade').value; renderTable(STATE.videos); });
  $('#viewPreset').addEventListener('change', ()=>{ 
    const p=$('#viewPreset').value;
    const keys=Object.keys(defaultColVis());
    const on={}; keys.forEach(k=>on[k]=false);
    if(p==='all'){ keys.forEach(k=>on[k]=true); }
    else if(p==='simple'){ ['thumb','title','channel','uploadedAt','pick'].forEach(k=>on[k]=true); on.bookmark=true; }
    else if(p==='speedeng'){ ['thumb','title','vel','er','pick'].forEach(k=>on[k]=true); on.bookmark=true; }
    else if(p==='metrics'){ ['vel','er','fresh','viewMult','velMult','impact','pick'].forEach(k=>on[k]=true); on.bookmark=true; on.title=true; on.thumb=true; }
    else if(p==='packaging'){ ['thumb','title','uploadedAt','likes','comments','impact','delta','pick'].forEach(k=>on[k]=true); on.bookmark=true; }
    STATE.colVis=on; save('sr_cols', on); buildColToggles(); applyColumnVisibility();
  });

  // 초기화
  (function init(){
    ROT.load();
    const savedCols = load('sr_cols', null); if(savedCols) STATE.colVis=savedCols;
    const savedSortKey = load('sr_sortKey', null); if(savedSortKey) STATE.sortKey=savedSortKey;
    const savedSortDir = load('sr_sortDir', null); if(savedSortDir) STATE.sortDir=savedSortDir;
    loadWatch();
    renderQuota(); 
    renderQuotaStateFlag();
    buildSortKeys();
    buildColToggles();
    applyColumnVisibility();
    
    // 스냅샷 복원 시도
    setTimeout(function(){
      if(!STATE.videos || STATE.videos.length === 0){
        loadSnapshot();
      }
    }, 100);
  })();
  
  // 페이지 떠날 때 저장
  window.addEventListener('beforeunload', saveSnapshot);
  window.addEventListener('pagehide', saveSnapshot);
})();
</script>

<!-- Light Rules v2.2 (원본 복구) -->
<script>
/* Light Rules v2.2 (Unified)
 * - 리뷰: "제품 리뷰만" 유지, 음식/요리/맛집 & 영화·드라마 리뷰는 제외/재분류
 * - 영화·드라마 리뷰는 메인 카테고리를 '연예'로 재분류
 * - 연예: 우선순위 없이 멀티 태깅(팬 / 예능 / 영화·드라마 하이라이트 / 소식·찌)
 * - 네트워크 호출 0 / 쿼터 0 / UI 미변경
 */
(function(){
  if (window.__LIGHT_RULES_V22) return; window.__LIGHT_RULES_V22 = true;

  /* ============ 0) 설정 ============ */
  const CFG = {
    // true: '리뷰'인데 제품 리뷰가 아니면 '기타'로 재분류(목록에서 자연히 빠짐)
    // false: 재분류 대신 v.flags에만 표시(외부 필터에서 숨길 때 사용)
    strictReviewOnly: true,

    // true: '영화·드라마 리뷰'를 '연예'로 자동 재분류
    reclassMovieDramaReviewsToEntertainment: true,

    // 콘솔 샘플 로그 (디버깅용)
    debugLogSample: false
  };

  /* ============ 1) 공통 유틸 ============ */
  function norm(s=''){
    s = (s||'').toString().toLowerCase();
    s = s.replace(/[\u200B-\u200D\uFEFF]/g,'');  // zero-width 제거
    s = s.replace(/\s+/g,' ').trim();
    return s;
  }
  function bagOf(v){
    const tags = Array.isArray(v?.tags) ? v.tags.join(' ')
               : (typeof v?.tags === 'string' ? v.tags : '');
    return norm([v?.title, v?.description, tags, v?.channelTitle, v?.channelDesc].join(' '));
  }

  /* ============ 2) 리뷰 정제 ============ */
  // 포함(+): 리뷰/사용기 맥락 신호
  const RV_POS = /(리뷰|사용기|언박싱|언팩|개봉기|후기|비교|추천|체험단|하울|불량|테스트|벤치|스펙|사양|가격|쿠폰|구매|가성비|설치기|업데이트|성능|배터리|충전)/i;

  // 제품 힌트(가점)
  const RV_PRODUCT_HINT = /(스마트폰|휴대폰|아이폰|갤럭시|노트북|맥북|태블릿|아이패드|이어폰|헤드폰|모니터|tv|프로젝터|냉장고|에어컨|청소기|세탁기|건조기|카메라|렌즈|드론|마이크|스피커|자동차|블랙박스|타이어|게이밍|골프채|자전거|시계|가방|의류)/i;

  // 제외(−): 음식/요리/맛집 리뷰
  const RV_NEG_FOOD = /(먹방|맛집|레시피|식당|카페|요리|쿠킹|디저트|라면|초밥|포차|술집)/i;

  // 제외(−): 영화·드라마 리뷰/감상/해설 등
  const RV_NEG_CINEMA = new RegExp(
    '(영화|드라마|시리즈|웹드라마|OTT|넷플릭스|디즈니\\+|티빙|웨이브|쿠팡플레이).*'
    + '(리뷰|해설|결말|평론|관람기|시사회|감상|후기|스포|줄거리|명장면|해설|분석|평점|쿠키(영상)?)','i'
  );

  function reviewSubtype(bag){
    if (RV_NEG_FOOD.test(bag)) return 'food';
    if (RV_NEG_CINEMA.test(bag)) return 'movie/series';
    if (RV_POS.test(bag) && (RV_PRODUCT_HINT.test(bag) || /제품|모델|사양|스펙/.test(bag))) return 'product';
    if (RV_POS.test(bag)) return 'product'; // 느슨한 허용(원하면 보수적으로 'other'로)
    return 'other';
  }
  function isProductReview(bag){ return reviewSubtype(bag) === 'product'; }

  /* ============ 3) 연예 멀티 태깅(우선순위 없음) ============ */
  const R_FAN = /(팬캠|fancam|직캠|직찍|face\s?cam|focus|member\s?focus|stage\s?mix|교차편집|응원법|fanchant|엔딩요정|ending\s?fairy)/i;
  const R_VAR_KW = /(하이라이트|레전드|모음|웃긴|빵터진|컷\b|편집본|요약|스페셜|비하인드|ng)/i;
  const R_VAR_SHOW = /(런닝맨|나혼산|나\s*혼자\s*산다|유퀴즈|라디오스타|무한도전|미우새|놀면뭐하니|1박2일|신서유기|코빅|아는형님|전지\s?적\s?참견\s?시점|복면가왕)/i;
  const R_FILMDR = /(영화|드라마|시리즈|웹드라마|ott).*(하이라이트|명장면|클립|컷\b|티저|예고|미리보기|명대사|키스신|액션신|ost|스틸)|\b명장면\b|\b명대사\b/i;
  const R_NEWS = /(찌|소식|열애|열애설|결별|결별설|논란|단독|속보|입장|해명|정리|해설|사실무근|사과|복귀|하차|합류|소속사|전속계약|분쟁|소송|병역|입대|결혼|출산)/i;

  function entSubs(bag){
    const out = [];
    if (R_FAN.test(bag)) out.push('팬');
    if (R_VAR_KW.test(bag) || R_VAR_SHOW.test(bag)) out.push('예능');
    if (R_FILMDR.test(bag) || /영화\s*리뷰|드라마\s*리뷰/.test(bag)) out.push('영화/드라마 하이라이트'); // 리뷰도 포함
    if (R_NEWS.test(bag)) out.push('소식/찌');
    return Array.from(new Set(out.length ? out : ['기타']));
  }

  /* ============ 4) 렌더 파이프라인에 얇게 주입 ============ */
  const _renderTable = window.renderTable || function(l){ return l; };
  window.renderTable = function(list){
    try{
      (list||[]).forEach(v=>{
        const bag = bagOf(v);

        // A) 리뷰 처리
        if (v.mainCat === '리뷰') {
          const subtype = reviewSubtype(bag);
          v.flags = v.flags || {}; v.flags.reviewType = subtype;

          // 영화·드라마 리뷰 → 연예로 재분류
          if (CFG.reclassMovieDramaReviewsToEntertainment && subtype === 'movie/series') {
            v._wasReview = true;
            v.mainCat = '연예';
          } else if (CFG.strictReviewOnly && subtype !== 'product') {
            // 제품 리뷰가 아니면 기타로 재분류(엄격 모드)
            v.mainCat = '기타';
          }
        }

        // B) 연예 멀티 태깅(재분류된 케이스 포함)
        if (v.mainCat === '연예') {
          const subs = entSubs(bag);
          v.entSubs = subs;             // 배열(필터/집계에 유용)
          v.entSub  = subs.join(' · '); // 문자열(표시용; 현재 UI는 그대로)
        }

        if (CFG.debugLogSample && Math.random()<0.003) {
          console.log('[LR v2.2 sample]', {id:v.id||v.videoId, main:v.mainCat, review:v.flags?.reviewType, entSubs:v.entSubs, title:v.title});
        }
      });
    } catch(e){ console.warn('[LightRules v2.2] patch error', e); }
    return _renderTable.apply(this, arguments);
  };
})();
</script>
  
</body>
</html>
