<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>YouTube Content Radar - 통합판 v8.0</title>
  <link rel="icon" href="data:,">
  <style>
    :root { 
      --bg:#f8f9fa; 
      --card:#ffffff; 
      --muted:#6b7280; 
      --text:#1f2937; 
      --accent:#10b981; 
      --accent2:#3b82f6; 
      --warn:#f59e0b; 
    }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Pretendard,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px 84px;position:relative}
    h1{font-weight:800;letter-spacing:-.4px;font-size:26px;margin:0 0 14px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:18px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .card{background:#ffffff;border:1px solid #e5e7eb;border-radius:14px;padding:14px 14px 16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input,select,button{border-radius:10px;border:1px solid #d1d5db;background:#ffffff;color:var(--text);padding:9px 11px;font-size:14px}
    input::placeholder{color:#9ca3af}
    button{cursor:pointer;background:#f9fafb;border:1px solid #d1d5db}
    button.primary{background:linear-gradient(180deg,#3b82f6,#2563eb);border:0;color:#fff}
    button.ghost{background:transparent;border:1px dashed #d1d5db}
    button.danger{background:#fee2e2;border:1px solid #f87171;color:#991b1b}
    .hint{color:var(--muted);font-size:12px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .pill{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:8px 12px;font-size:12px;color:#4b5563;cursor:pointer}
    .pill.active{background:#d1fae5;border-color:#10b981;color:#065f46}
    .pill.blocked{background:#fee2e2;border-color:#f87171;color:#991b1b}
    .table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left;font-size:13px}
    th{color:#6b7280;font-weight:600;white-space:nowrap}
    #table thead th{position:sticky;top:0;background:#f8fafc;z-index:3}
    .thumb{width:120px;height:68px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;object-fit:cover}
    .badge{padding:4px 8px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb;font-size:11px}
    .grade-S{background:#d1fae5;border-color:#10b981;color:#065f46}
    .grade-A{background:#dbeafe;border-color:#3b82f6;color:#1e40af}
    .grade-B,.grade-C{background:#f3f4f6;border-color:#d1d5db;color:#4b5563}
    .grade-D{background:#f9fafb;border-color:#e5e7eb;color:#9ca3af}
    .good{color:#10b981}
    .warn{color:var(--warn)}
    .qbar{position:relative;height:8px;width:160px;border:1px solid #e5e7eb;border-radius:999px;overflow:hidden;background:#f9fafb}
    .qfill{height:100%;background:linear-gradient(90deg,#10b981,#3b82f6);transition:width .4s ease}
    .progress-wrapper{display:inline-flex;align-items:center;gap:6px}
    #chart{height:240px;border-radius:12px;overflow:hidden}
    .loader{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:48px;height:48px;border:4px solid #e5e7eb;border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg)}100%{transform:translate(-50%,-50%) rotate(360deg)}}
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:999}
    .modal.open{display:flex}
    .modal-content{background:#fff;border-radius:16px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;padding:24px;position:relative}
    .close{position:absolute;top:12px;right:12px;width:32px;height:32px;border-radius:50%;background:#f3f4f6;border:0;cursor:pointer;font-size:18px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin:16px 0}
    .stat-box{background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:10px;text-align:center}
    .stat-label{font-size:11px;color:#6b7280;margin-bottom:4px}
    .stat-value{font-size:18px;font-weight:700}
    .mini-chart{height:60px;margin-top:8px}
    .tabs{display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid #e5e7eb}
    .tab{padding:8px 16px;background:transparent;border:0;cursor:pointer;border-bottom:2px solid transparent;color:#6b7280}
    .tab.active{color:#3b82f6;border-bottom-color:#3b82f6}
    .empty{text-align:center;padding:40px;color:#9ca3af}
    .filters{background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin-bottom:16px}
    .btn-group{display:flex;gap:8px;flex-wrap:wrap}
    input[type="range"]{width:100%}
    .range-labels{display:flex;justify-content:space-between;font-size:11px;color:#6b7280;margin-top:4px}
    .toolbar{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
    @media (max-width:640px){.grid.cols-2{grid-template-columns:1fr}.table{font-size:11px}th,td{padding:6px}.thumb{width:80px;height:45px}}
    .content-type-badge{
      display:inline-block;
      padding:2px 6px;
      border-radius:4px;
      font-size:10px;
      font-weight:600;
      margin-left:4px;
    }
    .type-short{background:#fef3c7;color:#92400e}
    .type-mid{background:#dbeafe;color:#1e40af}
    .type-long{background:#e0e7ff;color:#3730a3}
    .type-vlong{background:#fce7f3;color:#9f1239}
    .duration-display{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:12px;
      color:#6b7280;
    }
    .metric-longform{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .metric-label{
      font-size:10px;
      color:#9ca3af;
    }
    .metric-value{
      font-size:13px;
      font-weight:600;
    }
    .compare-card{
      background:linear-gradient(135deg,#f0f9ff,#f0fdf4);
      border:1px solid #cbd5e1;
      border-radius:12px;
      padding:16px;
      margin-top:12px;
    }
    .compare-row{
      display:flex;
      justify-content:space-between;
      margin:8px 0;
    }
    .compare-label{
      font-size:12px;
      color:#64748b;
    }
    .compare-value{
      font-size:14px;
      font-weight:600;
    }
  </style>
  <script src="https://unpkg.com/chart.js@4.3.0/dist/chart.umd.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>🚀 YouTube Content Radar v8.0</h1>
    <div class="sub">쇼츠 & 롱폼 통합 분석 도구 | 실시간 트렌드 추적 | 벤치마킹 대시보드</div>
    
    <div class="card">
      <h3>🔍 검색 설정</h3>
      <div class="row">
        <select id="mode">
          <option value="keyword">키워드 검색</option>
          <option value="channel">채널 검색</option>
          <option value="seedless">시드리스 (자동)</option>
        </select>
        <input id="query" type="text" placeholder="검색어 입력..." style="flex:1" />
        <select id="contentType">
          <option value="all" selected>전체 콘텐츠</option>
          <option value="shorts">쇼츠만 (≤60초)</option>
          <option value="long">롱폼만 (>60초)</option>
          <option value="mid">미드폼 (1-10분)</option>
          <option value="vlong">초장편 (>20분)</option>
        </select>
      </div>
      
      <div class="row" style="margin-top:8px">
        <label>최소 길이(초)</label>
        <input id="minDuration" type="number" value="0" min="0" style="width:80px"/>
        <label>최대 길이(초)</label>
        <input id="maxDuration" type="number" value="3600" max="86400" style="width:80px"/>
        <select id="region">
          <option value="KR">한국</option>
          <option value="US">미국</option>
          <option value="JP">일본</option>
        </select>
        <select id="lang">
          <option value="ko">한국어</option>
          <option value="en">영어</option>
          <option value="ja">일본어</option>
        </select>
      </div>
      
      <div class="row" style="margin-top:8px">
        <label>기간</label>
        <select id="days">
          <option value="1">24시간</option>
          <option value="7" selected>7일</option>
          <option value="30">30일</option>
          <option value="90">90일</option>
          <option value="365">1년</option>
        </select>
        <label>결과</label>
        <input id="maxResults" type="number" value="50" min="10" max="200" style="width:60px"/>
        <button class="primary" onclick="search()">🔍 검색</button>
        <button onclick="exportData()">📊 내보내기</button>
        <button onclick="openWatchlist()">👁️ 워치리스트</button>
      </div>
      <div class="hint">💡 시드리스 모드: 16개 카테고리별 인기 영상 자동 수집</div>
    </div>

    <div class="card" id="categories" style="display:none">
      <h3>📁 카테고리 필터</h3>
      <div class="kpi" id="categoryFilters"></div>
      <div style="margin-top:10px">
        <button class="ghost" onclick="selectAllCategories()">전체 선택</button>
        <button class="ghost" onclick="deselectAllCategories()">전체 해제</button>
      </div>
    </div>

    <div class="card" id="summary" style="display:none">
      <h3>📊 요약 통계</h3>
      <div class="grid cols-2" style="gap:16px">
        <div>
          <div class="stats-grid" id="statsGrid"></div>
        </div>
        <div>
          <canvas id="chart"></canvas>
        </div>
      </div>
      
      <div class="compare-card" id="formatComparison" style="display:none">
        <h4 style="margin:0 0 12px">🎬 포맷별 성과 비교</h4>
        <div class="compare-row">
          <span class="compare-label">쇼츠 평균 조회수</span>
          <span class="compare-value" id="shortsAvgViews">-</span>
        </div>
        <div class="compare-row">
          <span class="compare-label">롱폼 평균 조회수</span>
          <span class="compare-value" id="longAvgViews">-</span>
        </div>
        <div class="compare-row">
          <span class="compare-label">최적 포맷</span>
          <span class="compare-value" id="optimalFormat">-</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:12px">
        <h3 style="margin:0">📋 결과</h3>
        <div class="toolbar">
          <button class="ghost" onclick="toggleSnapshot()">📸 스냅샷</button>
          <button class="ghost" onclick="showTrends()">📈 장기트렌드</button>
          <select id="sortBy" onchange="sortTable()">
            <option value="views">조회수순</option>
            <option value="speed">속도순</option>
            <option value="er">반응률순</option>
            <option value="fresh">신선도순</option>
            <option value="impact">임팩트순</option>
            <option value="rpm">RPM순</option>
            <option value="retention">지속률순</option>
          </select>
        </div>
      </div>
      
      <div id="tableWrap" style="overflow-x:auto">
        <table class="table" id="table">
          <thead><tr id="tableHeaders"></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="empty" id="empty">검색을 시작하세요</div>
    </div>
  </div>

  <div class="loader" id="loader" style="display:none"></div>
  
  <div class="modal" id="channelModal">
    <div class="modal-content">
      <button class="close" onclick="closeModal()">✕</button>
      <h2 id="modalTitle">채널 분석</h2>
      <div id="modalContent"></div>
    </div>
  </div>

  <div class="modal" id="watchlistModal">
    <div class="modal-content">
      <button class="close" onclick="closeWatchlist()">✕</button>
      <h2>👁️ 워치리스트</h2>
      <div class="tabs">
        <button class="tab active" onclick="switchWatchTab(0,this)">영상 추적</button>
        <button class="tab" onclick="switchWatchTab(1,this)">24시간 스냅샷</button>
      </div>
      <div id="watchContent"></div>
    </div>
  </div>

  <div class="modal" id="trendsModal">
    <div class="modal-content" style="max-width:800px">
      <button class="close" onclick="closeTrends()">✕</button>
      <h2>📈 장기 트렌드 분석</h2>
      <div id="trendsContent"></div>
    </div>
  </div>

  <script>
    const API_KEY = 'AIzaSyCEzcUYLaItoSqA3ELRP6mFmgvxJzT8hzQ';
    const API_BASE = 'https://www.googleapis.com/youtube/v3';
    
    const STATE = {
      videos: [],
      categories: [],
      chart: null,
      watchlist: JSON.parse(localStorage.getItem('ytWatchlist') || '[]'),
      snapshots: JSON.parse(localStorage.getItem('ytSnapshots') || '[]'),
      trends: JSON.parse(localStorage.getItem('ytTrends') || '{}')
    };

    const CATEGORIES = [
      {id:'music',name:'음악',weight:3,keywords:['음악 쇼츠','kpop 쇼츠','뮤직비디오 shorts','노래 shorts']},
      {id:'game',name:'게임',weight:3,keywords:['게임 쇼츠','game shorts','gameplay shorts','gaming shorts']},
      {id:'comedy',name:'코미디',weight:2,keywords:['웃긴 쇼츠','코미디 shorts','funny shorts','개그 shorts']},
      {id:'food',name:'음식',weight:2,keywords:['먹방 쇼츠','요리 shorts','food shorts','맛집 shorts']},
      {id:'beauty',name:'뷰티',weight:2,keywords:['메이크업 쇼츠','뷰티 shorts','화장 shorts','skincare shorts']},
      {id:'pet',name:'동물',weight:2,keywords:['강아지 쇼츠','고양이 shorts','pet shorts','동물 shorts']},
      {id:'sports',name:'스포츠',weight:1,keywords:['축구 쇼츠','sports shorts','야구 shorts','운동 shorts']},
      {id:'news',name:'뉴스',weight:1,keywords:['뉴스 쇼츠','시사 shorts','news shorts','이슈 shorts']},
      {id:'tech',name:'테크',weight:1,keywords:['tech shorts','기술 shorts','IT shorts','gadget shorts']},
      {id:'edu',name:'교육',weight:1,keywords:['교육 쇼츠','study shorts','공부 shorts','learning shorts']},
      {id:'vlog',name:'일상',weight:2,keywords:['일상 쇼츠','브이로그 shorts','vlog shorts','daily shorts']},
      {id:'dance',name:'댄스',weight:2,keywords:['댄스 쇼츠','dance shorts','춤 shorts','안무 shorts']},
      {id:'drama',name:'드라마',weight:1,keywords:['드라마 쇼츠','drama shorts','웹드라마 shorts','시리즈 shorts']},
      {id:'kids',name:'키즈',weight:1,keywords:['키즈 쇼츠','어린이 shorts','kids shorts','아이들 shorts']},
      {id:'senior',name:'시니어',weight:1,keywords:['시니어','중년','50대','60대']},
      {id:'pride',name:'국뽁',weight:1,keywords:['국뽁','한국','korea','korean','k-']}
    ];

    // 콘텐츠 타입 판별
    function getContentType(duration) {
      if (typeof duration === 'string') {
        duration = isoToSeconds(duration);
      }
      if (duration <= 60) return 'shorts';
      if (duration <= 600) return 'mid';
      if (duration <= 1200) return 'long';
      return 'vlong';
    }

    // ISO 8601 duration을 초로 변환
    function isoToSeconds(duration) {
      const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      if (!match) return 0;
      const hours = parseInt(match[1] || 0);
      const minutes = parseInt(match[2] || 0);
      const seconds = parseInt(match[3] || 0);
      return hours * 3600 + minutes * 60 + seconds;
    }

    // 시간 포맷팅
    function formatDuration(seconds) {
      if (seconds < 60) return `${seconds}초`;
      if (seconds < 3600) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return s > 0 ? `${m}분 ${s}초` : `${m}분`;
      }
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      return m > 0 ? `${h}시간 ${m}분` : `${h}시간`;
    }

    // 롱폼 전용 지표 계산
    function computeLongformMetrics(video) {
      const duration = isoToSeconds(video.contentDetails.duration);
      const views = parseInt(video.statistics.viewCount || 0);
      const likes = parseInt(video.statistics.likeCount || 0);
      const comments = parseInt(video.statistics.commentCount || 0);
      const publishedAt = new Date(video.snippet.publishedAt);
      const ageInDays = Math.max(1, (Date.now() - publishedAt) / 86400000);
      
      // 평균 시청시간 추정 (참여율 기반)
      const engagementRate = (likes + comments) / Math.max(1, views);
      const estimatedRetention = Math.min(0.8, 0.3 + engagementRate * 50);
      const avgViewDuration = Math.round(duration * estimatedRetention);
      
      // 시청 지속률 점수 (0-100)
      const retentionScore = Math.round(estimatedRetention * 100);
      
      // RPM 추정 (수익성)
      let rpm = 0;
      if (duration > 480) { // 8분 이상
        rpm = 3.5 + (engagementRate * 100);
      } else if (duration > 60) {
        rpm = 1.5 + (engagementRate * 50);
      }
      
      // 에버그린 점수 (지속적 조회수)
      const dailyViews = views / ageInDays;
      const decayFactor = Math.exp(-ageInDays / 365);
      const evergreenScore = Math.round(dailyViews * (1 - decayFactor) / 100);
      
      return {
        avgViewDuration,
        retentionScore,
        rpm: rpm.toFixed(2),
        evergreenScore,
        formattedDuration: formatDuration(duration),
        contentType: getContentType(duration)
      };
    }

    // 테이블 헤더 업데이트
    function updateTableHeaders() {
      const contentType = document.getElementById('contentType').value;
      const headers = document.getElementById('tableHeaders');
      
      let cols = ['썸네일', '제목/채널', '길이'];
      
      if (contentType === 'shorts') {
        cols.push('속도', '반응률', '신선도', '임팩트', '등급');
      } else if (contentType === 'long' || contentType === 'mid' || contentType === 'vlong') {
        cols.push('평균시청', '지속률', 'RPM', '에버그린', '등급');
      } else {
        cols.push('타입', '조회수', '반응률', 'RPM', '등급');
      }
      
      headers.innerHTML = cols.map(col => `<th>${col}</th>`).join('');
    }

    // YouTube API 검색
    async function ytSearch(params) {
      const defaultParams = {
        part: 'id,snippet',
        type: 'video',
        maxResults: 50,
        order: 'viewCount',
        key: API_KEY
      };
      
      // 콘텐츠 타입에 따른 duration 파라미터 설정
      const contentType = document.getElementById('contentType').value;
      const minDur = parseInt(document.getElementById('minDuration').value) || 0;
      const maxDur = parseInt(document.getElementById('maxDuration').value) || 86400;
      
      if (contentType === 'shorts' || maxDur <= 240) {
        defaultParams.videoDuration = 'short';
      } else if (contentType === 'mid' || (minDur > 240 && maxDur <= 1200)) {
        defaultParams.videoDuration = 'medium';
      } else if (contentType === 'long' || contentType === 'vlong' || minDur > 1200) {
        defaultParams.videoDuration = 'long';
      }
      
      const url = new URL(`${API_BASE}/search`);
      Object.entries({...defaultParams, ...params}).forEach(([k, v]) => 
        url.searchParams.append(k, v)
      );
      
      const res = await fetch(url);
      return await res.json();
    }

    // 영상 상세 정보 가져오기
    async function fetchVideoDetails(videoIds) {
      const url = new URL(`${API_BASE}/videos`);
      url.searchParams.append('part', 'snippet,statistics,contentDetails');
      url.searchParams.append('id', videoIds.join(','));
      url.searchParams.append('key', API_KEY);
      
      const res = await fetch(url);
      return await res.json();
    }

    // 검색 실행
    async function search() {
      const mode = document.getElementById('mode').value;
      const query = document.getElementById('query').value;
      const region = document.getElementById('region').value;
      const lang = document.getElementById('lang').value;
      const days = document.getElementById('days').value;
      const maxResults = document.getElementById('maxResults').value;
      
      if (mode !== 'seedless' && !query.trim()) {
        alert('검색어를 입력하세요');
        return;
      }
      
      showLoader();
      STATE.videos = [];
      
      try {
        if (mode === 'seedless') {
          await seedlessSearch(region, lang, days, maxResults);
        } else {
          await keywordSearch(query, region, lang, days, maxResults, mode);
        }
        
        processResults();
      } catch(e) {
        console.error(e);
        alert('검색 중 오류 발생');
      } finally {
        hideLoader();
      }
    }

    // 시드리스 검색
    async function seedlessSearch(region, lang, days, maxResults) {
      const publishedAfter = new Date(Date.now() - days * 24 * 3600 * 1000).toISOString();
      const targetPerCategory = Math.ceil(maxResults / CATEGORIES.length);
      
      document.getElementById('categories').style.display = 'block';
      renderCategoryFilters();
      
      for (let i = 0; i < CATEGORIES.length; i++) {
        const cat = CATEGORIES[i];
        console.log(`[${i+1}/${CATEGORIES.length}] ${cat.name} 검색 중...`);
        
        const categoryVideos = [];
        for (const keyword of cat.keywords) {
          if (categoryVideos.length >= targetPerCategory) break;
          
          const res = await ytSearch({
            q: keyword,
            regionCode: region,
            relevanceLanguage: lang,
            publishedAfter,
            maxResults: 15
          });
          
          if (res.items && res.items.length > 0) {
            const videoIds = res.items.map(item => item.id.videoId);
            const details = await fetchVideoDetails(videoIds);
            
            if (details.items) {
              const filtered = details.items.filter(v => {
                const duration = isoToSeconds(v.contentDetails.duration);
                const minDur = parseInt(document.getElementById('minDuration').value) || 0;
                const maxDur = parseInt(document.getElementById('maxDuration').value) || 86400;
                return duration >= minDur && duration <= maxDur;
              });
              
              filtered.forEach(v => {
                v._category = cat.name;
                v._categoryId = cat.id;
              });
              
              categoryVideos.push(...filtered);
            }
          }
        }
        
        STATE.videos.push(...categoryVideos.slice(0, targetPerCategory));
      }
    }

    // 키워드/채널 검색
    async function keywordSearch(query, region, lang, days, maxResults, mode) {
      const publishedAfter = new Date(Date.now() - days * 24 * 3600 * 1000).toISOString();
      
      const params = {
        regionCode: region,
        relevanceLanguage: lang,
        publishedAfter,
        maxResults
      };
      
      if (mode === 'channel') {
        params.channelId = query;
      } else {
        params.q = query;
      }
      
      const res = await ytSearch(params);
      
      if (res.items && res.items.length > 0) {
        const videoIds = res.items.map(item => item.id.videoId);
        const details = await fetchVideoDetails(videoIds);
        
        if (details.items) {
          STATE.videos = details.items.filter(v => {
            const duration = isoToSeconds(v.contentDetails.duration);
            const minDur = parseInt(document.getElementById('minDuration').value) || 0;
            const maxDur = parseInt(document.getElementById('maxDuration').value) || 86400;
            return duration >= minDur && duration <= maxDur;
          });
        }
      }
    }

    // 결과 처리
    function processResults() {
      if (STATE.videos.length === 0) {
        document.getElementById('empty').style.display = 'block';
        document.getElementById('table').style.display = 'none';
        document.getElementById('summary').style.display = 'none';
        return;
      }
      
      // 파생 지표 계산
      STATE.videos.forEach(v => {
        const views = parseInt(v.statistics.viewCount || 0);
        const likes = parseInt(v.statistics.likeCount || 0);
        const comments = parseInt(v.statistics.commentCount || 0);
        const publishedAt = new Date(v.snippet.publishedAt);
        const hoursAgo = (Date.now() - publishedAt) / 3600000;
        const duration = isoToSeconds(v.contentDetails.duration);
        
        // 기본 지표
        v._d = {
          speed: Math.round(views / Math.max(1, hoursAgo)),
          er: ((likes + comments) / Math.max(1, views) * 100).toFixed(2),
          fresh: Math.round(100 * Math.exp(-hoursAgo / 168)),
          impact: Math.round(Math.log10(views + 1) * 20)
        };
        
        // 콘텐츠 타입별 추가 지표
        if (duration > 60) {
          const longMetrics = computeLongformMetrics(v);
          v._longform = longMetrics;
        }
        
        // 등급 산정
        const score = v._d.speed * 0.3 + parseFloat(v._d.er) * 10 + v._d.fresh * 0.2 + v._d.impact;
        if (score > 80) v._grade = 'S';
        else if (score > 60) v._grade = 'A';
        else if (score > 40) v._grade = 'B';
        else if (score > 20) v._grade = 'C';
        else v._grade = 'D';
      });
      
      sortTable();
      renderSummary();
      document.getElementById('empty').style.display = 'none';
      document.getElementById('table').style.display = 'table';
      document.getElementById('summary').style.display = 'block';
    }

    // 테이블 정렬
    function sortTable() {
      const sortBy = document.getElementById('sortBy').value;
      
      STATE.videos.sort((a, b) => {
        if (sortBy === 'views') return parseInt(b.statistics.viewCount) - parseInt(a.statistics.viewCount);
        if (sortBy === 'speed') return b._d.speed - a._d.speed;
        if (sortBy === 'er') return parseFloat(b._d.er) - parseFloat(a._d.er);
        if (sortBy === 'fresh') return b._d.fresh - a._d.fresh;
        if (sortBy === 'impact') return b._d.impact - a._d.impact;
        if (sortBy === 'rpm' && b._longform) return parseFloat(b._longform.rpm || 0) - parseFloat(a._longform?.rpm || 0);
        if (sortBy === 'retention' && b._longform) return (b._longform.retentionScore || 0) - (a._longform?.retentionScore || 0);
        return 0;
      });
      
      renderTable();
    }

    // 테이블 렌더링
    function renderTable() {
      updateTableHeaders();
      const tbody = document.getElementById('tbody');
      const contentType = document.getElementById('contentType').value;
      const filtered = filterVideos();
      
      tbody.innerHTML = filtered.map(v => {
        const duration = isoToSeconds(v.contentDetails.duration);
        const type = getContentType(duration);
        const typeLabel = {
          shorts: '쇼츠',
          mid: '미드',
          long: '롱폼',
          vlong: '초장편'
        }[type];
        
        let cols = `
          <td><img class="thumb" src="${v.snippet.thumbnails.medium.url}" onclick="window.open('https://youtube.com/watch?v=${v.id}')"></td>
          <td>
            <div style="font-weight:600">${v.snippet.title.slice(0,50)}</div>
            <div style="color:#6b7280;font-size:12px;cursor:pointer" onclick="showChannelModal('${v.snippet.channelId}')">${v.snippet.channelTitle}</div>
            ${v._category ? `<span class="badge" style="margin-top:4px">${v._category}</span>` : ''}
          </td>
          <td>
            <div class="duration-display">
              ${v._longform ? v._longform.formattedDuration : formatDuration(duration)}
              <span class="content-type-badge type-${type}">${typeLabel}</span>
            </div>
          </td>
        `;
        
        if (contentType === 'shorts') {
          cols += `
            <td>${v._d.speed.toLocaleString()}/h</td>
            <td>${v._d.er}%</td>
            <td>${v._d.fresh}%</td>
            <td>${v._d.impact}</td>
            <td><span class="badge grade-${v._grade}">${v._grade}</span></td>
          `;
        } else if (contentType === 'long' || contentType === 'mid' || contentType === 'vlong') {
          if (v._longform) {
            cols += `
              <td>${formatDuration(v._longform.avgViewDuration)}</td>
              <td>${v._longform.retentionScore}%</td>
              <td>$${v._longform.rpm}</td>
              <td>${v._longform.evergreenScore}</td>
              <td><span class="badge grade-${v._grade}">${v._grade}</span></td>
            `;
          } else {
            cols += `
              <td>-</td><td>-</td><td>-</td><td>-</td>
              <td><span class="badge grade-${v._grade}">${v._grade}</span></td>
            `;
          }
        } else {
          cols += `
            <td><span class="content-type-badge type-${type}">${typeLabel}</span></td>
            <td>${parseInt(v.statistics.viewCount).toLocaleString()}</td>
            <td>${v._d.er}%</td>
            <td>${v._longform ? '$' + v._longform.rpm : '-'}</td>
            <td><span class="badge grade-${v._grade}">${v._grade}</span></td>
          `;
        }
        
        return `<tr>${cols}</tr>`;
      }).join('');
    }

    // 영상 필터링
    function filterVideos() {
      let filtered = [...STATE.videos];
      
      // 카테고리 필터
      if (document.getElementById('mode').value === 'seedless') {
        const activeCategories = Array.from(document.querySelectorAll('.pill.active'))
          .map(el => el.dataset.id);
        if (activeCategories.length > 0) {
          filtered = filtered.filter(v => activeCategories.includes(v._categoryId));
        }
      }
      
      return filtered;
    }

    // 요약 통계 렌더링
    function renderSummary() {
      const videos = filterVideos();
      const totalViews = videos.reduce((sum, v) => sum + parseInt(v.statistics.viewCount), 0);
      const avgViews = Math.round(totalViews / videos.length);
      const avgER = (videos.reduce((sum, v) => sum + parseFloat(v._d.er), 0) / videos.length).toFixed(2);
      
      // 포맷별 분석
      const shorts = videos.filter(v => getContentType(isoToSeconds(v.contentDetails.duration)) === 'shorts');
      const longs = videos.filter(v => {
        const type = getContentType(isoToSeconds(v.contentDetails.duration));
        return type === 'mid' || type === 'long' || type === 'vlong';
      });
      
      document.getElementById('statsGrid').innerHTML = `
        <div class="stat-box">
          <div class="stat-label">총 영상</div>
          <div class="stat-value">${videos.length}</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">총 조회수</div>
          <div class="stat-value">${(totalViews/1000000).toFixed(1)}M</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">평균 조회수</div>
          <div class="stat-value">${(avgViews/1000).toFixed(0)}K</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">평균 반응률</div>
          <div class="stat-value">${avgER}%</div>
        </div>
      `;
      
      // 포맷 비교 표시
      if (shorts.length > 0 && longs.length > 0) {
        document.getElementById('formatComparison').style.display = 'block';
        
        const shortsAvg = Math.round(shorts.reduce((sum, v) => sum + parseInt(v.statistics.viewCount), 0) / shorts.length);
        const longsAvg = Math.round(longs.reduce((sum, v) => sum + parseInt(v.statistics.viewCount), 0) / longs.length);
        
        document.getElementById('shortsAvgViews').textContent = shortsAvg.toLocaleString();
        document.getElementById('longAvgViews').textContent = longsAvg.toLocaleString();
        document.getElementById('optimalFormat').textContent = shortsAvg > longsAvg ? '쇼츠' : '롱폼';
      }
      
      renderChart(videos);
    }

    // 차트 렌더링
    function renderChart(videos) {
      const ctx = document.getElementById('chart').getContext('2d');
      
      if (STATE.chart) STATE.chart.destroy();
      
      // 시간별 그룹핑
      const hourly = {};
      videos.forEach(v => {
        const hour = new Date(v.snippet.publishedAt).getHours();
        if (!hourly[hour]) hourly[hour] = [];
        hourly[hour].push(parseInt(v.statistics.viewCount));
      });
      
      const labels = Array.from({length: 24}, (_, i) => `${i}시`);
      const data = labels.map((_, i) => {
        const vids = hourly[i] || [];
        return vids.length ? vids.reduce((a,b) => a+b) / vids.length : 0;
      });
      
      STATE.chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: '시간대별 평균 조회수',
            data,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#e5e7eb' }
            },
            x: {
              grid: { display: false }
            }
          }
        }
      });
    }

    // 카테고리 필터 렌더링
    function renderCategoryFilters() {
      const container = document.getElementById('categoryFilters');
      container.innerHTML = CATEGORIES.map(cat => `
        <span class="pill active" data-id="${cat.id}" onclick="toggleCategory(this)">
          ${cat.name}
        </span>
      `).join('');
    }

    // 카테고리 토글
    function toggleCategory(el) {
      el.classList.toggle('active');
      processResults();
    }

    // 전체 선택/해제
    function selectAllCategories() {
      document.querySelectorAll('#categoryFilters .pill').forEach(el => el.classList.add('active'));
      processResults();
    }
    
    function deselectAllCategories() {
      document.querySelectorAll('#categoryFilters .pill').forEach(el => el.classList.remove('active'));
      processResults();
    }

    // 채널 모달
    async function showChannelModal(channelId) {
      const modal = document.getElementById('channelModal');
      const content = document.getElementById('modalContent');
      
      content.innerHTML = '로딩 중...';
      modal.classList.add('open');
      
      try {
        // 채널 정보 가져오기
        const channelRes = await fetch(`${API_BASE}/channels?part=snippet,statistics&id=${channelId}&key=${API_KEY}`);
        const channelData = await channelRes.json();
        const channel = channelData.items[0];
        
        // 채널의 최근 영상 가져오기
        const videosRes = await fetch(`${API_BASE}/search?part=snippet&channelId=${channelId}&order=date&maxResults=10&type=video&key=${API_KEY}`);
        const videosData = await videosRes.json();
        
        content.innerHTML = `
          <div style="display:flex;gap:16px;margin-bottom:20px">
            <img src="${channel.snippet.thumbnails.default.url}" style="width:80px;height:80px;border-radius:50%">
            <div>
              <h3>${channel.snippet.title}</h3>
              <p style="color:#6b7280;font-size:14px">${channel.snippet.description.slice(0,200)}</p>
            </div>
          </div>
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-label">구독자</div>
              <div class="stat-value">${(parseInt(channel.statistics.subscriberCount)/1000000).toFixed(1)}M</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">총 영상</div>
              <div class="stat-value">${parseInt(channel.statistics.videoCount).toLocaleString()}</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">총 조회수</div>
              <div class="stat-value">${(parseInt(channel.statistics.viewCount)/1000000000).toFixed(1)}B</div>
            </div>
          </div>
          <h4 style="margin-top:20px">최근 업로드</h4>
          <div style="max-height:300px;overflow-y:auto">
            ${videosData.items.map(v => `
              <div style="display:flex;gap:12px;padding:8px;cursor:pointer" onclick="window.open('https://youtube.com/watch?v=${v.id.videoId}')">
                <img src="${v.snippet.thumbnails.default.url}" style="width:120px;height:68px;border-radius:8px">
                <div style="flex:1">
                  <div style="font-weight:600;font-size:13px">${v.snippet.title}</div>
                  <div style="color:#6b7280;font-size:12px">${new Date(v.snippet.publishedAt).toLocaleDateString()}</div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      } catch(e) {
        content.innerHTML = '채널 정보를 불러올 수 없습니다';
      }
    }

    // 워치리스트
    function openWatchlist() {
      const modal = document.getElementById('watchlistModal');
      modal.classList.add('open');
      switchWatchTab(0, document.querySelector('#watchlistModal .tab'));
    }
    
    function closeWatchlist() {
      document.getElementById('watchlistModal').classList.remove('open');
    }
    
    function switchWatchTab(index, el) {
      document.querySelectorAll('#watchlistModal .tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      
      const content = document.getElementById('watchContent');
      
      if (index === 0) {
        // 워치리스트
        if (STATE.watchlist.length === 0) {
          content.innerHTML = '<div class="empty">워치리스트가 비어있습니다</div>';
        } else {
          content.innerHTML = STATE.watchlist.map(v => `
            <div style="display:flex;gap:12px;padding:8px;border-bottom:1px solid #e5e7eb">
              <img src="${v.thumbnail}" style="width:120px;height:68px;border-radius:8px">
              <div style="flex:1">
                <div style="font-weight:600">${v.title}</div>
                <div style="color:#6b7280;font-size:12px">${v.channel}</div>
                <div style="margin-top:4px">
                  <span class="badge">시작: ${v.initialViews.toLocaleString()}</span>
                  <span class="badge">현재: ${v.currentViews?.toLocaleString() || '-'}</span>
                </div>
              </div>
              <button onclick="removeFromWatchlist('${v.id}')">삭제</button>
            </div>
          `).join('');
        }
      } else {
        // 스냅샷
        if (STATE.snapshots.length === 0) {
          content.innerHTML = '<div class="empty">스냅샷이 없습니다</div>';
        } else {
          content.innerHTML = STATE.snapshots.map(s => `
            <div style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px">
              <h4>${new Date(s.timestamp).toLocaleString()}</h4>
              <div>영상 수: ${s.videos.length}</div>
              <div>총 조회수: ${s.totalViews.toLocaleString()}</div>
              <button onclick="loadSnapshot('${s.id}')">불러오기</button>
              <button class="danger" onclick="deleteSnapshot('${s.id}')">삭제</button>
            </div>
          `).join('');
        }
      }
    }
    
    function removeFromWatchlist(id) {
      STATE.watchlist = STATE.watchlist.filter(v => v.id !== id);
      localStorage.setItem('ytWatchlist', JSON.stringify(STATE.watchlist));
      switchWatchTab(0, document.querySelector('#watchlistModal .tab.active'));
    }
    
    function loadSnapshot(id) {
      const snapshot = STATE.snapshots.find(s => s.id === id);
      if (snapshot) {
        console.log('스냅샷 로드:', snapshot);
        alert(`${snapshot.videos.length}개 영상 로드됨`);
        closeWatchlist();
      }
    }
    
    function deleteSnapshot(id) {
      STATE.snapshots = STATE.snapshots.filter(s => s.id !== id);
      localStorage.setItem('ytSnapshots', JSON.stringify(STATE.snapshots));
      switchWatchTab(1, document.querySelector('#watchlistModal .tab.active'));
    }

    // 스냅샷 기능
    function toggleSnapshot() {
      if (!STATE.videos.length) {
        alert('먼저 검색을 실행하세요');
        return;
      }
      
      const snapshot = {
        id: Date.now().toString(),
        timestamp: new Date().toISOString(),
        videos: STATE.videos.map(v => ({
          id: v.id,
          title: v.snippet.title,
          channel: v.snippet.channelTitle,
          views: parseInt(v.statistics.viewCount)
        })),
        totalViews: STATE.videos.reduce((sum, v) => sum + parseInt(v.statistics.viewCount), 0)
      };
      
      STATE.snapshots.push(snapshot);
      localStorage.setItem('ytSnapshots', JSON.stringify(STATE.snapshots));
      alert('스냅샷 저장됨');
    }

    // 장기 트렌드
    function showTrends() {
      const modal = document.getElementById('trendsModal');
      const content = document.getElementById('trendsContent');
      
      content.innerHTML = `
        <div class="row" style="margin-bottom:16px">
          <input id="trendKeyword" placeholder="추적할 키워드 입력" style="flex:1">
          <button onclick="addTrendKeyword()">추가</button>
        </div>
        <div id="trendsList"></div>
      `;
      
      renderTrendsList();
      modal.classList.add('open');
    }
    
    function closeTrends() {
      document.getElementById('trendsModal').classList.remove('open');
    }
    
    function renderTrendsList() {
      const container = document.getElementById('trendsList');
      const keywords = Object.keys(STATE.trends);
      
      if (keywords.length === 0) {
        container.innerHTML = '<div class="empty">추적 중인 키워드가 없습니다</div>';
        return;
      }
      
      container.innerHTML = keywords.map(keyword => {
        const data = STATE.trends[keyword];
        const latest = data[data.length - 1];
        const prev = data[data.length - 2];
        const change = prev ? ((latest.avgViews - prev.avgViews) / prev.avgViews * 100).toFixed(1) : 0;
        
        return `
          <div style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h4>${keyword}</h4>
              <button class="danger" onclick="removeTrendKeyword('${keyword}')">삭제</button>
            </div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">
              <div class="stat-box">
                <div class="stat-label">평균 조회수</div>
                <div class="stat-value">${(latest.avgViews/1000).toFixed(0)}K</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">변동</div>
                <div class="stat-value ${change > 0 ? 'good' : 'warn'}">${change > 0 ? '+' : ''}${change}%</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">데이터 포인트</div>
                <div class="stat-value">${data.length}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    async function addTrendKeyword() {
      const keyword = document.getElementById('trendKeyword').value.trim();
      if (!keyword) return;
      
      showLoader();
      
      try {
        const res = await ytSearch({
          q: keyword,
          regionCode: document.getElementById('region').value,
          maxResults: 20
        });
        
        if (res.items && res.items.length > 0) {
          const videoIds = res.items.map(item => item.id.videoId);
          const details = await fetchVideoDetails(videoIds);
          
          const avgViews = details.items.reduce((sum, v) => sum + parseInt(v.statistics.viewCount), 0) / details.items.length;
          
          if (!STATE.trends[keyword]) STATE.trends[keyword] = [];
          
          STATE.trends[keyword].push({
            timestamp: new Date().toISOString(),
            avgViews: Math.round(avgViews),
            count: details.items.length
          });
          
          localStorage.setItem('ytTrends', JSON.stringify(STATE.trends));
          document.getElementById('trendKeyword').value = '';
          renderTrendsList();
        }
      } catch(e) {
        alert('트렌드 추가 실패');
      } finally {
        hideLoader();
      }
    }
    
    function removeTrendKeyword(keyword) {
      delete STATE.trends[keyword];
      localStorage.setItem('ytTrends', JSON.stringify(STATE.trends));
      renderTrendsList();
    }

    // 데이터 내보내기
    function exportData() {
      if (!STATE.videos.length) {
        alert('먼저 검색을 실행하세요');
        return;
      }
      
      const csv = [
        ['제목', '채널', '조회수', '좋아요', '댓글', '길이', '타입', '업로드일시', '속도', '반응률', 'RPM', '등급'],
        ...STATE.videos.map(v => {
          const duration = isoToSeconds(v.contentDetails.duration);
          return [
            v.snippet.title,
            v.snippet.channelTitle,
            v.statistics.viewCount,
            v.statistics.likeCount,
            v.statistics.commentCount,
            formatDuration(duration),
            getContentType(duration),
            v.snippet.publishedAt,
            v._d.speed,
            v._d.er,
            v._longform?.rpm || '-',
            v._grade
          ];
        })
      ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `youtube_data_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    }

    // UI 헬퍼
    function showLoader() {
      document.getElementById('loader').style.display = 'block';
    }
    
    function hideLoader() {
      document.getElementById('loader').style.display = 'none';
    }
    
    function closeModal() {
      document.getElementById('channelModal').classList.remove('open');
    }

    // 초기화
    window.addEventListener('load', () => {
      console.log('YouTube Content Radar v8.0 - 쇼츠 & 롱폼 통합 분석');
      updateTableHeaders();
    });
  </script>
</body>
</html>
