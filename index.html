<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shorts Radar Pro — 패키징·모멘텀·운영 신호까지</title>
  <link rel="icon" href="data:,">
  <script>
    // ---- Lazy-load Tesseract (kor+eng) ----
    window.loadTesseract = async function(){
      if (window.Tesseract) return;
      var s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js';
      document.head.appendChild(s);
      await new Promise(function(res){ s.onload = res; s.onerror = res; });
    };
  </script>
  <style>
    :root { --bg:#0b1116; --card:#101922; --muted:#7a8a9a; --text:#e8f0f7; --accent:#62d26f; --accent2:#6aa7ff; --warn:#ffb84d; }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Pretendard,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px 80px}
    h1{font-weight:800;letter-spacing:-.5px;font-size:26px;margin:0 0 14px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:18px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .card{background:linear-gradient(180deg,#0f1821,#0a1118);border:1px solid #1e2a36;border-radius:14px;padding:14px 14px 16px;box-shadow:0 8px 22px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea,button{border-radius:10px;border:1px solid #2a3a4a;background:#0c141c;color:var(--text);padding:10px 12px;font-size:14px}
    input::placeholder,textarea::placeholder{color:#6b7b8b}
    button{cursor:pointer;background:#152332;border:1px solid #274156}
    button.primary{background:linear-gradient(180deg,#2a6fff,#2461e6);border:0}
    button.ghost{background:transparent;border:1px dashed #2d3b49}
    button.danger{background:#4b1c16;border:1px solid #6b2c24}
    .hint{color:var(--muted);font-size:12px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .pill{background:#0f1620;border:1px solid #1f2a36;border-radius:999px;padding:8px 12px;font-size:12px;color:#b9c7d6}
    .tag{display:inline-block;background:#0e1620;border:1px solid #213142;border-radius:999px;padding:4px 8px;margin:2px;color:#a8b9cc;font-size:12px}
    .muted{color:#9fb0bf}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #1e2a36;text-align:left;font-size:13px}
    .table th{color:#a5b6c6;font-weight:600}
    .badge{padding:4px 8px;border-radius:999px;background:#0e1b29;border:1px solid #23374a;font-size:11px}
    .good{color:#b9ffd0}
    .warn{color:var(--warn)}
    .cluster{display:flex;gap:12px;align-items:flex-start}
    .thumb{width:120px;height:68px;background:#111;border:1px solid #253444;border-radius:10px;object-fit:cover}
    .footer{position:fixed;left:0;right:0;bottom:0;background:rgba(9,14,20,.9);border-top:1px solid #1e2a36;padding:10px 16px;display:flex;gap:8px;align-items:center;justify-content:center}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .small{font-size:12px}
    .hero{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    @media (max-width:1000px){.grid.cols-3{grid-template-columns:1fr}.grid.cols-2{grid-template-columns:1fr}.thumb{width:96px;height:54px}}

    /* Heatmap */
    .hm{font-size:11px}
    .hm .row{display:flex;align-items:center;gap:4px;margin:2px 0}
    .hm .label{width:18px;color:#8fa4b8;text-align:right;margin-right:6px}
    .hm .cell{width:18px;height:18px;border-radius:4px;border:1px solid #213142;background:#0e1620}
    .hm .legend{display:flex;align-items:center;gap:6px;margin-top:6px}
    .hm .legend .box{width:18px;height:18px;border-radius:4px;border:1px solid #213142}
    /* Quota bar */
    .qbar{position:relative;height:8px;width:160px;border:1px solid #213142;border-radius:999px;background:#0e1620}
    .qbar .fill{height:100%;border-radius:999px;background:linear-gradient(90deg,#2a6fff,#62d26f)}
    /* Channel board */
    .channel-card{display:flex;justify-content:space-between;align-items:center;border:1px solid #223243;border-radius:12px;padding:10px 12px;background:#0e1620}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div>
        <h1>Shorts Radar <span class="muted">Pro</span> <span class="muted">— 패키징·모멘텀·운영 신호까지</span></h1>
        <div class="sub">썸네일OCR/제목패턴/워치리스트 스냅샷/채널 운영카드가 포함된 kor+eng OCR 포함.</div>
      </div>
      <div class="row">
        <button id="exportCsv" class="ghost">CSV 내보내기</button>
        <button id="exportManual" class="ghost">사용법 내보내기(MD)</button>
        <button id="btnOcr" class="ghost">썸네일 OCR(한·영)</button>
        <button id="btnReprobe" class="ghost">워치리스트 재측정</button>
        <button id="resetBtn" class="danger">초기화</button>
      </div>
    </div>

    <!-- 1. 연결 설정 -->
    <div class="grid cols-2">
      <div class="card">
        <h3 style="margin:0 0 8px">1) 연결 설정</h3>
        <div class="row" style="gap:8px">
          <input id="apiKey" placeholder="YouTube Data API 키 붙여넣기" style="min-width:300px" aria-label="YouTube API Key" autocomplete="off"/>
          <button id="saveKey" class="primary">키 저장</button>
          <span class="hint">* GCP 콘솔에서 HTTP referrer(본인 GitHub Pages 도메인) 제한을 꼭 설정하세요.</span>
        </div>
        <div class="row" style="gap:8px;margin-top:10px">
          <label>일일 한도(유닛)</label>
          <input id="quotaLimit" type="number" min="1000" step="100" value="10000" style="width:120px" aria-label="일일 한도" autocomplete="off"/>
          <button id="quotaApply" class="ghost">적용</button>
          <span id="quotaStat" class="pill">API 사용량(오늘) 0 / 10000 (0%)</span>
          <div id="quotaBar" class="qbar"><div class="fill" style="width:0%"></div></div>
          <button id="quotaReset" class="ghost">사용량 초기화</button>
        </div>
      </div>

      <!-- 2. 찾을 조건 -->
      <div class="card">
        <h3 style="margin:0 0 8px">2) 찾을 조건</h3>
        <div class="row" style="gap:8px">
          <input id="keywords" placeholder="찾을 주제(예: 정치풍자, 고양이 모래매트)" style="flex:1" aria-label="키워드" autocomplete="off"/>
          <input id="channels" placeholder="경쟁 채널 ID들(쉼표로 구분 · 선택)" style="flex:1" aria-label="채널 ID 목록" autocomplete="off"/>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <select id="presetSelect" style="min-width:220px"></select>
          <button id="presetLoad" class="ghost">설정 불러오기</button>
          <button id="presetSave" class="ghost">현재 입력 저장</button>
          <button id="presetDel" class="danger">삭제</button>
          <span class="hint">* 내 브라우저(로컬)에 저장됩니다.</span>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <select id="days">
            <option value="3">최근 3일</option>
            <option value="7" selected>최근 7일</option>
            <option value="14">최근 14일</option>
          </select>
          <select id="region" title="지역 힌트(랭킹 가중치)">
            <option value="KR" selected>KR</option>
            <option value="US">US</option>
            <option value="JP">JP</option>
            <option value="GB">GB</option>
          </select>
          <select id="lang" title="언어 힌트(랭킹 가중치)">
            <option value="ko" selected>ko</option>
            <option value="en">en</option>
            <option value="ja">ja</option>
          </select>
          <input id="maxResults" type="number" min="10" max="200" value="80" style="width:120px" aria-label="결과 개수" autocomplete="off"/>
          <button id="runBtn" class="primary">찾기 시작</button>
        </div>
      </div>
    </div>

    <!-- KPI -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">요약</h3>
      <div id="summary" class="kpi"></div>
    </div>

    <!-- 클러스터 보드 -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">비슷한 주제 묶음</h3>
        <div class="row">
          <label>최소 종합점수</label>
          <input id="minRank" type="number" value="0" step="0.01" style="width:100px" aria-label="최소 종합점수" autocomplete="off"/>
          <label>묶음 개수(k)</label>
          <input id="kValue" type="number" min="1" max="20" value="0" style="width:80px" title="0이면 자동(√N)" aria-label="묶음 개수" autocomplete="off"/>
          <button id="recluster" class="ghost">다시 묶기</button>
        </div>
      </div>
      <div id="clusters" class="grid cols-2" style="margin-top:8px"></div>
    </div>

    <!-- 올리기 좋은 시간대 -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">올리기 좋은 시간대 (시간대 지도)</h3>
        <span class="hint">로컬 시간 기준 · PickRank 가중치</span>
      </div>
      <div class="grid cols-2" style="margin-top:8px">
        <div id="heatmap" class="hm"></div>
        <div>
          <b>추천 Top 시간대</b>
          <ol id="bestTimes" style="margin-top:6px"></ol>
          <div class="hint" style="margin-top:8px">* 데이터가 적으면 기간을 14일로 넓혀 보세요.</div>
        </div>
      </div>
    </div>

    <!-- 채널 운영 카드 -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">경쟁 채널 운영 카드</h3>
        <span class="hint">최근 결과에 등장한 채널 기준(게시 주기/시간대)</span>
      </div>
      <div id="chanBoard" class="grid cols-2" style="margin-top:8px"></div>
    </div>

    <!-- 영상 테이블 -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">영상 리스트</h3>
      <div id="colControls" class="row" style="gap:8px; margin:6px 0 8px; align-items:center; flex-wrap:wrap"></div>
      <table class="table" id="table">
        <thead>
          <tr>
            <th>☆</th>
            <th>썸네일</th>
            <th>제목</th>
            <th>패턴</th>
            <th>채널</th>
            <th>길이</th>
            <th>조회</th>
            <th>좋아요</th>
            <th>댓글</th>
            <th>속도</th>
            <th>반응</th>
            <th>신선도</th>
            <th>주제적합</th>
            <th>Δ24h</th>
            <th>종합점수</th>
            <th>묶음</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- 비슷하게 만들기 도우미 -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">비슷하게 만들기 도우미</h3>
        <div class="row"><label>묶음 번호</label><input id="wizCluster" type="number" value="0" style="width:80px" aria-label="묶음 번호" autocomplete="off"/><button id="runWizard" class="ghost">생성</button></div>
      </div>
      <div id="wizardOut" class="grid cols-2" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="footer small">
    <span>Tip: <b>종합점수</b>가 높은 순으로 오늘 바로 따라 만들 주제를 고르세요. — <span class="muted">속도(조회/시간)·반응(좋아요/댓글)·신선도·주제적합</span>을 합쳐 계산합니다.</span>
  </div>

<script>
(function(){
  // ---------- 작은 유틸 ----------
  function $(sel){ return document.querySelector(sel); }
  function now(){ return new Date(); }
  function hoursSince(iso){ return (now() - new Date(iso)) / 36e5; }
  function fmt(n){ return (n!=null && n!=undefined) ? Number(n).toLocaleString('en-US') : '-'; }
  function toISO(d){ return new Date(d).toISOString(); }
  function escapeHtml(s){ 
    s = s || '';
    return s.replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c];});
  }
  // 안전 접근
  function getv(obj, path, def){
    var parts = path.split('.');
    var o = obj;
    for(var i=0;i<parts.length;i++){
      if(o && (parts[i] in o)) o = o[parts[i]];
      else { o = undefined; break; }
    }
    return (o==null ? def : o);
  }

  // ---------- 텍스트/랭킹 ----------
  var stopwords = new Set("이 그 저 데 는 은 는 을 를 와 과 도 의 에 로 으로 한 하는 했다 하기 하며 또는 그리고 그러나 그래서 부터 까지 보다 보다도 및 등 더 것 같은 이런 저런 뭐 왜 또 좀 아주 경우 대한 위한 누구 무엇 어디 어떻게 모두 너무 정말 지금 매우 그냥 서로 또한 약간 만큼 만큼의 라는 라고 으로서 으로써 때문 때문인 듯 함께 대해 다른 했다가 하다가 된다 했다면 까지도 뿐만 아니라 including with the a an to of for in on at as is are be this that those these from by and or but so very much more less only just than then when where who what how why while into onto about over under again still really".split(/\s+/));
  function tokenize(text){
    text = (text||'').toLowerCase().replace(/[\p{P}\p{S}]/gu,' ');
    var t = text.split(/\s+/).filter(function(w){ return w && !stopwords.has(w) && w.length>1; });
    return t;
  }
  function uniq(arr){ return Array.from(new Set(arr)); }
  function cosine(a,b){
    var dot=0,na=0,nb=0;
    var keys = new Set(Object.keys(a).concat(Object.keys(b)));
    keys.forEach(function(k){ var va=a[k]||0,vb=b[k]||0; dot+=va*vb; na+=va*va; nb+=vb*vb; });
    return dot/(Math.sqrt(na)*Math.sqrt(nb)||1);
  }
  function tf(tokens){ var m={}; tokens.forEach(function(w){ m[w]=(m[w]||0)+1; }); var n=tokens.length||1; Object.keys(m).forEach(function(k){ m[k]/=n;}); return m; }
  function idf(docs){ var df={},N=docs.length||1; docs.forEach(function(doc){ Object.keys(doc).forEach(function(k){ df[k]=(df[k]||0)+1; });}); var m={}; Object.keys(df).forEach(function(k){ m[k]=Math.log(1+N/df[k])+1;}); return m; }
  function tfidf(tfMap,idfMap){ var v={}; Object.keys(tfMap).forEach(function(k){ v[k]=tfMap[k]*(idfMap[k]||1);}); return v; }
  function topKeywords(vec,n){ return Object.entries(vec).sort(function(a,b){return b[1]-a[1]}).slice(0,n||6).map(function(x){return x[0]}); }
  function expDecay(hours,tau){ return Math.exp(-hours/(tau||48)); }
  function secToHMS(sec){ sec=sec|0; var h=(sec/3600)|0, m=((sec%3600)/60)|0, s=(sec%60)|0; return (h?h+':':'')+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }
  function isoToSeconds(dur){ var m = (dur||'').match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/); return m? (Number(m[1]||0)*3600 + Number(m[2]||0)*60 + Number(m[3]||0)) : 0; }

  // ---------- 전역 상태 ----------
  var STATE = { videos:[], clusters:[], idf:null, vectors:[], topicVec:{}, labels:[], colVis:null, sortKey:null, sortDir:null, watch:new Set(), snapshots:{}, ocr:{} };

  // ---------- 저장소 ----------
  function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
  function load(key,def){ try{ var v=localStorage.getItem(key); return v? JSON.parse(v):def; }catch(e){ return def; } }

  // ---------- 제목 패턴 분석 ----------
  function analyzeTitle(title){
    title = title || '';
    var emoji = (title.match(/\p{Extended_Pictographic}/gu) || []).length;
    var hasNum = /\d/.test(title);
    var isQ = /[?？]|\b(왜|무엇|어떻게|누가|언제|가능|인가)\b/.test(title);
    var hasBracket = /[\[\(（]()]()
