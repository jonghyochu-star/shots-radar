<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>YouTube Content Radar - í†µí•©íŒ v8.0</title>
  <link rel="icon" href="data:,">
  <style>
    :root { --bg:#0b1116; --card:#101922; --muted:#7a8a9a; --text:#e8f0f7; --accent:#62d26f; --accent2:#6aa7ff; --warn:#ffb84d; }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Pretendard,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px 84px;position:relative}
    h1{font-weight:800;letter-spacing:-.4px;font-size:26px;margin:0 0 14px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:18px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .card{background:#ffffff;border:1px solid #1e2a36;border-radius:14px;padding:14px 14px 16px;box-shadow:0 8px 22px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input,select,button{border-radius:10px;border:1px solid #2a3a4a;background:#0c141c;color:var(--text);padding:9px 11px;font-size:14px}
    input::placeholder{color:#6b7b8b}
    button{cursor:pointer;background:#152332;border:1px solid #274156}
    button.primary{background:linear-gradient(180deg,#2a6fff,#2461e6);border:0}
    button.ghost{background:transparent;border:1px dashed #2d3b49}
    button.danger{background:#4b1c16;border:1px solid #6b2c24}
    .hint{color:var(--muted);font-size:12px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .pill{background:#0f1620;border:1px solid #1f2a36;border-radius:999px;padding:8px 12px;font-size:12px;color:#b9c7d6;cursor:pointer}
    .pill.active{background:#0f2b1a;border-color:#1f4b2a;color:#b9ffd0}
    .pill.blocked{background:#4b1c16;border-color:#6b2c24;color:#ffcab3}
    .table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #1e2a36;text-align:left;font-size:13px}
    th{color:#a5b6c6;font-weight:600;white-space:nowrap}
    #table thead th{position:sticky;top:0;background:#f8fafc;z-index:3}
    .thumb{width:120px;height:68px;background:#111;border:1px solid #253444;border-radius:10px;object-fit:cover}
    .badge{padding:4px 8px;border-radius:999px;background:#0e1b29;border:1px solid #23374a;font-size:11px}
    .grade-S{background:#0f2b1a;border-color:#1f4b2a;color:#b9ffd0}
    .grade-A{background:#0e232f;border-color:#214056;color:#bfe7ff}
    .grade-B,.grade-C{background:#121a24;border-color:#223243;color:#c7d4e3}
    .grade-D{background:#151922;border-color:#222838;color:#9aa8b8}
    .good{color:#b9ffd0}
    .warn{color:var(--warn)}
    .qbar{position:relative;height:8px;width:160px;border:1px solid #213142;border-radius:999px;background:#0e1620}
    .qbar .fill{height:100%;border-radius:999px;background:linear-gradient(90deg,#2a6fff,#62d26f)}
    .star{cursor:pointer;font-size:18px;user-select:none}
    .star.on{color:#ffd166}
    .tag{display:inline-block;background:#0e1620;border:1px solid #213142;border-radius:999px;padding:4px 8px;margin:2px;color:#a8b9cc;font-size:12px}
    .tableWrap{max-height:68vh;overflow:auto;border:1px solid #1e2a36;border-radius:12px;position:relative}
    .sideScroll{position:absolute;right:-56px;top:0;display:flex;flex-direction:column;gap:8px;pointer-events:auto}
    .sideScroll button{width:44px;height:36px;border-radius:10px;border:1px solid #2a3a4a;background:#0c141c;color:#e8f0f7;cursor:pointer}
    @media (max-width:1200px){.sideScroll{right:-2px;top:-54px;flex-direction:row}}
    @media (max-width:1000px){.grid.cols-2{grid-template-columns:1fr}.thumb{width:96px;height:54px}}
  
    /* Long Trend Dashboard */
    :root{ --font-ui: 'Pretendard Variable','Inter','Noto Sans KR',system-ui,-apple-system,'Segoe UI',Roboto,'Apple SD Gothic Neo','Malgun Gothic',sans-serif }
    .longdash{background:#ffffff;border:1px solid #1e2a36;border-radius:14px;padding:16px;margin-top:12px;margin-bottom:8px;font-family:var(--font-ui)}
    .longdash .ctrls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
    .longdash h3{font-weight:700;letter-spacing:-0.2px;margin:0}
    .longdash .grid{display:grid;grid-template-columns:2fr 1fr;gap:12px;align-items:start}
    @media (max-width:1100px){.longdash .grid{grid-template-columns:1fr}}
    .chart{position:relative;height:420px}
    .longdash .side{position:relative;height:420px}
    .sideOverlay{position:absolute;top:0;left:0;right:0;padding:4px 0 6px 0}
    .sideChart{position:absolute;left:0;right:0;bottom:0;top:86px}
    @media (max-width:1100px){.longdash .side{height:360px}.sideChart{top:90px}}
    .pills{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0 8px 0;max-height:72px;overflow:auto}
    .pill.off{opacity:.45}
    .risers{display:flex;flex-wrap:wrap;gap:8px}
    .risers .pill{background:#10351f;border-color:#1c5a31;color:#c8ffd9}
    .sideHead .title{font-weight:700;font-size:16px;letter-spacing:-0.2px}
    .sideHead .meta{font-size:12px;color:#9fb2c4;letter-spacing:-0.1px}
    .note{background:#1a2330;border:1px solid #2a3a4a;border-radius:8px;padding:8px 12px;margin:8px 0;font-size:12px;color:#9fb2c4}

    /* Channel Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(8,12,18,.72);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal-panel{width:min(980px,92vw);max-height:86vh;overflow:auto;background:#ffffff;border:1px solid #1e2a36;border-radius:16px;box-shadow:0 12px 28px rgba(0,0,0,.4);padding:16px 18px;color:#e8f0f7}
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .modal-title{font-weight:800;font-size:18px}
    .modal-close{border-radius:10px;border:1px solid #2a3a4a;background:#0c141c;color:#e8f0f7;cursor:pointer;padding:6px 10px}
    .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0}
    .kpi-card{background:#0f1620;border:1px solid #1f2a36;border-radius:12px;padding:10px}
    .kpi-card b{font-size:18px}
    .best-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:6px}
    .best-card{background:#0f1620;border:1px solid #1f2a36;border-radius:12px;padding:8px;display:flex;gap:8px}
    .best-thumb{width:132px;height:74px;object-fit:cover;border-radius:10px;border:1px solid #223243}
    .meta-row{display:flex;gap:12px;flex-wrap:wrap;color:#a8b9cc;font-size:12px}
    .badge-soft{display:inline-block;padding:4px 8px;border-radius:999px;background:#0e1620;border:1px solid #213142;color:#b9c7d6;cursor:pointer}
    .badge-soft:disabled{opacity:.5;cursor:not-allowed}
    .hr{height:1px;background:#1e2a36;margin:8px 0}
    .rev-box{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .rev-out{font-weight:700}
    .ch-link{all:unset;cursor:pointer;color:#cfe3ff;text-decoration:underline}
    .ch-link:hover{opacity:.9}
    @media (max-width:768px){.kpi-grid{grid-template-columns:repeat(2,1fr)}.best-grid{grid-template-columns:1fr}}
  
    /* v8.0 Longform Integration */
    .content-type-selector{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-bottom:10px}
    .content-type-selector .row{gap:6px}
    .type-badge{padding:6px 12px;border-radius:20px;background:#fff;border:1px solid #d1d5db;cursor:pointer;font-size:12px}
    .type-badge.active{background:#2563eb;color:#fff;border-color:#2563eb}
    .longform-badge{background:#7c3aed;color:#fff}
    .midform-badge{background:#0891b2;color:#fff}
    .metric-label{font-size:11px;color:#6b7280;display:block}
    .metric-value{font-size:14px;font-weight:600;color:#111827}
    .compare-dash{background:#ffffff;border:1px solid #e5e7eb;border-radius:14px;padding:16px;margin-top:12px}
    .compare-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:768px){.compare-grid{grid-template-columns:1fr}}
    .compare-card{background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:12px}
    .compare-title{font-weight:700;font-size:14px;margin-bottom:8px}
    .compare-stat{display:flex;justify-content:space-between;padding:4px 0}
    .compare-label{color:#6b7280;font-size:12px}
    .compare-value{font-weight:600;font-size:13px}
    
    /* Light Polish Override */
    #keyState{ display:flex; flex-wrap:wrap; align-items:center; gap:8px; }
    #keyState > *{ margin:0 !important; }
    .quota-flag{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #2a3a4a; background:#0c141c; color:#9fb2c4; }
    .quota-flag.online{ color:#00d084 !important; border-color:#1c3a24 !important; background:#0c1f14 !important; font-weight:700 !important; }
    .quota-flag.offline{ color:#ffb8b8 !important; border-color:#4a1f1f !important; background:#1c0c0c !important; font-weight:700 !important; }
    .snapshot-notice{background:#1a3a2a;border:2px solid #62d26f;margin:12px 0;padding:12px;}
    .category-hint{background:#1a2330;border:1px solid #2a3a4a;border-radius:8px;padding:10px;margin-top:10px;}
    .seedless-notice{background:#1a3a2a;border:2px solid #62d26f;margin:12px 0;padding:12px;}
  </style>
<style id="light-polish">
  :root{
    --bg:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#6b7280;
    --border:#e5e7eb; --surface:#f8fafc; --grid:rgba(0,0,0,0.08); --grid2:rgba(0,0,0,0.12);
  }
  html,body{ background:#ffffff; color:#0f172a; }
  .card, .longdash{ background:#ffffff !important; border:1px solid var(--border) !important; box-shadow:0 8px 24px rgba(0,0,0,.06) !important; }
  .category-hint, .note{ background:var(--surface) !important; border:1px solid var(--border) !important; color:#374151 !important; }
  input, select, button{ background:#fff !important; color:#111827 !important; border-color:#d1d5db !important; }
  button.primary{ background:linear-gradient(180deg,#2563eb,#1d4ed8) !important; border:0 !important; color:#fff !important; }
  button.ghost{ background:#fff !important; border:1px dashed #cbd5e1 !important; }
  button.danger{ background:#fee2e2 !important; border:1px solid #fecaca !important; color:#991b1b !important; }
  .pill{ background:#f3f4f6 !important; border:1px solid #e5e7eb !important; color:#374151 !important; }
  .pill.active{ background:#ecfdf5 !important; border-color:#86efac !important; color:#065f46 !important; }
  .pill.blocked{ background:#fff7ed !important; border-color:#fed7aa !important; color:#7c2d12 !important; }
  .badge{ background:#eef2ff !important; border-color:#c7d2fe !important; color:#1e293b !important; }
  .tableWrap{ border-color:var(--border) !important; }
  th, td{ border-bottom:1px solid var(--border) !important; }
  #table thead th{ background:#f8fafc !important; color:#111827 !important; }
  .thumb{ background:#f3f4f6 !important; border-color:#e5e7eb !important; }
  .kpi-card, .best-card{ background:#ffffff !important; border:1px solid var(--border) !important; }
  .modal-backdrop{ background:rgba(0,0,0,.12) !important; }
  .modal-panel{ background:#ffffff !important; border:1px solid var(--border) !important; color:#0f172a !important; box-shadow:0 18px 40px rgba(0,0,0,.20) !important; }
  .risers .pill{ background:#ecfdf5 !important; border-color:#86efac !important; color:#065f46 !important; }
  .hr{ background:var(--border) !important; }
  .quota-flag{ background:#fff !important; border-color:#d1d5db !important; color:#334155 !important; }
  .tag{ background:#eff6ff !important; border-color:#bfdbfe !important; color:#1e3a8a !important; }
  /* Zebra & hover */
  #table tbody tr:nth-child(even){ background:#fcfdff; }
  #table tbody tr:hover{ background:#eef2ff; }
  /* Sticky footer tip (inline-styled row at bottom) */
  body > .row[style*="position:fixed"]{ background:rgba(255,255,255,.95) !important; border-top:1px solid var(--border) !important; color:#334155 !important; }
  /* Scrollbar (WebKit) */
  ::-webkit-scrollbar{ height:10px; width:10px; }
  ::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:8px; }
  ::-webkit-scrollbar-track{ background:#f1f5f9; }
  /* Content type badges */
  .content-type-selector{ background:#f9fafb !important; border-color:var(--border) !important; }
  .type-badge{ background:#fff !important; border-color:#d1d5db !important; color:#374151 !important; }
  .type-badge.active{ background:#2563eb !important; color:#fff !important; }
  .compare-dash{ background:#ffffff !important; border-color:var(--border) !important; }
  .compare-card{ background:#f9fafb !important; border-color:var(--border) !important; }
</style>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>YouTube Content Radar â€” <span style="color:#7a8a9a">í†µí•©íŒ</span> <span style='color:#7a8a9a;font-size:12px;margin-left:8px'>v8.0</span></h1>
        <div class="sub">Shorts + Longform í†µí•© ë¶„ì„ Â· ì½˜í…ì¸  íƒ€ì…ë³„ ìµœì í™” ì§€í‘œ Â· ìˆ˜ìµì„± ë¶„ì„ Â· 16ê°œ ì¹´í…Œê³ ë¦¬ ìë™ ìˆ˜ì§‘</div>
      </div>
      <div class="row">
        <button id="exportXlsx" class="ghost">Excel</button>
        <button id="btnReprobe" class="ghost">ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ ì¬ì¸¡ì •</button>
        <button id="resetBtn" class="danger">ì´ˆê¸°í™”</button>
      </div>
    </div>

    <!-- API & ê²€ìƒ‰ ì„¤ì • -->
    <div class="grid cols-2">
      <div class="card">
        <h3 style="margin:0 0 8px">1) ì—°ê²° ì„¤ì •</h3>
        <div class="row" style="gap:8px">
          <input id="apiKey" placeholder="YouTube Data API í‚¤ (ì‰¼í‘œ/ê³µë°±/ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ ê°œ ì…ë ¥ ê°€ëŠ¥)" style="min-width:300px" aria-label="YouTube API Key" autocomplete="off"/>
          <button id="saveKey" class="primary">í‚¤ ì €ì¥</button>
          <span class="hint">* GCP ì½˜ì†”ì—ì„œ HTTP referrer(ë³¸ì¸ GitHub Pages ë„ë©”ì¸) ì œí•œì„ ê¼­ ì„¤ì •í•˜ì„¸ìš”.</span>
        </div>
        <div class="row" style="gap:8px;margin-top:10px">
          <label>ì¼ì¼ í•œë„(ìœ ë‹›)</label>
          <input id="quotaLimit" type="number" min="1000" step="100" value="10000" style="width:120px" aria-label="ì¼ì¼ í•œë„" autocomplete="off"/>
          <button id="quotaApply" class="ghost">ì ìš©</button>
          <span id="quotaStat" class="pill">API ì‚¬ìš©ëŸ‰(ì˜¤ëŠ˜) 0 / 10000 (0%)</span>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <button id="quotaReset" class="ghost">ì‚¬ìš©ëŸ‰ ì´ˆê¸°í™”</button>
          <span id="quotaStateFlag" class="quota-flag online">ìƒíƒœ: <b>ONLINE</b></span>
        </div>
        <div id="quotaBar" class="qbar"><div class="fill" style="width:0%"></div></div>
        <!-- í‚¤ íšŒì „ ìƒíƒœ í‘œì‹œ -->
        <div id="keyState" class="row" style="gap:6px;margin-top:8px"></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">2) ì°¾ì„ ì¡°ê±´</h3>
        <div class="row" style="gap:8px">
          <input id="keywords" placeholder="ì°¾ì„ ì£¼ì œ(ì˜ˆ: ì •ì¹˜í’ì, ê³ ì–‘ì´ ëª¨ë˜ë§¤íŠ¸)" style="flex:1" aria-label="í‚¤ì›Œë“œ" autocomplete="off"/>
          <input id="channels" placeholder="ê²½ìŸ ì±„ë„ IDë“¤(ì‰¼í‘œë¡œ êµ¬ë¶„ Â· ì„ íƒ)" style="flex:1" aria-label="ì±„ë„ ID ëª©ë¡" autocomplete="off"/>
        </div>
        <!-- ì½˜í…ì¸  íƒ€ì… ì„ íƒ -->
        <div class="content-type-selector">
          <div class="row">
            <label>ì½˜í…ì¸  íƒ€ì…</label>
            <span class="type-badge active" data-type="all">ì „ì²´</span>
            <span class="type-badge" data-type="shorts">ì‡¼ì¸  (â‰¤60ì´ˆ)</span>
            <span class="type-badge" data-type="long">ë¡±í¼ (>60ì´ˆ)</span>
            <span class="type-badge" data-type="mid">ë¯¸ë“œí¼ (1-10ë¶„)</span>
            <span class="type-badge" data-type="vlong">ì¥í¸ (>20ë¶„)</span>
            <input type="hidden" id="contentType" value="all"/>
          </div>
          <div class="row" style="margin-top:8px">
            <label>ì»¤ìŠ¤í…€ ê¸¸ì´</label>
            <input id="minSec" type="number" min="0" value="0" style="width:80px" placeholder="ìµœì†Œ(ì´ˆ)"/>
            <span>~</span>
            <input id="maxSec" type="number" min="1" value="3600" style="width:80px" placeholder="ìµœëŒ€(ì´ˆ)"/>
            <span class="hint">ì´ˆ ë‹¨ìœ„ (ì˜ˆ: 300 = 5ë¶„)</span>
          </div>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <select id="days">
            <option value="3">ìµœê·¼ 3ì¼</option>
            <option value="7" selected>ìµœê·¼ 7ì¼</option>
            <option value="14">ìµœê·¼ 14ì¼</option>
            <option value="30">ìµœê·¼ 30ì¼</option>
          </select>
          <select id="region"><option value="KR" selected>KR</option><option value="US">US</option><option value="JP">JP</option><option value="GB">GB</option></select>
          <select id="lang"><option value="ko" selected>ko</option><option value="en">en</option><option value="ja">ja</option></select>
          <input id="maxResults" type="number" min="10" max="200" value="80" style="width:120px" aria-label="ê²°ê³¼ ê°œìˆ˜" autocomplete="off"/>
          <button id="runBtn" class="primary" onclick="run()">ì°¾ê¸° ì‹œì‘</button>
        </div>
        <div class="category-hint">
          ğŸ’¡ <b>í‚¤ì›Œë“œ ì—†ì´ ê²€ìƒ‰</b>í•˜ë©´ ì¹´í…Œê³ ë¦¬ë³„ ì¸ê¸° ì˜ìƒì„ ìë™ ìˆ˜ì§‘í•©ë‹ˆë‹¤<br>
          ğŸ“‹ ì¹´í…Œê³ ë¦¬(16ê°œ): ìŒì•…, ê²Œì„, ìœ ë¨¸, ë™ë¬¼, ìŠ¤í¬ì¸ , ëŒ„ìŠ¤<br>
          ğŸ“º ì—°ì˜ˆ, ì˜í™”, ë“œë¼ë§ˆ, AI, ì˜ˆëŠ¥, ì‹œë‹ˆì–´<br>
          ğŸ¯ êµ­ë½•, ì˜¤í”¼ì…œ, ë¦¬ë·°, ì •ì¹˜
        </div>
      </div>
    </div>

    <!-- ìš”ì•½ KPI -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">ìš”ì•½</h3>
      <div id="summary" class="kpi"></div>
    </div>

    <!-- ì½˜í…ì¸  íƒ€ì… ë¹„êµ ëŒ€ì‹œë³´ë“œ (ìƒˆë¡œ ì¶”ê°€) -->
    <div class="compare-dash" id="compareDash" style="display:none">
      <h3 style="margin:0 0 12px">ğŸ“Š ì½˜í…ì¸  íƒ€ì… ì„±ê³¼ ë¹„êµ</h3>
      <div class="compare-grid">
        <div class="compare-card">
          <div class="compare-title">ğŸ¬ ì‡¼ì¸  (â‰¤60ì´ˆ)</div>
          <div class="compare-stat">
            <span class="compare-label">ìˆ˜ëŸ‰</span>
            <span class="compare-value" id="cmpShortsCount">0</span>
          </div>
          <div class="compare-stat">
            <span class="compare-label">í‰ê·  ì¡°íšŒìˆ˜</span>
            <span class="compare-value" id="cmpShortsViews">0</span>
          </div>
          <div class="compare-stat">
            <span class="compare-label">í‰ê·  ë°˜ì‘ë¥ </span>
            <span class="compare-value" id="cmpShortsER">0â€°</span>
          </div>
          <div class="compare-stat">
            <span class="compare-label">ì‹œê°„ë‹¹ ì¡°íšŒ</span>
            <span class="compare-value" id="cmpShortsVel">0</span>
          </div>
        </div>
        <div class="compare-card">
          <div class="compare-title">ğŸ“º ë¡±í¼ (>60ì´ˆ)</div>
          <div class="compare-stat">
            <span class="compare-label">ìˆ˜ëŸ‰</span>
            <span class="compare-value" id="cmpLongCount">0</span>
          </div>
          <div class="compare-stat">
            <span class="compare-label">í‰ê·  ì¡°íšŒìˆ˜</span>
            <span class="compare-value" id="cmpLongViews">0</span>
          </div>
          <div class="compare-stat">
            <span class="compare-label">í‰ê·  ë°˜ì‘ë¥ </span>
            <span class="compare-value" id="cmpLongER">0â€°</span>
          </div>
          <div class="compare-stat">
            <span class="compare-label">ì˜ˆìƒ RPM</span>
            <span class="compare-value" id="cmpLongRPM">â‚©0</span>
          </div>
        </div>
      </div>
      <canvas id="compareChart" style="margin-top:16px;max-height:200px"></canvas>
    </div>

    <!-- ì˜¬ë¦¬ê¸° ì¢‹ì€ ì‹œê°„ëŒ€ -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">ì˜¬ë¦¬ê¸° ì¢‹ì€ ì‹œê°„ëŒ€</h3>
        <span class="hint">ë¡œì»¬ ì‹œê°„ ê¸°ì¤€ Â· ì¢…í•©ì ìˆ˜ ê°€ì¤‘ì¹˜</span>
      </div>
      <div id="bestTimes" class="row" style="margin-top:6px; flex-wrap:wrap"></div>
    </div>

    <!-- í•´ì‹œíƒœê·¸ íŠ¸ë Œë“œ -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">ğŸ”¥ í•´ì‹œíƒœê·¸ íŠ¸ë Œë“œ</h3>
        <span class="hint">ìˆ˜ì§‘ëœ ì˜ìƒë“¤ì˜ ì¸ê¸° íƒœê·¸</span>
      </div>
      <div id="hashtagTrends" class="row" style="margin-top:6px; flex-wrap:wrap"></div>
    </div>

    <!-- S3: í‚¤ì›Œë“œ ì¥ê¸° íŠ¸ë Œë“œ -->
    <div class="longdash" id="longDash">
      <div class="ctrls">
        <h3>í‚¤ì›Œë“œ ì¥ê¸° íŠ¸ë Œë“œ</h3>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label>ì§€í‘œ</label>
          <select id="ltMetric">
            <option value="views">ì¡°íšŒ í•©(ì¼)</option>
            <option value="ema28" selected>EMA28(ì¡°íšŒ)</option>
            <option value="score">ìƒìŠ¹ë ¥ ì ìˆ˜</option>
          </select>
          <label>ê¸°ê°„</label>
          <select id="ltDays">
            <option value="90">90ì¼</option>
            <option value="180" selected>180ì¼</option>
          </select>
          <label>ìµœì†Œ í‘œë³¸</label>
          <input id="ltMinN" type="number" min="1" value="10" style="width:90px"/>
          <label><input id="ltSmoothing" type="checkbox" checked/> ìŠ¤ë¬´ë”©(EMA)</label>
          <button id="ltReload">ëŒ€ì‹œë³´ë“œ ê°±ì‹ </button>
        </div>
      </div>
      <div class="note">ìƒ˜í”Œ ë°ì´í„°ë¡œ ë™ì‘í•©ë‹ˆë‹¤. ë°°í¬ ì‹œ <code>kw-trend.json</code> ì—”ë“œí¬ì¸íŠ¸ë¡œ êµì²´í•©ë‹ˆë‹¤.</div>
      <div class="pills" id="ltPills"></div>
      <div class="grid">
        <div class="main"><div class="chart"><canvas id="ltChart"></canvas></div></div>
        <div class="side">
          <div class="sideOverlay">
            <div class="sideHead">
              <div class="title">ìƒìŠ¹ í‚¤ì›Œë“œ Top5</div>
              <div class="meta">ìµœê·¼ 7ì¼ vs ì§ì „ 7ì¼ Â· ì—…ë°ì´íŠ¸: <span id="ltUpdate"></span></div>
            </div>
            <div class="risers" id="ltRisers"></div>
          </div>
          <div class="sideChart"><canvas id="ltShare"></canvas></div>
        </div>
      </div>
    </div>

    <!-- ë°ì´í„° ê²€ì¦ ì¹´ë“œ -->
    <div class="card" id="ltValidationCard" style="margin-top:8px">
      <h3 style="margin:0 0 8px">ë°ì´í„° ê²€ì¦(ìµœê·¼ 30ì¼)</h3>
      <div id="ltValidation" class="row" style="flex-wrap:wrap;gap:8px">
        <span class="pill">í‘œë³¸ìˆ˜: -</span>
        <span class="pill">ê²°ì¸¡ ë¹„ì¤‘: -</span>
        <span class="pill">ì¼ ì¡°íšŒí•© ë²”ìœ„: -</span>
        <span class="pill">ì‚¬ìš© í‚¤ì›Œë“œ: -</span>
        <span class="pill">ì—”ë“œí¬ì¸íŠ¸: <code id="ltEndpoint">-</code></span>
      </div>
    </div>

    <!-- ì˜ìƒ ë¦¬ìŠ¤íŠ¸ -->
    <div class="card" style="margin-top:12px; position:relative">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">ì˜ìƒ ë¦¬ìŠ¤íŠ¸</h3>
        <div class="row small">
          <label>ë³´ê¸° í”„ë¦¬ì…‹</label>
          <select id="viewPreset">
            <option value="all">ì „ì²´(ê¸°ë³¸)</option>
            <option value="simple">ê°„ë‹¨</option>
            <option value="speedeng">ì†ë„Â·ë°˜ì‘</option>
            <option value="metrics">ì§€í‘œë§Œ</option>
            <option value="packaging">íŒ¨í‚¤ì§•</option>
            <option value="longform">ë¡±í¼ ìµœì í™”</option>
          </select>
          <label>ì •ë ¬</label>
          <select id="sortKey"></select>
          <select id="sortDir"><option value="desc">ë‚´ë¦¼ì°¨ìˆœ</option><option value="asc">ì˜¤ë¦„ì°¨ìˆœ</option></select>
          <label>ìµœì†Œ ë°˜ì‘ë¥  (â€°)</label><input id="fMinER" type="number" step="0.1" value="0" style="width:90px"/>
          <label>ìµœì†Œ ì¡°íšŒ ë°°ìœ¨</label><input id="fMinVX" type="number" step="0.1" value="0" style="width:90px"/>
          <label>ìµœì†Œ ì„íŒ©íŠ¸ ë“±ê¸‰</label>
          <select id="fMinGrade"><option value="ALL">ì „ì²´</option><option value="D">D</option><option value="C">C</option><option value="B">B</option><option value="A">A</option><option value="S">S</option></select>
        </div>
      </div>
      <div id="colToggles" class="row" style="gap:8px; margin:6px 0 8px; align-items:center; flex-wrap:wrap"></div>
      <div id="tableWrap" class="tableWrap">
        <table class="table" id="table">
          <thead>
            <tr>
              <th>â˜†</th>
              <th>ì¸ë„¤ì¼</th>
              <th>ì œëª©</th>
              <th>ì±„ë„</th>
              <th>ì—…ë¡œë“œì¼</th>
              <th>ê¸¸ì´</th>
              <th>íƒ€ì…</th>
              <th>ì¡°íšŒ</th>
              <th>ì¢‹ì•„ìš”</th>
              <th>ëŒ“ê¸€</th>
              <th>ì†ë„</th>
              <th>ë°˜ì‘ë¥  (â€°)</th>
              <th>ì‹ ì„ ë„</th>
              <th>ì¡°íšŒ ë°°ìœ¨</th>
              <th>ì†ë„ ë°°ìœ¨</th>
              <th>ì„íŒ©íŠ¸</th>
              <th>Î”24h</th>
              <th>RPMì¶”ì •</th>
              <th>ì¢…í•©</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="sideScroll" class="sideScroll">
        <button id="scrollUp">â–²</button>
        <button id="scrollDown">â–¼</button>
        <button id="scrollTop">TOP</button>
        <button id="scrollBottom">END</button>
      </div>
    </div>
  </div>

  <!-- S2: Channel Detail Modal -->
  <div id="channelModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="chTitle">
    <div class="modal-panel">
      <div class="modal-head">
        <div class="modal-title" id="chTitle">ì±„ë„ ìƒì„¸</div>
        <div class="meta-row" id="chLinkHolder"></div>
        <button class="badge-soft" id="chRefresh">ì‹¤ì‹œê°„ ìƒˆë¡œê³ ì¹¨</button>
        <button class="modal-close" id="chClose">ë‹«ê¸°</button>
      </div>
      <div id="chLoading" class="hint">ë¡œë”©ì¤‘â€¦</div>
      <div id="chError" class="hint" style="display:none;color:#ffb84d">ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤/ì¿¼í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.</div>
      <div id="chBody" style="display:none">
        <div class="kpi-grid" id="chKpi"></div>
        <div class="meta-row" id="chPatterns"></div>
        <div class="hr"></div>
        <div><b>ë² ìŠ¤íŠ¸ 3</b></div>
        <div class="best-grid" id="best3"></div>
        <div class="hr"></div>
        <div class="rev-box">
          <label>ì˜ˆìƒ CPM(â‚©/1kë·°)</label>
          <input id="cpmLow" type="number" min="0" value="500" style="width:100px"/>
          ~
          <input id="cpmHigh" type="number" min="0" value="2500" style="width:100px"/>
          <span class="hint">ìµœê·¼ ì˜ìƒ í•©ì‚° ë³´ìˆ˜ ì¶”ì •</span>
          <span class="rev-out" id="revOut"></span>
        </div>
      </div>
    </div>
  </div>

  <div class="row" style="position:fixed;left:0;right:0;bottom:0;background:rgba(9,14,20,.9);border-top:1px solid #1e2a36;padding:10px 16px;gap:8px;align-items:center;justify-content:center;font-size:12px">
    <span>Tip: <b>ì—…ë¡œë“œì¼Â·ì†ë„Â·ë°˜ì‘ë¥ </b>ì„ í•©ì³ ìƒìœ„ë§Œ ê³¨ë¼ ì‘ì—…í•˜ì„¸ìš”.</span>
  </div>

<script>
// ========== YouTube Content Radar v8.0 WITH LONGFORM ==========
// ëª¨ë“  í•¨ìˆ˜ë¥¼ ë¨¼ì € ì„ ì–¸í•œ í›„ ì´ë²¤íŠ¸ ë°”ì¸ë”© ë° ì´ˆê¸°í™”
(function(){
  // ========== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ==========
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const now = () => new Date();
  const hoursSince = iso => (now() - new Date(iso)) / 36e5;
  const fmt = n => (n===undefined || n===null) ? '-' : Number(n).toLocaleString('en-US');
  const escapeHtml = s => (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const toISO = d => new Date(d).toISOString();
  const isoToSeconds = dur => { const m=(dur||'').match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/); return m?(+(m[1]||0)*3600 + +(m[2]||0)*60 + +(m[3]||0)):0; };
  const hms = sec => { sec=+sec|0; const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; return (h? h+':':'') + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0'); };
  function uniq(arr){ return [...new Set(arr)]; }

  // ========== ìƒíƒœ ==========
  let STATE = {
    videos: [], 
    colVis:null, 
    sortKey:null, 
    sortDir:null,
    filters:{minER:0, minVX:0, minGrade:'ALL'},
    watch:new Set(), 
    snapshots:{},
    contentType: 'all'
  };

  // ========== ì €ì¥/ë¡œë“œ ==========
  function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
  function load(key,def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def;}catch(e){return def}}

  // ========== ì‹œê°„ í—¬í¼ ==========
  function pacificTodayStr(){
    try { return new Intl.DateTimeFormat('en-CA',{timeZone:'America/Los_Angeles',year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date()); }
    catch(_) { const d=new Date(); return d.toISOString().slice(0,10); }
  }
  function nextPacificMidnightISO(){
    try{ const la = new Date(new Date().toLocaleString('en-US', { timeZone:'America/Los_Angeles' })); la.setHours(24,0,0,0); return la.toISOString(); }
    catch(_){ const d=new Date(); d.setHours(24,0,0,0); return d.toISOString(); }
  }

  // ========== í‚¤ íšŒì „ ==========
  const ROT = {
    keys: [],
    idx: 0,
    stat: [],
    lastMarkTime: 0,
    
    load(){
      const arr = JSON.parse(localStorage.getItem('yt_api_keys')||'[]');
      const legacy = JSON.parse(localStorage.getItem('yt_api_key')||'""');
      this.keys = (arr && arr.length) ? arr : (legacy? [legacy] : []);
      
      const savedIdx = parseInt(localStorage.getItem('sr_curIdx')||'0', 10);
      this.idx = (savedIdx >= 0 && savedIdx < this.keys.length) ? savedIdx : 0;
      
      const savedStat = load('sr_keyStat', {}); 
      const savedDate = load('sr_keyStatDate', null); 
      const todayLA = pacificTodayStr(); 
      if(savedDate !== todayLA){ 
        save('sr_keyStatDate', todayLA); 
        save('sr_keyStat', {}); 
      }
      this.stat = this.keys.map((k,i) => savedStat[k] || {ok:0, fail:0, blocked:false, used:0});
      
      renderKeyState();
    },
    
    saveStat(){
      const obj = {};
      this.keys.forEach((k,i) => { 
        obj[k] = this.stat[i] || {ok:0, fail:0, blocked:false, used:0}; 
      });
      save('sr_keyStat', obj);
    },
    
    current(){ 
      return this.keys.length ? this.keys[this.idx] : null; 
    },
    
    rotate(){ 
      if(this.keys.length <= 1) return;
      
      let attempts = 0;
      do {
        this.idx = (this.idx + 1) % this.keys.length;
        attempts++;
      } while(this.stat[this.idx]?.blocked && attempts < this.keys.length);
      
      localStorage.setItem('sr_curIdx', String(this.idx));
      renderKeyState();
    },
    
    markOk(){ 
      const now = Date.now();
      if(now - this.lastMarkTime < 500) return;
      this.lastMarkTime = now;
      
      if(!this.stat[this.idx]) this.stat[this.idx] = {ok:0, fail:0, blocked:false, used:0};
      this.stat[this.idx].ok++;
      this.saveStat();
      renderKeyState();
    },
    
    markFail(){ 
      const now = Date.now();
      if(now - this.lastMarkTime < 500) return;
      this.lastMarkTime = now;
      
      if(!this.stat[this.idx]) this.stat[this.idx] = {ok:0, fail:0, blocked:false, used:0};
      const s = this.stat[this.idx];
      s.fail++;
      if(s.fail >= 3) {
        s.blocked = true;
      }
      this.saveStat();
      this.rotate();
      renderQuotaStateFlag();
    },
    
    resetKeyStats(){
      this.stat = this.keys.map(() => ({ok:0, fail:0, blocked:false, used:0}));
      this.saveStat();
      renderKeyState();
    }
  };

  // í‚¤ ìƒíƒœ í‘œì‹œ
  function renderKeyState(){
    const holder = $('#keyState');
    if (!holder) return;
    
    if (!ROT.keys.length){
      holder.innerHTML = '<span class="pill">í‚¤ ìƒíƒœ: ì—†ìŒ</span>';
      renderQuotaStateFlag();
      return;
    }
    
    holder.innerHTML = ROT.keys.map((_, i) => {
      const s = ROT.stat[i] || {ok:0, fail:0, blocked:false, used:0};
      const isActive = (i === ROT.idx);
      const className = s.blocked ? 'pill blocked' : (isActive ? 'pill active' : 'pill');
      
      return `
        <span class="${className}" 
              role="button" 
              tabindex="0" 
              title="ì„±ê³µ:${s.ok} ì‹¤íŒ¨:${s.fail} ì‚¬ìš©:${s.used||0}${s.blocked?' (ì°¨ë‹¨ë¨)':''}"
              onclick="window._pickKey(${i})"
              onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();window._pickKey(${i});}">
          <b>KEY${i+1}</b>
          ${isActive ? '<span class="badge">NOW</span>' : ''}
          <span class="badge">ok:${s.ok}</span>
          <span class="badge">fail:${s.fail}</span>
          ${s.used ? `<span class="badge">used:${s.used}</span>` : ''}
          ${s.blocked ? '<span class="badge">BLOCK</span>' : ''}
        </span>
      `;
    }).join('');
    
    renderQuotaStateFlag();
  }

  window._pickKey = function(i){
    if (i < 0 || i >= ROT.keys.length) return;
    if (ROT.stat[i]?.blocked) {
      alert('ì´ í‚¤ëŠ” ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í‚¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
      return;
    }
    ROT.idx = i;
    localStorage.setItem('sr_curIdx', String(i));
    renderKeyState();
    renderQuota();
  };

  // API í˜¸ì¶œ
  async function fetchWithRotate(url, quotaInc){
    const maxTry = Math.max(1, ROT.keys.length * 2);
    let lastError = null;
    let allBlocked = true;
    
    for(let i = 0; i < ROT.keys.length; i++) {
      if(!ROT.stat[i]?.blocked) {
        allBlocked = false;
        break;
      }
    }
    
    if(allBlocked && ROT.keys.length > 0) {
      console.log('ëª¨ë“  í‚¤ê°€ ì°¨ë‹¨ë¨. ì²« ë²ˆì§¸ í‚¤ ë¸”ë¡ í•´ì œ ì‹œë„...');
      ROT.stat[0].blocked = false;
      ROT.stat[0].fail = 0;
      ROT.saveStat();
      ROT.idx = 0;
      renderKeyState();
    }
    
    for(let t = 0; t < maxTry; t++){
      const key = ROT.current();
      if(!key) {
        throw new Error('ì‚¬ìš© ê°€ëŠ¥í•œ API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤');
      }
      
      if(ROT.stat[ROT.idx]?.blocked && !allBlocked) {
        ROT.rotate();
        continue;
      }
      
      const final = url + (url.includes('?') ? '&' : '?') + 'key=' + encodeURIComponent(key);
      
      try{
        const res = await fetch(final, {cache:'no-store'});
        
        if(res.ok){
          const data = await res.json();
          if(quotaInc){ 
            incQuota(quotaInc); 
            if(!ROT.stat[ROT.idx]) ROT.stat[ROT.idx] = {ok:0, fail:0, blocked:false, used:0};
            ROT.stat[ROT.idx].used = (ROT.stat[ROT.idx].used || 0) + quotaInc;
            ROT.saveStat();
          } 
          ROT.markOk();
          return data;
        } else {
          const errorText = await res.text(); 
          lastError = `HTTP ${res.status}: ${errorText}`; 
          if(shouldLockForQuota(res.status,errorText)) setQuotaLocked(true);
          
          if(res.status === 403 || (res.status >= 400 && res.status < 500)) {
            ROT.markFail();
          }
        }
      } catch(e) {
        lastError = e.message;
        ROT.markFail();
      }
    }
    
    throw new Error(`ëª¨ë“  í‚¤ ì‹œë„ ì‹¤íŒ¨: ${lastError}`);
  }

  // ========== ì¿¼í„° ==========
  const QUOTA_KEY='sr_quota';
  const QUOTA_LOCK_KEY='sr_quota_lock_until';
  
  function todayStr(){ return pacificTodayStr(); }
  function getQuota(){ let q = load(QUOTA_KEY, null); const today=todayStr(); if(!q) q={date:today, used:0, limit:10000}; if(q.date!==today){ q.date=today; q.used=0; } return q; }
  function saveQuota(q){ save(QUOTA_KEY, q); }
  function setQuotaLimit(n){ const q=getQuota(); q.limit=Math.max(1000, Number(n)||10000); saveQuota(q); renderQuota(); renderQuotaStateFlag(); }
  function incQuota(units){ 
    const q=getQuota(); 
    q.used += Math.max(0, units|0); 
    saveQuota(q); 
    renderQuota(); 
    renderQuotaStateFlag(); 
  }
  function resetQuota(){ 
    const q={date:todayStr(), used:0, limit:getQuota().limit}; 
    saveQuota(q); 
    if(ROT.stat){
      ROT.stat.forEach(s => { if(s) s.used = 0; });
      ROT.saveStat();
    }
    renderQuota(); 
    renderQuotaStateFlag(); 
    renderKeyState();
  }
  
  function renderQuota(){ 
    const q=getQuota(); 
    const pct=Math.min(100, Math.round((q.used/(q.limit||1))*100)); 
    
    let keyInfo = '';
    if(ROT.keys.length > 0){
      const keyUsed = (ROT.stat[ROT.idx] && ROT.stat[ROT.idx].used) || 0;
      keyInfo = ` [KEY${ROT.idx+1}: ${keyUsed}]`;
    }
    
    $('#quotaStat').innerHTML=`API ì‚¬ìš©ëŸ‰(ì˜¤ëŠ˜) <b>${q.used}</b> / ${q.limit} (${pct}%)${keyInfo}`; 
    $('#quotaLimit').value=q.limit; 
    $('#quotaBar .fill').style.width=pct+'%'; 
  }
  
  function isQuotaLocked(){ 
    const iso=localStorage.getItem(QUOTA_LOCK_KEY); 
    if(!iso) return false; 
    if(new Date(iso)<=new Date()){ 
      localStorage.removeItem(QUOTA_LOCK_KEY); 
      return false; 
    } 
    return true; 
  }
  
  function setQuotaLocked(on=true){ 
    if(on) localStorage.setItem(QUOTA_LOCK_KEY,nextPacificMidnightISO()); 
    else localStorage.removeItem(QUOTA_LOCK_KEY); 
    renderQuotaStateFlag(); 
  }
  
  function shouldLockForQuota(status, text){
    if(status===429) return true;
    if(status!==403) return false;
    const lower = String(text||'').toLowerCase();
    try{ 
      const j=JSON.parse(text); 
      const reason=(j?.error?.errors?.[0]?.reason||j?.error?.status||'').toLowerCase(); 
      if(['quotaexceeded','dailylimitexceeded','userratelimitexceeded','ratelimitexceeded'].includes(reason)) return true; 
    }catch(_){}
    if(/quota|daily.*limit|userratelimitexceeded|ratelimitexceeded/.test(lower)) return true;
    return false;
  }
  
  function renderQuotaStateFlag(){
    const el = $('#quotaStateFlag');
    if(!el) return;
    
    let allKeysBlocked = false;
    if(ROT.keys.length > 0){
      allKeysBlocked = ROT.stat.every(s => s && s.blocked);
    }
    
    const offline = isQuotaLocked() || allKeysBlocked;
    el.className = 'quota-flag ' + (offline ? 'offline' : 'online');
    el.innerHTML = 'ìƒíƒœ: <b>' + (offline ? 'OFFLINE(ì¿¼í„° ì†Œì§„)' : 'ONLINE') + '</b>';
  }

  // ========== API ==========
  async function ytSearch({q, channelId, publishedAfter, regionCode, maxResults, pageToken, lang, durBucket, order, videoCategoryId}){
    const params = new URLSearchParams({
      part:'snippet', 
      type:'video', 
      maxResults:String(Math.min(50, maxResults||50))
    });
    
    if(publishedAfter) params.set('publishedAfter', publishedAfter);
    if(regionCode) params.set('regionCode', regionCode);
    if(lang) params.set('relevanceLanguage', lang);
    
    params.set('order', order || 'date');
    if(q) params.set('q', q);
    if(channelId) params.set('channelId', channelId);
    if(pageToken) params.set('pageToken', pageToken);
    if(durBucket) params.set('videoDuration', durBucket);
    if(videoCategoryId) params.set('videoCategoryId', videoCategoryId);
    
    const url = `https://www.googleapis.com/youtube/v3/search?${params.toString()}`;
    return fetchWithRotate(url, 100);
  }
  
  async function ytVideos(ids){
    const url = `https://www.googleapis.com/youtube/v3/videos?`+
      new URLSearchParams({part:'snippet,contentDetails,statistics', id: ids.join(',')}).toString();
    return fetchWithRotate(url, 1);
  }
  
  // ========== Seedless ì¹´í…Œê³ ë¦¬ë³„ ìˆ˜ì§‘ ==========
  async function ytSearchSeedlessShorts({regionCode, lang, publishedAfter, maxResults=80}){
    console.log('ğŸ¯ Seedless ëª¨ë“œ: 16ê°œ ì¹´í…Œê³ ë¦¬ë³„ ìˆ˜ì§‘');
    console.log(`ğŸ” ì„¤ì •: ì§€ì—­=${regionCode}, ì–¸ì–´=${lang}, ëª©í‘œ=${maxResults}ê°œ`);
    
    const allVideos = [];
    const stats = {};
    const failedCategories = [];
    
    const categories = [
      { name: 'ìŒì•…', keywords: regionCode === 'KR' ? ['ìŒì•… ì‡¼ì¸ ', 'kpop ì‡¼ì¸ ', 'ë®¤ì§ë¹„ë””ì˜¤ shorts', 'ë…¸ë˜ shorts'] : ['music shorts', 'music video shorts', 'pop music', 'song shorts'], weight: 3 },
      { name: 'ê²Œì„', keywords: regionCode === 'KR' ? ['ê²Œì„ ì‡¼ì¸ ', 'ê²Œì„ í•˜ì´ë¼ì´íŠ¸', 'ë¡¤ ë§¤ë“œë¬´ë¹„', 'ê²Œì„ í”Œë ˆì´'] : ['gaming shorts', 'gameplay shorts', 'game clips', 'gaming highlights'], weight: 3 },
      { name: 'ìœ ë¨¸', keywords: regionCode === 'KR' ? ['ì›ƒê¸´ ì˜ìƒ', 'ìœ ë¨¸ ëª¨ìŒ', 'ë ˆì „ë“œ ì§¤', 'ê°œê·¸ ì‡¼ì¸ '] : ['funny shorts', 'meme compilation', 'comedy shorts', 'hilarious clips'], weight: 3 },
      { name: 'ë™ë¬¼', keywords: regionCode === 'KR' ? ['ê°•ì•„ì§€ ê³ ì–‘ì´', 'ê·€ì—¬ìš´ ë™ë¬¼', 'í«íŠœë¸Œ', 'ë™ë¬¼ ì‡¼ì¸ '] : ['cute animals', 'pets shorts', 'dog cat', 'animal shorts'], weight: 2 },
      { name: 'ìŠ¤í¬ì¸ ', keywords: regionCode === 'KR' ? ['ìŠ¤í¬ì¸  í•˜ì´ë¼ì´íŠ¸', 'ì¶•êµ¬ ê³¨ëª¨ìŒ', 'ì•¼êµ¬ ëª…ì¥ë©´', 'ìŠ¤í¬ì¸  ì‡¼ì¸ '] : ['sports highlights', 'football shorts', 'basketball', 'sports clips'], weight: 2 },
      { name: 'ëŒ„ìŠ¤', keywords: regionCode === 'KR' ? ['ëŒ„ìŠ¤ ì±Œë¦°ì§€', 'ì¶¤ ì»¤ë²„', 'í‹±í†¡ ëŒ„ìŠ¤', 'ëŒ„ìŠ¤ ì‡¼ì¸ '] : ['dance challenge', 'dance cover', 'tiktok dance', 'dance shorts'], weight: 2 },
      { name: 'ì—°ì˜ˆ', keywords: regionCode === 'KR' ? ['ì—°ì˜ˆ ì§¤', 'ì—°ì˜ˆì¸ ì†Œì‹', 'ì•„ì´ëŒ ì‡¼ì¸ ', 'ì—°ì˜ˆê³„'] : ['celebrity news', 'kpop idol', 'entertainment shorts', 'celebrity'], weight: 2 },
      { name: 'ì˜í™”', keywords: regionCode === 'KR' ? ['ì˜í™” ëª…ì¥ë©´', 'ì˜í™” ë¦¬ë·°', 'ì˜í™” ì¶”ì²œ', 'ì˜í™” ì‡¼ì¸ '] : ['movie scenes', 'movie review', 'film clips', 'movie shorts'], weight: 2 },
      { name: 'ë“œë¼ë§ˆ', keywords: regionCode === 'KR' ? ['ë“œë¼ë§ˆ í•˜ì´ë¼ì´íŠ¸', 'ë“œë¼ë§ˆ ëª…ì¥ë©´', 'ì›¹ë“œë¼ë§ˆ', 'ë“œë¼ë§ˆ ì‡¼ì¸ '] : ['drama scenes', 'kdrama shorts', 'tv shows', 'drama clips'], weight: 2 },
      { name: 'AI', keywords: regionCode === 'KR' ? ['AI ì˜ìƒ', 'AI ìƒì„±', 'ì¸ê³µì§€ëŠ¥', 'AI ì‡¼ì¸ '] : ['AI generated', 'AI video', 'artificial intelligence', 'AI shorts'], weight: 1 },
      { name: 'ì˜ˆëŠ¥', keywords: regionCode === 'KR' ? ['ì˜ˆëŠ¥ ë ˆì „ë“œ', 'ëŸ°ë‹ë§¨ ì‡¼ì¸ ', 'ë‚˜í˜¼ì‚°', 'ì˜ˆëŠ¥ í•˜ì´ë¼ì´íŠ¸'] : ['variety show', 'korean variety', 'tv show funny', 'variety shorts'], weight: 2 },
      { name: 'ì‹œë‹ˆì–´', keywords: regionCode === 'KR' ? ['ì‹œë‹ˆì–´ ìœ íŠœë¸Œ', '5060 ì˜ìƒ', 'ì¤‘ë…„ ì‡¼ì¸ ', 'ì‹¤ë²„ ìœ íŠœë¸Œ'] : ['senior content', 'boomer videos', 'elderly shorts', 'senior citizens'], weight: 1 },
      { name: 'êµ­ë½•', keywords: regionCode === 'KR' ? ['êµ­ë½• ì˜ìƒ', 'í•œêµ­ ìë‘', 'êµ­ê°€ ìë¶€ì‹¬', 'ëŒ€í•œë¯¼êµ­'] : ['korean pride', 'korea amazing', 'korean culture', 'korea best'], weight: 1 },
      { name: 'ì˜¤í”¼ì…œ', keywords: regionCode === 'KR' ? ['ê³µì‹ ë®¤ì§ë¹„ë””ì˜¤', 'official MV', 'ê³µì‹ ì˜ìƒ', 'ì˜¤í”¼ì…œ'] : ['official music video', 'official MV', 'VEVO', 'official video'], weight: 1 },
      { name: 'ë¦¬ë·°', keywords: regionCode === 'KR' ? ['ì œí’ˆ ë¦¬ë·°', 'ì–¸ë°•ì‹±', 'ì‚¬ìš©ê¸°', 'ë¦¬ë·° ì‡¼ì¸ '] : ['product review', 'unboxing', 'tech review', 'review shorts'], weight: 2 },
      { name: 'ì •ì¹˜', keywords: regionCode === 'KR' ? ['ì •ì¹˜ ë‰´ìŠ¤', 'ì •ì¹˜ ì§¤', 'ì‹œì‚¬ ì‡¼ì¸ ', 'ì •ì¹˜ ì˜ìƒ'] : ['politics shorts', 'political news', 'news shorts', 'political clips'], weight: 1 }
    ];
    
    console.log(`ğŸ“Š ${categories.length}ê°œ ì¹´í…Œê³ ë¦¬ ì¤€ë¹„ ì™„ë£Œ`);
    
    for(let i = 0; i < categories.length; i++){
      const cat = categories[i];
      const targetPerCategory = 3;
      
      console.log(`\nğŸ” [${i+1}/${categories.length}] ${cat.name} (ê°€ì¤‘ì¹˜:${cat.weight})`);
      
      const categoryVideos = [];
      
      for(let ki = 0; ki < cat.keywords.length && categoryVideos.length < targetPerCategory; ki++){
        const keyword = cat.keywords[ki];
        
        try{
          console.log(`  ê²€ìƒ‰ ${ki+1}: "${keyword}"`);
          
          const res = await ytSearch({
            q: keyword,
            publishedAfter: publishedAfter,
            regionCode: regionCode,
            lang: lang,
            maxResults: 15,
            order: 'viewCount'
          });
          
          if(res && res.items && res.items.length > 0){
            const needed = targetPerCategory - categoryVideos.length;
            const topItems = res.items.slice(0, Math.min(needed, res.items.length));
            
            topItems.forEach(item => {
              item._category = cat.name;
              categoryVideos.push(item);
            });
            
            console.log(`    âœ… ${topItems.length}ê°œ ì¶”ê°€ (ëˆ„ì : ${categoryVideos.length}ê°œ)`);
            
            if(categoryVideos.length >= targetPerCategory) break;
          }
          
        } catch(e){
          console.error(`    âŒ ì˜¤ë¥˜:`, e.message);
        }
        
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      stats[cat.name] = categoryVideos.length;
      if(categoryVideos.length === 0){
        failedCategories.push(cat.name);
      }
      
      allVideos.push(...categoryVideos);
      await new Promise(resolve => setTimeout(resolve, 150));
    }
    
    console.log(`\nâœ¨ ì´ ${allVideos.length}ê°œ ì˜ìƒ ìˆ˜ì§‘ ì™„ë£Œ`);
    
    window.__seedlessStats = {...stats};
    window.__seedlessFailedCategories = [...failedCategories];
    
    allVideos._seedlessStats = stats;
    return allVideos;
  }
  
  async function ytChannels(ids){
    const url = `https://www.googleapis.com/youtube/v3/channels?`+
      new URLSearchParams({part:'snippet,statistics,contentDetails', id: ids.join(',')}).toString();
    return fetchWithRotate(url, 1);
  }
  
  // ========== ì½˜í…ì¸  íƒ€ì… íŒë³„ ==========
  function getContentType(v){
    const sec = isoToSeconds(v.contentDetails?.duration || 'PT0S');
    if(sec <= 60) return 'shorts';
    if(sec <= 600) return 'mid';
    if(sec <= 1200) return 'long';
    return 'vlong';
  }
  
  function isContentMatch(v, contentType, minSec, maxSec){
    const sec = isoToSeconds(v.contentDetails?.duration || 'PT0S');
    
    if(minSec !== undefined && maxSec !== undefined){
      return sec >= minSec && sec <= maxSec;
    }
    
    switch(contentType){
      case 'shorts': return sec <= 60;
      case 'mid': return sec > 60 && sec <= 600;
      case 'long': return sec > 60;
      case 'vlong': return sec > 1200;
      case 'all':
      default: return true;
    }
  }

  // ========== ì§€í‘œ ê³„ì‚° ==========
  function expDecay(hours, tau=48){ return Math.exp(-hours/ tau); }
  
  function estimateRPM(v){
    const views = +v.statistics.viewCount || 0;
    const duration = isoToSeconds(v.contentDetails?.duration || 'PT0S');
    
    let baseCPM = 500;
    if(duration > 600) baseCPM = 1500;
    if(duration > 1200) baseCPM = 2000;
    
    const er = (+v.statistics.likeCount + 5*(+v.statistics.commentCount)) / Math.max(1, views) * 1000;
    const erMultiplier = Math.min(2, Math.max(0.5, er / 10));
    
    return baseCPM * erMultiplier;
  }
  
  function computeDerived(all){
    all.forEach(v=>{
      const hours = Math.max(0.01, hoursSince(v.snippet.publishedAt));
      const views = +v.statistics.viewCount||0;
      const likes = +v.statistics.likeCount||0;
      const comments = +v.statistics.commentCount||0;
      const vel = views / hours;
      const er = (likes + 5*comments) / Math.max(1, views) * 1000;
      const fresh = expDecay(hours, 48);
      const contentType = getContentType(v);
      const rpm = estimateRPM(v);
      
      v._d = {hours, views, likes, comments, vel, er, fresh, contentType, rpm};
    });
    
    const avg = (arr,fn)=> arr.reduce((s,x)=>s+fn(x),0)/Math.max(1,arr.length);
    const meanViews = avg(all, x=>x._d.views)||1;
    const meanVel   = avg(all, x=>x._d.vel)||1;
    
    all.forEach(v=>{
      v._d.viewMult = v._d.views / meanViews;
      v._d.velMult  = v._d.vel / meanVel;
    });
    
    all.forEach(v=>{
      const fit = 0.0001;
      v._d.pick = Math.pow(v._d.vel,0.5) * Math.pow(Math.max(v._d.er,0),0.3) * Math.pow(v._d.fresh,0.2) * fit;
    });
    
    const picks = all.map(v=>v._d.pick).sort((a,b)=>a-b);
    function percentile(value){
      if(!picks.length) return 0;
      const idx = picks.findIndex(x=>value<=x);
      const i = (idx<0? picks.length-1 : idx);
      return Math.round((i/(picks.length-1||1))*100);
    }
    
    all.forEach(v=>{
      const p = percentile(v._d.pick);
      let g='D';
      if(p>=90) g='S'; else if(p>=80) g='A'; else if(p>=60) g='B'; else if(p>=40) g='C'; else g='D';
      v._impact = {percentile:p, grade:g};
    });
  }

  // ========== ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ ==========
  function loadWatch(){ STATE.watch = new Set(load('sr_watchlist', [])); STATE.snapshots = load('sr_snapshots', {} ) || {}; }
  function saveWatch(){ save('sr_watchlist', [...STATE.watch]); save('sr_snapshots', STATE.snapshots); }
  function toggleWatch(id){ if(STATE.watch.has(id)) STATE.watch.delete(id); else STATE.watch.add(id); saveWatch(); renderTable(STATE.videos); }
  function pushSnapshot(id, v){ const s=STATE.snapshots[id] || (STATE.snapshots[id]=[]); s.push({t:toISO(new Date()), views:+(v.statistics.viewCount||0)}); STATE.snapshots[id]=s.slice(-50); saveWatch(); }
  function delta24h(id){ const s=STATE.snapshots[id]||[]; if(s.length<2) return 0; const nowt=new Date(); const from=new Date(nowt - 24*3600*1000); const recent=s.filter(x=> new Date(x.t)>=from); if(recent.length<2) return 0; const first=recent[0], last=recent[recent.length-1]; return (last.views-first.views)||0; }

  // ========== ì»¬ëŸ¼/ì •ë ¬ ==========
  function defaultColVis(){
    return {
      bookmark:true,thumb:true,title:true,channel:true,uploadedAt:true,
      length:true,contentType:true,views:true,likes:true,comments:true,
      vel:true,er:true,fresh:true,viewMult:true,velMult:true,
      impact:true,delta:true,rpm:true,pick:true
    };
  }
  
  function buildColToggles(){
    if(!STATE.colVis) STATE.colVis = load('sr_cols', null) || defaultColVis();
    const holder = $('#colToggles'); holder.innerHTML='';
    const keys = Object.keys(STATE.colVis);
    const labels = {
      bookmark:'â˜†', thumb:'ì¸ë„¤ì¼', title:'ì œëª©', channel:'ì±„ë„', 
      uploadedAt:'ì—…ë¡œë“œì¼', length:'ê¸¸ì´', contentType:'íƒ€ì…',
      views:'ì¡°íšŒ', likes:'ì¢‹ì•„ìš”', comments:'ëŒ“ê¸€', 
      vel:'ì†ë„', er:'ë°˜ì‘ë¥  (â€°)', fresh:'ì‹ ì„ ë„', 
      viewMult:'ì¡°íšŒ ë°°ìœ¨', velMult:'ì†ë„ ë°°ìœ¨', 
      impact:'ì„íŒ©íŠ¸', delta:'Î”24h', rpm:'RPMì¶”ì •', pick:'ì¢…í•©'
    };
    
    keys.forEach(k=>{
      const id='vis_'+k; 
      const w=document.createElement('label'); 
      w.style.display='flex'; 
      w.style.alignItems='center'; 
      w.style.gap='6px'; 
      w.className='hint';
      w.innerHTML = `<input type="checkbox" id="${id}" ${STATE.colVis[k]?'checked':''}/> ${labels[k]||k}`;
      holder.appendChild(w);
      w.querySelector('input').addEventListener('change', ()=>{ 
        STATE.colVis[k]=w.querySelector('input').checked; 
        save('sr_cols', STATE.colVis); 
        applyColumnVisibility(); 
      });
    });
  }
  
  function applyColumnVisibility(){
    const keys = Object.keys(defaultColVis());
    keys.forEach(k=>{
      $$('#table thead th')[keys.indexOf(k)]?.classList.add('c-'+k);
    });
    Object.keys(STATE.colVis).forEach((k)=>{
      const show = STATE.colVis[k];
      document.querySelectorAll('.c-'+k).forEach(el=>{ el.style.display = show ? '' : 'none'; });
    });
  }
  
  function buildSortKeys(){
    if(!STATE.sortKey) STATE.sortKey = load('sr_sortKey', null) || 'uploadedAt';
    if(!STATE.sortDir) STATE.sortDir = load('sr_sortDir', null) || 'desc';
    const labelMap = {
      pick:'ì¢…í•©', uploadedAt:'ì—…ë¡œë“œì¼', er:'ë°˜ì‘ë¥  (â€°)', 
      viewMult:'ì¡°íšŒ ë°°ìœ¨', velMult:'ì†ë„ ë°°ìœ¨', 
      views:'ì¡°íšŒ', vel:'ì†ë„', rpm:'RPM'
    };
    const opts = ['pick','uploadedAt','er','viewMult','velMult','views','vel','rpm'];
    const sk = $('#sortKey'); 
    sk.innerHTML=''; 
    opts.forEach(k=>{ 
      const o=document.createElement('option'); 
      o.value=k; 
      o.textContent=labelMap[k]||k; 
      sk.appendChild(o); 
    });
    if(!opts.includes(STATE.sortKey)) STATE.sortKey='uploadedAt';
    sk.value = STATE.sortKey; 
    $('#sortDir').value = STATE.sortDir;
    sk.addEventListener('change', ()=>{ 
      STATE.sortKey=sk.value; 
      save('sr_sortKey', STATE.sortKey); 
      renderTable(STATE.videos); 
    });
    $('#sortDir').addEventListener('change', ()=>{ 
      STATE.sortDir=$('#sortDir').value; 
      save('sr_sortDir', STATE.sortDir); 
      renderTable(STATE.videos); 
    });
  }

  // ========== í•´ì‹œíƒœê·¸ íŠ¸ë Œë“œ ==========
  function extractHashtags(videos){
    const hashtagMap = {};
    
    videos.forEach(v => {
      const text = `${v.snippet.title || ''} ${v.snippet.description || ''}`;
      const hashtags = text.match(/#[ê°€-í£a-zA-Z0-9_]+/g) || [];
      
      hashtags.forEach(tag => {
        const normalizedTag = tag.toLowerCase();
        if(!hashtagMap[normalizedTag]) {
          hashtagMap[normalizedTag] = {
            tag: tag,
            count: 0,
            videos: []
          };
        }
        hashtagMap[normalizedTag].count++;
        hashtagMap[normalizedTag].videos.push(v.id);
      });
    });
    
    const sortedTags = Object.values(hashtagMap)
      .sort((a, b) => b.count - a.count)
      .slice(0, 20);
    
    return sortedTags;
  }
  
  function renderHashtagTrends(videos){
    const holder = $('#hashtagTrends');
    if(!holder) return;
    
    const hashtags = extractHashtags(videos);
    
    if(hashtags.length === 0) {
      holder.innerHTML = '<span class="hint">ìˆ˜ì§‘ëœ ì˜ìƒì— í•´ì‹œíƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
      return;
    }
    
    const maxCount = Math.max(...hashtags.map(h => h.count));
    
    holder.innerHTML = hashtags.slice(0, 10).map(h => {
      const ratio = h.count / maxCount;
      const size = 12 + Math.round(ratio * 8);
      const opacity = 0.6 + ratio * 0.4;
      
      let bgColor, borderColor, textColor;
      if(ratio > 0.7) {
        bgColor = '#0f2b1a';
        borderColor = '#1f4b2a';  
        textColor = '#b9ffd0';
      } else if(ratio > 0.4) {
        bgColor = '#0e232f';
        borderColor = '#214056';
        textColor = '#bfe7ff';
      } else {
        bgColor = '#0e1620';
        borderColor = '#213142';
        textColor = '#a8b9cc';
      }
      
      return `<span class="tag" 
                    style="font-size:${size}px; 
                           opacity:${opacity};
                           background:${bgColor};
                           border-color:${borderColor};
                           color:${textColor};
                           font-weight:${ratio > 0.5 ? '600' : '400'}"
                    title="${h.count}ê°œ ì˜ìƒì—ì„œ ì‚¬ìš©">
                ${h.tag} 
                <small style="opacity:0.7">(${h.count})</small>
              </span>`;
    }).join('');
    
    if(hashtags.length > 10) {
      holder.innerHTML += `<span class="hint" style="margin-left:8px">+${hashtags.length - 10}ê°œ ë”...</span>`;
    }
  }

  // ========== ì½˜í…ì¸  íƒ€ì… ë¹„êµ ëŒ€ì‹œë³´ë“œ ==========
  function renderComparisonDash(videos){
    const dash = $('#compareDash');
    if(!dash || !videos || videos.length === 0) {
      if(dash) dash.style.display = 'none';
      return;
    }
    
    const shorts = videos.filter(v => v._d.contentType === 'shorts');
    const longs = videos.filter(v => v._d.contentType !== 'shorts');
    
    if(shorts.length === 0 || longs.length === 0) {
      dash.style.display = 'none';
      return;
    }
    
    dash.style.display = 'block';
    
    const avg = (arr, fn) => arr.reduce((s,x) => s + fn(x), 0) / Math.max(1, arr.length);
    
    $('#cmpShortsCount').textContent = shorts.length;
    $('#cmpShortsViews').textContent = Math.round(avg(shorts, v => v._d.views)).toLocaleString();
    $('#cmpShortsER').textContent = avg(shorts, v => v._d.er).toFixed(1) + 'â€°';
    $('#cmpShortsVel').textContent = avg(shorts, v => v._d.vel).toFixed(1);
    
    $('#cmpLongCount').textContent = longs.length;
    $('#cmpLongViews').textContent = Math.round(avg(longs, v => v._d.views)).toLocaleString();
    $('#cmpLongER').textContent = avg(longs, v => v._d.er).toFixed(1) + 'â€°';
    $('#cmpLongRPM').textContent = 'â‚©' + Math.round(avg(longs, v => v._d.rpm || 0));
    
    const ctx = $('#compareChart');
    if(ctx && window.Chart){
      if(window.compareChartInstance){
        window.compareChartInstance.destroy();
      }
      
      window.compareChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['ì‡¼ì¸ ', 'ë¡±í¼'],
          datasets: [{
            label: 'í‰ê·  ì¡°íšŒìˆ˜',
            data: [
              Math.round(avg(shorts, v => v._d.views)),
              Math.round(avg(longs, v => v._d.views))
            ],
            backgroundColor: ['#3b82f6', '#8b5cf6']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
  }

  // ========== í…Œì´ë¸” ë Œë”ë§ ==========
  function getSortValue(v,key){
    switch(key){
      case 'views': return +v.statistics.viewCount||0;
      case 'vel': return v._d.vel||0;
      case 'er': return v._d.er||0;
      case 'fresh': return v._d.fresh||0;
      case 'velMult': return v._d.velMult||0;
      case 'viewMult': return v._d.viewMult||0;
      case 'pick': return v._d.pick||0;
      case 'rpm': return v._d.rpm||0;
      case 'uploadedAt': return new Date(v.snippet.publishedAt).getTime();
      default: return v._d.vel||0;
    }
  }
  
  function rankGrade(g){ return ({'D':1,'C':2,'B':3,'A':4,'S':5}[g]||0); }
  
  function renderTable(videos){
    if(Array.isArray(videos) && videos.length > 0){
      saveSnapshot();
    }
    
    const tb = $('#tbody'); 
    tb.innerHTML='';
    const f = STATE.filters;
    const filtered = videos.filter(v=> 
      (v._d.er >= (f.minER||0)) && 
      (v._d.viewMult >= (f.minVX||0)) && 
      (f.minGrade==='ALL' || rankGrade(v._impact.grade) >= rankGrade(f.minGrade))
    );
    
    const key = STATE.sortKey || 'uploadedAt';
    const asc = (STATE.sortDir || 'desc')==='asc';
    filtered.sort((a,b)=>{ 
      const av=getSortValue(a,key), bv=getSortValue(b,key); 
      return asc? (av-bv):(bv-av); 
    });
    
    for(const v of filtered){
      const sec = isoToSeconds(v.contentDetails.duration||'PT0S');
      const delta = delta24h(v.id);
      const catBadge = v._category ? `<span class="badge">${v._category}</span>` : '';
      
      let typeBadge = '';
      switch(v._d.contentType){
        case 'shorts': typeBadge = '<span class="badge" style="background:#3b82f6;color:#fff">ì‡¼ì¸ </span>'; break;
        case 'mid': typeBadge = '<span class="badge midform-badge">ë¯¸ë“œ</span>'; break;
        case 'long': typeBadge = '<span class="badge longform-badge">ë¡±í¼</span>'; break;
        case 'vlong': typeBadge = '<span class="badge" style="background:#dc2626;color:#fff">ì¥í¸</span>'; break;
      }
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="c-bookmark"><span class="star ${STATE.watch.has(v.id)?'on':''}" data-id="${v.id}">${STATE.watch.has(v.id)?'â˜…':'â˜†'}</span></td>
        <td class="c-thumb"><a href="https://www.youtube.com/watch?v=${v.id}" target="_blank"><img class="thumb" src="${v.snippet.thumbnails?.medium?.url||''}"/></a></td>
        <td class="c-title">${escapeHtml(v.snippet.title||'')} ${catBadge}</td>
        <td class="c-channel"><button class="ch-link" data-cid="${v.snippet.channelId||''}" data-ctitle="${escapeHtml(v.snippet.channelTitle||'')}">${escapeHtml(v.snippet.channelTitle||'')}</button></td>
        <td class="c-uploadedAt" title="${v.snippet.publishedAt}">${new Date(v.snippet.publishedAt).toLocaleString('ko-KR')}</td>
        <td class="c-length">${hms(sec)}</td>
        <td class="c-contentType">${typeBadge}</td>
        <td class="c-views">${fmt(v.statistics.viewCount)}</td>
        <td class="c-likes">${fmt(v.statistics.likeCount)}</td>
        <td class="c-comments">${fmt(v.statistics.commentCount)}</td>
        <td class="c-vel">${(v._d.vel).toFixed(1)}</td>
        <td class="c-er">${(v._d.er).toFixed(2)}</td>
        <td class="c-fresh">${(v._d.fresh).toFixed(2)}</td>
        <td class="c-viewMult">${(v._d.viewMult).toFixed(2)}Ã—</td>
        <td class="c-velMult">${(v._d.velMult).toFixed(2)}Ã—</td>
        <td class="c-impact"><span class="badge grade-${v._impact.grade}">${v._impact.grade}</span> <span class="muted">(${v._impact.percentile})</span></td>
        <td class="c-delta"><span class="${delta>0?'good':''}">+${fmt(delta||0)}</span></td>
        <td class="c-rpm">â‚©${Math.round(v._d.rpm||0)}</td>
        <td class="c-pick"><b>${(v._d.pick).toFixed(2)}</b></td>`;
      tb.appendChild(tr);
    }
    
    tb.querySelectorAll('.star').forEach(s=> 
      s.addEventListener('click', (ev)=>{ 
        const id=ev.target.getAttribute('data-id'); 
        toggleWatch(id);
      })
    );
    
    tb.querySelectorAll('.ch-link').forEach(btn=> 
      btn.addEventListener('click', ()=> 
        openChannelModal(btn.dataset.cid, btn.dataset.ctitle)
      )
    );
    
    applyColumnVisibility();
    setSummary(videos, filtered);
    renderBestTimes(videos);
    renderHashtagTrends(videos);
    renderComparisonDash(videos);
  }

  // ========== ìš”ì•½ ==========
  function setSummary(all, filtered){
    const avg = (arr,fn)=> arr.reduce((s,x)=>s+fn(x),0)/Math.max(1,arr.length);
    
    const categoryDist = {};
    all.forEach(v => {
      const cat = v._category || 'ê¸°íƒ€';
      categoryDist[cat] = (categoryDist[cat] || 0) + 1;
    });
    
    const typeDist = {};
    all.forEach(v => {
      const type = v._d.contentType || 'unknown';
      typeDist[type] = (typeDist[type] || 0) + 1;
    });
    
    const pills = [
      `<span class="pill">ì´ ìˆ˜ì§‘ <b>${all.length}</b></span>`,
      `<span class="pill">í‘œì‹œ <b>${filtered.length}</b></span>`,
      `<span class="pill">í‰ê·  ì†ë„ <b>${avg(all,x=>x._d.vel).toFixed(1)}</b></span>`,
      `<span class="pill">í‰ê·  ë°˜ì‘ë¥  <b>${avg(all,x=>x._d.er).toFixed(2)}</b>â€°</span>`
    ];
    
    if(Object.keys(typeDist).length > 0){
      const types = Object.entries(typeDist)
        .sort((a, b) => b[1] - a[1])
        .map(([type, count]) => {
          const label = {
            'shorts': 'ì‡¼ì¸ ',
            'mid': 'ë¯¸ë“œ',
            'long': 'ë¡±í¼',
            'vlong': 'ì¥í¸'
          }[type] || type;
          return `${label}:${count}`;
        });
      pills.push(`<span class="pill">ğŸ“º íƒ€ì…: ${types.join(' ')}</span>`);
    }
    
    if(Object.keys(categoryDist).length > 0){
      const categories = Object.entries(categoryDist)
        .sort((a, b) => b[1] - a[1])
        .map(([cat, count]) => `${cat}:${count}`);
      
      pills.push(`<span class="pill">ğŸ” ì¹´í…Œê³ ë¦¬ë³„: ${categories.join(' ')}</span>`);
      
      const seedlessCategories = ['ìŒì•…', 'ê²Œì„', 'ìœ ë¨¸', 'ë™ë¬¼', 'ìŠ¤í¬ì¸ ', 'ëŒ„ìŠ¤', 'ì—°ì˜ˆ', 'ì˜í™”', 'ë“œë¼ë§ˆ', 'AI', 'ì˜ˆëŠ¥', 'ì‹œë‹ˆì–´', 'êµ­ë½•', 'ì˜¤í”¼ì…œ', 'ë¦¬ë·°', 'ì •ì¹˜'];
      const isSeedless = Object.keys(categoryDist).some(cat => seedlessCategories.includes(cat));
      
      if(isSeedless){
        const collectedCategories = Object.keys(categoryDist).filter(cat => seedlessCategories.includes(cat));
        const totalAttempted = 16;
        const totalCollected = collectedCategories.length;
        
        pills.push(`<span class="pill">âœ¨ Seedless: ${totalCollected}/${totalAttempted}ê°œ ì¹´í…Œê³ ë¦¬ ì„±ê³µ</span>`);
      }
    }
    
    $('#summary').innerHTML = pills.join(' ');
  }
  
  function renderBestTimes(videos){
    const slots = new Array(24).fill(0);
    videos.forEach(v=>{ 
      const h=new Date(v.snippet.publishedAt).getHours(); 
      slots[h]+= (v._d.pick||0); 
    });
    const arr = slots.map((v,i)=>({h:i,score:v})).sort((a,b)=>b.score-a.score).slice(0,5);
    const out = arr.map(x=>`<span class="tag">${String(x.h).padStart(2,'0')}:00</span>`).join('');
    $('#bestTimes').innerHTML = out || '<span class="hint">ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</span>';
  }

  // ========== ì‹¤í–‰ í•¨ìˆ˜ (ì „ì—­ ë…¸ì¶œ) ==========
  window.run = async function(){
    if(!ROT.keys.length) return alert('API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. ìƒë‹¨ì— ì—¬ëŸ¬ í‚¤ë¥¼ ë¶™ì—¬ë„£ê³  [í‚¤ ì €ì¥]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
    
    const days = +$('#days').value||7;
    const region = $('#region').value||'KR';
    const lang = $('#lang').value||'ko';
    const maxResults = +$('#maxResults').value||80;
    const contentType = $('#contentType').value || 'all';
    let minSec = +($('#minSec').value);
    let maxSec = +($('#maxSec').value);
    
    if(contentType === 'shorts'){
      minSec = 0;
      maxSec = 60;
    } else if(contentType === 'mid'){
      minSec = 61;
      maxSec = 600;
    } else if(contentType === 'long'){
      minSec = 61;
      maxSec = 3600;
    } else if(contentType === 'vlong'){
      minSec = 1201;
      maxSec = 7200;
    }
    
    let durBucket = null;
    if(maxSec <= 240) durBucket = 'short';
    else if(minSec > 240 && maxSec <= 1200) durBucket = 'medium';
    else if(minSec > 1200) durBucket = 'long';
    
    const q = $('#keywords').value.trim();
    const chanIds = $('#channels').value.trim().split(',').map(s=>s.trim()).filter(Boolean);

    const publishedAfter = new Date(Date.now()-days*24*3600*1000).toISOString();
    
    if(!q && chanIds.length === 0){
      console.log('ğŸš€ Seedless ëª¨ë“œ í™œì„±í™”');
      
      const summaryEl = $('#summary');
      if(summaryEl){
        summaryEl.innerHTML = '<span class="pill">ğŸ”„ ì¹´í…Œê³ ë¦¬ë³„ ìˆ˜ì§‘ ì¤‘...</span>';
      }
      
      try{
        const searchItems = await ytSearchSeedlessShorts({
          regionCode: region,
          lang: lang,
          publishedAfter: publishedAfter,
          maxResults: maxResults
        });
        
        if(searchItems.length === 0){
          console.warn('Seedless ìˆ˜ì§‘ ì‹¤íŒ¨');
          return;
        }
        
        const videoIds = [...new Set(searchItems.map(x => x.id?.videoId).filter(Boolean))];
        
        const videos = [];
        for(let i = 0; i < videoIds.length; i += 50){
          const batch = videoIds.slice(i, i + 50);
          const res = await ytVideos(batch);
          (res.items || []).forEach(v => {
            const searchItem = searchItems.find(s => s.id?.videoId === v.id);
            if(searchItem && searchItem._category){
              v._category = searchItem._category;
            }
            videos.push(v);
          });
        }
        
        const filtered = videos.filter(v => isContentMatch(v, contentType, minSec, maxSec));
        computeDerived(filtered);
        
        const sorted = filtered.sort((a, b) => {
          const aViews = parseInt(a.statistics?.viewCount || 0);
          const bViews = parseInt(b.statistics?.viewCount || 0);
          return bViews - aViews;
        });
        
        const finalResults = sorted.slice(0, maxResults);
        
        STATE.videos = finalResults;
        renderTable(STATE.videos);
        
      } catch(e){
        console.error('âŒ Seedless ëª¨ë“œ ì‹¤íŒ¨:', e);
        alert('ì¹´í…Œê³ ë¦¬ë³„ ìˆ˜ì§‘ ì‹¤íŒ¨');
      }
      
      return;
    }

    let items=[];
    if(q){
      let next=null;
      do{
        const res = await ytSearch({
          q, 
          publishedAfter, 
          regionCode:region, 
          maxResults, 
          pageToken:next, 
          lang, 
          durBucket,
          order: 'viewCount'
        });
        (res.items||[]).forEach(it=> items.push(it));
        next = res.nextPageToken;
      }while(items.length < maxResults && next);
    }
    
    for(const ch of chanIds){
      let next=null;
      do{
        const res = await ytSearch({
          channelId:ch, 
          publishedAfter, 
          regionCode:region, 
          maxResults, 
          pageToken:next, 
          lang, 
          durBucket,
          order: 'viewCount'
        });
        (res.items||[]).forEach(it=> items.push(it));
        next = res.nextPageToken;
      }while(items.length < maxResults && next);
    }

    const ids = uniq(items.map(x=>x.id?.videoId).filter(Boolean)).slice(0, maxResults);
    const videos = [];
    for(let i=0;i<ids.length;i+=50){
      const res = await ytVideos(ids.slice(i,i+50));
      (res.items||[]).forEach(v=> videos.push(v));
    }
    
    const filtered = videos.filter(v=> isContentMatch(v, contentType, minSec, maxSec));
    computeDerived(filtered);
    STATE.videos = filtered;
    renderTable(STATE.videos);
  }

  // ========== Export í•¨ìˆ˜ ==========
  function exportXlsx(){
    if(!STATE.videos.length) return alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    const f = STATE.filters;
    const filtered = STATE.videos.filter(v=> 
      (v._d.er >= (f.minER||0)) && 
      (v._d.viewMult >= (f.minVX||0)) && 
      (f.minGrade==='ALL' || rankGrade(v._impact.grade) >= rankGrade(f.minGrade))
    );
    
    const headers = [
      "id","title","channel","publishedAt","durationSec",
      "contentType","views","likes","comments","vel","er",
      "fresh","fit","viewMult","velMult","impact","delta",
      "rpm","pick","category"
    ];
    const rows = [headers];
    
    for(const v of filtered){
      const sec = isoToSeconds(v.contentDetails.duration||'PT0S');
      const delta = delta24h(v.id) || 0;
      rows.push([
        v.id,
        v.snippet.title||"",
        v.snippet.channelTitle||"",
        v.snippet.publishedAt,
        sec,
        v._d.contentType||"",
        +(v.statistics.viewCount||0),
        +(v.statistics.likeCount||0),
        +(v.statistics.commentCount||0),
        +(v._d.vel||0),
        +(v._d.er||0),
        +(v._d.fresh||0),
        0,
        +(v._d.viewMult||0),
        +(v._d.velMult||0),
        v._impact.grade,
        delta,
        +(v._d.rpm||0),
        +(v._d.pick||0),
        v._category || ''
      ]);
    }
    if(typeof XLSX==='undefined'){ 
      alert('XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); 
      return; 
    }
    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws['!cols'] = [16,60,28,24,14,10,12,12,12,12,12,10,8,12,12,10,10,10,10,10].map(w=>({wch:w}));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'ContentRadar');
    XLSX.writeFile(wb, `content_radar_${new Date().toISOString().slice(0,10)}.xlsx`);
  }

  // ========== ì±„ë„ ëª¨ë‹¬ ê´€ë ¨ ==========
  let __lastChannel = null;
  
  async function listChannelRecentVideos(channelId, n=50){
    let items=[], next=null;
    const region = $('#region')?.value||undefined;
    const lang = $('#lang')?.value||undefined;
    do{
      const data = await ytSearch({channelId, order:'date', maxResults:50, pageToken:next, regionCode:region, lang});
      (data.items||[]).forEach(x=> items.push(x));
      next = data.nextPageToken;
    }while(next && items.length < n);
    const ids = [...new Set(items.map(x=>x.id?.videoId).filter(Boolean))].slice(0,n);
    const videos=[];
    for(let i=0;i<ids.length;i+=50){
      const d = await ytVideos(ids.slice(i,i+50));
      (d.items||[]).forEach(v=> videos.push(v));
    }
    return videos;
  }
  
  function median(arr){ 
    const a=[...arr].sort((x,y)=>x-y); 
    const m=Math.floor(a.length/2); 
    return a.length? (a.length%2? a[m]:(a[m-1]+a[m])/2):0; 
  }
  
  function sum(arr,fn){ return arr.reduce((s,x)=>s+(fn?fn(x):x),0); }
  function fmtWon(n){ n=Number(n||0); return 'â‚©'+n.toLocaleString('ko-KR'); }

  async function openChannelModal(cid, ctitle){
    __lastChannel = {cid, title: ctitle};
    
    const m = document.getElementById('channelModal');
    const body = document.getElementById('chBody');
    const load = document.getElementById('chLoading');
    const err  = document.getElementById('chError');
    const kpi  = document.getElementById('chKpi');
    const best = document.getElementById('best3');
    const pat  = document.getElementById('chPatterns');
    const linkHold = document.getElementById('chLinkHolder');

    m.style.display='flex'; 
    body.style.display='none'; 
    load.style.display=''; 
    err.style.display='none';
    document.getElementById('chTitle').textContent = ctitle || 'ì±„ë„ ìƒì„¸';
    linkHold.innerHTML = `<a class="badge-soft" target="_blank" href="https://www.youtube.com/channel/${cid}">ì±„ë„ë¡œ ì—´ê¸° â†—</a>`;

    const allKeysBlocked = ROT.keys.length > 0 && ROT.stat.every(s => s && s.blocked);
    if(isQuotaLocked() || allKeysBlocked){
      load.style.display='none'; err.style.display='';
      document.getElementById('chError').textContent = 'ì¿¼í„°ê°€ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤.';
      return;
    }
    
    try{
      if(!ROT.keys.length) throw new Error('API í‚¤ í•„ìš”');
      const meta = await ytChannels([cid]);
      const ch = (meta.items||[])[0];
      const vids = await listChannelRecentVideos(cid, 60);
      const shorts = vids.filter(v=>{
        const m = (v.contentDetails?.duration||'').match(/PT(?:(\d+)M)?(?:(\d+)S)?/);
        const sec = (m? (Number(m[1]||0)*60 + Number(m[2]||0)) : 0);
        return sec>0 ? (sec<=62) : false;
      });
      computeDerived(shorts);

      const avgVel = (sum(shorts, x=>x._d.vel)/Math.max(1,shorts.length)).toFixed(1);
      const avgEr  = (sum(shorts, x=>x._d.er)/Math.max(1,shorts.length)).toFixed(2);

      kpi.innerHTML = [
        `<div class="kpi-card"><div>êµ¬ë…ì</div><b>${(ch?.statistics?.subscriberCount||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,',')}</b></div>`,
        `<div class="kpi-card"><div>ëˆ„ì  ì¡°íšŒ</div><b>${(ch?.statistics?.viewCount||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,',')}</b></div>`,
        `<div class="kpi-card"><div>ì´ ì˜ìƒ</div><b>${(ch?.statistics?.videoCount||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,',')}</b></div>`,
        `<div class="kpi-card"><div>ìµœê·¼ í‰ê· </div><b>ì†ë„ ${avgVel} Â· ë°˜ì‘ë¥  ${avgEr}â€°</b></div>`
      ].join('');

      pat.innerHTML = `<span class="badge-soft">ë¶„ì„ ë°ì´í„°</span>`;

      const top = [...shorts].sort((a,b)=> (b._d.pick - a._d.pick) || (b._d.vel - a._d.vel)).slice(0,3);
      best.innerHTML = top.map(v=>{
        const sec = (v.contentDetails?.duration||'').match(/PT(?:(\d+)M)?(?:(\d+)S)?/);
        const s = (sec? (Number(sec[1]||0)*60 + Number(sec[2]||0)) : 0);
        return `<div class="best-card">
          <a target="_blank" href="https://www.youtube.com/watch?v=${v.id}"><img class="best-thumb" src="${v.snippet.thumbnails?.medium?.url||''}"/></a>
          <div>
            <div style="font-weight:600;margin-bottom:4px">${escapeHtml(v.snippet.title||'')}</div>
            <div class="meta-row">ì¡°íšŒ ${(v.statistics.viewCount||0).toLocaleString('en-US')} Â· ì†ë„ ${v._d.vel.toFixed(1)} Â· ë°˜ì‘ë¥  ${v._d.er.toFixed(2)}â€°</div>
          </div>
        </div>`;
      }).join('');

      function calcRevenue(){
        const low = Number(document.getElementById('cpmLow').value||0);
        const high= Number(document.getElementById('cpmHigh').value||0);
        const totalViews = sum(shorts, v=> +v.statistics.viewCount||0);
        const lowRev  = Math.floor(totalViews/1000*low);
        const highRev = Math.floor(totalViews/1000*high);
        document.getElementById('revOut').textContent = `ìµœê·¼ í•©ì‚° ì¡°íšŒ ${totalViews.toLocaleString('ko-KR')} â†’ ${fmtWon(lowRev)} ~ ${fmtWon(highRev)}`;
      }
      document.getElementById('cpmLow').onchange = calcRevenue;
      document.getElementById('cpmHigh').onchange = calcRevenue;
      calcRevenue();

      load.style.display='none'; body.style.display='';
    }catch(e){
      load.style.display='none'; err.style.display='';
      document.getElementById('chError').textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + e.message;
      console.error(e);
    }
  }
  
  function closeChannelModal(){ 
    document.getElementById('channelModal').style.display='none'; 
  }

  // ========== ìŠ¤ëƒ…ìƒ· ==========
  function saveSnapshot(){
    try {
      if(!STATE.videos || !STATE.videos.length) return false;
      
      const snapshot = {
        version: '8.0',
        timestamp: Date.now(),
        date: new Date().toISOString(),
        data: {
          videos: STATE.videos,
          filters: STATE.filters || {},
          sortKey: STATE.sortKey || 'uploadedAt',
          sortDir: STATE.sortDir || 'desc',
          colVis: STATE.colVis || {},
          contentType: STATE.contentType || 'all'
        }
      };
      
      localStorage.setItem('sr_snapshot_v8', JSON.stringify(snapshot));
      console.log('[CR] Snapshot saved:', STATE.videos.length, 'videos');
      return true;
    } catch(e) {
      console.error('[CR] Snapshot save failed:', e);
      return false;
    }
  }
  
  function loadSnapshot(){
    try {
      const raw = localStorage.getItem('sr_snapshot_v8');
      if(!raw) {
        console.log('[CR] No snapshot found');
        return false;
      }
      
      const snapshot = JSON.parse(raw);
      if(!snapshot || !snapshot.data || !snapshot.data.videos || !snapshot.data.videos.length) {
        console.log('[CR] Invalid snapshot');
        return false;
      }
      
      const age = Date.now() - snapshot.timestamp;
      if(age > 24 * 3600 * 1000) {
        console.log('[CR] Snapshot too old:', Math.round(age/3600000), 'hours');
        localStorage.removeItem('sr_snapshot_v8');
        return false;
      }
      
      STATE.videos = snapshot.data.videos;
      STATE.filters = snapshot.data.filters || {};
      STATE.sortKey = snapshot.data.sortKey || 'uploadedAt';
      STATE.sortDir = snapshot.data.sortDir || 'desc';
      STATE.colVis = snapshot.data.colVis || STATE.colVis || {};
      STATE.contentType = snapshot.data.contentType || 'all';
      
      if($('#fMinER')) $('#fMinER').value = STATE.filters.minER || 0;
      if($('#fMinVX')) $('#fMinVX').value = STATE.filters.minVX || 0;
      if($('#fMinGrade')) $('#fMinGrade').value = STATE.filters.minGrade || 'ALL';
      if($('#sortKey')) $('#sortKey').value = STATE.sortKey;
      if($('#sortDir')) $('#sortDir').value = STATE.sortDir;
      if($('#contentType')) $('#contentType').value = STATE.contentType;
      
      renderTable(STATE.videos);
      renderHashtagTrends(STATE.videos);
      renderComparisonDash(STATE.videos);
      
      console.log('[CR] Snapshot loaded:', STATE.videos.length, 'videos');
      return true;
    } catch(e) {
      console.error('[CR] Snapshot load failed:', e);
      return false;
    }
  }

  // ========== ì½˜í…ì¸  íƒ€ì… UI ==========
  function initContentTypeSelector(){
    const badges = $$('.type-badge');
    badges.forEach(badge => {
      badge.addEventListener('click', function(){
        badges.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        const type = this.dataset.type;
        $('#contentType').value = type;
        STATE.contentType = type;
        
        switch(type){
          case 'shorts':
            $('#minSec').value = 0;
            $('#maxSec').value = 60;
            break;
          case 'mid':
            $('#minSec').value = 61;
            $('#maxSec').value = 600;
            break;
          case 'long':
            $('#minSec').value = 61;
            $('#maxSec').value = 3600;
            break;
          case 'vlong':
            $('#minSec').value = 1201;
            $('#maxSec').value = 7200;
            break;
          case 'all':
          default:
            $('#minSec').value = 0;
            $('#maxSec').value = 3600;
            break;
        }
      });
    });
  }

  // ========== ì´ë²¤íŠ¸ ë°”ì¸ë”© ==========
  $('#exportXlsx').addEventListener('click', exportXlsx);
  $('#saveKey').addEventListener('click', ()=>{
    const raw = ($('#apiKey').value || '').trim();
    const tokens = raw.split(/[\s,;|\/\\]+/).map(s=>s.trim()).filter(Boolean);
    const keys = Array.from(new Set(tokens));
    if(!keys.length) return alert('1ê°œ ì´ìƒ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    localStorage.removeItem('yt_api_key');
    const old = JSON.parse(localStorage.getItem('yt_api_keys')||'[]');
    const merged = Array.from(new Set([...(Array.isArray(old)?old:[]), ...keys]));
    localStorage.setItem('yt_api_keys', JSON.stringify(merged));
    $('#apiKey').value='';
    ROT.load();
    alert(`${keys.length}ê°œ ì¶”ê°€ë¨ Â· ì´ ${merged.length}ê°œ ì €ì¥ë¨`);
  });
  $('#resetBtn').addEventListener('click', ()=>{ 
    if(confirm('ëª¨ë“  ì„¤ì •ì„ ì´ˆê¸°í™”í• ê¹Œìš”?')){ 
      localStorage.clear(); 
      location.reload(); 
    } 
  });
  $('#quotaApply').addEventListener('click', ()=> setQuotaLimit($('#quotaLimit').value) );
  $('#quotaReset').addEventListener('click', resetQuota);
  $('#btnReprobe').addEventListener('click', ()=>{
    STATE.videos.forEach(v => STATE.watch.has(v.id) && pushSnapshot(v.id, v));
    alert('ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ ì˜ìƒë“¤ì˜ í˜„ì¬ ì¡°íšŒìˆ˜ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
  });

  // í•„í„°
  $('#fMinER').addEventListener('change', ()=>{ 
    STATE.filters.minER = +$('#fMinER').value||0; 
    renderTable(STATE.videos); 
  });
  $('#fMinVX').addEventListener('change', ()=>{ 
    STATE.filters.minVX = +$('#fMinVX').value||0; 
    renderTable(STATE.videos); 
  });
  $('#fMinGrade').addEventListener('change', ()=>{ 
    STATE.filters.minGrade = $('#fMinGrade').value; 
    renderTable(STATE.videos); 
  });

  // ìŠ¤í¬ë¡¤ ë²„íŠ¼
  $('#scrollUp')?.addEventListener('click', ()=>{ 
    $('#tableWrap').scrollTop -= 200; 
  });
  $('#scrollDown')?.addEventListener('click', ()=>{ 
    $('#tableWrap').scrollTop += 200; 
  });
  $('#scrollTop')?.addEventListener('click', ()=>{ 
    $('#tableWrap').scrollTop = 0; 
  });
  $('#scrollBottom')?.addEventListener('click', ()=>{ 
    $('#tableWrap').scrollTop = $('#tableWrap').scrollHeight; 
  });
  
  // ì±„ë„ ëª¨ë‹¬
  document.getElementById('chClose').addEventListener('click', closeChannelModal);
  document.getElementById('channelModal').addEventListener('click', (ev)=>{ 
    if(ev.target.id==='channelModal') closeChannelModal(); 
  });
  document.addEventListener('keydown', (ev)=>{ 
    if(ev.key==='Escape') closeChannelModal(); 
  });
  
  document.getElementById('chRefresh').addEventListener('click', function(){
    if(isQuotaLocked()){
      alert('ì˜¤ëŠ˜ ì¿¼í„° ì†Œì§„');
      return;
    }
    
    if(!__lastChannel || !__lastChannel.cid){
      console.error('No channel info');
      return;
    }
    
    const btn = this;
    btn.disabled = true;
    
    setTimeout(function(){
      openChannelModal(__lastChannel.cid, __lastChannel.title || '');
      setTimeout(function(){
        btn.disabled = false;
      }, 500);
    }, 100);
  });

  // View Preset
  $('#viewPreset').addEventListener('change', ()=>{ 
    const p=$('#viewPreset').value;
    const keys=Object.keys(defaultColVis());
    const on={}; 
    keys.forEach(k=>on[k]=false);
    
    if(p==='all'){ 
      keys.forEach(k=>on[k]=true); 
    }
    else if(p==='simple'){ 
      ['thumb','title','channel','uploadedAt','pick'].forEach(k=>on[k]=true); 
      on.bookmark=true; 
    }
    else if(p==='speedeng'){ 
      ['thumb','title','vel','er','pick'].forEach(k=>on[k]=true); 
      on.bookmark=true; 
    }
    else if(p==='metrics'){ 
      ['vel','er','fresh','viewMult','velMult','impact','pick'].forEach(k=>on[k]=true); 
      on.bookmark=true; 
      on.title=true; 
      on.thumb=true; 
    }
    else if(p==='packaging'){ 
      ['thumb','title','uploadedAt','likes','comments','impact','delta','pick'].forEach(k=>on[k]=true); 
      on.bookmark=true; 
    }
    else if(p==='longform'){ 
      ['thumb','title','channel','length','contentType','views','er','rpm','pick'].forEach(k=>on[k]=true); 
      on.bookmark=true; 
    }
    
    STATE.colVis=on; 
    save('sr_cols', on); 
    buildColToggles(); 
    applyColumnVisibility();
  });

  // ========== ì´ˆê¸°í™” ==========
  (function init(){
    ROT.load();
    const savedCols = load('sr_cols', null); 
    if(savedCols) STATE.colVis=savedCols;
    const savedSortKey = load('sr_sortKey', null); 
    if(savedSortKey) STATE.sortKey=savedSortKey;
    const savedSortDir = load('sr_sortDir', null); 
    if(savedSortDir) STATE.sortDir=savedSortDir;
    loadWatch();
    renderQuota(); 
    renderQuotaStateFlag();
    buildSortKeys();
    buildColToggles();
    applyColumnVisibility();
    initContentTypeSelector();
    
    setTimeout(function(){
      if(!STATE.videos || STATE.videos.length === 0){
        loadSnapshot();
      }
    }, 100);
  })();
  
  window.addEventListener('beforeunload', saveSnapshot);
  window.addEventListener('pagehide', saveSnapshot);
})();
</script>

</body>
</html>
