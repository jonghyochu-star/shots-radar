<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shorts Radar Pro — 패키징·모멘텀·운영 신호까지 (kor+eng OCR)</title>
  <link rel="icon" href="data:,">
  <script>
    // Lazy-load Tesseract for OCR
    window.loadTesseract = async function(){
      if(window.Tesseract) return;
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js';
      document.head.appendChild(s);
      await new Promise(res=>{s.onload=res; s.onerror=()=>res();});
    };
  </script>
  <style>
    :root { --bg:#0b1116; --card:#101922; --muted:#7a8a9a; --text:#e8f0f7; --accent:#62d26f; --accent2:#6aa7ff; --warn:#ffb84d; }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Pretendard,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px 80px}
    h1{font-weight:800;letter-spacing:-.5px;font-size:26px;margin:0 0 14px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:18px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .card{background:linear-gradient(180deg,#0f1821,#0a1118);border:1px solid #1e2a36;border-radius:14px;padding:14px 14px 16px;box-shadow:0 8px 22px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea,button{border-radius:10px;border:1px solid #2a3a4a;background:#0c141c;color:var(--text);padding:10px 12px;font-size:14px}
    input::placeholder,textarea::placeholder{color:#6b7b8b}
    button{cursor:pointer;background:#152332;border:1px solid #274156}
    button.primary{background:linear-gradient(180deg,#2a6fff,#2461e6);border:0}
    button.ghost{background:transparent;border:1px dashed #2d3b49}
    button.danger{background:#4b1c16;border:1px solid #6b2c24}
    .hint{color:var(--muted);font-size:12px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .pill{background:#0f1620;border:1px solid #1f2a36;border-radius:999px;padding:8px 12px;font-size:12px;color:#b9c7d6}
    .tag{display:inline-block;background:#0e1620;border:1px solid #213142;border-radius:999px;padding:4px 8px;margin:2px;color:#a8b9cc;font-size:12px}
    .muted{color:#9fb0bf}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #1e2a36;text-align:left;font-size:13px}
    .table th{color:#a5b6c6;font-weight:600}
    .badge{padding:4px 8px;border-radius:999px;background:#0e1b29;border:1px solid #23374a;font-size:11px}
    .good{color:#b9ffd0}
    .warn{color:var(--warn)}
    .cluster{display:flex;gap:12px;align-items:flex-start}
    .thumb{width:120px;height:68px;background:#111;border:1px solid #253444;border-radius:10px;object-fit:cover}
    .footer{position:fixed;left:0;right:0;bottom:0;background:rgba(9,14,20,.9);border-top:1px solid #1e2a36;padding:10px 16px;display:flex;gap:8px;align-items:center;justify-content:center}
    .small{font-size:12px}
    .hero{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .hm{font-size:11px}
    .hm .row{display:flex;align-items:center;gap:4px;margin:2px 0}
    .hm .label{width:18px;color:#8fa4b8;text-align:right;margin-right:6px}
    .hm .cell{width:18px;height:18px;border-radius:4px;border:1px solid #213142;background:#0e1620}
    .hm .legend{display:flex;align-items:center;gap:6px;margin-top:6px}
    .hm .legend .box{width:18px;height:18px;border-radius:4px;border:1px solid #213142}
    .qbar{position:relative;height:8px;width:160px;border:1px solid #213142;border-radius:999px;background:#0e1620}
    .qbar .fill{height:100%;border-radius:999px;background:linear-gradient(90deg,#2a6fff,#62d26f)}
    .star{cursor:pointer;font-size:18px;user-select:none}
    .star.on{color:#ffd166}
    .channel-card{display:flex;justify-content:space-between;align-items:center;border:1px solid #223243;border-radius:12px;padding:10px 12px;background:#0e1620}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div>
        <h1>Shorts Radar <span class="muted">Pro</span> <span class="muted">— 패키징·모멘텀·운영 신호까지</span></h1>
        <div class="sub">썸네일OCR/제목패턴/워치리스트 스냅샷/채널 운영카드가 포함된 kor+eng OCR 버전.</div>
      </div>
      <div class="row">
        <button id="exportCsv" class="ghost">CSV 내보내기</button>
        <button id="exportManual" class="ghost">사용법 내보내기(MD)</button>
        <button id="btnOcr" class="ghost">썸네일 OCR(한·영)</button>
        <button id="btnReprobe" class="ghost">워치리스트 재측정</button>
        <button id="resetBtn" class="danger">초기화</button>
      </div>
    </div>

    <div class="grid cols-2">
      <div class="card">
        <h3 style="margin:0 0 8px">1) 연결 설정</h3>
        <div class="row" style="gap:8px">
          <input id="apiKey" placeholder="YouTube Data API 키 붙여넣기" style="min-width:300px" aria-label="YouTube API Key" autocomplete="off"/>
          <button id="saveKey" class="primary">키 저장</button>
          <span class="hint">* GCP 콘솔에서 HTTP referrer(본인 GitHub Pages 도메인) 제한을 꼭 설정하세요.</span>
        </div>
        <div class="row" style="gap:8px;margin-top:10px">
          <label>일일 한도(유닛)</label>
          <input id="quotaLimit" type="number" min="1000" step="100" value="10000" style="width:120px" aria-label="일일 한도" autocomplete="off"/>
          <button id="quotaApply" class="ghost">적용</button>
          <span id="quotaStat" class="pill">API 사용량(오늘) 0 / 10000 (0%)</span>
          <div id="quotaBar" class="qbar"><div class="fill" style="width:0%"></div></div>
          <button id="quotaReset" class="ghost">사용량 초기화</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">2) 찾을 조건</h3>
        <div class="row" style="gap:8px">
          <input id="keywords" placeholder="찾을 주제(예: 정치풍자, 고양이 모래매트)" style="flex:1" aria-label="키워드" autocomplete="off"/>
          <input id="channels" placeholder="경쟁 채널 ID들(쉼표로 구분 · 선택)" style="flex:1" aria-label="채널 ID 목록" autocomplete="off"/>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <select id="days">
            <option value="3">최근 3일</option>
            <option value="7" selected>최근 7일</option>
            <option value="14">최근 14일</option>
          </select>
          <select id="region" title="지역 힌트(랭킹 가중치)">
            <option value="KR" selected>KR</option>
            <option value="US">US</option>
            <option value="JP">JP</option>
            <option value="GB">GB</option>
          </select>
          <select id="lang" title="언어 힌트(랭킹 가중치)">
            <option value="ko" selected>ko</option>
            <option value="en">en</option>
            <option value="ja">ja</option>
          </select>
          <input id="maxResults" type="number" min="10" max="200" value="80" style="width:120px" aria-label="결과 개수" autocomplete="off"/>
          <button id="runBtn" class="primary">찾기 시작</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">요약</h3>
      <div id="summary" class="kpi"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">비슷한 주제 묶음</h3>
        <div class="row">
          <label>최소 종합점수</label>
          <input id="minRank" type="number" value="0" step="0.01" style="width:100px" aria-label="최소 종합점수" autocomplete="off"/>
          <label>묶음 개수(k)</label>
          <input id="kValue" type="number" min="1" max="20" value="0" style="width:80px" title="0이면 자동(√N)" aria-label="묶음 개수" autocomplete="off"/>
          <button id="recluster" class="ghost">다시 묶기</button>
        </div>
      </div>
      <div id="clusters" class="grid cols-2" style="margin-top:8px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">올리기 좋은 시간대 (시간대 지도)</h3>
        <span class="hint">로컬 시간 기준 · PickRank 가중치</span>
      </div>
      <div class="grid cols-2" style="margin-top:8px">
        <div id="heatmap" class="hm"></div>
        <div>
          <b>추천 Top 시간대</b>
          <ol id="bestTimes" style="margin-top:6px"></ol>
          <div class="hint" style="margin-top:8px">* 데이터가 적으면 기간을 14일로 넓혀 보세요.</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">경쟁 채널 운영 카드</h3>
        <span class="hint">최근 결과에 등장한 채널 기준(게시 주기/시간대)</span>
      </div>
      <div id="chanBoard" class="grid cols-2" style="margin-top:8px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">영상 리스트</h3>
      <div id="colControls" class="row" style="gap:8px; margin:6px 0 8px; align-items:center; flex-wrap:wrap"></div>
      <table class="table" id="table">
        <thead>
          <tr>
            <th>☆</th>
            <th>썸네일</th>
            <th>제목</th>
            <th>패턴</th>
            <th>채널</th>
            <th>길이</th>
            <th>조회</th>
            <th>좋아요</th>
            <th>댓글</th>
            <th>속도</th>
            <th>반응</th>
            <th>신선도</th>
            <th>주제적합</th>
            <th>Δ24h</th>
            <th>종합점수</th>
            <th>묶음</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">비슷하게 만들기 도우미</h3>
        <div class="row"><label>묶음 번호</label><input id="wizCluster" type="number" value="0" style="width:80px" aria-label="묶음 번호" autocomplete="off"/><button id="runWizard" class="ghost">생성</button></div>
      </div>
      <div id="wizardOut" class="grid cols-2" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="footer small">
    <span>Tip: <b>종합점수</b>가 높은 순으로 오늘 바로 따라 만들 주제를 고르세요. — <span class="muted">속도(조회/시간)·반응(좋아요/댓글)·신선도·주제적합</span>을 합쳐 계산합니다.</span>
  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const now = () => new Date();
  const hoursSince = iso => (now() - new Date(iso)) / 36e5;
  const fmt = n => n?.toLocaleString('en-US') ?? '-';
  const toISO = d => new Date(d).toISOString();
  function escapeHtml(s){ return (s||'').replace(/[&<>\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\\'':'&#39;'}[c])); }

  const stopwords = new Set("이 그 저 데 는 은 는 을 를 와 과 도 의 에 로 으로 한 하는 했다 하기 하며 또는 그리고 그러나 그래서 부터 까지 보다 보다도 및 등 더 것 같은 이런 저런 뭐 왜 또 좀 아주 보다처럼 경우 대한 위한 위한것 같은것 누구 무엇 어디 어떻게 그렇지만 모두 너무 정말 지금 아주 매우 그냥 서로 다시 또한 또한만 약간 만큼 만큼의 라는 라고 으로서 으로써 때문 때문인 듯 듯이 함께 대해 대한 또한또 다른 이런저런 했다가 하다가 된다 했다면 까지도 뿐만 아니라 including with the a an to of for in on at as is are be this that those these from by and or but so very much more less only just than then when where who what how why while into onto about over under again still really".split(/\\s+/));
  function tokenize(text=""){
    const t = (text||"")
      .toLowerCase()
      .replace(/[\\p{P}\\p{S}]/gu,' ')
      .split(/\\s+/)
      .filter(w=>w && !stopwords.has(w) && w.length>1);
    return t;
  }
  function uniq(arr){return [...new Set(arr)];}
  function cosine(a,b){
    let dot=0,na=0,nb=0;
    const keys = new Set([...Object.keys(a),...Object.keys(b)]);
    keys.forEach(k=>{ const va=a[k]||0,vb=b[k]||0; dot+=va*vb; na+=va*va; nb+=vb*vb;});
    return dot/(Math.sqrt(na)*Math.sqrt(nb)||1);
  }
  function tf(tokens){ const m={}; tokens.forEach(w=>m[w]=(m[w]||0)+1); const n=tokens.length||1; Object.keys(m).forEach(k=>m[k]/=n); return m; }
  function idf(docs){ const df={}; const N=docs.length||1; docs.forEach(doc=>Object.keys(doc).forEach(k=>{df[k]=(df[k]||0)+1;})); const m={}; Object.keys(df).forEach(k=>m[k]=Math.log(1+N/df[k])+1); return m; }
  function tfidf(tfMap,idfMap){ const v={}; Object.keys(tfMap).forEach(k=>v[k]=tfMap[k]*(idfMap[k]||1)); return v; }
  function topKeywords(vec, n=6){ return Object.entries(vec).sort((a,b)=>b[1]-a[1]).slice(0,n).map(x=>x[0]); }
  function expDecay(hours, tau=48){ return Math.exp(-hours/ tau); }
  function hoursToHMS(sec){ const h = Math.floor(sec/3600); const m = Math.floor((sec%3600)/60); const s = Math.floor(sec%60); return (h? h+':':'')+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }
  function isoToSeconds(dur){ const m = (dur||'').match(/PT(?:(\\d+)H)?(?:(\\d+)M)?(?:(\\d+)S)?/); return (m? (Number(m[1]||0)*3600 + Number(m[2]||0)*60 + Number(m[3]||0)) : 0); }

  let STATE = { videos:[], clusters:[], idf:null, vectors:[], topicVec:{}, labels:[], colVis:null, sortKey:null, sortDir:null, watch:new Set(), snapshots:{}, ocr:{} };

  function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
  function load(key,def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def;}catch(e){return def}}
  const QUOTA_KEY='sr_quota';

  function analyzeTitle(title=""){
    const emoji = (title.match(/\\p{Extended_Pictographic}/gu) || []).length;
    const hasNum = /\\d/.test(title);
    const isQ = /[?？]|\\b(왜|무엇|어떻게|누가|언제|가능|인가)\\b/.test(title);
    const hasBracket = /[\\[\\(（【]/.test(title);
    const series = /(part\\s*\\d+|ep\\s*\\d+|시즌\\s*\\d+|파트\\s*\\d+)/i.test(title);
    return {emoji, hasNum, isQ, hasBracket, series};
  }
  function patternIcon(p){
    const icons=[];
    if(p.hasNum) icons.push('🔢');
    if(p.isQ) icons.push('❓');
    if(p.hasBracket) icons.push('🧩');
    if(p.series) icons.push('📚');
    if(p.emoji>0) icons.push('😊×'+p.emoji);
    return icons.join(' ');
  }

  function todayStr(){ const d=new Date(); return d.toISOString().slice(0,10); }
  function getQuota(){ let q = load(QUOTA_KEY, null); const today=todayStr(); if(!q) q={date:today, used:0, limit:10000}; if(q.date!==today){ q.date=today; q.used=0; } return q; }
  function saveQuota(q){ save(QUOTA_KEY, q); }
  function setQuotaLimit(n){ const q=getQuota(); q.limit=Math.max(1000, Number(n)||10000); saveQuota(q); renderQuota(); }
  function incQuota(units){ const q=getQuota(); q.used += Math.max(0, units|0); saveQuota(q); renderQuota(); }
  function resetQuota(){ const q={date:todayStr(), used:0, limit:getQuota().limit}; saveQuota(q); renderQuota(); }
  function renderQuota(){ const q=getQuota(); const pct=Math.min(100, Math.round((q.used/(q.limit||1))*100)); const stat=document.getElementById('quotaStat'); if(stat) stat.innerHTML=`API 사용량(오늘) <b>${q.used}</b> / ${q.limit} (${pct}%)`; const lim=document.getElementById('quotaLimit'); if(lim) lim.value=q.limit; const bar=document.querySelector('#quotaBar .fill'); if(bar) bar.style.width=pct+'%'; }

  async function ytSearch({q, channelId, publishedAfter, regionCode, maxResults, key, pageToken}){
    const params = new URLSearchParams({
      part:'snippet', q, maxResults:String(Math.min(50, maxResults||50)), type:'video',
      order:'date', publishedAfter, regionCode, relevanceLanguage: ($('#lang')?.value||'ko'),
      key
    });
    if(channelId) params.set('channelId', channelId);
    if(pageToken) params.set('pageToken', pageToken);
    const url = `https://www.googleapis.com/youtube/v3/search?${params.toString()}`;
    const res = await fetch(url); if(!res.ok) throw new Error('search '+res.status);
    incQuota(100);
    return res.json();
  }
  async function ytVideos(ids,key){
    const params = new URLSearchParams({ part:'snippet,contentDetails,statistics', id: ids.join(','), key });
    const url = `https://www.googleapis.com/youtube/v3/videos?${params.toString()}`;
    const res = await fetch(url); if(!res.ok) throw new Error('videos '+res.status);
    incQuota(1);
    return res.json();
  }

  function isShort(snippet, contentDetails){
    const m = (contentDetails?.duration||'').match(/PT(?:(\\d+)M)?(?:(\\d+)S)?/);
    const sec = (m? (Number(m[1]||0)*60 + Number(m[2]||0)) : 0);
    const hastag = (snippet?.title+" "+snippet?.description)?.toLowerCase().includes('#shorts');
    return sec>0 ? (sec<=62) : hastag;
  }
  function buildTopicVec(input){ return tf(tokenize(input)); }
  function calcMetrics(v, topicVec){
    const hours = hoursSince(v.snippet.publishedAt);
    const views = Number(v.statistics.viewCount||0);
    const likes = Number(v.statistics.likeCount||0);
    const comments = Number(v.statistics.commentCount||0);
    const vel = views / Math.max(1, hours);
    const eng = (likes + 5*comments) / Math.max(1, views) * 1000;
    const fresh = expDecay(hours, 48);
    const text = `${v.snippet.title||''} ${v.snippet.description||''} ${(v.snippet.tags||[]).join(' ')}`;
    const tfMap = tf(tokenize(text));
    const fit = cosine(tfidf(tfMap, STATE.idf||{}), topicVec);
    const pick = Math.pow(vel,0.5) * Math.pow(Math.max(eng,0),0.3) * Math.pow(fresh,0.2) * Math.max(fit,0.0001);
    return {vel,eng,fresh,fit,pick, tfMap};
  }

  function loadWatch(){ STATE.watch = new Set(load('sr_watchlist', [])); STATE.snapshots = load('sr_snapshots', {} ) || {}; }
  function saveWatch(){ save('sr_watchlist', [...STATE.watch]); save('sr_snapshots', STATE.snapshots); }
  function toggleWatch(id){ if(STATE.watch.has(id)) STATE.watch.delete(id); else STATE.watch.add(id); saveWatch(); renderTable(STATE.videos); }
  function pushSnapshot(id, v){ const s=STATE.snapshots[id] || (STATE.snapshots[id]=[]); s.push({t:toISO(new Date()), views:Number(v.statistics.viewCount||0), likes:Number(v.statistics.likeCount||0), comments:Number(v.statistics.commentCount||0)}); STATE.snapshots[id]=s.slice(-50); saveWatch(); }
  function delta24h(id){ const s=STATE.snapshots[id]||[]; if(s.length<2) return {views:0,likes:0,comments:0}; const nowt = new Date(); const from = new Date(nowt - 24*3600*1000); const recent = s.filter(x=> new Date(x.t)>=from); if(recent.length<2) return {views:0,likes:0,comments:0}; const first=recent[0], last=recent[recent.length-1]; return {views:last.views-first.views, likes:last.likes-first.likes, comments:last.comments-first.comments}; }

  async function reprobeWatchlist(){
    const ids = [...STATE.watch]; if(ids.length===0) return alert('워치리스트가 비어 있습니다.');
    const key = $('#apiKey').value.trim(); if(!key) return alert('API 키 필요');
    for(let i=0;i<ids.length;i+=50){
      const data = await ytVideos(ids.slice(i,i+50), key);
      (data.items||[]).forEach(v=> pushSnapshot(v.id, v));
    }
    alert('재측정 완료');
    renderTable(STATE.videos);
  }

  async function runOcrTopN(n=20){
    await loadTesseract();
    if(!window.Tesseract){ alert('Tesseract 로드 실패'); return; }
    const sorted=[...STATE.videos].sort((a,b)=>b.metrics.pick-a.metrics.pick).slice(0,n);
    for(const v of sorted){
      if(STATE.ocr[v.id]) continue;
      try{
        const url=v.snippet.thumbnails?.medium?.url; if(!url) continue;
        const res = await Tesseract.recognize(url, 'kor+eng', {
          logger:()=>{},
          langPath:'https://tessdata.projectnaptha.com/4.0.0'
        });
        const text=(res?.data?.text||'').replace(/\\s+/g,' ').trim();
        const toks=tokenize(text).slice(0,8);
        STATE.ocr[v.id]={len:text.length, keys:toks};
      }catch(e){ STATE.ocr[v.id]={len:0, keys:[]}; }
    }
    renderTable(STATE.videos);
  }

  function setSummary(videos){
    const n = videos.length;
    const shorts = videos.filter(v=>v._isShort).length;
    const top = [...videos].sort((a,b)=>b.metrics.pick - a.metrics.pick).slice(0,5);
    const avg = (arr,fn)=> arr.reduce((s,x)=>s+fn(x),0)/Math.max(1,arr.length);
    const pills = [
      `<span class="pill">총 수집 <b>${n}</b> (쇼츠 ${shorts})</span>`,
      `<span class="pill">평균 속도 <b>${avg(videos,x=>x.metrics.vel).toFixed(1)}</b></span>`,
      `<span class="pill">평균 반응 <b>${avg(videos,x=>x.metrics.eng).toFixed(2)}</b></span>`,
      `<span class="pill">종합점수 1위: <b>${(top[0]?.snippet?.title||'-').slice(0,36)}</b></span>`
    ];
    $('#summary').innerHTML = pills.join(' ');
  }

  function ensureHeaderClasses(){ const ths=document.querySelectorAll('#table thead th'); const classes=['bookmark','thumb','title','pattern','channel','length','views','likes','comments','vel','eng','fresh','fit','delta','pick','cluster']; classes.forEach((k,i)=>{ if(ths[i]) ths[i].classList.add('c-'+k); }); }
  function defaultColVis(){ const m={bookmark:true,thumb:true,title:true,pattern:true,channel:true,length:true,views:true,likes:true,comments:true,vel:true,eng:true,fresh:true,fit:true,delta:true,pick:true,cluster:true}; return m; }
  function applyColumnVisibility(){ const vis = STATE.colVis || load('sr_cols', null) || defaultColVis(); const keys=Object.keys(vis); keys.forEach(k=>{ document.querySelectorAll('.c-'+k).forEach(el=>{ el.style.display = vis[k] ? '' : 'none'; }); }); }
  function getSortValue(v,key){
    switch(key){
      case 'views': return Number(v.statistics.viewCount||0);
      case 'likes': return Number(v.statistics.likeCount||0);
      case 'comments': return Number(v.statistics.commentCount||0);
      case 'vel': return Number(v.metrics?.vel||0);
      case 'eng': return Number(v.metrics?.eng||0);
      case 'fresh': return Number(v.metrics?.fresh||0);
      case 'fit': return Number(v.metrics?.fit||0);
      case 'length': return isoToSeconds(v.contentDetails?.duration||'PT0S');
      case 'delta': { const d=delta24h(v.id); return Number(d.views||0); }
      case 'pick': default: return Number(v.metrics?.pick||0);
    }
  }
  function buildColControls(){
    if(!STATE.colVis) STATE.colVis = load('sr_cols', null) || defaultColVis();
    if(!STATE.sortKey) STATE.sortKey = load('sr_sortKey', null) || 'pick';
    if(!STATE.sortDir) STATE.sortDir = load('sr_sortDir', null) || 'desc';
    const holder = $('#colControls'); if(!holder) return;
    const labelMap = {pick:'종합', vel:'속도', eng:'반응', fresh:'신선도', fit:'적합', views:'조회', likes:'좋아요', comments:'댓글', length:'길이', delta:'Δ24h'};
    holder.innerHTML = `
      <label>보기 프리셋</label>
      <select id="viewPreset">
        <option value="all">전체(기본)</option>
        <option value="speedeng">속도·반응만</option>
        <option value="metrics">지표만</option>
        <option value="packaging">패키징(썸네일/패턴/Δ)</option>
        <option value="simple">간단</option>
      </select>
      <label>정렬</label>
      <select id="sortKey"></select>
      <select id="sortDir"><option value="desc">내림차순</option><option value="asc">오름차순</option></select>
      <div id="colToggles" class="row" style="gap:6px"></div>`;
    const sortKeys=['pick','delta','vel','eng','fresh','fit','views','likes','comments','length'];
    const sk = $('#sortKey'); sortKeys.forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=labelMap[k]||k; sk.appendChild(o); });
    sk.value = STATE.sortKey; $('#sortDir').value = STATE.sortDir;
    const box=$('#colToggles'); box.innerHTML='';
    const keys = Object.keys(defaultColVis());
    keys.forEach(k=>{ const id='vis_'+k; const lbl=document.createElement('label'); lbl.className='small'; lbl.style.display='flex'; lbl.style.alignItems='center'; lbl.style.gap='6px'; lbl.innerHTML=`<input type="checkbox" id="${id}" ${STATE.colVis[k]?'checked':''}/> ${k}`; box.appendChild(lbl); document.getElementById(id).addEventListener('change',()=>{ STATE.colVis[k]=document.getElementById(id).checked; save('sr_cols', STATE.colVis); applyColumnVisibility(); }); });
    $('#viewPreset').addEventListener('change',()=>{
      const p=$('#viewPreset').value; const vis=defaultColVis(); keys.forEach(k=>vis[k]=true);
      if(p==='speedeng'){ keys.forEach(k=>vis[k]=false); ['thumb','title','vel','eng','pick'].forEach(k=>vis[k]=true); }
      else if(p==='metrics'){ keys.forEach(k=>vis[k]=false); ['vel','eng','fresh','fit','pick'].forEach(k=>vis[k]=true); }
      else if(p==='packaging'){ keys.forEach(k=>vis[k]=false); ['thumb','title','pattern','delta','pick','bookmark'].forEach(k=>vis[k]=true); }
      else if(p==='simple'){ keys.forEach(k=>vis[k]=false); ['thumb','title','pick'].forEach(k=>vis[k]=true); }
      STATE.colVis=vis; save('sr_cols', vis); keys.forEach(k=>{ const chk=document.getElementById('vis_'+k); if(chk) chk.checked=!!vis[k]; }); applyColumnVisibility();
    });
    sk.addEventListener('change',()=>{ STATE.sortKey=sk.value; save('sr_sortKey', STATE.sortKey); renderTable(STATE.videos); applyColumnVisibility(); });
    $('#sortDir').addEventListener('change',()=>{ STATE.sortDir=$('#sortDir').value; save('sr_sortDir', STATE.sortDir); renderTable(STATE.videos); applyColumnVisibility(); });
  }

  function renderTable(videos){
    const tb = $('#tbody'); tb.innerHTML='';
    const key = STATE.sortKey || 'pick';
    const asc = (STATE.sortDir || 'desc')==='asc';
    videos.sort((a,b)=>{ const av=getSortValue(a,key); const bv=getSortValue(b,key); return asc? (av-bv):(bv-av); });
    for(const v of videos){
      const sec = isoToSeconds(v.contentDetails.duration);
      const pat = patternIcon(v._pattern||{});
      const d24 = delta24h(v.id);
      const ocr = STATE.ocr[v.id];
      const star = STATE.watch.has(v.id) ? '★' : '☆';
      const ocrTip = ocr ? `OC:${ocr.len} ${ocr.keys.slice(0,3).join('/')}` : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="c-bookmark"><span class="star ${STATE.watch.has(v.id)?'on':''}" data-id="${v.id}">${star}</span></td>
        <td class="c-thumb"><a href="https://www.youtube.com/watch?v=${v.id}" target="_blank"><img class="thumb" src="${v.snippet.thumbnails?.medium?.url||''}" title="${escapeHtml(ocrTip)}"/></a></td>
        <td class="c-title">${escapeHtml(v.snippet.title||'')}</td>
        <td class="c-pattern small">${escapeHtml(pat)}</td>
        <td class="c-channel small">${escapeHtml(v.snippet.channelTitle||'')}</td>
        <td class="c-length">${hoursToHMS(sec)}</td>
        <td class="c-views">${fmt(v.statistics.viewCount)}</td>
        <td class="c-likes">${fmt(v.statistics.likeCount)}</td>
        <td class="c-comments">${fmt(v.statistics.commentCount)}</td>
        <td class="c-vel">${v.metrics.vel.toFixed(1)}</td>
        <td class="c-eng">${v.metrics.eng.toFixed(2)}</td>
        <td class="c-fresh">${v.metrics.fresh.toFixed(2)}</td>
        <td class="c-fit">${v.metrics.fit.toFixed(2)}</td>
        <td class="c-delta"><span class="${(d24.views||0)>0?'good':''}">+${fmt(d24.views||0)}</span></td>
        <td class="c-pick"><b class="good">${v.metrics.pick.toFixed(2)}</b></td>
        <td class="c-cluster"><span class="badge">${v.clusterId ?? '-'}</span></td>`;
      tb.appendChild(tr);
    }
    tb.querySelectorAll('.star').forEach(s=> s.addEventListener('click', (ev)=>{ const id=ev.target.getAttribute('data-id'); toggleWatch(id);}));
  }

  function avgRank(arr){ return arr.reduce((s,x)=>s+(x.metrics?.pick||0),0)/Math.max(1,arr.length); }
  function renderClusters(state){
    const el = $('#clusters'); el.innerHTML='';
    const groups = {};
    state.videos.forEach(v=>{ const id=v.clusterId??0; (groups[id]=groups[id]||[]).push(v); });
    const entries = Object.entries(groups).sort((a,b)=> avgRank(b[1]) - avgRank(a[1]));

    for(const [cid, arr] of entries){
      if(arr.length===0) continue;
      const rep = [...arr].sort((a,b)=>b.metrics.pick - a.metrics.pick)[0];
      const keys = topKeywords(state.centroids[cid]||{}, 8);
      const card = document.createElement('div');
      card.className='card cluster';
      card.innerHTML = `
        <img class="thumb" src="${rep?.snippet?.thumbnails?.medium?.url||''}"/>
        <div>
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div><b>묶음 ${cid}</b> · <span class="muted">${arr.length}개</span></div>
            <div class="badge">평균 종합점수 ${avgRank(arr).toFixed(2)}</div>
          </div>
          <div style="margin:6px 0 2px">${keys.map(k=>`<span class="tag">${escapeHtml(k)}</span>`).join('')}</div>
          <div class="hint">대표: ${(rep?.snippet?.title||'').slice(0,80)}</div>
        </div>`;
      el.appendChild(card);
    }
  }

  function renderChannelBoard(videos){
    const byCh={};
    videos.forEach(v=>{
      const cid=v.snippet.channelId||v.snippet.channel?.id||'unknown';
      (byCh[cid]=byCh[cid]||{title:v.snippet.channelTitle,id:cid,times:[]}).times.push(v.snippet.publishedAt);
    });
    const list=Object.values(byCh).sort((a,b)=>b.times.length-a.times.length).slice(0,8);
    const board=$('#chanBoard'); board.innerHTML='';
    for(const ch of list){
      const times=ch.times.map(t=>new Date(t).getTime()).sort((a,b)=>a-b);
      let gaps=[]; for(let i=1;i<times.length;i++) gaps.push((times[i]-times[i-1])/(24*3600*1000));
      const avgGap=gaps.length? (gaps.reduce((s,x)=>s+x,0)/gaps.length):0;
      const hours=new Array(24).fill(0); ch.times.forEach(t=>{ hours[new Date(t).getHours()]++; });
      const topHour=hours.map((v,i)=>({v,i})).sort((a,b)=>b.v-a.v)[0]?.i ?? 0;
      const el=document.createElement('div'); el.className='channel-card';
      el.innerHTML=`<div><b>${escapeHtml(ch.title||'-')}</b><div class="small muted">결과수 ${ch.times.length} · 평균 주기 ${avgGap?avgGap.toFixed(1)+'일':'-'}</div></div>
      <div class="small">히트 시간대: <b>${String(topHour).padStart(2,'0')}:00</b></div>`;
      board.appendChild(el);
    }
  }

  function runWizard(clusterId){
    const group = STATE.videos.filter(v=>v.clusterId===clusterId);
    const out = $('#wizardOut'); out.innerHTML='';
    if(group.length===0){ out.innerHTML='<div class="hint">해당 묶음이 비어 있습니다.</div>'; return; }
    const rep = [...group].sort((a,b)=>b.metrics.pick - a.metrics.pick)[0];
    const keys = topKeywords(STATE.centroids[clusterId]||{}, 8);

    const hooks = [
      `딱 10초로 끝내는 ${keys[0]||'핵심'} 요약`,
      `댓글 폭발한 ${keys[1]||'장면'}, 3초 리메이크`,
      `${keys[2]||'논란'} 한 문장, 앞뒤 맥락은?`
    ];

    const shotlist = [
      '0–2s: 강렬한 썸네일 텍스트 + 효과음',
      `3–8s: ${keys[0]||'핵심요소'} 장면 클립/밈`,
      `9–15s: 대비 장면/팩트 1`,
      `16–22s: 반전 장면/팩트 2`,
      '23–27s: 요약 한 문장(자막 크게)',
      '28–30s: 구독/팔로우 CTA + 다음 편 예고'
    ];

    const hashtags = ['#shorts','#trending', ...keys.slice(0,4).map(k=>'#'+k)].join(' ');

    const left = document.createElement('div'); left.className='card';
    left.innerHTML = `<b>훅(Hooks) 3안</b><ul>${hooks.map(h=>`<li>${escapeHtml(h)}</li>`).join('')}</ul>`;
    const right = document.createElement('div'); right.className='card';
    right.innerHTML = `<b>샷리스트(30초)</b><ol>${shotlist.map(s=>`<li>${escapeHtml(s)}</li>`).join('')}</ol><div style="margin-top:6px"><b>해시태그:</b> <span class="muted">${escapeHtml(hashtags)}</span></div>`;
    out.append(left,right);
  }

  function exportCsv(){
    if(!STATE.videos.length) return alert('데이터가 없습니다.');
    const cols = ['id','title','channel','publishedAt','durationSec','views','likes','comments','vel','eng','fresh','fit','pick','delta24h','titleFlags','ocrLen','ocrKeys','clusterId'];
    const rows = [cols.join(',')];
    for(const v of STATE.videos){
      const sec = isoToSeconds(v.contentDetails.duration);
      const d=delta24h(v.id); const oc=STATE.ocr[v.id]||{len:0,keys:[]};
      const flags=v._pattern||{};
      const r = [
        v.id,
        '"'+(v.snippet.title||'').replace(/"/g,'""')+'"',
        '"'+(v.snippet.channelTitle||'').replace(/"/g,'""')+'"',
        v.snippet.publishedAt,
        sec,
        v.statistics.viewCount||0,
        v.statistics.likeCount||0,
        v.statistics.commentCount||0,
        v.metrics.vel.toFixed(3),
        v.metrics.eng.toFixed(3),
        v.metrics.fresh.toFixed(5),
        v.metrics.fit.toFixed(5),
        v.metrics.pick.toFixed(5),
        d.views||0,
        "num:"+(flags.hasNum?1:0)+";q:"+(flags.isQ?1:0)+";emo:"+(flags.emoji||0)+";br:"+(flags.hasBracket?1:0)+";ser:"+(flags.series?1:0),
        oc.len||0,
        '"'+(oc.keys||[]).join(' ').replace(/"/g,'""')+'"',
        v.clusterId??''
      ];
      rows.push(r.join(','));
    }
    const blob = new Blob([rows.join('\\n')],{type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'shorts_radar_pro.csv'; document.body.appendChild(a); a.click(); a.remove();
  }

  function exportManual(){
    const date = new Date().toLocaleDateString('ko-KR');
    const md = `# Shorts Radar Pro 사용 매뉴얼 (한 장)
생성일: ${date}

- 새 기능: 썸네일 OCR(한·영), 제목 패턴, 워치리스트 스냅샷, 채널 운영 카드
- 워치리스트: ☆ 클릭 → '워치리스트 재측정'으로 24시간 증가량 확인
- OCR: 상위 N개(기본20)만 추출. 무거우니 필요할 때 버튼으로 실행
- 채널 카드: 최근 결과 기준. 평균 주기(일), 히트 시간대 추천
`;
    const blob = new Blob([md], {type:'text/markdown;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Shorts_Radar_Pro_사용법.md'; document.body.appendChild(a); a.click(); a.remove();
  }

  async function run(){
    try{
      const key = $('#apiKey').value.trim(); if(!key) return alert('API 키를 입력하세요.');
      const q = $('#keywords').value.trim();
      const channels = $('#channels').value.trim().split(',').map(s=>s.trim()).filter(Boolean);
      const days = Number($('#days').value||7);
      const regionCode = $('#region').value || 'KR';
      const maxResults = Number($('#maxResults').value||80);
      const publishedAfter = new Date(Date.now()-days*24*3600*1000).toISOString();

      const items = [];
      async function collectBy(q, channelId){
        let pageToken=null; let fetched=0; const limit=maxResults;
        do{
          const data = await ytSearch({q, channelId, publishedAfter, regionCode, maxResults: Math.min(50, limit-fetched), key, pageToken});
          const vids = (data.items||[]).filter(it=> it.id?.videoId );
          items.push(...vids.map(it=>({id:it.id.videoId, snippet:it.snippet})));
          fetched += vids.length; pageToken = data.nextPageToken && fetched < limit ? data.nextPageToken : null;
        } while(pageToken);
      }
      if(channels.length){ for(const ch of channels) await collectBy(q||'', ch); }
      else await collectBy(q||'', null);

      const ids = uniq(items.map(x=>x.id));
      const videos=[]; for(let i=0;i<ids.length;i+=50){
        const batch = ids.slice(i,i+50);
        const data = await ytVideos(batch, key);
        data.items.forEach(v=>videos.push(v));
      }

      const shorts = videos.filter(v=> isShort(v.snippet, v.contentDetails));

      const docs = shorts.map(v=> tf(tokenize(`${v.snippet.title||''} ${v.snippet.description||''} ${(v.snippet.tags||[]).join(' ')}`)) );
      STATE.idf = idf(docs);
      STATE.topicVec = buildTopicVec(q);

      shorts.forEach(v=>{
        v._isShort = true;
        v.metrics = calcMetrics(v, STATE.topicVec);
        v._pattern = analyzeTitle(v.snippet.title||'');
      });

      const vecs = docs.map(d=> tfidf(d, STATE.idf));
      const kManual = Number($('#kValue').value||0);
      const k = kManual>0? kManual : Math.max(1, Math.round(Math.sqrt(vecs.length||1)));
      const {labels, centroids} = kmeans(vecs, k);
      shorts.forEach((v,i)=> v.clusterId = labels[i]);

      const minRank = Number($('#minRank').value||0);
      const filtered = shorts.filter(v=> v.metrics.pick >= minRank);

      STATE.videos = filtered; STATE.vectors = vecs; STATE.centroids = centroids; STATE.labels = labels;

      setSummary(filtered);
      renderClusters(STATE);
      renderTable(filtered);
      renderHeatmap(filtered);
      renderChannelBoard(filtered);
      ensureHeaderClasses();
      applyColumnVisibility();
    }catch(e){ console.error(e); alert('오류: '+e.message); }
  }

  const dayOrder = [1,2,3,4,5,6,0]; const dayNames=['일','월','화','수','목','금','토'];
  function formatHour(h){ return String(h).padStart(2,'0')+':00'; }
  function colorFor(val,max){ const n = max>0? (val/max) : 0; const l = 16 + n*48; return `hsl(210,80%,${l}%)`; }
  function renderHeatmap(videos){
    const grid = Array.from({length:7},()=>Array(24).fill(0));
    videos.forEach(v=>{ const d=new Date(v.snippet.publishedAt); const dow=d.getDay(); const h=d.getHours(); const w=Math.max(0, v.metrics?.pick||0); grid[dow][h]+=w; });
    let max=0; for(let d=0;d<7;d++){ for(let h=0;h<24;h++){ if(grid[d][h]>max) max=grid[d][h]; }}
    const hm = $('#heatmap'); if(!hm) return; let html='';
    html += `<div class="row"><span class="label"></span>${[...Array(24).keys()].map(h=>`<span class="small" style="width:18px;text-align:center;color:#8fa4b8">${h%6===0?h:''}</span>`).join('')}</div>`;
    for(const d of dayOrder){
      html += `<div class="row"><span class="label">${dayNames[d]}</span>`;
      for(let h=0;h<24;h++){
        const v = grid[d][h]; const clr = colorFor(v,max);
        html += `<span class="cell" title="${dayNames[d]} ${formatHour(h)} · ${v.toFixed(2)}" style="background:${clr}"></span>`;
      }
      html += `</div>`;
    }
    html += `<div class="legend"><span class="small muted">낮음</span><span class="box" style="background:${colorFor(0,max)}"></span><span class="box" style="background:${colorFor(max*0.5,max)}"></span><span class="box" style="background:${colorFor(max,max)}"></span><span class="small muted">높음</span></div>`;
    hm.innerHTML = html;

    const arr=[]; for(let d=0;d<7;d++){ for(let h=0;h<24;h++){ arr.push({d,h,score:grid[d][h]}); }}
    arr.sort((a,b)=>b.score-a.score);
    const top = arr.filter(x=>x.score>0).slice(0,6);
    const best = $('#bestTimes'); if(best) best.innerHTML = top.map(t=>`<li>${dayNames[t.d]} ${formatHour(t.h)}–${formatHour((t.h+1)%24)} · 지수 ${t.score.toFixed(2)}</li>`).join('');
  }

  function kmeans(vectors, k, maxIter=20){
    const n = vectors.length; if(n===0) return {labels:[],centroids:[]};
    k = Math.max(1, Math.min(k, n));
    function dist(a,b){return 1 - cosine(a,b);}
    const idxs=uniq([...Array(n).keys()].sort(()=>Math.random()-0.5)).slice(0,k);
    let centroids = idxs.map(i=>Object.assign({}, vectors[i]));
    let labels = new Array(n).fill(0);
    for(let iter=0; iter<maxIter; iter++){
      let changed=false;
      for(let i=0;i<n;i++){
        let best=0,bestd=Infinity;
        for(let c=0;c<k;c++){ const d=dist(vectors[i],centroids[c]); if(d<bestd){bestd=d;best=c}}
        if(labels[i]!==best){labels[i]=best;changed=true}
      }
      if(!changed) break;
      const sums=Array.from({length:k},()=>({})); const counts=new Array(k).fill(0);
      for(let i=0;i<n;i++){
        const c=labels[i]; counts[c]++;
        for(const [key,val] of Object.entries(vectors[i])) sums[c][key]=(sums[c][key]||0)+val;
      }
      for(let c=0;c<k;c++){ const v={}; const cnt=Math.max(1,counts[c]); for(const [key,val] of Object.entries(sums[c])) v[key]=val/cnt; centroids[c]=v; }
    }
    return {labels,centroids};
  }

  $('#runBtn').addEventListener('click', run);
  $('#recluster').addEventListener('click', ()=>{
    if(!STATE.videos.length) return alert('데이터가 없습니다.');
    const vecs = STATE.vectors; const kManual = Number($('#kValue').value||0);
    const k = kManual>0? kManual : Math.max(1, Math.round(Math.sqrt(vecs.length||1)));
    const {labels,centroids} = kmeans(vecs,k);
    STATE.videos.forEach((v,i)=> v.clusterId = labels[i]);
    STATE.centroids = centroids; STATE.labels = labels;
    renderClusters(STATE); renderTable(STATE.videos); renderHeatmap(STATE.videos); renderChannelBoard(STATE.videos);
    ensureHeaderClasses(); applyColumnVisibility();
  });
  $('#runWizard').addEventListener('click', ()=>{ const cid = Number($('#wizCluster').value||0); runWizard(cid); });
  $('#saveKey').addEventListener('click', ()=>{ save('yt_api_key', $('#apiKey').value.trim()); alert('저장됨'); });
  $('#exportCsv').addEventListener('click', exportCsv);
  $('#exportManual').addEventListener('click', exportManual);
  $('#resetBtn').addEventListener('click', ()=>{ localStorage.clear(); $('#apiKey').value=''; alert('초기화 완료'); });
  $('#btnOcr').addEventListener('click', ()=> runOcrTopN(20));
  $('#btnReprobe').addEventListener('click', reprobeWatchlist);

  const savedKey = load('yt_api_key',''); if(savedKey) $('#apiKey').value = savedKey;
  loadWatch();
  (function initCol(){ // quick default build so user sees controls even before first run
    const el=document.getElementById('colControls');
    if(el) el.innerHTML='<span class="hint">검색 후 열 숨김/정렬 컨트롤이 표시됩니다.</span>';
  })();
  (function buildNow(){ // build controls once DOM ready
    function buildColControlsInline(){
      const holder = document.getElementById('colControls'); if(!holder) return;
      holder.innerHTML=''; // will be re-created after first results too
      // call main builder after first results; left minimal here
    }
    buildColControlsInline();
  })();
  // Build full controls & quota bar initial render
  function afterFirst(){ buildColControls(); renderQuota(); ensureHeaderClasses(); applyColumnVisibility(); }
  renderQuota();
  ensureHeaderClasses(); applyColumnVisibility();
})();
</script>
</body>
</html>
