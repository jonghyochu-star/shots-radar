<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>YouTube Content Radar - í†µí•©íŒ v8.0</title>
  <link rel="icon" href="data:,">
  <style>
    :root { 
      --bg:#f8f9fa; 
      --card:#ffffff; 
      --muted:#6b7280; 
      --text:#1f2937; 
      --accent:#10b981; 
      --accent2:#3b82f6; 
      --warn:#f59e0b; 
    }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Pretendard,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px 84px;position:relative}
    h1{font-weight:800;letter-spacing:-.4px;font-size:26px;margin:0 0 14px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:18px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .card{background:#ffffff;border:1px solid #e5e7eb;border-radius:14px;padding:14px 14px 16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input,select,button{border-radius:10px;border:1px solid #d1d5db;background:#ffffff;color:var(--text);padding:9px 11px;font-size:14px}
    input::placeholder{color:#9ca3af}
    button{cursor:pointer;background:#f9fafb;border:1px solid #d1d5db}
    button.primary{background:linear-gradient(180deg,#3b82f6,#2563eb);border:0;color:#fff}
    button.ghost{background:transparent;border:1px dashed #d1d5db}
    button.danger{background:#fee2e2;border:1px solid #f87171;color:#991b1b}
    .hint{color:var(--muted);font-size:12px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .pill{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:8px 12px;font-size:12px;color:#4b5563;cursor:pointer}
    .pill.active{background:#d1fae5;border-color:#10b981;color:#065f46}
    .pill.blocked{background:#fee2e2;border-color:#f87171;color:#991b1b}
    .table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left;font-size:13px}
    th{color:#6b7280;font-weight:600;white-space:nowrap}
    #table thead th{position:sticky;top:0;background:#f8fafc;z-index:3}
    .thumb{width:120px;height:68px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;object-fit:cover}
    .badge{padding:4px 8px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb;font-size:11px}
    .grade-S{background:#d1fae5;border-color:#10b981;color:#065f46}
    .grade-A{background:#dbeafe;border-color:#3b82f6;color:#1e40af}
    .grade-B,.grade-C{background:#f3f4f6;border-color:#d1d5db;color:#4b5563}
    .grade-D{background:#f9fafb;border-color:#e5e7eb;color:#9ca3af}
    .good{color:#10b981}
    .warn{color:var(--warn)}
    .qbar{position:relative;height:8px;width:160px;border:1px solid #e5e7eb;border-radius:999px;overflow:hidden;background:#f9fafb}
    .qfill{height:100%;background:linear-gradient(90deg,#10b981,#3b82f6);transition:width .4s ease}
    .progress-wrapper{display:inline-flex;align-items:center;gap:6px}
    #chart{height:240px;border-radius:12px;overflow:hidden}
    .loader{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:48px;height:48px;border:4px solid #e5e7eb;border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg)}100%{transform:translate(-50%,-50%) rotate(360deg)}}
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:999}
    .modal.open{display:flex}
    .modal-content{background:#fff;border-radius:16px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;padding:24px;position:relative}
    .close{position:absolute;top:12px;right:12px;width:32px;height:32px;border-radius:50%;background:#f3f4f6;border:0;cursor:pointer;font-size:18px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin:16px 0}
    .stat-box{background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:10px;text-align:center}
    .stat-label{font-size:11px;color:#6b7280;margin-bottom:4px}
    .stat-value{font-size:18px;font-weight:700}
    .mini-chart{height:60px;margin-top:8px}
    .tabs{display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid #e5e7eb}
    .tab{padding:8px 16px;background:transparent;border:0;cursor:pointer;border-bottom:2px solid transparent;color:#6b7280}
    .tab.active{color:#3b82f6;border-bottom-color:#3b82f6}
    .empty{text-align:center;padding:40px;color:#9ca3af}
    .filters{background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin-bottom:16px}
    .btn-group{display:flex;gap:8px;flex-wrap:wrap}
    input[type="range"]{width:100%}
    .range-labels{display:flex;justify-content:space-between;font-size:11px;color:#6b7280;margin-top:4px}
    .toolbar{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
    @media (max-width:640px){.grid.cols-2{grid-template-columns:1fr}.table{font-size:11px}th,td{padding:6px}.thumb{width:80px;height:45px}}
    .content-type-badge{
      display:inline-block;
      padding:2px 6px;
      border-radius:4px;
      font-size:10px;
      font-weight:600;
      margin-left:4px;
    }
    .type-short{background:#fef3c7;color:#92400e}
    .type-mid{background:#dbeafe;color:#1e40af}
    .type-long{background:#e0e7ff;color:#3730a3}
    .type-vlong{background:#fce7f3;color:#9f1239}
    .duration-display{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:12px;
      color:#6b7280;
    }
    .metric-longform{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .metric-label{
      font-size:10px;
      color:#9ca3af;
    }
    .metric-value{
      font-size:13px;
      font-weight:600;
    }
    .compare-card{
      background:linear-gradient(135deg,#f0f9ff,#f0fdf4);
      border:1px solid #cbd5e1;
      border-radius:12px;
      padding:16px;
      margin-top:12px;
    }
    .compare-row{
      display:flex;
      justify-content:space-between;
      margin:8px 0;
    }
    .compare-label{
      font-size:12px;
      color:#64748b;
    }
    .compare-value{
      font-size:14px;
      font-weight:600;
    }
  </style>
  <script src="https://unpkg.com/chart.js@4.3.0/dist/chart.umd.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>ğŸš€ YouTube Content Radar v8.0</h1>
    <div class="sub">ì‡¼ì¸  & ë¡±í¼ í†µí•© ë¶„ì„ ë„êµ¬ | ì‹¤ì‹œê°„ íŠ¸ë Œë“œ ì¶”ì  | ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ì‹œë³´ë“œ</div>
    
    <div class="card">
      <h3>ğŸ” ê²€ìƒ‰ ì„¤ì •</h3>
      <div class="row">
        <select id="mode">
          <option value="keyword">í‚¤ì›Œë“œ ê²€ìƒ‰</option>
          <option value="channel">ì±„ë„ ê²€ìƒ‰</option>
          <option value="seedless">ì‹œë“œë¦¬ìŠ¤ (ìë™)</option>
        </select>
        <input id="query" type="text" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." style="flex:1" />
        <select id="contentType">
          <option value="all" selected>ì „ì²´ ì½˜í…ì¸ </option>
          <option value="shorts">ì‡¼ì¸ ë§Œ (â‰¤60ì´ˆ)</option>
          <option value="long">ë¡±í¼ë§Œ (>60ì´ˆ)</option>
          <option value="mid">ë¯¸ë“œí¼ (1-10ë¶„)</option>
          <option value="vlong">ì´ˆì¥í¸ (>20ë¶„)</option>
        </select>
      </div>
      
      <div class="row" style="margin-top:8px">
        <label>ìµœì†Œ ê¸¸ì´(ì´ˆ)</label>
        <input id="minDuration" type="number" value="0" min="0" style="width:80px"/>
        <label>ìµœëŒ€ ê¸¸ì´(ì´ˆ)</label>
        <input id="maxDuration" type="number" value="3600" max="86400" style="width:80px"/>
        <select id="region">
          <option value="KR">í•œêµ­</option>
          <option value="US">ë¯¸êµ­</option>
          <option value="JP">ì¼ë³¸</option>
        </select>
        <select id="lang">
          <option value="ko">í•œêµ­ì–´</option>
          <option value="en">ì˜ì–´</option>
          <option value="ja">ì¼ë³¸ì–´</option>
        </select>
      </div>
      
      <div class="row" style="margin-top:8px">
        <label>ê¸°ê°„</label>
        <select id="days">
          <option value="1">24ì‹œê°„</option>
          <option value="7" selected>7ì¼</option>
          <option value="30">30ì¼</option>
          <option value="90">90ì¼</option>
          <option value="365">1ë…„</option>
        </select>
        <label>ê²°ê³¼</label>
        <input id="maxResults" type="number" value="50" min="10" max="200" style="width:60px"/>
        <button class="primary" onclick="search()">ğŸ” ê²€ìƒ‰</button>
        <button onclick="exportData()">ğŸ“Š ë‚´ë³´ë‚´ê¸°</button>
        <button onclick="openWatchlist()">ğŸ‘ï¸ ì›Œì¹˜ë¦¬ìŠ¤íŠ¸</button>
      </div>
      <div class="hint">ğŸ’¡ ì‹œë“œë¦¬ìŠ¤ ëª¨ë“œ: 16ê°œ ì¹´í…Œê³ ë¦¬ë³„ ì¸ê¸° ì˜ìƒ ìë™ ìˆ˜ì§‘</div>
    </div>

    <div class="card" id="categories" style="display:none">
      <h3>ğŸ“ ì¹´í…Œê³ ë¦¬ í•„í„°</h3>
      <div class="kpi" id="categoryFilters"></div>
      <div style="margin-top:10px">
        <button class="ghost" onclick="selectAllCategories()">ì „ì²´ ì„ íƒ</button>
        <button class="ghost" onclick="deselectAllCategories()">ì „ì²´ í•´ì œ</button>
      </div>
    </div>

    <div class="card" id="summary" style="display:none">
      <h3>ğŸ“Š ìš”ì•½ í†µê³„</h3>
      <div class="grid cols-2" style="gap:16px">
        <div>
          <div class="stats-grid" id="statsGrid"></div>
        </div>
        <div>
          <canvas id="chart"></canvas>
        </div>
      </div>
      
      <div class="compare-card" id="formatComparison" style="display:none">
        <h4 style="margin:0 0 12px">ğŸ¬ í¬ë§·ë³„ ì„±ê³¼ ë¹„êµ</h4>
        <div class="compare-row">
          <span class="compare-label">ì‡¼ì¸  í‰ê·  ì¡°íšŒìˆ˜</span>
          <span class="compare-value" id="shortsAvgViews">-</span>
        </div>
        <div class="compare-row">
          <span class="compare-label">ë¡±í¼ í‰ê·  ì¡°íšŒìˆ˜</span>
          <span class="compare-value" id="longAvgViews">-</span>
        </div>
        <div class="compare-row">
          <span class="compare-label">ìµœì  í¬ë§·</span>
          <span class="compare-value" id="optimalFormat">-</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:12px">
        <h3 style="margin:0">ğŸ“‹ ê²°ê³¼</h3>
        <div class="toolbar">
          <button class="ghost" onclick="toggleSnapshot()">ğŸ“¸ ìŠ¤ëƒ…ìƒ·</button>
          <button class="ghost" onclick="showTrends()">ğŸ“ˆ ì¥ê¸°íŠ¸ë Œë“œ</button>
          <select id="sortBy" onchange="sortTable()">
            <option value="views">ì¡°íšŒìˆ˜ìˆœ</option>
            <option value="speed">ì†ë„ìˆœ</option>
            <option value="er">ë°˜ì‘ë¥ ìˆœ</option>
            <option value="fresh">ì‹ ì„ ë„ìˆœ</option>
            <option value="impact">ì„íŒ©íŠ¸ìˆœ</option>
            <option value="rpm">RPMìˆœ</option>
            <option value="retention">ì§€ì†ë¥ ìˆœ</option>
          </select>
        </div>
      </div>
      
      <div id="tableWrap" style="overflow-x:auto">
        <table class="table" id="table">
          <thead><tr id="tableHeaders"></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="empty" id="empty">ê²€ìƒ‰ì„ ì‹œì‘í•˜ì„¸ìš”</div>
    </div>
  </div>

  <div class="loader" id="loader" style="display:none"></div>
  
  <div class="modal" id="channelModal">
    <div class="modal-content">
      <button class="close" onclick="closeModal()">âœ•</button>
      <h2 id="modalTitle">ì±„ë„ ë¶„ì„</h2>
      <div id="modalContent"></div>
    </div>
  </div>

  <div class="modal" id="watchlistModal">
    <div class="modal-content">
      <button class="close" onclick="closeWatchlist()">âœ•</button>
      <h2>ğŸ‘ï¸ ì›Œì¹˜ë¦¬ìŠ¤íŠ¸</h2>
      <div class="tabs">
        <button class="tab active" onclick="switchWatchTab(0,this)">ì˜ìƒ ì¶”ì </button>
        <button class="tab" onclick="switchWatchTab(1,this)">24ì‹œê°„ ìŠ¤ëƒ…ìƒ·</button>
      </div>
      <div id="watchContent"></div>
    </div>
  </div>

  <div class="modal" id="trendsModal">
    <div class="modal-content" style="max-width:800px">
      <button class="close" onclick="closeTrends()">âœ•</button>
      <h2>ğŸ“ˆ ì¥ê¸° íŠ¸ë Œë“œ ë¶„ì„</h2>
      <div id="trendsContent"></div>
    </div>
  </div>

  <script>
    const API_KEY = 'AIzaSyCEzcUYLaItoSqA3ELRP6mFmgvxJzT8hzQ';
    const API_BASE = 'https://www.googleapis.com/youtube/v3';
    
    const STATE = {
      videos: [],
      categories: [],
      chart: null,
      watchlist: JSON.parse(localStorage.getItem('ytWatchlist') || '[]'),
      snapshots: JSON.parse(localStorage.getItem('ytSnapshots') || '[]'),
      trends: JSON.parse(localStorage.getItem('ytTrends') || '{}')
    };

    const CATEGORIES = [
      {id:'music',name:'ìŒì•…',weight:3,keywords:['ìŒì•… ì‡¼ì¸ ','kpop ì‡¼ì¸ ','ë®¤ì§ë¹„ë””ì˜¤ shorts','ë…¸ë˜ shorts']},
      {id:'game',name:'ê²Œì„',weight:3,keywords:['ê²Œì„ ì‡¼ì¸ ','game shorts','gameplay shorts','gaming shorts']},
      {id:'comedy',name:'ì½”ë¯¸ë””',weight:2,keywords:['ì›ƒê¸´ ì‡¼ì¸ ','ì½”ë¯¸ë”” shorts','funny shorts','ê°œê·¸ shorts']},
      {id:'food',name:'ìŒì‹',weight:2,keywords:['ë¨¹ë°© ì‡¼ì¸ ','ìš”ë¦¬ shorts','food shorts','ë§›ì§‘ shorts']},
      {id:'beauty',name:'ë·°í‹°',weight:2,keywords:['ë©”ì´í¬ì—… ì‡¼ì¸ ','ë·°í‹° shorts','í™”ì¥ shorts','skincare shorts']},
      {id:'pet',name:'ë™ë¬¼',weight:2,keywords:['ê°•ì•„ì§€ ì‡¼ì¸ ','ê³ ì–‘ì´ shorts','pet shorts','ë™ë¬¼ shorts']},
      {id:'sports',name:'ìŠ¤í¬ì¸ ',weight:1,keywords:['ì¶•êµ¬ ì‡¼ì¸ ','sports shorts','ì•¼êµ¬ shorts','ìš´ë™ shorts']},
      {id:'news',name:'ë‰´ìŠ¤',weight:1,keywords:['ë‰´ìŠ¤ ì‡¼ì¸ ','ì‹œì‚¬ shorts','news shorts','ì´ìŠˆ shorts']},
      {id:'tech',name:'í…Œí¬',weight:1,keywords:['tech shorts','ê¸°ìˆ  shorts','IT shorts','gadget shorts']},
      {id:'edu',name:'êµìœ¡',weight:1,keywords:['êµìœ¡ ì‡¼ì¸ ','study shorts','ê³µë¶€ shorts','learning shorts']},
      {id:'vlog',name:'ì¼ìƒ',weight:2,keywords:['ì¼ìƒ ì‡¼ì¸ ','ë¸Œì´ë¡œê·¸ shorts','vlog shorts','daily shorts']},
      {id:'dance',name:'ëŒ„ìŠ¤',weight:2,keywords:['ëŒ„ìŠ¤ ì‡¼ì¸ ','dance shorts','ì¶¤ shorts','ì•ˆë¬´ shorts']},
      {id:'drama',name:'ë“œë¼ë§ˆ',weight:1,keywords:['ë“œë¼ë§ˆ ì‡¼ì¸ ','drama shorts','ì›¹ë“œë¼ë§ˆ shorts','ì‹œë¦¬ì¦ˆ shorts']},
      {id:'kids',name:'í‚¤ì¦ˆ',weight:1,keywords:['í‚¤ì¦ˆ ì‡¼ì¸ ','ì–´ë¦°ì´ shorts','kids shorts','ì•„ì´ë“¤ shorts']},
      {id:'senior',name:'ì‹œë‹ˆì–´',weight:1,keywords:['ì‹œë‹ˆì–´','ì¤‘ë…„','50ëŒ€','60ëŒ€']},
      {id:'pride',name:'êµ­ë½',weight:1,keywords:['êµ­ë½','í•œêµ­','korea','korean','k-']}
    ];

    // ì½˜í…ì¸  íƒ€ì… íŒë³„
    function getContentType(duration) {
      if (typeof duration === 'string') {
        duration = isoToSeconds(duration);
      }
      if (duration <= 60) return 'shorts';
      if (duration <= 600) return 'mid';
      if (duration <= 1200) return 'long';
      return 'vlong';
    }

    // ISO 8601 durationì„ ì´ˆë¡œ ë³€í™˜
    function isoToSeconds(duration) {
      const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      if (!match) return 0;
      const hours = parseInt(match[1] || 0);
      const minutes = parseInt(match[2] || 0);
      const seconds = parseInt(match[3] || 0);
      return hours * 3600 + minutes * 60 + seconds;
    }

    // ì‹œê°„ í¬ë§·íŒ…
    function formatDuration(seconds) {
      if (seconds < 60) return `${seconds}ì´ˆ`;
      if (seconds < 3600) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return s > 0 ? `${m}ë¶„ ${s}ì´ˆ` : `${m}ë¶„`;
      }
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      return m > 0 ? `${h}ì‹œê°„ ${m}ë¶„` : `${h}ì‹œê°„`;
    }

    // ë¡±í¼ ì „ìš© ì§€í‘œ ê³„ì‚°
    function computeLongformMetrics(video) {
      const duration = isoToSeconds(video.contentDetails.duration);
      const views = parseInt(video.statistics.viewCount || 0);
      const likes = parseInt(video.statistics.likeCount || 0);
      const comments = parseInt(video.statistics.commentCount || 0);
      const publishedAt = new Date(video.snippet.publishedAt);
      const ageInDays = Math.max(1, (Date.now() - publishedAt) / 86400000);
      
      // í‰ê·  ì‹œì²­ì‹œê°„ ì¶”ì • (ì°¸ì—¬ìœ¨ ê¸°ë°˜)
      const engagementRate = (likes + comments) / Math.max(1, views);
      const estimatedRetention = Math.min(0.8, 0.3 + engagementRate * 50);
      const avgViewDuration = Math.round(duration * estimatedRetention);
      
      // ì‹œì²­ ì§€ì†ë¥  ì ìˆ˜ (0-100)
      const retentionScore = Math.round(estimatedRetention * 100);
      
      // RPM ì¶”ì • (ìˆ˜ìµì„±)
      let rpm = 0;
      if (duration > 480) { // 8ë¶„ ì´ìƒ
        rpm = 3.5 + (engagementRate * 100);
      } else if (duration > 60) {
        rpm = 1.5 + (engagementRate * 50);
      }
      
      // ì—ë²„ê·¸ë¦° ì ìˆ˜ (ì§€ì†ì  ì¡°íšŒìˆ˜)
      const dailyViews = views / ageInDays;
      const decayFactor = Math.exp(-ageInDays / 365);
      const evergreenScore = Math.round(dailyViews * (1 - decayFactor) / 100);
      
      return {
        avgViewDuration,
        retentionScore,
        rpm: rpm.toFixed(2),
        evergreenScore,
        formattedDuration: formatDuration(duration),
        contentType: getContentType(duration)
      };
    }

    // í…Œì´ë¸” í—¤ë” ì—…ë°ì´íŠ¸
    function updateTableHeaders() {
      const contentType = document.getElementById('contentType').value;
      const headers = document.getElementById('tableHeaders');
      
      let cols = ['ì¸ë„¤ì¼', 'ì œëª©/ì±„ë„', 'ê¸¸ì´'];
      
      if (contentType === 'shorts') {
        cols.push('ì†ë„', 'ë°˜ì‘ë¥ ', 'ì‹ ì„ ë„', 'ì„íŒ©íŠ¸', 'ë“±ê¸‰');
      } else if (contentType === 'long' || contentType === 'mid' || contentType === 'vlong') {
        cols.push('í‰ê· ì‹œì²­', 'ì§€ì†ë¥ ', 'RPM', 'ì—ë²„ê·¸ë¦°', 'ë“±ê¸‰');
      } else {
        cols.push('íƒ€ì…', 'ì¡°íšŒìˆ˜', 'ë°˜ì‘ë¥ ', 'RPM', 'ë“±ê¸‰');
      }
      
      headers.innerHTML = cols.map(col => `<th>${col}</th>`).join('');
    }

    // YouTube API ê²€ìƒ‰
    async function ytSearch(params) {
      const defaultParams = {
        part: 'id,snippet',
        type: 'video',
        maxResults: 50,
        order: 'viewCount',
        key: API_KEY
      };
      
      // ì½˜í…ì¸  íƒ€ì…ì— ë”°ë¥¸ duration íŒŒë¼ë¯¸í„° ì„¤ì •
      const contentType = document.getElementById('contentType').value;
      const minDur = parseInt(document.getElementById('minDuration').value) || 0;
      const maxDur = parseInt(document.getElementById('maxDuration').value) || 86400;
      
      if (contentType === 'shorts' || maxDur <= 240) {
        defaultParams.videoDuration = 'short';
      } else if (contentType === 'mid' || (minDur > 240 && maxDur <= 1200)) {
        defaultParams.videoDuration = 'medium';
      } else if (contentType === 'long' || contentType === 'vlong' || minDur > 1200) {
        defaultParams.videoDuration = 'long';
      }
      
      const url = new URL(`${API_BASE}/search`);
      Object.entries({...defaultParams, ...params}).forEach(([k, v]) => 
        url.searchParams.append(k, v)
      );
      
      const res = await fetch(url);
      return await res.json();
    }

    // ì˜ìƒ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    async function fetchVideoDetails(videoIds) {
      const url = new URL(`${API_BASE}/videos`);
      url.searchParams.append('part', 'snippet,statistics,contentDetails');
      url.searchParams.append('id', videoIds.join(','));
      url.searchParams.append('key', API_KEY);
      
      const res = await fetch(url);
      return await res.json();
    }

    // ê²€ìƒ‰ ì‹¤í–‰
    async function search() {
      const mode = document.getElementById('mode').value;
      const query = document.getElementById('query').value;
      const region = document.getElementById('region').value;
      const lang = document.getElementById('lang').value;
      const days = document.getElementById('days').value;
      const maxResults = document.getElementById('maxResults').value;
      
      if (mode !== 'seedless' && !query.trim()) {
        alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }
      
      showLoader();
      STATE.videos = [];
      
      try {
        if (mode === 'seedless') {
          await seedlessSearch(region, lang, days, maxResults);
        } else {
          await keywordSearch(query, region, lang, days, maxResults, mode);
        }
        
        processResults();
      } catch(e) {
        console.error(e);
        alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
      } finally {
        hideLoader();
      }
    }

    // ì‹œë“œë¦¬ìŠ¤ ê²€ìƒ‰
    async function seedlessSearch(region, lang, days, maxResults) {
      const publishedAfter = new Date(Date.now() - days * 24 * 3600 * 1000).toISOString();
      const targetPerCategory = Math.ceil(maxResults / CATEGORIES.length);
      
      document.getElementById('categories').style.display = 'block';
      renderCategoryFilters();
      
      for (let i = 0; i < CATEGORIES.length; i++) {
        const cat = CATEGORIES[i];
        console.log(`[${i+1}/${CATEGORIES.length}] ${cat.name} ê²€ìƒ‰ ì¤‘...`);
        
        const categoryVideos = [];
        for (const keyword of cat.keywords) {
          if (categoryVideos.length >= targetPerCategory) break;
          
          const res = await ytSearch({
            q: keyword,
            regionCode: region,
            relevanceLanguage: lang,
            publishedAfter,
            maxResults: 15
          });
          
          if (res.items && res.items.length > 0) {
            const videoIds = res.items.map(item => item.id.videoId);
            const details = await fetchVideoDetails(videoIds);
            
            if (details.items) {
              const filtered = details.items.filter(v => {
                const duration = isoToSeconds(v.contentDetails.duration);
                const minDur = parseInt(document.getElementById('minDuration').value) || 0;
                const maxDur = parseInt(document.getElementById('maxDuration').value) || 86400;
                return duration >= minDur && duration <= maxDur;
              });
              
              filtered.forEach(v => {
                v._category = cat.name;
                v._categoryId = cat.id;
              });
              
              categoryVideos.push(...filtered);
            }
          }
        }
        
        STATE.videos.push(...categoryVideos.slice(0, targetPerCategory));
      }
    }

    // í‚¤ì›Œë“œ/ì±„ë„ ê²€ìƒ‰
    async function keywordSearch(query, region, lang, days, maxResults, mode) {
      const publishedAfter = new Date(Date.now() - days * 24 * 3600 * 1000).toISOString();
      
      const params = {
        regionCode: region,
        relevanceLanguage: lang,
        publishedAfter,
        maxResults
      };
      
      if (mode === 'channel') {
        params.channelId = query;
      } else {
        params.q = query;
      }
      
      const res = await ytSearch(params);
      
      if (res.items && res.items.length > 0) {
        const videoIds = res.items.map(item => item.id.videoId);
        const details = await fetchVideoDetails(videoIds);
        
        if (details.items) {
          STATE.videos = details.items.filter(v => {
            const duration = isoToSeconds(v.contentDetails.duration);
            const minDur = parseInt(document.getElementById('minDuration').value) || 0;
            const maxDur = parseInt(document.getElementById('maxDuration').value) || 86400;
            return duration >= minDur && duration <= maxDur;
          });
        }
      }
    }

    // ê²°ê³¼ ì²˜ë¦¬
    function processResults() {
      if (STATE.videos.length === 0) {
        document.getElementById('empty').style.display = 'block';
        document.getElementById('table').style.display = 'none';
        document.getElementById('summary').style.display = 'none';
        return;
      }
      
      // íŒŒìƒ ì§€í‘œ ê³„ì‚°
      STATE.videos.forEach(v => {
        const views = parseInt(v.statistics.viewCount || 0);
        const likes = parseInt(v.statistics.likeCount || 0);
        const comments = parseInt(v.statistics.commentCount || 0);
        const publishedAt = new Date(v.snippet.publishedAt);
        const hoursAgo = (Date.now() - publishedAt) / 3600000;
        const duration = isoToSeconds(v.contentDetails.duration);
        
        // ê¸°ë³¸ ì§€í‘œ
        v._d = {
          speed: Math.round(views / Math.max(1, hoursAgo)),
          er: ((likes + comments) / Math.max(1, views) * 100).toFixed(2),
          fresh: Math.round(100 * Math.exp(-hoursAgo / 168)),
          impact: Math.round(Math.log10(views + 1) * 20)
        };
        
        // ì½˜í…ì¸  íƒ€ì…ë³„ ì¶”ê°€ ì§€í‘œ
        if (duration > 60) {
          const longMetrics = computeLongformMetrics(v);
          v._longform = longMetrics;
        }
        
        // ë“±ê¸‰ ì‚°ì •
        const score = v._d.speed * 0.3 + parseFloat(v._d.er) * 10 + v._d.fresh * 0.2 + v._d.impact;
        if (score > 80) v._grade = 'S';
        else if (score > 60) v._grade = 'A';
        else if (score > 40) v._grade = 'B';
        else if (score > 20) v._grade = 'C';
        else v._grade = 'D';
      });
      
      sortTable();
      renderSummary();
      document.getElementById('empty').style.display = 'none';
      document.getElementById('table').style.display = 'table';
      document.getElementById('summary').style.display = 'block';
    }

    // í…Œì´ë¸” ì •ë ¬
    function sortTable() {
      const sortBy = document.getElementById('sortBy').value;
      
      STATE.videos.sort((a, b) => {
        if (sortBy === 'views') return parseInt(b.statistics.viewCount) - parseInt(a.statistics.viewCount);
        if (sortBy === 'speed') return b._d.speed - a._d.speed;
        if (sortBy === 'er') return parseFloat(b._d.er) - parseFloat(a._d.er);
        if (sortBy === 'fresh') return b._d.fresh - a._d.fresh;
        if (sortBy === 'impact') return b._d.impact - a._d.impact;
        if (sortBy === 'rpm' && b._longform) return parseFloat(b._longform.rpm || 0) - parseFloat(a._longform?.rpm || 0);
        if (sortBy === 'retention' && b._longform) return (b._longform.retentionScore || 0) - (a._longform?.retentionScore || 0);
        return 0;
      });
      
      renderTable();
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable() {
      updateTableHeaders();
      const tbody = document.getElementById('tbody');
      const contentType = document.getElementById('contentType').value;
      const filtered = filterVideos();
      
      tbody.innerHTML = filtered.map(v => {
        const duration = isoToSeconds(v.contentDetails.duration);
        const type = getContentType(duration);
        const typeLabel = {
          shorts: 'ì‡¼ì¸ ',
          mid: 'ë¯¸ë“œ',
          long: 'ë¡±í¼',
          vlong: 'ì´ˆì¥í¸'
        }[type];
        
        let cols = `
          <td><img class="thumb" src="${v.snippet.thumbnails.medium.url}" onclick="window.open('https://youtube.com/watch?v=${v.id}')"></td>
          <td>
            <div style="font-weight:600">${v.snippet.title.slice(0,50)}</div>
            <div style="color:#6b7280;font-size:12px;cursor:pointer" onclick="showChannelModal('${v.snippet.channelId}')">${v.snippet.channelTitle}</div>
            ${v._category ? `<span class="badge" style="margin-top:4px">${v._category}</span>` : ''}
          </td>
          <td>
            <div class="duration-display">
              ${v._longform ? v._longform.formattedDuration : formatDuration(duration)}
              <span class="content-type-badge type-${type}">${typeLabel}</span>
            </div>
          </td>
        `;
        
        if (contentType === 'shorts') {
          cols += `
            <td>${v._d.speed.toLocaleString()}/h</td>
            <td>${v._d.er}%</td>
            <td>${v._d.fresh}%</td>
            <td>${v._d.impact}</td>
            <td><span class="badge grade-${v._grade}">${v._grade}</span></td>
          `;
        } else if (contentType === 'long' || contentType === 'mid' || contentType === 'vlong') {
          if (v._longform) {
            cols += `
              <td>${formatDuration(v._longform.avgViewDuration)}</td>
              <td>${v._longform.retentionScore}%</td>
              <td>$${v._longform.rpm}</td>
              <td>${v._longform.evergreenScore}</td>
              <td><span class="badge grade-${v._grade}">${v._grade}</span></td>
            `;
          } else {
            cols += `
              <td>-</td><td>-</td><td>-</td><td>-</td>
              <td><span class="badge grade-${v._grade}">${v._grade}</span></td>
            `;
          }
        } else {
          cols += `
            <td><span class="content-type-badge type-${type}">${typeLabel}</span></td>
            <td>${parseInt(v.statistics.viewCount).toLocaleString()}</td>
            <td>${v._d.er}%</td>
            <td>${v._longform ? '$' + v._longform.rpm : '-'}</td>
            <td><span class="badge grade-${v._grade}">${v._grade}</span></td>
          `;
        }
        
        return `<tr>${cols}</tr>`;
      }).join('');
    }

    // ì˜ìƒ í•„í„°ë§
    function filterVideos() {
      let filtered = [...STATE.videos];
      
      // ì¹´í…Œê³ ë¦¬ í•„í„°
      if (document.getElementById('mode').value === 'seedless') {
        const activeCategories = Array.from(document.querySelectorAll('.pill.active'))
          .map(el => el.dataset.id);
        if (activeCategories.length > 0) {
          filtered = filtered.filter(v => activeCategories.includes(v._categoryId));
        }
      }
      
      return filtered;
    }

    // ìš”ì•½ í†µê³„ ë Œë”ë§
    function renderSummary() {
      const videos = filterVideos();
      const totalViews = videos.reduce((sum, v) => sum + parseInt(v.statistics.viewCount), 0);
      const avgViews = Math.round(totalViews / videos.length);
      const avgER = (videos.reduce((sum, v) => sum + parseFloat(v._d.er), 0) / videos.length).toFixed(2);
      
      // í¬ë§·ë³„ ë¶„ì„
      const shorts = videos.filter(v => getContentType(isoToSeconds(v.contentDetails.duration)) === 'shorts');
      const longs = videos.filter(v => {
        const type = getContentType(isoToSeconds(v.contentDetails.duration));
        return type === 'mid' || type === 'long' || type === 'vlong';
      });
      
      document.getElementById('statsGrid').innerHTML = `
        <div class="stat-box">
          <div class="stat-label">ì´ ì˜ìƒ</div>
          <div class="stat-value">${videos.length}</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">ì´ ì¡°íšŒìˆ˜</div>
          <div class="stat-value">${(totalViews/1000000).toFixed(1)}M</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">í‰ê·  ì¡°íšŒìˆ˜</div>
          <div class="stat-value">${(avgViews/1000).toFixed(0)}K</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">í‰ê·  ë°˜ì‘ë¥ </div>
          <div class="stat-value">${avgER}%</div>
        </div>
      `;
      
      // í¬ë§· ë¹„êµ í‘œì‹œ
      if (shorts.length > 0 && longs.length > 0) {
        document.getElementById('formatComparison').style.display = 'block';
        
        const shortsAvg = Math.round(shorts.reduce((sum, v) => sum + parseInt(v.statistics.viewCount), 0) / shorts.length);
        const longsAvg = Math.round(longs.reduce((sum, v) => sum + parseInt(v.statistics.viewCount), 0) / longs.length);
        
        document.getElementById('shortsAvgViews').textContent = shortsAvg.toLocaleString();
        document.getElementById('longAvgViews').textContent = longsAvg.toLocaleString();
        document.getElementById('optimalFormat').textContent = shortsAvg > longsAvg ? 'ì‡¼ì¸ ' : 'ë¡±í¼';
      }
      
      renderChart(videos);
    }

    // ì°¨íŠ¸ ë Œë”ë§
    function renderChart(videos) {
      const ctx = document.getElementById('chart').getContext('2d');
      
      if (STATE.chart) STATE.chart.destroy();
      
      // ì‹œê°„ë³„ ê·¸ë£¹í•‘
      const hourly = {};
      videos.forEach(v => {
        const hour = new Date(v.snippet.publishedAt).getHours();
        if (!hourly[hour]) hourly[hour] = [];
        hourly[hour].push(parseInt(v.statistics.viewCount));
      });
      
      const labels = Array.from({length: 24}, (_, i) => `${i}ì‹œ`);
      const data = labels.map((_, i) => {
        const vids = hourly[i] || [];
        return vids.length ? vids.reduce((a,b) => a+b) / vids.length : 0;
      });
      
      STATE.chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'ì‹œê°„ëŒ€ë³„ í‰ê·  ì¡°íšŒìˆ˜',
            data,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#e5e7eb' }
            },
            x: {
              grid: { display: false }
            }
          }
        }
      });
    }

    // ì¹´í…Œê³ ë¦¬ í•„í„° ë Œë”ë§
    function renderCategoryFilters() {
      const container = document.getElementById('categoryFilters');
      container.innerHTML = CATEGORIES.map(cat => `
        <span class="pill active" data-id="${cat.id}" onclick="toggleCategory(this)">
          ${cat.name}
        </span>
      `).join('');
    }

    // ì¹´í…Œê³ ë¦¬ í† ê¸€
    function toggleCategory(el) {
      el.classList.toggle('active');
      processResults();
    }

    // ì „ì²´ ì„ íƒ/í•´ì œ
    function selectAllCategories() {
      document.querySelectorAll('#categoryFilters .pill').forEach(el => el.classList.add('active'));
      processResults();
    }
    
    function deselectAllCategories() {
      document.querySelectorAll('#categoryFilters .pill').forEach(el => el.classList.remove('active'));
      processResults();
    }

    // ì±„ë„ ëª¨ë‹¬
    async function showChannelModal(channelId) {
      const modal = document.getElementById('channelModal');
      const content = document.getElementById('modalContent');
      
      content.innerHTML = 'ë¡œë”© ì¤‘...';
      modal.classList.add('open');
      
      try {
        // ì±„ë„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const channelRes = await fetch(`${API_BASE}/channels?part=snippet,statistics&id=${channelId}&key=${API_KEY}`);
        const channelData = await channelRes.json();
        const channel = channelData.items[0];
        
        // ì±„ë„ì˜ ìµœê·¼ ì˜ìƒ ê°€ì ¸ì˜¤ê¸°
        const videosRes = await fetch(`${API_BASE}/search?part=snippet&channelId=${channelId}&order=date&maxResults=10&type=video&key=${API_KEY}`);
        const videosData = await videosRes.json();
        
        content.innerHTML = `
          <div style="display:flex;gap:16px;margin-bottom:20px">
            <img src="${channel.snippet.thumbnails.default.url}" style="width:80px;height:80px;border-radius:50%">
            <div>
              <h3>${channel.snippet.title}</h3>
              <p style="color:#6b7280;font-size:14px">${channel.snippet.description.slice(0,200)}</p>
            </div>
          </div>
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-label">êµ¬ë…ì</div>
              <div class="stat-value">${(parseInt(channel.statistics.subscriberCount)/1000000).toFixed(1)}M</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">ì´ ì˜ìƒ</div>
              <div class="stat-value">${parseInt(channel.statistics.videoCount).toLocaleString()}</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">ì´ ì¡°íšŒìˆ˜</div>
              <div class="stat-value">${(parseInt(channel.statistics.viewCount)/1000000000).toFixed(1)}B</div>
            </div>
          </div>
          <h4 style="margin-top:20px">ìµœê·¼ ì—…ë¡œë“œ</h4>
          <div style="max-height:300px;overflow-y:auto">
            ${videosData.items.map(v => `
              <div style="display:flex;gap:12px;padding:8px;cursor:pointer" onclick="window.open('https://youtube.com/watch?v=${v.id.videoId}')">
                <img src="${v.snippet.thumbnails.default.url}" style="width:120px;height:68px;border-radius:8px">
                <div style="flex:1">
                  <div style="font-weight:600;font-size:13px">${v.snippet.title}</div>
                  <div style="color:#6b7280;font-size:12px">${new Date(v.snippet.publishedAt).toLocaleDateString()}</div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      } catch(e) {
        content.innerHTML = 'ì±„ë„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
      }
    }

    // ì›Œì¹˜ë¦¬ìŠ¤íŠ¸
    function openWatchlist() {
      const modal = document.getElementById('watchlistModal');
      modal.classList.add('open');
      switchWatchTab(0, document.querySelector('#watchlistModal .tab'));
    }
    
    function closeWatchlist() {
      document.getElementById('watchlistModal').classList.remove('open');
    }
    
    function switchWatchTab(index, el) {
      document.querySelectorAll('#watchlistModal .tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      
      const content = document.getElementById('watchContent');
      
      if (index === 0) {
        // ì›Œì¹˜ë¦¬ìŠ¤íŠ¸
        if (STATE.watchlist.length === 0) {
          content.innerHTML = '<div class="empty">ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</div>';
        } else {
          content.innerHTML = STATE.watchlist.map(v => `
            <div style="display:flex;gap:12px;padding:8px;border-bottom:1px solid #e5e7eb">
              <img src="${v.thumbnail}" style="width:120px;height:68px;border-radius:8px">
              <div style="flex:1">
                <div style="font-weight:600">${v.title}</div>
                <div style="color:#6b7280;font-size:12px">${v.channel}</div>
                <div style="margin-top:4px">
                  <span class="badge">ì‹œì‘: ${v.initialViews.toLocaleString()}</span>
                  <span class="badge">í˜„ì¬: ${v.currentViews?.toLocaleString() || '-'}</span>
                </div>
              </div>
              <button onclick="removeFromWatchlist('${v.id}')">ì‚­ì œ</button>
            </div>
          `).join('');
        }
      } else {
        // ìŠ¤ëƒ…ìƒ·
        if (STATE.snapshots.length === 0) {
          content.innerHTML = '<div class="empty">ìŠ¤ëƒ…ìƒ·ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        } else {
          content.innerHTML = STATE.snapshots.map(s => `
            <div style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px">
              <h4>${new Date(s.timestamp).toLocaleString()}</h4>
              <div>ì˜ìƒ ìˆ˜: ${s.videos.length}</div>
              <div>ì´ ì¡°íšŒìˆ˜: ${s.totalViews.toLocaleString()}</div>
              <button onclick="loadSnapshot('${s.id}')">ë¶ˆëŸ¬ì˜¤ê¸°</button>
              <button class="danger" onclick="deleteSnapshot('${s.id}')">ì‚­ì œ</button>
            </div>
          `).join('');
        }
      }
    }
    
    function removeFromWatchlist(id) {
      STATE.watchlist = STATE.watchlist.filter(v => v.id !== id);
      localStorage.setItem('ytWatchlist', JSON.stringify(STATE.watchlist));
      switchWatchTab(0, document.querySelector('#watchlistModal .tab.active'));
    }
    
    function loadSnapshot(id) {
      const snapshot = STATE.snapshots.find(s => s.id === id);
      if (snapshot) {
        console.log('ìŠ¤ëƒ…ìƒ· ë¡œë“œ:', snapshot);
        alert(`${snapshot.videos.length}ê°œ ì˜ìƒ ë¡œë“œë¨`);
        closeWatchlist();
      }
    }
    
    function deleteSnapshot(id) {
      STATE.snapshots = STATE.snapshots.filter(s => s.id !== id);
      localStorage.setItem('ytSnapshots', JSON.stringify(STATE.snapshots));
      switchWatchTab(1, document.querySelector('#watchlistModal .tab.active'));
    }

    // ìŠ¤ëƒ…ìƒ· ê¸°ëŠ¥
    function toggleSnapshot() {
      if (!STATE.videos.length) {
        alert('ë¨¼ì € ê²€ìƒ‰ì„ ì‹¤í–‰í•˜ì„¸ìš”');
        return;
      }
      
      const snapshot = {
        id: Date.now().toString(),
        timestamp: new Date().toISOString(),
        videos: STATE.videos.map(v => ({
          id: v.id,
          title: v.snippet.title,
          channel: v.snippet.channelTitle,
          views: parseInt(v.statistics.viewCount)
        })),
        totalViews: STATE.videos.reduce((sum, v) => sum + parseInt(v.statistics.viewCount), 0)
      };
      
      STATE.snapshots.push(snapshot);
      localStorage.setItem('ytSnapshots', JSON.stringify(STATE.snapshots));
      alert('ìŠ¤ëƒ…ìƒ· ì €ì¥ë¨');
    }

    // ì¥ê¸° íŠ¸ë Œë“œ
    function showTrends() {
      const modal = document.getElementById('trendsModal');
      const content = document.getElementById('trendsContent');
      
      content.innerHTML = `
        <div class="row" style="margin-bottom:16px">
          <input id="trendKeyword" placeholder="ì¶”ì í•  í‚¤ì›Œë“œ ì…ë ¥" style="flex:1">
          <button onclick="addTrendKeyword()">ì¶”ê°€</button>
        </div>
        <div id="trendsList"></div>
      `;
      
      renderTrendsList();
      modal.classList.add('open');
    }
    
    function closeTrends() {
      document.getElementById('trendsModal').classList.remove('open');
    }
    
    function renderTrendsList() {
      const container = document.getElementById('trendsList');
      const keywords = Object.keys(STATE.trends);
      
      if (keywords.length === 0) {
        container.innerHTML = '<div class="empty">ì¶”ì  ì¤‘ì¸ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }
      
      container.innerHTML = keywords.map(keyword => {
        const data = STATE.trends[keyword];
        const latest = data[data.length - 1];
        const prev = data[data.length - 2];
        const change = prev ? ((latest.avgViews - prev.avgViews) / prev.avgViews * 100).toFixed(1) : 0;
        
        return `
          <div style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h4>${keyword}</h4>
              <button class="danger" onclick="removeTrendKeyword('${keyword}')">ì‚­ì œ</button>
            </div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">
              <div class="stat-box">
                <div class="stat-label">í‰ê·  ì¡°íšŒìˆ˜</div>
                <div class="stat-value">${(latest.avgViews/1000).toFixed(0)}K</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">ë³€ë™</div>
                <div class="stat-value ${change > 0 ? 'good' : 'warn'}">${change > 0 ? '+' : ''}${change}%</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">ë°ì´í„° í¬ì¸íŠ¸</div>
                <div class="stat-value">${data.length}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    async function addTrendKeyword() {
      const keyword = document.getElementById('trendKeyword').value.trim();
      if (!keyword) return;
      
      showLoader();
      
      try {
        const res = await ytSearch({
          q: keyword,
          regionCode: document.getElementById('region').value,
          maxResults: 20
        });
        
        if (res.items && res.items.length > 0) {
          const videoIds = res.items.map(item => item.id.videoId);
          const details = await fetchVideoDetails(videoIds);
          
          const avgViews = details.items.reduce((sum, v) => sum + parseInt(v.statistics.viewCount), 0) / details.items.length;
          
          if (!STATE.trends[keyword]) STATE.trends[keyword] = [];
          
          STATE.trends[keyword].push({
            timestamp: new Date().toISOString(),
            avgViews: Math.round(avgViews),
            count: details.items.length
          });
          
          localStorage.setItem('ytTrends', JSON.stringify(STATE.trends));
          document.getElementById('trendKeyword').value = '';
          renderTrendsList();
        }
      } catch(e) {
        alert('íŠ¸ë Œë“œ ì¶”ê°€ ì‹¤íŒ¨');
      } finally {
        hideLoader();
      }
    }
    
    function removeTrendKeyword(keyword) {
      delete STATE.trends[keyword];
      localStorage.setItem('ytTrends', JSON.stringify(STATE.trends));
      renderTrendsList();
    }

    // ë°ì´í„° ë‚´ë³´ë‚´ê¸°
    function exportData() {
      if (!STATE.videos.length) {
        alert('ë¨¼ì € ê²€ìƒ‰ì„ ì‹¤í–‰í•˜ì„¸ìš”');
        return;
      }
      
      const csv = [
        ['ì œëª©', 'ì±„ë„', 'ì¡°íšŒìˆ˜', 'ì¢‹ì•„ìš”', 'ëŒ“ê¸€', 'ê¸¸ì´', 'íƒ€ì…', 'ì—…ë¡œë“œì¼ì‹œ', 'ì†ë„', 'ë°˜ì‘ë¥ ', 'RPM', 'ë“±ê¸‰'],
        ...STATE.videos.map(v => {
          const duration = isoToSeconds(v.contentDetails.duration);
          return [
            v.snippet.title,
            v.snippet.channelTitle,
            v.statistics.viewCount,
            v.statistics.likeCount,
            v.statistics.commentCount,
            formatDuration(duration),
            getContentType(duration),
            v.snippet.publishedAt,
            v._d.speed,
            v._d.er,
            v._longform?.rpm || '-',
            v._grade
          ];
        })
      ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `youtube_data_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    }

    // UI í—¬í¼
    function showLoader() {
      document.getElementById('loader').style.display = 'block';
    }
    
    function hideLoader() {
      document.getElementById('loader').style.display = 'none';
    }
    
    function closeModal() {
      document.getElementById('channelModal').classList.remove('open');
    }

    // ì´ˆê¸°í™”
    window.addEventListener('load', () => {
      console.log('YouTube Content Radar v8.0 - ì‡¼ì¸  & ë¡±í¼ í†µí•© ë¶„ì„');
      updateTableHeaders();
    });
  </script>
</body>
</html>
