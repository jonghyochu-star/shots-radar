<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shorts Radar — S1 테이블/Export (KOR)</title>
<link rel="icon" href="data:,">
<!-- XLSX (SheetJS) for .xlsx export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{--bg:#0b1116;--card:#101922;--muted:#7a8a9a;--text:#e8f0f7;--accent:#62d26f;--warn:#ffb84d}
  html,body{height:100%} body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Pretendard,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:1180px;margin:24px auto;padding:0 16px 80px}
  h1{font-weight:800;letter-spacing:-.3px;font-size:24px;margin:0 0 10px}
  .sub{color:var(--muted);font-size:13px;margin-bottom:12px}
  .card{background:linear-gradient(180deg,#0f1821,#0a1118);border:1px solid #1e2a36;border-radius:14px;padding:14px 14px 16px;margin-top:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,select,button{border-radius:10px;border:1px solid #2a3a4a;background:#0c141c;color:var(--text);padding:9px 11px;font-size:14px}
  input::placeholder{color:#6b7b8b}
  button{cursor:pointer;background:#152332;border:1px solid #274156}
  button.primary{background:linear-gradient(180deg,#2a6fff,#2461e6);border:0}
  button.ghost{background:transparent;border:1px dashed #2d3b49}
  .hint{color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:9px;border-bottom:1px solid #1e2a36;text-align:left;font-size:13px}
  th{color:#a5b6c6;font-weight:600;white-space:nowrap}
  .thumb{width:108px;height:60px;object-fit:cover;border-radius:8px;border:1px solid #223243;background:#0e1620}
  .badge{padding:4px 8px;border-radius:999px;background:#0e1b29;border:1px solid #23374a;font-size:11px}
  .grade-S{background:#0f2b1a;border-color:#1f4b2a;color:#b9ffd0}
  .grade-A{background:#0e232f;border-color:#214056;color:#bfe7ff}
  .grade-B,.grade-C{background:#121a24;border-color:#223243;color:#c7d4e3}
  .grade-D{background:#151922;border-color:#222838;color:#9aa8b8}
  .pill{background:#0f1620;border:1px solid #1f2a36;border-radius:999px;padding:6px 10px;font-size:12px;color:#b9c7d6}
  .star{cursor:pointer;font-size:18px;user-select:none}
  .star.on{color:#ffd166}
  .right{justify-content:flex-end}
  .muted{color:#9fb0bf}
</style>
</head>
<body>
<div class="wrap">
  <h1>Shorts Radar <span class="muted">— S1 테이블·Export</span></h1>
  <div class="sub">업로드일 · 조회/속도 배율 · 반응률 · 임팩트 등급 · 필터/정렬 · CSV/XLSX/JSON 내보내기</div>

  <!-- 1) 연결 설정 -->
  <div class="card">
    <div class="row">
      <input id="apiKey" placeholder="YouTube Data API 키 붙여넣기" style="min-width:320px" />
      <button id="saveKey" class="primary">키 저장</button>
      <span class="hint">* 브라우저에만 보관됩니다.</span>
    </div>
    <div class="row" style="margin-top:6px">
      <label>기간</label>
      <select id="days"><option value="3">3일</option><option value="7">7일</option><option value="14" selected>14일</option></select>
      <label>지역</label>
      <select id="region"><option>KR</option><option>US</option><option>JP</option><option>GB</option></select>
      <label>언어</label>
      <select id="lang"><option>ko</option><option>en</option><option>ja</option></select>
      <label>최대 결과</label>
      <input id="maxResults" type="number" value="80" min="10" max="200" style="width:120px" />
    </div>
    <div class="row" style="margin-top:6px">
      <input id="keywords" placeholder="찾을 주제(예: 고양이 모래매트, 정치풍자)" style="flex:1" />
      <input id="channels" placeholder="채널 ID들(쉼표 구분·선택)" style="flex:1" />
      <button id="runBtn" class="primary">찾기 시작</button>
    </div>
  </div>

  <!-- 2) 필터/정렬/보기 & Export -->
  <div class="card">
    <div class="row">
      <label>보기 프리셋</label>
      <select id="viewPreset">
        <option value="recommend">모방 추천(기본)</option>
        <option value="speedeng">속도·반응</option>
        <option value="metrics">지표만</option>
        <option value="packaging">패키징</option>
        <option value="simple">간단</option>
        <option value="all">전체</option>
      </select>
      <label>정렬</label>
      <select id="sortKey"></select>
      <select id="sortDir"><option value="desc">내림차순</option><option value="asc">오름차순</option></select>
      <span class="pill" id="summaryPill">수집 0</span>
      <div class="row right" style="flex:1">
        <button id="expCsv" class="ghost">CSV</button>
        <button id="expXlsx" class="ghost">XLSX</button>
        <button id="expJson" class="ghost">JSON</button>
      </div>
    </div>
    <div class="row" style="margin-top:6px">
      <label>최소 반응률(%)</label><input id="fMinER" type="number" value="0" step="0.1" style="width:100px" />
      <label>최소 조회 배율</label><input id="fMinVX" type="number" value="0" step="0.1" style="width:100px" />
      <label>최소 임팩트 등급</label>
      <select id="fMinGrade"><option value="ALL">전체</option><option value="D">D</option><option value="C">C</option><option value="B">B</option><option value="A">A</option><option value="S">S</option></select>
      <button id="saveFilters" class="ghost">필터 저장</button>
      <button id="resetFilters" class="ghost">필터 초기화</button>
    </div>
  </div>

  <!-- 3) 테이블 -->
  <div class="card">
    <div class="row" id="colToggles" style="gap:10px;margin-bottom:6px"></div>
    <table id="table">
      <thead>
        <tr>
          <th class="c-bookmark">☆</th>
          <th class="c-thumb">썸네일</th>
          <th class="c-title">제목</th>
          <th class="c-channel">채널</th>
          <th class="c-uploadedAt">업로드일</th>
          <th class="c-length">길이</th>
          <th class="c-views">조회</th>
          <th class="c-likes">좋아요</th>
          <th class="c-comments">댓글</th>
          <th class="c-vel">속도(views/h)</th>
          <th class="c-er">반응률(%)</th>
          <th class="c-fresh">신선도</th>
          <th class="c-viewsX">조회 배율</th>
          <th class="c-velX">속도 배율</th>
          <th class="c-impact">임팩트 등급</th>
          <th class="c-pick">종합점수</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
(()=>{
// ====== 유틸 ======
const $=q=>document.querySelector(q);
const fmt=n=> (n===undefined||n===null) ? '-' : Number(n).toLocaleString('en-US');
const hms=sec=>{sec=+sec|0;const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60;return (h? h+':':'')+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')};
const isoToSec=d=>{const m=(d||'').match(/PT(?:(\\d+)H)?(?:(\\d+)M)?(?:(\\d+)S)?/);return m?(+(m[1]||0)*3600+ +(m[2]||0)*60+ +(m[3]||0)):0};
const hoursSince=iso=> (Date.now()-new Date(iso).getTime())/36e5;
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const escapeHtml=s=>(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

// ====== 상태 ======
let STATE={items:[], filtered:[], cols:null, sortKey:'pick', sortDir:'desc', filters:{minER:0,minVX:0,minGrade:'ALL'}};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load=(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}};

// ====== YouTube API ======
async function ytSearch({q, channelId, publishedAfter, regionCode, lang, maxResults, key, pageToken}){
  const params=new URLSearchParams({part:'snippet',type:'video',order:'date',maxResults:String(Math.min(50,maxResults||50)),publishedAfter,regionCode,relevanceLanguage:lang,key});
  if(q) params.set('q', q);
  if(channelId) params.set('channelId', channelId);
  if(pageToken) params.set('pageToken', pageToken);
  const url=`https://www.googleapis.com/youtube/v3/search?${params.toString()}`;
  const r=await fetch(url); if(!r.ok) throw new Error('search '+r.status); return r.json();
}
async function ytVideos(ids,key){
  const url=`https://www.googleapis.com/youtube/v3/videos?`+new URLSearchParams({part:'snippet,contentDetails,statistics',id:ids.join(','),key});
  const r=await fetch(url); if(!r.ok) throw new Error('videos '+r.status); return r.json();
}
function isShort(v){
  const sec=isoToSec(v.contentDetails?.duration||'PT0S');
  const tag=(v.snippet.title+' '+(v.snippet.description||'')).toLowerCase().includes('#shorts');
  return sec? (sec<=62) : tag;
}

// ====== 지표 계산 ======
function median(arr){ if(!arr.length) return 0; const a=[...arr].sort((x,y)=>x-y); const m=Math.floor(a.length/2); return a.length%2? a[m] : (a[m-1]+a[m])/2; }
function percentileRank(values, v){ if(values.length<=1) return 50; const a=[...values].sort((x,y)=>x-y); let idx=a.findIndex(x=>v<=x); if(idx===-1) idx=a.length-1; let rank=0; for(let i=0;i<a.length;i++){ if(v>=a[i]) rank=i; else break; } return clamp( (rank/(a.length-1))*100, 0, 100); }
function impactGrade(score){ if(score>=90) return 'S'; if(score>=80) return 'A'; if(score>=60) return 'B'; if(score>=40) return 'C'; return 'D'; }

function computeMetrics(videos){
  // 채널별 메디안
  const byCh={};
  videos.forEach(v=>{
    const cid=v.snippet.channelId;
    const h=hoursSince(v.snippet.publishedAt);
    const vel=(+v.statistics.viewCount||0)/Math.max(0.01,h);
    (byCh[cid]=byCh[cid]||{views:[],vel:[]}).views.push(+v.statistics.viewCount||0);
    byCh[cid].vel.push(vel);
  });
  const allVel=videos.map(v=>(+v.statistics.viewCount||0)/Math.max(0.01,hoursSince(v.snippet.publishedAt)));
  const allViews=videos.map(v=>+v.statistics.viewCount||0);
  const gMedV=median(allViews)||1, gMedVel=median(allVel)||1;

  // 1차 값 계산
  videos.forEach(v=>{
    const views=+v.statistics.viewCount||0;
    const likes=+v.statistics.likeCount||0;
    const comments=+v.statistics.commentCount||0;
    const hours=Math.max(0.01, hoursSince(v.snippet.publishedAt));
    const vel=views/hours;
    const er=(likes+comments)/Math.max(views,1)*100;
    const fresh=Math.exp(-hours/48);
    const ch=byCh[v.snippet.channelId]||{views:[],vel:[]};
    const medViews = ch.views.length>=3? median(ch.views) : gMedV;
    const medVel   = ch.vel.length>=3? median(ch.vel)   : gMedVel;
    const viewsX = views/Math.max(1,medViews);
    const velX   = vel/Math.max(0.01,medVel);
    Object.assign(v, {_calc:{hours,vel,er,fresh,viewsX,velX, baseline:(ch.views.length>=3?'channel':'global')}});
  });

  // 백분위 → 임팩트 점수/등급
  const arrVX=videos.map(v=>v._calc.viewsX);
  const arrER=videos.map(v=>v._calc.er);
  const arrFR=videos.map(v=>v._calc.fresh);
  videos.forEach(v=>{
    const p1=percentileRank(arrVX, v._calc.viewsX);
    const p2=percentileRank(arrER, v._calc.er);
    const p3=percentileRank(arrFR, v._calc.fresh);
    const impact=((p1+p2+p3)/3);
    v._impact={score:impact, grade:impactGrade(impact)};
  });
}

// 종합점수(기존 Pick 유사, 간단 버전)
function computePick(v){
  return Math.pow(v._calc.vel,0.5)*Math.pow(Math.max(v._calc.er,0),0.3)*Math.pow(v._calc.fresh,0.2);
}

// ====== 렌더 ======
const LABELS={
  bookmark:'☆', thumb:'썸네일', title:'제목', channel:'채널',
  uploadedAt:'업로드일', length:'길이', views:'조회', likes:'좋아요', comments:'댓글',
  vel:'속도(views/h)', er:'반응률(%)', fresh:'신선도',
  viewsX:'조회 배율', velX:'속도 배율', impact:'임팩트 등급', pick:'종합점수'
};
const DEFAULT_COLS={bookmark:true,thumb:true,title:true,channel:true,uploadedAt:true,length:true,views:true,likes:true,comments:true,vel:true,er:true,fresh:true,viewsX:true,velX:true,impact:true,pick:true};

function buildColToggles(){
  if(!STATE.cols) STATE.cols=load('sr_cols', DEFAULT_COLS);
  const box=$("#colToggles"); box.innerHTML='';
  Object.keys(DEFAULT_COLS).forEach(k=>{
    const id='col_'+k;
    const w=document.createElement('label'); w.style.display='flex'; w.style.alignItems='center'; w.style.gap='6px'; w.className='hint';
    w.innerHTML=`<input type="checkbox" id="${id}" ${STATE.cols[k]?'checked':''}/> ${LABELS[k]||k}`;
    box.appendChild(w);
    w.querySelector('input').addEventListener('change', ()=>{
      STATE.cols[k]=w.querySelector('input').checked; save('sr_cols', STATE.cols); applyColVis();
    });
  });
}
function applyColVis(){
  Object.keys(DEFAULT_COLS).forEach(k=>{
    document.querySelectorAll('.c-'+k).forEach(el=> el.style.display = STATE.cols[k] ? '' : 'none');
  });
}

function buildSortKeys(){
  const opts=[
    ['pick','종합점수'],['uploadedAt','업로드일'],['er','반응률(%)'],
    ['viewsX','조회 배율'],['velX','속도 배율'],['views','조회'],['vel','속도']
  ];
  const sk=$("#sortKey"); sk.innerHTML='';
  for(const [v,t] of opts){ const o=document.createElement('option'); o.value=v; o.textContent=t; sk.appendChild(o); }
  $("#sortKey").value = load('sr_sortKey', 'pick');
  $("#sortDir").value = load('sr_sortDir', 'desc');
  $("#sortKey").addEventListener('change', ()=>{ STATE.sortKey=$("#sortKey").value; save('sr_sortKey', STATE.sortKey); renderTable(); });
  $("#sortDir").addEventListener('change', ()=>{ STATE.sortDir=$("#sortDir").value; save('sr_sortDir', STATE.sortDir); renderTable(); });
}

function applyFilters(){
  const {minER,minVX,minGrade}=STATE.filters;
  STATE.filtered = STATE.items.filter(v=>{
    const okER = v._calc.er >= (minER||0);
    const okVX = v._calc.viewsX >= (minVX||0);
    const okG  = (minGrade==='ALL') || (rankGrade(v._impact.grade) >= rankGrade(minGrade));
    return okER && okVX && okG;
  });
}
function rankGrade(g){ return ({'D':1,'C':2,'B':3,'A':4,'S':5}[g]||0); }

function renderTable(){
  applyFilters();
  const arr=[...STATE.filtered];
  const key=STATE.sortKey||'pick'; const asc=(STATE.sortDir||'desc')==='asc';
  const valueOf=(v)=>{
    switch(key){
      case 'uploadedAt': return new Date(v.snippet.publishedAt).getTime();
      case 'er': return v._calc.er;
      case 'viewsX': return v._calc.viewsX;
      case 'velX': return v._calc.velX;
      case 'views': return +v.statistics.viewCount||0;
      case 'vel': return v._calc.vel;
      case 'pick': default: return v._pick;
    }
  };
  arr.sort((a,b)=> asc? (valueOf(a)-valueOf(b)) : (valueOf(b)-valueOf(a)));

  const tb=$("#tbody"); tb.innerHTML='';
  arr.forEach(v=>{
    const sec=isoToSec(v.contentDetails.duration);
    const upISO=v.snippet.publishedAt;
    const upLocal=new Date(upISO).toLocaleString('ko-KR');
    const g=v._impact.grade;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="c-bookmark"><span class="star" data-id="${v.id}">☆</span></td>
      <td class="c-thumb"><a href="https://www.youtube.com/watch?v=${v.id}" target="_blank"><img class="thumb" src="${v.snippet.thumbnails?.medium?.url||''}"/></a></td>
      <td class="c-title">${escapeHtml(v.snippet.title||'')}</td>
      <td class="c-channel">${escapeHtml(v.snippet.channelTitle||'')}</td>
      <td class="c-uploadedAt" title="${upISO}">${upLocal}</td>
      <td class="c-length">${hms(sec)}</td>
      <td class="c-views">${fmt(v.statistics.viewCount)}</td>
      <td class="c-likes">${fmt(v.statistics.likeCount)}</td>
      <td class="c-comments">${fmt(v.statistics.commentCount)}</td>
      <td class="c-vel" title="조회/시간">${(v._calc.vel).toFixed(1)}</td>
      <td class="c-er" title="좋아요+댓글 ÷ 조회 × 100">${(v._calc.er).toFixed(2)}</td>
      <td class="c-fresh" title="최근일수록 높음">${(v._calc.fresh).toFixed(2)}</td>
      <td class="c-viewsX" title="같은 채널 평균 대비">${(v._calc.viewsX).toFixed(2)}×</td>
      <td class="c-velX" title="같은 채널 평균 대비">${(v._calc.velX).toFixed(2)}×</td>
      <td class="c-impact"><span class="badge grade-${g}">${g}</span> <span class="muted">(${v._impact.score.toFixed(0)})</span></td>
      <td class="c-pick"><b>${(v._pick).toFixed(2)}</b></td>
    `;
    tb.appendChild(tr);
  });
  // 별(워치) 토글 더미
  tb.querySelectorAll('.star').forEach(el=> el.addEventListener('click', (ev)=>{
    ev.target.classList.toggle('on'); ev.target.textContent = ev.target.classList.contains('on')?'★':'☆';
  }));
  applyColVis();
  $("#summaryPill").textContent = `수집 ${STATE.items.length} · 표시 ${STATE.filtered.length}`;
}

function applyViewPreset(){
  const p=$("#viewPreset").value;
  const all=Object.keys(DEFAULT_COLS); const on={}; all.forEach(k=>on[k]=false);
  if(p==='recommend'){ ['thumb','title','channel','uploadedAt','views','likes','er','viewsX','velX','impact','pick'].forEach(k=>on[k]=true); on.bookmark=true; on.length=true; }
  else if(p==='speedeng'){ ['thumb','title','vel','er','pick'].forEach(k=>on[k]=true); }
  else if(p==='metrics'){ ['vel','er','fresh','viewsX','velX','impact','pick'].forEach(k=>on[k]=true); }
  else if(p==='packaging'){ ['thumb','title','uploadedAt','likes','comments','impact','pick'].forEach(k=>on[k]=true); }
  else if(p==='simple'){ ['thumb','title','pick'].forEach(k=>on[k]=true); }
  else if(p==='all'){ Object.keys(on).forEach(k=>on[k]=true); }
  STATE.cols=on; save('sr_cols', on); buildColToggles(); applyColVis();
}

// ====== Export ======
function exportRows(){
  // 현재 필터/정렬 결과 사용
  const rows=STATE.filtered.map(v=>{
    const sec=isoToSec(v.contentDetails.duration);
    return {
      '영상ID': v.id,
      'URL': `https://www.youtube.com/watch?v=${v.id}`,
      '제목': v.snippet.title||'',
      '채널': v.snippet.channelTitle||'',
      '채널ID': v.snippet.channelId||'',
      '업로드일ISO': v.snippet.publishedAt,
      '업로드일Local': new Date(v.snippet.publishedAt).toLocaleString('ko-KR'),
      '길이초': sec,
      '조회': +v.statistics.viewCount||0,
      '좋아요': +v.statistics.likeCount||0,
      '댓글': +v.statistics.commentCount||0,
      '속도viewsPerHour': v._calc.vel,
      '반응률': v._calc.er,
      '신선도': v._calc.fresh,
      '주제적합': v.metrics?.fit ?? 0,
      '24시간증가': 0, // (S6에서 스냅샷로 계산)
      '조회배율': v._calc.viewsX,
      '속도배율': v._calc.velX,
      '임팩트점수': v._impact.score,
      '임팩트등급': v._impact.grade,
      '패턴': '', // (패턴 분석은 추후)
      '묶음': '', // (클러스터는 추후)
      '종합점수': v._pick,
      '기준종류': v._calc.baseline
    };
  });
  return rows;
}
function downloadBlob(name, blob){
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); a.remove();
}
function ts(){ const d=new Date(); const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}_${z(d.getHours())}${z(d.getMinutes())}`; }
$("#expCsv").addEventListener('click', ()=>{
  const rows=exportRows(); if(!rows.length) return alert('내보낼 데이터가 없습니다.');
  const headers=Object.keys(rows[0]); const csv=[headers.join(',')];
  rows.forEach(r=> csv.push(headers.map(h=>{
    const v=r[h]; const s=(v===null||v===undefined)? '': String(v).replace(/"/g,'""'); return `"${s}"`;
  }).join(',')));
  const blob=new Blob([csv.join('\n')],{type:'text/csv;charset=utf-8;'});
  downloadBlob(`shorts_radar_export_${ts()}_KST.csv`, blob);
});
$("#expJson").addEventListener('click', ()=>{
  const rows=exportRows(); if(!rows.length) return alert('내보낼 데이터가 없습니다.');
  const meta={exportedAt:new Date().toISOString(), filters:STATE.filters, rows};
  const blob=new Blob([JSON.stringify(meta,null,2)],{type:'application/json'});
  downloadBlob(`shorts_radar_export_${ts()}_KST.json`, blob);
});
$("#expXlsx").addEventListener('click', ()=>{
  const rows=exportRows(); if(!rows.length) return alert('내보낼 데이터가 없습니다.');
  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Videos');
  const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});
  downloadBlob(`shorts_radar_export_${ts()}_KST.xlsx`, new Blob([wbout],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}));
});

// ====== 실행 ======
async function run(){
  try{
    const key=$("#apiKey").value.trim(); if(!key) return alert('API 키를 입력하세요.');
    const q=$("#keywords").value.trim();
    const channels=$("#channels").value.trim().split(',').map(s=>s.trim()).filter(Boolean);
    const days=+$("#days").value||7;
    const region=$("#region").value||'KR';
    const lang=$("#lang").value||'ko';
    const maxResults=+$("#maxResults").value||80;
    const publishedAfter=new Date(Date.now()-days*24*3600*1000).toISOString();

    const items=[];
    async function collect(q, ch){
      let pageToken=null, got=0;
      do{
        const data=await ytSearch({q, channelId:ch, publishedAfter, regionCode:region, lang, maxResults:Math.min(50, maxResults-got), key, pageToken});
        const vids=(data.items||[]).filter(it=>it.id?.videoId).map(it=>({id:it.id.videoId, snippet:it.snippet}));
        items.push(...vids);
        got+=vids.length; pageToken = (data.nextPageToken && got<maxResults)? data.nextPageToken : null;
      }while(pageToken);
    }
    if(channels.length){ for(const ch of channels) await collect(q||'', ch); } else { await collect(q||'', null); }

    // 상세 조회
    const ids=[...new Set(items.map(x=>x.id))];
    const videos=[];
    for(let i=0;i<ids.length;i+=50){
      const part=ids.slice(i,i+50);
      const data=await ytVideos(part, key);
      (data.items||[]).forEach(v=> videos.push(v));
    }
    const shorts=videos.filter(isShort);

    // 지표 계산
    computeMetrics(shorts);
    shorts.forEach(v=> v._pick=computePick(v));

    STATE.items=shorts; // 전체
    applyFilters();
    renderTable();
  }catch(e){ console.error(e); alert('오류: '+e.message); }
}

// ====== 초기 바인딩 ======
$("#runBtn").addEventListener('click', run);
$("#saveKey").addEventListener('click', ()=>{ save('yt_api_key',$("#apiKey").value.trim()); alert('저장되었습니다.'); });
$("#viewPreset").addEventListener('change', applyViewPreset);
$("#saveFilters").addEventListener('click', ()=>{ STATE.filters={minER:+$("#fMinER").value||0, minVX:+$("#fMinVX").value||0, minGrade:$("#fMinGrade").value||'ALL'}; save('sr_filters', STATE.filters); renderTable(); });
$("#resetFilters").addEventListener('click', ()=>{ STATE.filters={minER:0,minVX:0,minGrade:'ALL'}; $("#fMinER").value=0; $("#fMinVX").value=0; $("#fMinGrade").value='ALL'; save('sr_filters', STATE.filters); renderTable(); });

// 로드
(function init(){
  const k=load('yt_api_key',''); if(k) $("#apiKey").value=k;
  STATE.cols=load('sr_cols', null)||DEFAULT_COLS;
  STATE.sortKey=load('sr_sortKey','pick'); STATE.sortDir=load('sr_sortDir','desc'); STATE.filters=load('sr_filters',{minER:0,minVX:0,minGrade:'ALL'});
  $("#fMinER").value=STATE.filters.minER; $("#fMinVX").value=STATE.filters.minVX; $("#fMinGrade").value=STATE.filters.minGrade;
  buildColToggles(); applyColVis(); buildSortKeys(); applyViewPreset();
})();
})();
</script>
</body>
</html>
