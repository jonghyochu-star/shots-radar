<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shorts Radar Pro â€” íŒ¨í‚¤ì§•Â·ëª¨ë©˜í…€Â·ìš´ì˜ ì‹ í˜¸ê¹Œì§€</title>
  <link rel="icon" href="data:,">
  <style>
    :root { --bg:#0b1116; --card:#101922; --muted:#7a8a9a; --text:#e8f0f7; --accent:#62d26f; --accent2:#6aa7ff; --warn:#ffb84d; }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Pretendard,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px 80px}
    h1{font-weight:800;letter-spacing:-.5px;font-size:26px;margin:0 0 14px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:18px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .card{background:linear-gradient(180deg,#0f1821,#0a1118);border:1px solid #1e2a36;border-radius:14px;padding:14px 14px 16px;box-shadow:0 8px 22px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea,button{border-radius:10px;border:1px solid #2a3a4a;background:#0c141c;color:var(--text);padding:10px 12px;font-size:14px}
    input::placeholder,textarea::placeholder{color:#6b7b8b}
    button{cursor:pointer;background:#152332;border:1px solid #274156}
    button.primary{background:linear-gradient(180deg,#2a6fff,#2461e6);border:0}
    button.ghost{background:transparent;border:1px dashed #2d3b49}
    button.danger{background:#4b1c16;border:1px solid #6b2c24}
    .hint{color:var(--muted);font-size:12px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .pill{background:#0f1620;border:1px solid #1f2a36;border-radius:999px;padding:8px 12px;font-size:12px;color:#b9c7d6}
    .tag{display:inline-block;background:#0e1620;border:1px solid #213142;border-radius:999px;padding:4px 8px;margin:2px;color:#a8b9cc;font-size:12px}
    .muted{color:#9fb0bf}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #1e2a36;text-align:left;font-size:13px}
    .table th{color:#a5b6c6;font-weight:600}
    .badge{padding:4px 8px;border-radius:999px;background:#0e1b29;border:1px solid #23374a;font-size:11px}
    .good{color:#b9ffd0}
    .warn{color:var(--warn)}
    .cluster{display:flex;gap:12px;align-items:flex-start}
    .thumb{width:120px;height:68px;background:#111;border:1px solid #253444;border-radius:10px;object-fit:cover}
    .footer{position:fixed;left:0;right:0;bottom:0;background:rgba(9,14,20,.9);border-top:1px solid #1e2a36;padding:10px 16px;display:flex;gap:8px;align-items:center;justify-content:center}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .small{font-size:12px}
    .hero{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    @media (max-width:1000px){.grid.cols-3{grid-template-columns:1fr}.grid.cols-2{grid-template-columns:1fr}.thumb{width:96px;height:54px}}
    .hm{font-size:11px}
    .hm .row{display:flex;align-items:center;gap:4px;margin:2px 0}
    .hm .label{width:18px;color:#8fa4b8;text-align:right;margin-right:6px}
    .hm .cell{width:18px;height:18px;border-radius:4px;border:1px solid #213142;background:#0e1620}
    .hm .legend{display:flex;align-items:center;gap:6px;margin-top:6px}
    .hm .legend .box{width:18px;height:18px;border-radius:4px;border:1px solid #213142}
    .qbar{position:relative;height:8px;width:160px;border:1px solid #213142;border-radius:999px;background:#0e1620}
    .qbar .fill{height:100%;border-radius:999px;background:linear-gradient(90deg,#2a6fff,#62d26f)}
    .star{cursor:pointer;font-size:18px;user-select:none}
    .star.on{color:#ffd166}
    .channel-card{display:flex;justify-content:space-between;align-items:center;border:1px solid #223243;border-radius:12px;padding:10px 12px;background:#0e1620}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div>
        <h1>Shorts Radar <span class="muted">Pro</span> <span class="muted">â€” íŒ¨í‚¤ì§•Â·ëª¨ë©˜í…€Â·ìš´ì˜ ì‹ í˜¸ê¹Œì§€</span></h1>
        <div class="sub">ì¸ë„¤ì¼OCR/ì œëª©íŒ¨í„´/ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ ìŠ¤ëƒ…ìƒ·/ì±„ë„ ìš´ì˜ì¹´ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (kor+eng OCR í¬í•¨)</div>
      </div>
      <div class="row">
        <button id="exportCsv" class="ghost">CSV ë‚´ë³´ë‚´ê¸°</button>
        <button id="exportManual" class="ghost">ì‚¬ìš©ë²• ë‚´ë³´ë‚´ê¸°(MD)</button>
        <button id="btnOcr" class="ghost">ì¸ë„¤ì¼ OCR(í•œÂ·ì˜)</button>
        <button id="btnReprobe" class="ghost">ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ ì¬ì¸¡ì •</button>
        <button id="resetBtn" class="danger">ì´ˆê¸°í™”</button>
      </div>
    </div>

    <div class="grid cols-2">
      <div class="card">
        <h3 style="margin:0 0 8px">1) ì—°ê²° ì„¤ì •</h3>
        <div class="row" style="gap:8px">
          <input id="apiKey" placeholder="YouTube Data API í‚¤ ë¶™ì—¬ë„£ê¸°" style="min-width:300px" aria-label="YouTube API Key" autocomplete="off"/>
          <button id="saveKey" class="primary">í‚¤ ì €ì¥</button>
          <span class="hint">* GCP ì½˜ì†”ì—ì„œ HTTP referrer(ë³¸ì¸ GitHub Pages ë„ë©”ì¸) ì œí•œì„ ê¼­ ì„¤ì •.</span>
        </div>
        <div class="row" style="gap:8px;margin-top:10px">
          <label>ì¼ì¼ í•œë„(ìœ ë‹›)</label>
          <input id="quotaLimit" type="number" min="1000" step="100" value="10000" style="width:120px" aria-label="ì¼ì¼ í•œë„" autocomplete="off"/>
          <button id="quotaApply" class="ghost">ì ìš©</button>
          <span id="quotaStat" class="pill">API ì‚¬ìš©ëŸ‰(ì˜¤ëŠ˜) 0 / 10000 (0%)</span>
          <div id="quotaBar" class="qbar"><div class="fill" style="width:0%"></div></div>
          <button id="quotaReset" class="ghost">ì‚¬ìš©ëŸ‰ ì´ˆê¸°í™”</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">2) ì°¾ì„ ì¡°ê±´</h3>
        <div class="row" style="gap:8px">
          <input id="keywords" placeholder="ì°¾ì„ ì£¼ì œ(ì˜ˆ: ì •ì¹˜í’ì, ê³ ì–‘ì´ ëª¨ë˜ë§¤íŠ¸)" style="flex:1" aria-label="í‚¤ì›Œë“œ" autocomplete="off"/>
          <input id="channels" placeholder="ê²½ìŸ ì±„ë„ IDë“¤(ì‰¼í‘œë¡œ êµ¬ë¶„ Â· ì„ íƒ)" style="flex:1" aria-label="ì±„ë„ ID ëª©ë¡" autocomplete="off"/>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <select id="presetSelect" style="min-width:220px"></select>
          <button id="presetLoad" class="ghost">ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="presetSave" class="ghost">í˜„ì¬ ì…ë ¥ ì €ì¥</button>
          <button id="presetDel" class="danger">ì‚­ì œ</button>
          <span class="hint">* ë‚´ ë¸Œë¼ìš°ì €(ë¡œì»¬)ì— ì €ì¥ë©ë‹ˆë‹¤.</span>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <select id="days">
            <option value="3">ìµœê·¼ 3ì¼</option>
            <option value="7" selected>ìµœê·¼ 7ì¼</option>
            <option value="14">ìµœê·¼ 14ì¼</option>
          </select>
          <select id="region" title="ì§€ì—­ íŒíŠ¸(ë­í‚¹ ê°€ì¤‘ì¹˜)">
            <option value="KR" selected>KR</option>
            <option value="US">US</option>
            <option value="JP">JP</option>
            <option value="GB">GB</option>
          </select>
          <select id="lang" title="ì–¸ì–´ íŒíŠ¸(ë­í‚¹ ê°€ì¤‘ì¹˜)">
            <option value="ko" selected>ko</option>
            <option value="en">en</option>
            <option value="ja">ja</option>
          </select>
          <input id="maxResults" type="number" min="10" max="200" value="80" style="width:120px" aria-label="ê²°ê³¼ ê°œìˆ˜" autocomplete="off"/>
          <button id="runBtn" class="primary">ì°¾ê¸° ì‹œì‘</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">ìš”ì•½</h3>
      <div id="summary" class="kpi"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">ë¹„ìŠ·í•œ ì£¼ì œ ë¬¶ìŒ</h3>
        <div class="row">
          <label>ìµœì†Œ ì¢…í•©ì ìˆ˜</label>
          <input id="minRank" type="number" value="0" step="0.01" style="width:100px" aria-label="ìµœì†Œ ì¢…í•©ì ìˆ˜" autocomplete="off"/>
          <label>ë¬¶ìŒ ê°œìˆ˜(k)</label>
          <input id="kValue" type="number" min="1" max="20" value="0" style="width:80px" title="0ì´ë©´ ìë™(âˆšN)" aria-label="ë¬¶ìŒ ê°œìˆ˜" autocomplete="off"/>
          <button id="recluster" class="ghost">ë‹¤ì‹œ ë¬¶ê¸°</button>
        </div>
      </div>
      <div id="clusters" class="grid cols-2" style="margin-top:8px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">ì˜¬ë¦¬ê¸° ì¢‹ì€ ì‹œê°„ëŒ€ (ì‹œê°„ëŒ€ ì§€ë„)</h3>
        <span class="hint">ë¡œì»¬ ì‹œê°„ ê¸°ì¤€ Â· PickRank ê°€ì¤‘ì¹˜</span>
      </div>
      <div class="grid cols-2" style="margin-top:8px">
        <div id="heatmap" class="hm"></div>
        <div>
          <b>ì¶”ì²œ Top ì‹œê°„ëŒ€</b>
          <ol id="bestTimes" style="margin-top:6px"></ol>
          <div class="hint" style="margin-top:8px">* ë°ì´í„°ê°€ ì ìœ¼ë©´ ê¸°ê°„ì„ 14ì¼ë¡œ ë„“í˜€ ë³´ì„¸ìš”.</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">ê²½ìŸ ì±„ë„ ìš´ì˜ ì¹´ë“œ</h3>
        <span class="hint">ìµœê·¼ ê²°ê³¼ì— ë“±ì¥í•œ ì±„ë„ ê¸°ì¤€(ê²Œì‹œ ì£¼ê¸°/ì‹œê°„ëŒ€)</span>
      </div>
      <div id="chanBoard" class="grid cols-2" style="margin-top:8px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">ì˜ìƒ ë¦¬ìŠ¤íŠ¸</h3>
      <div id="colControls" class="row" style="gap:8px; margin:6px 0 8px; align-items:center; flex-wrap:wrap"></div>
      <table class="table" id="table">
        <thead>
          <tr>
            <th>â˜†</th>
            <th>ì¸ë„¤ì¼</th>
            <th>ì œëª©</th>
            <th>íŒ¨í„´</th>
            <th>ì±„ë„</th>
            <th>ê¸¸ì´</th>
            <th>ì¡°íšŒ</th>
            <th>ì¢‹ì•„ìš”</th>
            <th>ëŒ“ê¸€</th>
            <th>ì†ë„</th>
            <th>ë°˜ì‘</th>
            <th>ì‹ ì„ ë„</th>
            <th>ì£¼ì œì í•©</th>
            <th>Î”24h</th>
            <th>ì¢…í•©ì ìˆ˜</th>
            <th>ë¬¶ìŒ</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">ë¹„ìŠ·í•˜ê²Œ ë§Œë“¤ê¸° ë„ìš°ë¯¸</h3>
        <div class="row"><label>ë¬¶ìŒ ë²ˆí˜¸</label><input id="wizCluster" type="number" value="0" style="width:80px" aria-label="ë¬¶ìŒ ë²ˆí˜¸" autocomplete="off"/><button id="runWizard" class="ghost">ìƒì„±</button></div>
      </div>
      <div id="wizardOut" class="grid cols-2" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="footer small">
    <span>Tip: <b>ì¢…í•©ì ìˆ˜</b>ê°€ ë†’ì€ ìˆœìœ¼ë¡œ ì˜¤ëŠ˜ ë°”ë¡œ ë”°ë¼ ë§Œë“¤ ì£¼ì œë¥¼ ê³ ë¥´ì„¸ìš”. â€” <span class="muted">ì†ë„(ì¡°íšŒ/ì‹œê°„)Â·ë°˜ì‘(ì¢‹ì•„ìš”/ëŒ“ê¸€)Â·ì‹ ì„ ë„Â·ì£¼ì œì í•©</span>ì„ í•©ì³ ê³„ì‚°í•©ë‹ˆë‹¤.</span>
  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const now = () => new Date();
  const hoursSince = iso => (now() - new Date(iso)) / 36e5;
  const fmt = n => n ? Number(n).toLocaleString("en-US") : "0";
  const toISO = d => new Date(d).toISOString();

  function escapeHtml(s){
    return String(s || "").replace(/[&<>\"']/g, function(c){
      return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c];
    });
  }

  function tokenize(text){
    const t = String(text || "")
      .toLowerCase()
      .replace(/[\\p{P}\\p{S}]/gu, " ")
      .split(/\\s+/)
      .filter(function(w){ return w && w.length > 1; });
    return t;
  }
  function uniq(arr){ return Array.from(new Set(arr)); }
  function cosine(a,b){
    var dot=0,na=0,nb=0, k, keys=new Set(Object.keys(a).concat(Object.keys(b)));
    keys.forEach(function(k){ var va=a[k]||0, vb=b[k]||0; dot+=va*vb; na+=va*va; nb+=vb*vb; });
    return dot/(Math.sqrt(na)*Math.sqrt(nb)||1);
  }
  function tf(tokens){ var m={}; tokens.forEach(function(w){ m[w]=(m[w]||0)+1; }); var n=tokens.length||1; Object.keys(m).forEach(function(k){ m[k]/=n; }); return m; }
  function idf(docs){ var df={}, N=docs.length||1; docs.forEach(function(doc){ Object.keys(doc).forEach(function(k){ df[k]=(df[k]||0)+1; }); }); var m={}; Object.keys(df).forEach(function(k){ m[k]=Math.log(1+N/df[k])+1; }); return m; }
  function tfidf(tfMap,idfMap){ var v={}, k; for(k in tfMap){ v[k]=tfMap[k]*(idfMap[k]||1); } return v; }
  function topKeywords(vec, n){ return Object.keys(vec).sort(function(a,b){ return (vec[b]-vec[a]); }).slice(0,n||6); }
  function expDecay(hours){ return Math.exp(-hours/48); }
  function hoursToHMS(sec){ var h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=Math.floor(sec%60); return (h? h+":" : "")+String(m).padStart(2,"0")+":"+String(s).padStart(2,"0"); }
  function isoToSeconds(dur){ var m=(dur||"").match(/PT(?:(\\d+)H)?(?:(\\d+)M)?(?:(\\d+)S)?/); return m? (Number(m[1]||0)*3600 + Number(m[2]||0)*60 + Number(m[3]||0)) : 0; }

  var STATE = { videos:[], clusters:[], idf:null, vectors:[], topicVec:{}, labels:[], colVis:null, sortKey:null, sortDir:null, watch:new Set(), snapshots:{}, ocr:{} };

  function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
  function load(key,def){ try{ var v=localStorage.getItem(key); return v? JSON.parse(v) : def; }catch(e){ return def; }}
  var QUOTA_KEY="sr_quota";

  function analyzeTitle(title){
    title = String(title||"");
    var emoji = (title.match(/[\\p{Extended_Pictographic}]/gu) || []).length;
    var hasNum = /\\d/.test(title);
    var isQ = /[?ï¼Ÿ]|\\b(ì™œ|ë¬´ì—‡|ì–´ë–»ê²Œ|ëˆ„ê°€|ì–¸ì œ|ê°€ëŠ¥|ì¸ê°€)\\b/.test(title);
    var hasBracket = /[\\[\\(ï¼ˆã€]/.test(title);
    var series = /(part\\s*\\d+|ep\\s*\\d+|ì‹œì¦Œ\\s*\\d+|íŒŒíŠ¸\\s*\\d+)/i.test(title);
    return {emoji:emoji, hasNum:hasNum, isQ:isQ, hasBracket:hasBracket, series:series};
  }
  function patternIcon(p){
    var icons=[];
    if(p.hasNum) icons.push("ğŸ”¢");
    if(p.isQ) icons.push("â“");
    if(p.hasBracket) icons.push("ğŸ§©");
    if(p.series) icons.push("ğŸ“š");
    if(p.emoji>0) icons.push("ğŸ˜ŠÃ—"+p.emoji);
    return icons.join(" ");
  }

  function todayStr(){ var d=new Date(); return d.toISOString().slice(0,10); }
  function getQuota(){ var q=load(QUOTA_KEY,null), today=todayStr(); if(!q) q={date:today, used:0, limit:10000}; if(q.date!==today){ q.date=today; q.used=0; } return q; }
  function saveQuota(q){ save(QUOTA_KEY,q); }
  function setQuotaLimit(n){ var q=getQuota(); q.limit=Math.max(1000, Number(n)||10000); saveQuota(q); renderQuota(); }
  function incQuota(units){ var q=getQuota(); q.used += Math.max(0, units|0); saveQuota(q); renderQuota(); }
  function resetQuota(){ var q={date:todayStr(), used:0, limit:getQuota().limit}; saveQuota(q); renderQuota(); }
  function renderQuota(){
    var q=getQuota();
    var pct=Math.min(100, Math.round((q.used/(q.limit||1))*100));
    var stat=document.getElementById("quotaStat"); if(stat) stat.innerHTML="API ì‚¬ìš©ëŸ‰(ì˜¤ëŠ˜) <b>"+q.used+"</b> / "+q.limit+" ("+pct+"%)";
    var lim=document.getElementById("quotaLimit"); if(lim) lim.value=q.limit;
    var bar=document.querySelector("#quotaBar .fill"); if(bar) bar.style.width=pct+"%";
  }

  async function loadTesseract(){
    if(window.Tesseract) return;
    await new Promise(function(res){
      var s=document.createElement("script");
      s.src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js";
      s.onload=function(){ res(); };
      s.onerror=function(){ res(); };
      document.head.appendChild(s);
    });
  }

  async function ocrTopN(n){
    await loadTesseract();
    if(!window.Tesseract){ alert("Tesseract ë¡œë“œ ì‹¤íŒ¨"); return; }
    var list=[].concat(STATE.videos).sort(function(a,b){ return (b.metrics.pick - a.metrics.pick); }).slice(0, n||20);
    for(var i=0;i<list.length;i++){
      var v=list[i]; if(STATE.ocr[v.id]) continue;
      try{
        var url=(v.snippet.thumbnails && v.snippet.thumbnails.medium && v.snippet.thumbnails.medium.url) || "";
        if(!url) continue;
        var res = await Tesseract.recognize(url, "kor+eng", { langPath: "https://tessdata.projectnaptha.com/4.0.0" });
        var text = (res && res.data && res.data.text) ? String(res.data.text).replace(/\\s+/g," ").trim() : "";
        var toks = tokenize(text).slice(0,8);
        STATE.ocr[v.id] = { len: text.length, keys: toks };
      }catch(e){ STATE.ocr[v.id] = { len:0, keys:[] }; }
    }
    renderTable(STATE.videos);
  }

  async function ytSearch(opts){
    var q=opts.q||"", channelId=opts.channelId, publishedAfter=opts.publishedAfter, regionCode=opts.regionCode, maxResults=opts.maxResults, key=opts.key, pageToken=opts.pageToken;
    var params = new URLSearchParams({
      part:"snippet", q:q, maxResults:String(Math.min(50, maxResults||50)), type:"video",
      order:"date", publishedAfter:publishedAfter, regionCode:regionCode, relevanceLanguage:(document.getElementById("lang")?document.getElementById("lang").value:"ko"),
      key:key
    });
    if(channelId) params.set("channelId", channelId);
    if(pageToken) params.set("pageToken", pageToken);
    var url = "https://www.googleapis.com/youtube/v3/search?"+params.toString();
    var res = await fetch(url);
    if(!res.ok) throw new Error("search "+res.status);
    incQuota(100);
    return res.json();
  }
  async function ytVideos(ids,key){
    var params = new URLSearchParams({ part:"snippet,contentDetails,statistics", id: ids.join(","), key:key });
    var url = "https://www.googleapis.com/youtube/v3/videos?"+params.toString();
    var res = await fetch(url);
    if(!res.ok) throw new Error("videos "+res.status);
    incQuota(1);
    return res.json();
  }
  function isShort(snippet, contentDetails){
    var m = (contentDetails && contentDetails.duration || "").match(/PT(?:(\\d+)M)?(?:(\\d+)S)?/);
    var sec = m? (Number(m[1]||0)*60 + Number(m[2]||0)) : 0;
    var hastag = String((snippet && snippet.title || "")+" "+(snippet && snippet.description || "")).toLowerCase().indexOf("#shorts") >= 0;
    return sec>0 ? (sec<=62) : hastag;
  }
  function buildTopicVec(input){ return tf(tokenize(input)); }
  function calcMetrics(v, topicVec){
    var hours = hoursSince(v.snippet.publishedAt);
    var views = Number(v.statistics.viewCount||0);
    var likes = Number(v.statistics.likeCount||0);
    var comments = Number(v.statistics.commentCount||0);
    var vel = views / Math.max(1, hours);
    var eng = (likes + 5*comments) / Math.max(1, views) * 1000;
    var fresh = expDecay(hours);
    var text = String(v.snippet.title||"") + " " + String(v.snippet.description||"") + " " + (Array.isArray(v.snippet.tags)?v.snippet.tags.join(" "):"");
    var tfMap = tf(tokenize(text));
    var fit = cosine(tfidf(tfMap, STATE.idf||{}), topicVec || {});
    var pick = Math.pow(vel,0.5) * Math.pow(Math.max(eng,0),0.3) * Math.pow(fresh,0.2) * Math.max(fit,0.0001);
    return {vel:vel,eng:eng,fresh:fresh,fit:fit,pick:pick, tfMap:tfMap};
  }

  function loadWatch(){ STATE.watch = new Set(load("sr_watchlist", [])); STATE.snapshots = load("sr_snapshots", {} ) || {}; }
  function saveWatch(){ save("sr_watchlist", Array.from(STATE.watch)); save("sr_snapshots", STATE.snapshots); }
  function toggleWatch(id){ if(STATE.watch.has(id)) STATE.watch.delete(id); else STATE.watch.add(id); saveWatch(); renderTable(STATE.videos); }
  function pushSnapshot(id, v){ var s=STATE.snapshots[id] || (STATE.snapshots[id]=[]); s.push({t:toISO(new Date()), views:Number(v.statistics.viewCount||0), likes:Number(v.statistics.likeCount||0), comments:Number(v.statistics.commentCount||0)}); STATE.snapshots[id]=s.slice(-50); saveWatch(); }
  function delta24h(id){ var s=STATE.snapshots[id]||[]; if(s.length<2) return {views:0,likes:0,comments:0}; var nowt = new Date(); var from = new Date(nowt - 24*3600*1000); var recent = s.filter(function(x){ return new Date(x.t)>=from; }); if(recent.length<2) return {views:0,likes:0,comments:0}; var first=recent[0], last=recent[recent.length-1]; return {views:last.views-first.views, likes:last.likes-first.likes, comments:last.comments-first.comments}; }

  async function reprobeWatchlist(){
    var ids = Array.from(STATE.watch); if(ids.length===0) return alert("ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
    var key = document.getElementById("apiKey").value.trim(); if(!key) return alert("API í‚¤ í•„ìš”");
    for(var i=0;i<ids.length;i+=50){
      var data = await ytVideos(ids.slice(i,i+50), key);
      (data.items||[]).forEach(function(v){ pushSnapshot(v.id, v); });
    }
    alert("ì¬ì¸¡ì • ì™„ë£Œ"); renderTable(STATE.videos);
  }

  function setSummary(videos){
    var n = videos.length;
    var shorts = videos.filter(function(v){ return v._isShort; }).length;
    var top = [].concat(videos).sort(function(a,b){ return (b.metrics.pick - a.metrics.pick); }).slice(0,5);
    function avg(arr,fn){ var s=0; for(var i=0;i<arr.length;i++) s+=fn(arr[i]); return arr.length? s/arr.length : 0; }
    var pills = [
      '<span class="pill">ì´ ìˆ˜ì§‘ <b>'+n+'</b> (ì‡¼ì¸  '+shorts+')</span>',
      '<span class="pill">í‰ê·  ì†ë„ <b>'+avg(videos,function(x){return x.metrics.vel;}).toFixed(1)+'</b></span>',
      '<span class="pill">í‰ê·  ë°˜ì‘ <b>'+avg(videos,function(x){return x.metrics.eng;}).toFixed(2)+'</b></span>',
      '<span class="pill">ì¢…í•© 1ìœ„: <b>'+escapeHtml((top[0]&&top[0].snippet&&top[0].snippet.title||"-").slice(0,36))+'</b></span>'
    ];
    document.getElementById("summary").innerHTML = pills.join(" ");
  }

  function ensureHeaderClasses(){ var ths=document.querySelectorAll("#table thead th"); var classes=["bookmark","thumb","title","pattern","channel","length","views","likes","comments","vel","eng","fresh","fit","delta","pick","cluster"]; classes.forEach(function(k,i){ if(ths[i]) ths[i].classList.add("c-"+k); }); }
  function defaultColVis(){ var m={bookmark:true,thumb:true,title:true,pattern:true,channel:true,length:true,views:true,likes:true,comments:true,vel:true,eng:true,fresh:true,fit:true,delta:true,pick:true,cluster:true}; return m; }
  function applyColumnVisibility(){ var vis = STATE.colVis || load("sr_cols", null) || defaultColVis(); Object.keys(vis).forEach(function(k){ document.querySelectorAll(".c-"+k).forEach(function(el){ el.style.display = vis[k] ? "" : "none"; }); }); }
  function getSortValue(v,key){
    if(key==="views") return Number(v.statistics.viewCount||0);
    if(key==="likes") return Number(v.statistics.likeCount||0);
    if(key==="comments") return Number(v.statistics.commentCount||0);
    if(key==="vel") return Number(v.metrics && v.metrics.vel || 0);
    if(key==="eng") return Number(v.metrics && v.metrics.eng || 0);
    if(key==="fresh") return Number(v.metrics && v.metrics.fresh || 0);
    if(key==="fit") return Number(v.metrics && v.metrics.fit || 0);
    if(key==="length") return isoToSeconds(v.contentDetails && v.contentDetails.duration || "PT0S");
    if(key==="delta"){ var d=delta24h(v.id); return Number(d.views||0); }
    return Number(v.metrics && v.metrics.pick || 0);
  }
  function buildColControls(){
    if(!STATE.colVis) STATE.colVis = load("sr_cols", null) || defaultColVis();
    if(!STATE.sortKey) STATE.sortKey = load("sr_sortKey", null) || "pick";
    if(!STATE.sortDir) STATE.sortDir = load("sr_sortDir", null) || "desc";
    var holder = document.getElementById("colControls"); if(!holder) return;
    var labelMap = {pick:"ì¢…í•©", vel:"ì†ë„", eng:"ë°˜ì‘", fresh:"ì‹ ì„ ë„", fit:"ì í•©", views:"ì¡°íšŒ", likes:"ì¢‹ì•„ìš”", comments:"ëŒ“ê¸€", length:"ê¸¸ì´", delta:"Î”24h"};
    holder.innerHTML = [
      '<label>ë³´ê¸° í”„ë¦¬ì…‹</label>',
      '<select id="viewPreset">',
      '<option value="all">ì „ì²´(ê¸°ë³¸)</option>',
      '<option value="speedeng">ì†ë„Â·ë°˜ì‘ë§Œ</option>',
      '<option value="metrics">ì§€í‘œë§Œ</option>',
      '<option value="packaging">íŒ¨í‚¤ì§•(ì¸ë„¤ì¼/íŒ¨í„´/Î”)</option>',
      '<option value="simple">ê°„ë‹¨</option>',
      '</select>',
      '<label>ì •ë ¬</label>',
      '<select id="sortKey"></select>',
      '<select id="sortDir"><option value="desc">ë‚´ë¦¼ì°¨ìˆœ</option><option value="asc">ì˜¤ë¦„ì°¨ìˆœ</option></select>',
      '<div id="colToggles" class="row" style="gap:6px"></div>'
    ].join("");
    var sortKeys=["pick","delta","vel","eng","fresh","fit","views","likes","comments","length"];
    var sk = document.getElementById("sortKey");
    sortKeys.forEach(function(k){ var o=document.createElement("option"); o.value=k; o.textContent=labelMap[k]||k; sk.appendChild(o); });
    sk.value = STATE.sortKey; document.getElementById("sortDir").value = STATE.sortDir;
    var box=document.getElementById("colToggles"); box.innerHTML="";
    var keys = Object.keys(defaultColVis());
    keys.forEach(function(k){
      var id="vis_"+k;
      var lbl=document.createElement("label");
      lbl.className="small"; lbl.style.display="flex"; lbl.style.alignItems="center"; lbl.style.gap="6px";
      lbl.innerHTML='<input type="checkbox" id="'+id+'" '+(STATE.colVis[k]?'checked':'')+'/> '+k;
      box.appendChild(lbl);
      document.getElementById(id).addEventListener("change",function(){ STATE.colVis[k]=document.getElementById(id).checked; save("sr_cols", STATE.colVis); applyColumnVisibility(); });
    });
    document.getElementById("viewPreset").addEventListener("change",function(){
      var p=document.getElementById("viewPreset").value; var vis=defaultColVis(); keys.forEach(function(k){ vis[k]=true; });
      if(p==="speedeng"){ keys.forEach(function(k){ vis[k]=false; }); ["thumb","title","vel","eng","pick"].forEach(function(k){ vis[k]=true; }); }
      else if(p==="metrics"){ keys.forEach(function(k){ vis[k]=false; }); ["vel","eng","fresh","fit","pick"].forEach(function(k){ vis[k]=true; }); }
      else if(p==="packaging"){ keys.forEach(function(k){ vis[k]=false; }); ["thumb","title","pattern","delta","pick","bookmark"].forEach(function(k){ vis[k]=true; }); }
      else if(p==="simple"){ keys.forEach(function(k){ vis[k]=false; }); ["thumb","title","pick"].forEach(function(k){ vis[k]=true; }); }
      STATE.colVis=vis; save("sr_cols", vis); keys.forEach(function(k){ var chk=document.getElementById("vis_"+k); if(chk) chk.checked=!!vis[k]; }); applyColumnVisibility();
    });
    sk.addEventListener("change",function(){ STATE.sortKey=sk.value; save("sr_sortKey", STATE.sortKey); renderTable(STATE.videos); applyColumnVisibility(); });
    document.getElementById("sortDir").addEventListener("change",function(){ STATE.sortDir=document.getElementById("sortDir").value; save("sr_sortDir", STATE.sortDir); renderTable(STATE.videos); applyColumnVisibility(); });
  }

  function renderTable(videos){
    var tb = document.getElementById("tbody"); tb.innerHTML="";
    var key = STATE.sortKey || "pick";
    var asc = (STATE.sortDir || "desc")==="asc";
    videos.sort(function(a,b){ var av=getSortValue(a,key), bv=getSortValue(b,key); return asc? (av-bv):(bv-av); });
    for(var i=0;i<videos.length;i++){
      var v=videos[i];
      var sec = isoToSeconds(v.contentDetails.duration);
      var pat = patternIcon(v._pattern||{});
      var d24 = delta24h(v.id);
      var ocr = STATE.ocr[v.id];
      var star = STATE.watch.has(v.id) ? "â˜…" : "â˜†";
      var ocrTip = ocr ? ("OC:"+ocr.len+" "+ocr.keys.slice(0,3).join("/")) : "";
      var tr = document.createElement("tr");
      tr.innerHTML = [
        '<td class="c-bookmark"><span class="star '+(STATE.watch.has(v.id)?'on':'')+'" data-id="'+v.id+'">'+star+'</span></td>',
        '<td class="c-thumb"><a href="https://www.youtube.com/watch?v='+v.id+'" target="_blank"><img class="thumb" src="'+(v.snippet.thumbnails&&v.snippet.thumbnails.medium&&v.snippet.thumbnails.medium.url||'')+'" title="'+escapeHtml(ocrTip)+'"/></a></td>',
        '<td class="c-title">'+escapeHtml(v.snippet.title||"")+'</td>',
        '<td class="c-pattern small">'+escapeHtml(pat)+'</td>',
        '<td class="c-channel small">'+escapeHtml(v.snippet.channelTitle||"")+'</td>',
        '<td class="c-length">'+hoursToHMS(sec)+'</td>',
        '<td class="c-views">'+fmt(v.statistics.viewCount)+'</td>',
        '<td class="c-likes">'+fmt(v.statistics.likeCount)+'</td>',
        '<td class="c-comments">'+fmt(v.statistics.commentCount)+'</td>',
        '<td class="c-vel">'+v.metrics.vel.toFixed(1)+'</td>',
        '<td class="c-eng">'+v.metrics.eng.toFixed(2)+'</td>',
        '<td class="c-fresh">'+v.metrics.fresh.toFixed(2)+'</td>',
        '<td class="c-fit">'+v.metrics.fit.toFixed(2)+'</td>',
        '<td class="c-delta"><span class="'+((d24.views||0)>0?'good':'')+'">+'+fmt(d24.views||0)+'</span></td>',
        '<td class="c-pick"><b class="good">'+v.metrics.pick.toFixed(2)+'</b></td>',
        '<td class="c-cluster"><span class="badge">'+(v.clusterId!=null?v.clusterId:"-")+'</span></td>'
      ].join("");
      tb.appendChild(tr);
    }
    tb.querySelectorAll(".star").forEach(function(s){ s.addEventListener("click", function(ev){ var id=ev.target.getAttribute("data-id"); toggleWatch(id); }); });
  }

  function avgRank(arr){ var s=0; for(var i=0;i<arr.length;i++) s+=(arr[i].metrics && arr[i].metrics.pick || 0); return arr.length? s/arr.length : 0; }
  function renderClusters(state){
    var el = document.getElementById("clusters"); el.innerHTML="";
    var groups = {};
    state.videos.forEach(function(v){ var id=v.clusterId!=null?v.clusterId:0; (groups[id]=groups[id]||[]).push(v); });
    var entries = Object.keys(groups).map(function(k){ return [k, groups[k]]; }).sort(function(a,b){ return (avgRank(b[1]) - avgRank(a[1])); });
    entries.forEach(function(pair){
      var cid=pair[0], arr=pair[1]; if(!arr.length) return;
      var rep = [].concat(arr).sort(function(a,b){return b.metrics.pick-a.metrics.pick;})[0];
      var keys = topKeywords(state.centroids[cid]||{}, 8);
      var card = document.createElement("div");
      card.className="card cluster";
      card.innerHTML = [
        '<img class="thumb" src="'+(rep&&rep.snippet&&rep.snippet.thumbnails&&rep.snippet.thumbnails.medium&&rep.snippet.thumbnails.medium.url||'')+'"/>',
        '<div>',
        '<div class="row" style="justify-content:space-between;align-items:flex-start">',
        '<div><b>ë¬¶ìŒ '+cid+'</b> Â· <span class="muted">'+arr.length+'ê°œ</span></div>',
        '<div class="badge">í‰ê·  ì¢…í•©ì ìˆ˜ '+avgRank(arr).toFixed(2)+'</div>',
        '</div>',
        '<div style="margin:6px 0 2px">'+keys.map(function(k){return '<span class="tag">'+escapeHtml(k)+'</span>';}).join('')+'</div>',
        '<div class="hint">ëŒ€í‘œ: '+escapeHtml((rep&&rep.snippet&&rep.snippet.title||"").slice(0,80))+'</div>',
        '</div>'
      ].join("");
      el.appendChild(card);
    });
  }

  var dayOrder=[1,2,3,4,5,6,0], dayNames=["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
  function formatHour(h){ return String(h).padStart(2,"0")+":00"; }
  function colorFor(val,max){ var n = max>0? (val/max) : 0; var l = 16 + n*48; return "hsl(210,80%,"+l+"%)"; }
  function renderHeatmap(videos){
    var grid = Array.from({length:7}, function(){ return Array(24).fill(0); });
    videos.forEach(function(v){ var d=new Date(v.snippet.publishedAt), dow=d.getDay(), h=d.getHours(); var w=Math.max(0, v.metrics && v.metrics.pick || 0); grid[dow][h]+=w; });
    var max=0, d,h; for(d=0;d<7;d++){ for(h=0;h<24;h++){ if(grid[d][h]>max) max=grid[d][h]; }}
    var hm = document.getElementById("heatmap"); if(!hm) return; var html="";
    html += '<div class="row"><span class="label"></span>'+Array.from({length:24},function(_,i){ return '<span class="small" style="width:18px;text-align:center;color:#8fa4b8">'+(i%6===0?i:"")+'</span>'; }).join("")+'</div>';
    dayOrder.forEach(function(dow){
      html += '<div class="row"><span class="label">'+dayNames[dow]+'</span>';
      for(h=0;h<24;h++){ var v=grid[dow][h]; var clr=colorFor(v,max); html += '<span class="cell" title="'+dayNames[dow]+' '+formatHour(h)+' Â· '+v.toFixed(2)+'" style="background:'+clr+'"></span>'; }
      html += '</div>';
    });
    html += '<div class="legend"><span class="small muted">ë‚®ìŒ</span><span class="box" style="background:'+colorFor(0,max)+'"></span><span class="box" style="background:'+colorFor(max*0.5,max)+'"></span><span class="box" style="background:'+colorFor(max,max)+'"></span><span class="small muted">ë†’ìŒ</span></div>';
    hm.innerHTML = html;

    var arr=[], i; for(d=0;d<7;d++){ for(h=0;h<24;h++){ arr.push({d:d,h:h,score:grid[d][h]}); }}
    arr.sort(function(a,b){ return b.score-a.score; });
    var top = arr.filter(function(x){ return x.score>0; }).slice(0,6);
    var best = document.getElementById("bestTimes"); if(best) best.innerHTML = top.map(function(t){ return "<li>"+dayNames[t.d]+" "+formatHour(t.h)+"â€“"+formatHour((t.h+1)%24)+" Â· ì§€ìˆ˜ "+t.score.toFixed(2)+"</li>"; }).join("");
  }

  function runWizard(clusterId){
    var group = STATE.videos.filter(function(v){ return v.clusterId===clusterId; });
    var out = document.getElementById("wizardOut"); out.innerHTML="";
    if(group.length===0){ out.innerHTML='<div class="hint">í•´ë‹¹ ë¬¶ìŒì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</div>'; return; }
    var rep = [].concat(group).sort(function(a,b){ return b.metrics.pick-a.metrics.pick; })[0];
    var keys = topKeywords(STATE.centroids[clusterId]||{}, 8);
    var hooks = [
      "ë”± 10ì´ˆë¡œ ëë‚´ëŠ” "+(keys[0]||"í•µì‹¬")+" ìš”ì•½",
      "ëŒ“ê¸€ í­ë°œí•œ "+(keys[1]||"ì¥ë©´")+", 3ì´ˆ ë¦¬ë©”ì´í¬",
      (keys[2]||"ë…¼ë€")+" í•œ ë¬¸ì¥, ì•ë’¤ ë§¥ë½ì€?"
    ];
    var shotlist = [
      "0â€“2s: ê°•ë ¬í•œ ì¸ë„¤ì¼ í…ìŠ¤íŠ¸ + íš¨ê³¼ìŒ",
      "3â€“8s: "+(keys[0]||"í•µì‹¬ìš”ì†Œ")+" ì¥ë©´ í´ë¦½/ë°ˆ",
      "9â€“15s: ëŒ€ë¹„ ì¥ë©´/íŒ©íŠ¸ 1",
      "16â€“22s: ë°˜ì „ ì¥ë©´/íŒ©íŠ¸ 2",
      "23â€“27s: ìš”ì•½ í•œ ë¬¸ì¥(ìë§‰ í¬ê²Œ)",
      "28â€“30s: êµ¬ë…/íŒ”ë¡œìš° CTA + ë‹¤ìŒ í¸ ì˜ˆê³ "
    ];
    var hashtags = ["#shorts","#trending"].concat(keys.slice(0,4).map(function(k){ return "#"+k; })).join(" ");
    var left = document.createElement("div"); left.className="card";
    left.innerHTML = "<b>í›…(Hooks) 3ì•ˆ</b><ul>"+hooks.map(function(h){ return "<li>"+escapeHtml(h)+"</li>"; }).join("")+"</ul>";
    var right = document.createElement("div"); right.className="card";
    right.innerHTML = "<b>ìƒ·ë¦¬ìŠ¤íŠ¸(30ì´ˆ)</b><ol>"+shotlist.map(function(s){ return "<li>"+escapeHtml(s)+"</li>"; }).join("")+"</ol><div style=\"margin-top:6px\"><b>í•´ì‹œíƒœê·¸:</b> <span class=\"muted\">"+escapeHtml(hashtags)+"</span></div>";
    out.appendChild(left); out.appendChild(right);
  }

  function exportCsv(){
    if(!STATE.videos.length){ alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
    var cols = ["id","title","channel","publishedAt","durationSec","views","likes","comments","vel","eng","fresh","fit","pick","delta24h","titleFlags","ocrLen","ocrKeys","clusterId"];
    var rows = [cols.join(",")];
    STATE.videos.forEach(function(v){
      var sec = isoToSeconds(v.contentDetails.duration);
      var d=delta24h(v.id); var oc=STATE.ocr[v.id]||{len:0,keys:[]};
      var flags=v._pattern||{};
      var r = [
        v.id,
        '"'+String(v.snippet.title||"").replace(/"/g,'""')+'"',
        '"'+String(v.snippet.channelTitle||"").replace(/"/g,'""')+'"',
        v.snippet.publishedAt,
        sec,
        v.statistics.viewCount||0,
        v.statistics.likeCount||0,
        v.statistics.commentCount||0,
        (v.metrics.vel||0).toFixed(3),
        (v.metrics.eng||0).toFixed(3),
        (v.metrics.fresh||0).toFixed(5),
        (v.metrics.fit||0).toFixed(5),
        (v.metrics.pick||0).toFixed(5),
        d.views||0,
        "num:"+(flags.hasNum?1:0)+";q:"+(flags.isQ?1:0)+";emo:"+(flags.emoji||0)+";br:"+(flags.hasBracket?1:0)+";ser:"+(flags.series?1:0),
        oc.len||0,
        '"'+(oc.keys||[]).join(" ").replace(/"/g,'""')+'"',
        v.clusterId!=null?v.clusterId:""
      ];
      rows.push(r.join(","));
    });
    var blob = new Blob([rows.join("\\n")],{type:"text/csv;charset=utf-8;"});
    var a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "shorts_radar_pro.csv"; document.body.appendChild(a); a.click(); a.remove();
  }

  function exportManual(){
    var date = new Date().toLocaleDateString("ko-KR");
    var md = [
      "# Shorts Radar Pro ì‚¬ìš© ë§¤ë‰´ì–¼ (í•œ ì¥)",
      "ìƒì„±ì¼: "+date,
      "",
      "- ìƒˆ ê¸°ëŠ¥: ì¸ë„¤ì¼ OCR, ì œëª© íŒ¨í„´, ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ ìŠ¤ëƒ…ìƒ·, ì±„ë„ ìš´ì˜ ì¹´ë“œ",
      "- ì›Œì¹˜ë¦¬ìŠ¤íŠ¸: â˜† í´ë¦­ â†’ 'ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ ì¬ì¸¡ì •'ìœ¼ë¡œ 24ì‹œê°„ ì¦ê°€ëŸ‰ í™•ì¸",
      "- OCR: ìƒìœ„ Nê°œ(ê¸°ë³¸20)ë§Œ ì¶”ì¶œ. ë¬´ê±°ìš°ë‹ˆ í•„ìš”í•  ë•Œ ë²„íŠ¼ìœ¼ë¡œ ì‹¤í–‰",
      "- ì±„ë„ ì¹´ë“œ: ìµœê·¼ ê²°ê³¼ ê¸°ì¤€. í‰ê·  ì£¼ê¸°(ì¼), íˆíŠ¸ ì‹œê°„ëŒ€ ì¶”ì²œ",
      ""
    ].join("\\n");
    var blob = new Blob([md], {type:"text/markdown;charset=utf-8;"});
    var a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "Shorts_Radar_Pro_ì‚¬ìš©ë²•.md"; document.body.appendChild(a); a.click(); a.remove();
  }

  async function run(){
    try{
      var key = document.getElementById("apiKey").value.trim(); if(!key) return alert("API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      var q = document.getElementById("keywords").value.trim();
      var channels = document.getElementById("channels").value.trim().split(",").map(function(s){return s.trim();}).filter(Boolean);
      var days = Number(document.getElementById("days").value||7);
      var regionCode = document.getElementById("region").value || "KR";
      var maxResults = Number(document.getElementById("maxResults").value||80);
      var publishedAfter = new Date(Date.now()-days*24*3600*1000).toISOString();

      var items = [];
      async function collectBy(qword, channelId){
        var pageToken=null, fetched=0, limit=maxResults;
        do{
          var data = await ytSearch({q:qword, channelId:channelId, publishedAfter:publishedAfter, regionCode:regionCode, maxResults: Math.min(50, limit-fetched), key:key, pageToken:pageToken});
          var vids = (data.items||[]).filter(function(it){ return it.id && it.id.videoId; });
          items.push.apply(items, vids.map(function(it){ return {id:it.id.videoId, snippet:it.snippet}; }));
          fetched += vids.length; pageToken = data.nextPageToken && fetched < limit ? data.nextPageToken : null;
        } while(pageToken);
      }
      if(channels.length){ for(var i=0;i<channels.length;i++) await collectBy(q||"", channels[i]); }
      else await collectBy(q||"", null);

      var ids = uniq(items.map(function(x){ return x.id; }));
      var videos=[]; for(var j=0;j<ids.length;j+=50){
        var batch = ids.slice(j,j+50);
        var data2 = await ytVideos(batch, key);
        (data2.items||[]).forEach(function(v){ videos.push(v); });
      }

      var shorts = videos.filter(function(v){ return isShort(v.snippet, v.contentDetails); });

      var docs = shorts.map(function(v){ return tf(tokenize(String(v.snippet.title||"")+" "+String(v.snippet.description||"")+" "+(Array.isArray(v.snippet.tags)?v.snippet.tags.join(" "):""))); });
      STATE.idf = idf(docs);
      STATE.topicVec = buildTopicVec(q);

      shorts.forEach(function(v){
        v._isShort = true;
        v.metrics = calcMetrics(v, STATE.topicVec);
        v._pattern = analyzeTitle(v.snippet.title||"");
      });

      var vecs = docs.map(function(d){ return tfidf(d, STATE.idf); });
      var kManual = Number(document.getElementById("kValue").value||0);
      var k = kManual>0? kManual : Math.max(1, Math.round(Math.sqrt(vecs.length||1)));
      var km = kmeans(vecs, k);
      var labels = km.labels, centroids = km.centroids;
      shorts.forEach(function(v,i){ v.clusterId = labels[i]; });

      var minRank = Number(document.getElementById("minRank").value||0);
      var filtered = shorts.filter(function(v){ return v.metrics.pick >= minRank; });

      STATE.videos = filtered; STATE.vectors = vecs; STATE.centroids = centroids; STATE.labels = labels;

      setSummary(filtered);
      renderClusters(STATE);
      renderTable(filtered);
      renderHeatmap(filtered);
      renderChannelBoard(filtered);
      ensureHeaderClasses();
      applyColumnVisibility();
    }catch(e){ console.error(e); alert("ì˜¤ë¥˜: "+e.message); }
  }

  function renderChannelBoard(videos){
    var byCh={};
    videos.forEach(function(v){
      var cid=v.snippet.channelId|| (v.snippet.channel && v.snippet.channel.id) || "unknown";
      (byCh[cid]=byCh[cid]||{title:v.snippet.channelTitle,id:cid,times:[]}).times.push(v.snippet.publishedAt);
    });
    var list=Object.values(byCh).sort(function(a,b){ return b.times.length-a.times.length; }).slice(0,8);
    var board=document.getElementById("chanBoard"); board.innerHTML="";
    list.forEach(function(ch){
      var times=ch.times.map(function(t){return new Date(t).getTime();}).sort(function(a,b){return a-b;});
      var gaps=[], i; for(i=1;i<times.length;i++) gaps.push( (times[i]-times[i-1])/(24*3600*1000) );
      var avgGap=gaps.length? (gaps.reduce(function(s,x){return s+x;},0)/gaps.length):0;
      var hours=new Array(24).fill(0); ch.times.forEach(function(t){ hours[new Date(t).getHours()]++; });
      var topHour=hours.map(function(v,i){return {v:v,i:i};}).sort(function(a,b){return b.v-a.v;})[0]; topHour = topHour? topHour.i : 0;
      var el=document.createElement("div"); el.className="channel-card";
      el.innerHTML='<div><b>'+escapeHtml(ch.title||"-")+'</b><div class="small muted">ê²°ê³¼ìˆ˜ '+ch.times.length+' Â· í‰ê·  ì£¼ê¸° '+(avgGap?avgGap.toFixed(1)+"ì¼":"-")+'</div></div><div class="small">íˆíŠ¸ ì‹œê°„ëŒ€: <b>'+String(topHour).padStart(2,"0")+":00</b></div>';
      board.appendChild(el);
    });
  }

  function kmeans(vectors, k, maxIter){
    maxIter = maxIter || 20;
    var n = vectors.length; if(n===0) return {labels:[],centroids:[]};
    k = Math.max(1, Math.min(k, n));
    function dist(a,b){return 1 - cosine(a,b);}
    var idxs = Array.from({length:n}, function(_,i){return i;}).sort(function(){return Math.random()-0.5;}).slice(0,k);
    var centroids = idxs.map(function(i){ var o={}, key; for(key in vectors[i]) o[key]=vectors[i][key]; return o; });
    var labels = new Array(n).fill(0);
    for(var iter=0; iter<maxIter; iter++){
      var changed=false;
      for(var i=0;i<n;i++){
        var best=0,bestd=Infinity;
        for(var c=0;c<k;c++){ var d=dist(vectors[i],centroids[c]); if(d<bestd){bestd=d;best=c;} }
        if(labels[i]!==best){labels[i]=best;changed=true;}
      }
      if(!changed) break;
      var sums=Array.from({length:k},function(){return {};});
      var counts=new Array(k).fill(0);
      for(i=0;i<n;i++){
        var c=labels[i]; counts[c]++;
        Object.keys(vectors[i]).forEach(function(key){ sums[c][key]=(sums[c][key]||0)+vectors[i][key]; });
      }
      for(var c2=0;c2<k;c2++){
        var v={}, cnt=Math.max(1,counts[c2]);
        Object.keys(sums[c2]).forEach(function(key){ v[key]=sums[c2][key]/cnt; });
        centroids[c2]=v;
      }
    }
    return {labels:labels,centroids:centroids};
  }

  document.getElementById("runBtn").addEventListener("click", run);
  document.getElementById("recluster").addEventListener("click", function(){
    if(!STATE.videos.length){ alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
    var vecs = STATE.vectors; var kManual = Number(document.getElementById("kValue").value||0);
    var k = kManual>0? kManual : Math.max(1, Math.round(Math.sqrt(vecs.length||1)));
    var km=kmeans(vecs,k);
    STATE.videos.forEach(function(v,i){ v.clusterId = km.labels[i]; });
    STATE.centroids = km.centroids; STATE.labels = km.labels;
    renderClusters(STATE); renderTable(STATE.videos); renderHeatmap(STATE.videos); renderChannelBoard(STATE.videos);
    ensureHeaderClasses(); applyColumnVisibility();
  });
  document.getElementById("runWizard").addEventListener("click", function(){ var cid = Number(document.getElementById("wizCluster").value||0); runWizard(cid); });
  document.getElementById("saveKey").addEventListener("click", function(){ save("yt_api_key", document.getElementById("apiKey").value.trim()); alert("ì €ì¥ë¨"); });
  document.getElementById("exportCsv").addEventListener("click", exportCsv);
  document.getElementById("exportManual").addEventListener("click", exportManual);
  document.getElementById("resetBtn").addEventListener("click", function(){ localStorage.clear(); document.getElementById("apiKey").value=""; alert("ì´ˆê¸°í™” ì™„ë£Œ"); });
  document.getElementById("btnOcr").addEventListener("click", function(){ ocrTopN(20); });
  document.getElementById("btnReprobe").addEventListener("click", reprobeWatchlist);

  var BUILTIN_PRESETS = [
    {name:"ì •ì¹˜ë“œë¦½(ì‹œì‚¬í’ì)", keywords:"ì •ì¹˜í’ì, ì‹œì‚¬ ìš”ì•½, ë°ˆ", channels:""},
    {name:"BrotLab ë² ì´í‚¹", keywords:"ì‚¬ì›Œë„ìš°, ë°œíš¨ë¹µ, ë² ì´í‚¹ íŒ", channels:""},
    {name:"Paw Chu ë°˜ë ¤ë™ë¬¼", keywords:"ê³ ì–‘ì´, ë°˜ë ¤ë™ë¬¼, ëª¨ë˜ë§¤íŠ¸, ì§‘ì‚¬ íŒ", channels:""}
  ];
  function getPresets(){ var p = load("sr_presets", null); if(!p){ p = BUILTIN_PRESETS; save("sr_presets", p);} return p; }
  function setPresets(p){ save("sr_presets", p); }
  function initPresetsUI(){ var sel = document.getElementById("presetSelect"); if(!sel) return; var list=getPresets(); sel.innerHTML=list.map(function(p,i){ return '<option value="'+i+'">'+escapeHtml(p.name)+'</option>'; }).join(""); }
  document.addEventListener("DOMContentLoaded", initPresetsUI);
  document.getElementById("presetLoad").addEventListener("click", function(){ var idx=parseInt(document.getElementById("presetSelect").value||0,10); var list=getPresets(); var p=list[idx]; if(!p) return; document.getElementById("keywords").value=p.keywords||""; document.getElementById("channels").value=p.channels||""; });
  document.getElementById("presetSave").addEventListener("click", function(){ var name=prompt("í”„ë¦¬ì…‹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"); if(!name) return; var list=getPresets(); list.unshift({name:name, keywords:document.getElementById("keywords").value.trim(), channels:document.getElementById("channels").value.trim()}); setPresets(list); initPresetsUI(); buildColControls(); alert("ì €ì¥ ì™„ë£Œ"); });
  document.getElementById("presetDel").addEventListener("click", function(){ var sel=document.getElementById("presetSelect"); var idx=parseInt(sel.value||0,10); var list=getPresets(); if(!list[idx]) return; if(!confirm("'"+list[idx].name+"' í”„ë¦¬ì…‹ì„ ì‚­ì œí• ê¹Œìš”?")) return; list.splice(idx,1); setPresets(list); initPresetsUI(); });

  var savedKey = load("yt_api_key",""); if(savedKey) document.getElementById("apiKey").value = savedKey;
  loadWatch();
  buildColControls();
  renderQuota();
  document.getElementById("quotaApply").addEventListener("click", function(){ setQuotaLimit(document.getElementById("quotaLimit").value); });
  document.getElementById("quotaReset").addEventListener("click", resetQuota);
  ensureHeaderClasses(); applyColumnVisibility();
})();
</script>
</body>
</html>
